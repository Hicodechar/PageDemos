
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>[GIT,PULL] perf fixes - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    [GIT,PULL] perf fixes</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=35552">Ingo Molnar</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Dec. 6, 2017, 10:17 p.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;20171206221702.kt2homgqw2mjthqv@gmail.com&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/10097207/mbox/"
   >mbox</a>
|
   <a href="/patch/10097207/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/10097207/">/patch/10097207/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
	[172.30.200.125])
	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id
	6CB9460210 for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  6 Dec 2017 22:17:26 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 481BD29EAC
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  6 Dec 2017 22:17:26 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id 3C91929F2B; Wed,  6 Dec 2017 22:17:26 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-3.1 required=2.0 tests=BAYES_00,DKIM_SIGNED,
	FSL_HELO_FAKE, RCVD_IN_DNSWL_HI,
	T_DKIM_INVALID autolearn=ham version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id D621F29F2A
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  6 Dec 2017 22:17:21 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1752111AbdLFWRQ (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Wed, 6 Dec 2017 17:17:16 -0500
Received: from mail-wr0-f175.google.com ([209.85.128.175]:38106 &quot;EHLO
	mail-wr0-f175.google.com&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1751598AbdLFWRM (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Wed, 6 Dec 2017 17:17:12 -0500
Received: by mail-wr0-f175.google.com with SMTP id o2so5485300wro.5
	for &lt;linux-kernel@vger.kernel.org&gt;;
	Wed, 06 Dec 2017 14:17:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=gmail.com; s=20161025;
	h=sender:date:from:to:cc:subject:message-id:mime-version
	:content-disposition:user-agent;
	bh=Q1XyN/ADo/gChQNw4SjcFnqGqZyn0bOAZrQoDnNr9jM=;
	b=F/y6B96vsLyk0qzUN8/YbDMJlJJL+TNRs/c9aBwTcvPmsjKTJ7IDXXVXKipXP+t1x+
	Q5HW1um9RjGSLKoHQKFAs4sDKppq/sVvmKa4KlaGKjTvpVBPEdGq2c0RBol4N8jSrWcy
	8JaisLByBhn2XU2KDnYxsVUxH+WNklWVvWBctXSuFu//fLtrmmENnP0qfn5q0UBPJlBC
	eh3+5/ho9Qnb1GHD/yU6pzISSJnB2enhjBcuO9RwR4DX2uIE8Qe11M7k773hwGQ0pmVF
	9zfiT0hqXpH94i6jLDuPo0z+NibbpiYOdmYokk3PGZ8ySqP78ykIq7CbtUHno1AGvJwe
	SnGw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:sender:date:from:to:cc:subject:message-id
	:mime-version:content-disposition:user-agent;
	bh=Q1XyN/ADo/gChQNw4SjcFnqGqZyn0bOAZrQoDnNr9jM=;
	b=AVgfyZN/0b4fLxtCAH40KKMVbERon4nfTc+/a4gJKefSB9k+bY3dqGzfTTNMiRZGen
	L9MTvgS1XxtOTrvn9hXfob/yc5j/LEgtRj8IraJ/ZHEO4JVlekS8yA9n/+P30VFT7B5P
	QXuirYYVmnKStFYg9RfDH+1Vw70r+9pe+rM/+CGwqpnSzk9OOPvUNaooK2WiskZV5r0D
	UM0/N19mGTBDpJT81qxJM9yad/TTnnZdY6mkvPJVSK10cW19Qhr7ZR6BrnOAe5TpFgPn
	AHCbt40HBWS/MIYysixaqBD5ozPdVp2mM5ZplVnEpbc8pvWPSW6i+oYXxLDfSu4MN/pQ
	MeWA==
X-Gm-Message-State: AJaThX72xjEZcASnTp7TCQ3cPwGL+sTAV4he2uR4dMLc5yVe04eDeAtg
	5RlDaMi1bFTCwPs4wpURdc2tUg==
X-Google-Smtp-Source: AGs4zMY8mMj84mSQDTV2Kc+FSsjoJCkGl/7H1RbE7jbNOj5eDOGlVDAdDE9ATPKvkLUefSM67kqHyg==
X-Received: by 10.223.136.80 with SMTP id e16mr22717164wre.21.1512598625721; 
	Wed, 06 Dec 2017 14:17:05 -0800 (PST)
Received: from gmail.com (2E8B0CD5.catv.pool.telekom.hu. [46.139.12.213])
	by smtp.gmail.com with ESMTPSA id
	n14sm3615010wmh.37.2017.12.06.14.17.04
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Wed, 06 Dec 2017 14:17:04 -0800 (PST)
Date: Wed, 6 Dec 2017 23:17:02 +0100
From: Ingo Molnar &lt;mingo@kernel.org&gt;
To: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Cc: linux-kernel@vger.kernel.org,
	Arnaldo Carvalho de Melo &lt;acme@infradead.org&gt;,
	Peter Zijlstra &lt;a.p.zijlstra@chello.nl&gt;,
	Thomas Gleixner &lt;tglx@linutronix.de&gt;,
	Andrew Morton &lt;akpm@linux-foundation.org&gt;
Subject: [GIT PULL] perf fixes
Message-ID: &lt;20171206221702.kt2homgqw2mjthqv@gmail.com&gt;
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
User-Agent: NeoMutt/20170609 (1.8.3)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=35552">Ingo Molnar</a> - Dec. 6, 2017, 10:17 p.m.</div>
<pre class="content">
Linus,

Please pull the latest perf-urgent-for-linus git tree from:

   git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git perf-urgent-for-linus

   # HEAD: 34c9ca37aaec2e307b837bb099d3b44f0ea04ddc tooling/headers: Synchronize updated s390 and x86 UAPI headers

This tree includes perf namespace support kernel side fixes, plus an accumulated 
set of perf tooling fixes - including UAPI header synchronization that should make 
the perf build less noisy.

 Thanks,

	Ingo

------------------&gt;
Adrian Hunter (1):
      perf intel-pt: Bring instruction decoder files into line with the kernel

Andi Kleen (1):
      perf record: Fix -c/-F options for cpu event aliases

Andrei Vagin (1):
      perf trace: Fix an exit code of trace__symbols_init

Arnaldo Carvalho de Melo (16):
      perf evlist: Set the correct idx when adding dummy events
      perf record: Generate PERF_RECORD_{MMAP,COMM,EXEC} with --delay
      perf evsel: Fix up leftover perf_evsel_stat usage via evsel-&gt;priv
      perf script: Fix --per-event-dump for auxtrace synth evsels
      perf machine: Guard against NULL in machine__exit()
      perf evlist: Add helper to check if attr.exclude_kernel is set in all evsels
      perf report: Ignore kptr_restrict when not sampling the kernel
      perf record: Ignore kptr_restrict when not sampling the kernel
      perf top: Ignore kptr_restrict when not sampling the kernel
      tools headers: Synchronize kernel ABI headers wrt SPDX tags
      tools headers: Synchronize perf_event.h header
      tools headers uapi: Synchronize drm/drm.h
      tools headers: Synchronize drm/i915_drm.h
      tools headers: Synchronize KVM arch ABI headers
      tools headers: Synchronize prctl.h ABI header
      tools headers: Syncronize mman.h ABI header

Ingo Molnar (2):
      tools/headers: Synchronize kernel x86 UAPI headers
      tooling/headers: Synchronize updated s390 and x86 UAPI headers

Jiri Olsa (3):
      perf: Fix header.size for namespace events
      perf top: Fix window dimensions change handling
      perf top: Use signal interface for SIGWINCH handler

Namhyung Kim (1):
      perf help: Fix a bug during strstart() conversion

Ravi Bangoria (1):
      perf annotate: Do not truncate instruction names at 6 chars

Satheesh Rajendran (1):
      perf bench numa: Fixup discontiguous/sparse numa nodes

Thomas Richter (3):
      perf test shell: Fix check open filename arg using &#39;perf trace&#39; on s390x
      perf test shell: Fix test case probe libc&#39;s inet_pton on s390x
      perf test: Fix test 21 for s390x

Vasily Averin (1):
      perf/core: Fix memory leak triggered by perf --namespace


 kernel/events/core.c                               |   5 +-
 tools/arch/arm/include/uapi/asm/kvm.h              |   7 +
 tools/arch/arm64/include/uapi/asm/kvm.h            |   7 +
 tools/arch/s390/include/uapi/asm/kvm.h             |   4 -
 tools/arch/s390/include/uapi/asm/kvm_perf.h        |   4 -
 tools/arch/x86/include/asm/cpufeatures.h           | 537 +++++++++++----------
 tools/arch/x86/include/asm/disabled-features.h     |   8 +-
 tools/include/uapi/asm-generic/mman.h              |   1 +
 tools/include/uapi/drm/drm.h                       |  41 ++
 tools/include/uapi/drm/i915_drm.h                  |  33 +-
 tools/include/uapi/linux/kcmp.h                    |   1 +
 tools/include/uapi/linux/kvm.h                     |   1 +
 tools/include/uapi/linux/perf_event.h              |   1 +
 tools/include/uapi/linux/prctl.h                   |  10 +
 tools/perf/bench/numa.c                            |  56 ++-
 tools/perf/builtin-help.c                          |   4 +-
 tools/perf/builtin-record.c                        |  42 +-
 tools/perf/builtin-report.c                        |   3 +
 tools/perf/builtin-script.c                        |  31 +-
 tools/perf/builtin-top.c                           |  36 +-
 tools/perf/builtin-trace.c                         |   6 +-
 .../perf/tests/shell/trace+probe_libc_inet_pton.sh |   7 +-
 tools/perf/tests/shell/trace+probe_vfs_getname.sh  |   6 +-
 tools/perf/tests/task-exit.c                       |   4 +
 tools/perf/trace/beauty/mmap.c                     |   3 +
 tools/perf/util/annotate.c                         |  18 +-
 tools/perf/util/evlist.c                           |  14 +-
 tools/perf/util/evlist.h                           |   2 +
 tools/perf/util/evsel.c                            |  14 +-
 tools/perf/util/evsel.h                            |   1 +
 tools/perf/util/intel-pt-decoder/inat.h            |  10 +
 .../perf/util/intel-pt-decoder/x86-opcode-map.txt  |   2 +-
 tools/perf/util/machine.c                          |   3 +
 tools/perf/util/parse-events.c                     |   2 +
 tools/perf/util/parse-events.h                     |   3 +
 tools/perf/util/pmu.c                              |   5 +
 36 files changed, 594 insertions(+), 338 deletions(-)
</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
<span class="p_header">diff --git a/kernel/events/core.c b/kernel/events/core.c</span>
<span class="p_header">index 16beab4767e1..5961ef6dfd64 100644</span>
<span class="p_header">--- a/kernel/events/core.c</span>
<span class="p_header">+++ b/kernel/events/core.c</span>
<span class="p_chunk">@@ -6639,6 +6639,7 @@</span> <span class="p_context"> static void perf_event_namespaces_output(struct perf_event *event,</span>
 	struct perf_namespaces_event *namespaces_event = data;
 	struct perf_output_handle handle;
 	struct perf_sample_data sample;
<span class="p_add">+	u16 header_size = namespaces_event-&gt;event_id.header.size;</span>
 	int ret;
 
 	if (!perf_event_namespaces_match(event))
<span class="p_chunk">@@ -6649,7 +6650,7 @@</span> <span class="p_context"> static void perf_event_namespaces_output(struct perf_event *event,</span>
 	ret = perf_output_begin(&amp;handle, event,
 				namespaces_event-&gt;event_id.header.size);
 	if (ret)
<span class="p_del">-		return;</span>
<span class="p_add">+		goto out;</span>
 
 	namespaces_event-&gt;event_id.pid = perf_event_pid(event,
 							namespaces_event-&gt;task);
<span class="p_chunk">@@ -6661,6 +6662,8 @@</span> <span class="p_context"> static void perf_event_namespaces_output(struct perf_event *event,</span>
 	perf_event__output_id_sample(event, &amp;handle, &amp;sample);
 
 	perf_output_end(&amp;handle);
<span class="p_add">+out:</span>
<span class="p_add">+	namespaces_event-&gt;event_id.header.size = header_size;</span>
 }
 
 static void perf_fill_ns_link_info(struct perf_ns_link_info *ns_link_info,
<span class="p_header">diff --git a/tools/arch/arm/include/uapi/asm/kvm.h b/tools/arch/arm/include/uapi/asm/kvm.h</span>
<span class="p_header">index 1f57bbe82b6f..6edd177bb1c7 100644</span>
<span class="p_header">--- a/tools/arch/arm/include/uapi/asm/kvm.h</span>
<span class="p_header">+++ b/tools/arch/arm/include/uapi/asm/kvm.h</span>
<span class="p_chunk">@@ -152,6 +152,12 @@</span> <span class="p_context"> struct kvm_arch_memory_slot {</span>
 	(__ARM_CP15_REG(op1, 0, crm, 0) | KVM_REG_SIZE_U64)
 #define ARM_CP15_REG64(...) __ARM_CP15_REG64(__VA_ARGS__)
 
<span class="p_add">+/* PL1 Physical Timer Registers */</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CTL		ARM_CP15_REG32(0, 14, 2, 1)</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CNT		ARM_CP15_REG64(0, 14)</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CVAL		ARM_CP15_REG64(2, 14)</span>
<span class="p_add">+</span>
<span class="p_add">+/* Virtual Timer Registers */</span>
 #define KVM_REG_ARM_TIMER_CTL		ARM_CP15_REG32(0, 14, 3, 1)
 #define KVM_REG_ARM_TIMER_CNT		ARM_CP15_REG64(1, 14)
 #define KVM_REG_ARM_TIMER_CVAL		ARM_CP15_REG64(3, 14)
<span class="p_chunk">@@ -216,6 +222,7 @@</span> <span class="p_context"> struct kvm_arch_memory_slot {</span>
 #define   KVM_DEV_ARM_ITS_SAVE_TABLES		1
 #define   KVM_DEV_ARM_ITS_RESTORE_TABLES	2
 #define   KVM_DEV_ARM_VGIC_SAVE_PENDING_TABLES	3
<span class="p_add">+#define   KVM_DEV_ARM_ITS_CTRL_RESET		4</span>
 
 /* KVM_IRQ_LINE irq field index values */
 #define KVM_ARM_IRQ_TYPE_SHIFT		24
<span class="p_header">diff --git a/tools/arch/arm64/include/uapi/asm/kvm.h b/tools/arch/arm64/include/uapi/asm/kvm.h</span>
<span class="p_header">index 51149ec75fe4..9abbf3044654 100644</span>
<span class="p_header">--- a/tools/arch/arm64/include/uapi/asm/kvm.h</span>
<span class="p_header">+++ b/tools/arch/arm64/include/uapi/asm/kvm.h</span>
<span class="p_chunk">@@ -196,6 +196,12 @@</span> <span class="p_context"> struct kvm_arch_memory_slot {</span>
 
 #define ARM64_SYS_REG(...) (__ARM64_SYS_REG(__VA_ARGS__) | KVM_REG_SIZE_U64)
 
<span class="p_add">+/* Physical Timer EL0 Registers */</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CTL		ARM64_SYS_REG(3, 3, 14, 2, 1)</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CVAL		ARM64_SYS_REG(3, 3, 14, 2, 2)</span>
<span class="p_add">+#define KVM_REG_ARM_PTIMER_CNT		ARM64_SYS_REG(3, 3, 14, 0, 1)</span>
<span class="p_add">+</span>
<span class="p_add">+/* EL0 Virtual Timer Registers */</span>
 #define KVM_REG_ARM_TIMER_CTL		ARM64_SYS_REG(3, 3, 14, 3, 1)
 #define KVM_REG_ARM_TIMER_CNT		ARM64_SYS_REG(3, 3, 14, 3, 2)
 #define KVM_REG_ARM_TIMER_CVAL		ARM64_SYS_REG(3, 3, 14, 0, 2)
<span class="p_chunk">@@ -228,6 +234,7 @@</span> <span class="p_context"> struct kvm_arch_memory_slot {</span>
 #define   KVM_DEV_ARM_ITS_SAVE_TABLES           1
 #define   KVM_DEV_ARM_ITS_RESTORE_TABLES        2
 #define   KVM_DEV_ARM_VGIC_SAVE_PENDING_TABLES	3
<span class="p_add">+#define   KVM_DEV_ARM_ITS_CTRL_RESET		4</span>
 
 /* Device Control API on vcpu fd */
 #define KVM_ARM_VCPU_PMU_V3_CTRL	0
<span class="p_header">diff --git a/tools/arch/s390/include/uapi/asm/kvm.h b/tools/arch/s390/include/uapi/asm/kvm.h</span>
<span class="p_header">index 9ad172dcd912..38535a57fef8 100644</span>
<span class="p_header">--- a/tools/arch/s390/include/uapi/asm/kvm.h</span>
<span class="p_header">+++ b/tools/arch/s390/include/uapi/asm/kvm.h</span>
<span class="p_chunk">@@ -6,10 +6,6 @@</span> <span class="p_context"></span>
  *
  * Copyright IBM Corp. 2008
  *
<span class="p_del">- * This program is free software; you can redistribute it and/or modify</span>
<span class="p_del">- * it under the terms of the GNU General Public License (version 2 only)</span>
<span class="p_del">- * as published by the Free Software Foundation.</span>
<span class="p_del">- *</span>
  *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;
  *               Christian Borntraeger &lt;borntraeger@de.ibm.com&gt;
  */
<span class="p_header">diff --git a/tools/arch/s390/include/uapi/asm/kvm_perf.h b/tools/arch/s390/include/uapi/asm/kvm_perf.h</span>
<span class="p_header">index c36c97ffdc6f..84606b8cc49e 100644</span>
<span class="p_header">--- a/tools/arch/s390/include/uapi/asm/kvm_perf.h</span>
<span class="p_header">+++ b/tools/arch/s390/include/uapi/asm/kvm_perf.h</span>
<span class="p_chunk">@@ -4,10 +4,6 @@</span> <span class="p_context"></span>
  *
  * Copyright 2014 IBM Corp.
  * Author(s): Alexander Yarygin &lt;yarygin@linux.vnet.ibm.com&gt;
<span class="p_del">- *</span>
<span class="p_del">- * This program is free software; you can redistribute it and/or modify</span>
<span class="p_del">- * it under the terms of the GNU General Public License (version 2 only)</span>
<span class="p_del">- * as published by the Free Software Foundation.</span>
  */
 
 #ifndef __LINUX_KVM_PERF_S390_H
<span class="p_header">diff --git a/tools/arch/x86/include/asm/cpufeatures.h b/tools/arch/x86/include/asm/cpufeatures.h</span>
<span class="p_header">index 793690fbda36..c0b0e9e8aa66 100644</span>
<span class="p_header">--- a/tools/arch/x86/include/asm/cpufeatures.h</span>
<span class="p_header">+++ b/tools/arch/x86/include/asm/cpufeatures.h</span>
<span class="p_chunk">@@ -13,173 +13,176 @@</span> <span class="p_context"></span>
 /*
  * Defines x86 CPU feature bits
  */
<span class="p_del">-#define NCAPINTS	18	/* N 32-bit words worth of info */</span>
<span class="p_del">-#define NBUGINTS	1	/* N 32-bit bug flags */</span>
<span class="p_add">+#define NCAPINTS			18	   /* N 32-bit words worth of info */</span>
<span class="p_add">+#define NBUGINTS			1	   /* N 32-bit bug flags */</span>
 
 /*
  * Note: If the comment begins with a quoted string, that string is used
  * in /proc/cpuinfo instead of the macro name.  If the string is &quot;&quot;,
  * this feature bit is not displayed in /proc/cpuinfo at all.
<span class="p_add">+ *</span>
<span class="p_add">+ * When adding new features here that depend on other features,</span>
<span class="p_add">+ * please update the table in kernel/cpu/cpuid-deps.c as well.</span>
  */
 
<span class="p_del">-/* Intel-defined CPU features, CPUID level 0x00000001 (edx), word 0 */</span>
<span class="p_del">-#define X86_FEATURE_FPU		( 0*32+ 0) /* Onboard FPU */</span>
<span class="p_del">-#define X86_FEATURE_VME		( 0*32+ 1) /* Virtual Mode Extensions */</span>
<span class="p_del">-#define X86_FEATURE_DE		( 0*32+ 2) /* Debugging Extensions */</span>
<span class="p_del">-#define X86_FEATURE_PSE		( 0*32+ 3) /* Page Size Extensions */</span>
<span class="p_del">-#define X86_FEATURE_TSC		( 0*32+ 4) /* Time Stamp Counter */</span>
<span class="p_del">-#define X86_FEATURE_MSR		( 0*32+ 5) /* Model-Specific Registers */</span>
<span class="p_del">-#define X86_FEATURE_PAE		( 0*32+ 6) /* Physical Address Extensions */</span>
<span class="p_del">-#define X86_FEATURE_MCE		( 0*32+ 7) /* Machine Check Exception */</span>
<span class="p_del">-#define X86_FEATURE_CX8		( 0*32+ 8) /* CMPXCHG8 instruction */</span>
<span class="p_del">-#define X86_FEATURE_APIC	( 0*32+ 9) /* Onboard APIC */</span>
<span class="p_del">-#define X86_FEATURE_SEP		( 0*32+11) /* SYSENTER/SYSEXIT */</span>
<span class="p_del">-#define X86_FEATURE_MTRR	( 0*32+12) /* Memory Type Range Registers */</span>
<span class="p_del">-#define X86_FEATURE_PGE		( 0*32+13) /* Page Global Enable */</span>
<span class="p_del">-#define X86_FEATURE_MCA		( 0*32+14) /* Machine Check Architecture */</span>
<span class="p_del">-#define X86_FEATURE_CMOV	( 0*32+15) /* CMOV instructions */</span>
<span class="p_del">-					  /* (plus FCMOVcc, FCOMI with FPU) */</span>
<span class="p_del">-#define X86_FEATURE_PAT		( 0*32+16) /* Page Attribute Table */</span>
<span class="p_del">-#define X86_FEATURE_PSE36	( 0*32+17) /* 36-bit PSEs */</span>
<span class="p_del">-#define X86_FEATURE_PN		( 0*32+18) /* Processor serial number */</span>
<span class="p_del">-#define X86_FEATURE_CLFLUSH	( 0*32+19) /* CLFLUSH instruction */</span>
<span class="p_del">-#define X86_FEATURE_DS		( 0*32+21) /* &quot;dts&quot; Debug Store */</span>
<span class="p_del">-#define X86_FEATURE_ACPI	( 0*32+22) /* ACPI via MSR */</span>
<span class="p_del">-#define X86_FEATURE_MMX		( 0*32+23) /* Multimedia Extensions */</span>
<span class="p_del">-#define X86_FEATURE_FXSR	( 0*32+24) /* FXSAVE/FXRSTOR, CR4.OSFXSR */</span>
<span class="p_del">-#define X86_FEATURE_XMM		( 0*32+25) /* &quot;sse&quot; */</span>
<span class="p_del">-#define X86_FEATURE_XMM2	( 0*32+26) /* &quot;sse2&quot; */</span>
<span class="p_del">-#define X86_FEATURE_SELFSNOOP	( 0*32+27) /* &quot;ss&quot; CPU self snoop */</span>
<span class="p_del">-#define X86_FEATURE_HT		( 0*32+28) /* Hyper-Threading */</span>
<span class="p_del">-#define X86_FEATURE_ACC		( 0*32+29) /* &quot;tm&quot; Automatic clock control */</span>
<span class="p_del">-#define X86_FEATURE_IA64	( 0*32+30) /* IA-64 processor */</span>
<span class="p_del">-#define X86_FEATURE_PBE		( 0*32+31) /* Pending Break Enable */</span>
<span class="p_add">+/* Intel-defined CPU features, CPUID level 0x00000001 (EDX), word 0 */</span>
<span class="p_add">+#define X86_FEATURE_FPU			( 0*32+ 0) /* Onboard FPU */</span>
<span class="p_add">+#define X86_FEATURE_VME			( 0*32+ 1) /* Virtual Mode Extensions */</span>
<span class="p_add">+#define X86_FEATURE_DE			( 0*32+ 2) /* Debugging Extensions */</span>
<span class="p_add">+#define X86_FEATURE_PSE			( 0*32+ 3) /* Page Size Extensions */</span>
<span class="p_add">+#define X86_FEATURE_TSC			( 0*32+ 4) /* Time Stamp Counter */</span>
<span class="p_add">+#define X86_FEATURE_MSR			( 0*32+ 5) /* Model-Specific Registers */</span>
<span class="p_add">+#define X86_FEATURE_PAE			( 0*32+ 6) /* Physical Address Extensions */</span>
<span class="p_add">+#define X86_FEATURE_MCE			( 0*32+ 7) /* Machine Check Exception */</span>
<span class="p_add">+#define X86_FEATURE_CX8			( 0*32+ 8) /* CMPXCHG8 instruction */</span>
<span class="p_add">+#define X86_FEATURE_APIC		( 0*32+ 9) /* Onboard APIC */</span>
<span class="p_add">+#define X86_FEATURE_SEP			( 0*32+11) /* SYSENTER/SYSEXIT */</span>
<span class="p_add">+#define X86_FEATURE_MTRR		( 0*32+12) /* Memory Type Range Registers */</span>
<span class="p_add">+#define X86_FEATURE_PGE			( 0*32+13) /* Page Global Enable */</span>
<span class="p_add">+#define X86_FEATURE_MCA			( 0*32+14) /* Machine Check Architecture */</span>
<span class="p_add">+#define X86_FEATURE_CMOV		( 0*32+15) /* CMOV instructions (plus FCMOVcc, FCOMI with FPU) */</span>
<span class="p_add">+#define X86_FEATURE_PAT			( 0*32+16) /* Page Attribute Table */</span>
<span class="p_add">+#define X86_FEATURE_PSE36		( 0*32+17) /* 36-bit PSEs */</span>
<span class="p_add">+#define X86_FEATURE_PN			( 0*32+18) /* Processor serial number */</span>
<span class="p_add">+#define X86_FEATURE_CLFLUSH		( 0*32+19) /* CLFLUSH instruction */</span>
<span class="p_add">+#define X86_FEATURE_DS			( 0*32+21) /* &quot;dts&quot; Debug Store */</span>
<span class="p_add">+#define X86_FEATURE_ACPI		( 0*32+22) /* ACPI via MSR */</span>
<span class="p_add">+#define X86_FEATURE_MMX			( 0*32+23) /* Multimedia Extensions */</span>
<span class="p_add">+#define X86_FEATURE_FXSR		( 0*32+24) /* FXSAVE/FXRSTOR, CR4.OSFXSR */</span>
<span class="p_add">+#define X86_FEATURE_XMM			( 0*32+25) /* &quot;sse&quot; */</span>
<span class="p_add">+#define X86_FEATURE_XMM2		( 0*32+26) /* &quot;sse2&quot; */</span>
<span class="p_add">+#define X86_FEATURE_SELFSNOOP		( 0*32+27) /* &quot;ss&quot; CPU self snoop */</span>
<span class="p_add">+#define X86_FEATURE_HT			( 0*32+28) /* Hyper-Threading */</span>
<span class="p_add">+#define X86_FEATURE_ACC			( 0*32+29) /* &quot;tm&quot; Automatic clock control */</span>
<span class="p_add">+#define X86_FEATURE_IA64		( 0*32+30) /* IA-64 processor */</span>
<span class="p_add">+#define X86_FEATURE_PBE			( 0*32+31) /* Pending Break Enable */</span>
 
 /* AMD-defined CPU features, CPUID level 0x80000001, word 1 */
 /* Don&#39;t duplicate feature flags which are redundant with Intel! */
<span class="p_del">-#define X86_FEATURE_SYSCALL	( 1*32+11) /* SYSCALL/SYSRET */</span>
<span class="p_del">-#define X86_FEATURE_MP		( 1*32+19) /* MP Capable. */</span>
<span class="p_del">-#define X86_FEATURE_NX		( 1*32+20) /* Execute Disable */</span>
<span class="p_del">-#define X86_FEATURE_MMXEXT	( 1*32+22) /* AMD MMX extensions */</span>
<span class="p_del">-#define X86_FEATURE_FXSR_OPT	( 1*32+25) /* FXSAVE/FXRSTOR optimizations */</span>
<span class="p_del">-#define X86_FEATURE_GBPAGES	( 1*32+26) /* &quot;pdpe1gb&quot; GB pages */</span>
<span class="p_del">-#define X86_FEATURE_RDTSCP	( 1*32+27) /* RDTSCP */</span>
<span class="p_del">-#define X86_FEATURE_LM		( 1*32+29) /* Long Mode (x86-64) */</span>
<span class="p_del">-#define X86_FEATURE_3DNOWEXT	( 1*32+30) /* AMD 3DNow! extensions */</span>
<span class="p_del">-#define X86_FEATURE_3DNOW	( 1*32+31) /* 3DNow! */</span>
<span class="p_add">+#define X86_FEATURE_SYSCALL		( 1*32+11) /* SYSCALL/SYSRET */</span>
<span class="p_add">+#define X86_FEATURE_MP			( 1*32+19) /* MP Capable */</span>
<span class="p_add">+#define X86_FEATURE_NX			( 1*32+20) /* Execute Disable */</span>
<span class="p_add">+#define X86_FEATURE_MMXEXT		( 1*32+22) /* AMD MMX extensions */</span>
<span class="p_add">+#define X86_FEATURE_FXSR_OPT		( 1*32+25) /* FXSAVE/FXRSTOR optimizations */</span>
<span class="p_add">+#define X86_FEATURE_GBPAGES		( 1*32+26) /* &quot;pdpe1gb&quot; GB pages */</span>
<span class="p_add">+#define X86_FEATURE_RDTSCP		( 1*32+27) /* RDTSCP */</span>
<span class="p_add">+#define X86_FEATURE_LM			( 1*32+29) /* Long Mode (x86-64, 64-bit support) */</span>
<span class="p_add">+#define X86_FEATURE_3DNOWEXT		( 1*32+30) /* AMD 3DNow extensions */</span>
<span class="p_add">+#define X86_FEATURE_3DNOW		( 1*32+31) /* 3DNow */</span>
 
 /* Transmeta-defined CPU features, CPUID level 0x80860001, word 2 */
<span class="p_del">-#define X86_FEATURE_RECOVERY	( 2*32+ 0) /* CPU in recovery mode */</span>
<span class="p_del">-#define X86_FEATURE_LONGRUN	( 2*32+ 1) /* Longrun power control */</span>
<span class="p_del">-#define X86_FEATURE_LRTI	( 2*32+ 3) /* LongRun table interface */</span>
<span class="p_add">+#define X86_FEATURE_RECOVERY		( 2*32+ 0) /* CPU in recovery mode */</span>
<span class="p_add">+#define X86_FEATURE_LONGRUN		( 2*32+ 1) /* Longrun power control */</span>
<span class="p_add">+#define X86_FEATURE_LRTI		( 2*32+ 3) /* LongRun table interface */</span>
 
 /* Other features, Linux-defined mapping, word 3 */
 /* This range is used for feature bits which conflict or are synthesized */
<span class="p_del">-#define X86_FEATURE_CXMMX	( 3*32+ 0) /* Cyrix MMX extensions */</span>
<span class="p_del">-#define X86_FEATURE_K6_MTRR	( 3*32+ 1) /* AMD K6 nonstandard MTRRs */</span>
<span class="p_del">-#define X86_FEATURE_CYRIX_ARR	( 3*32+ 2) /* Cyrix ARRs (= MTRRs) */</span>
<span class="p_del">-#define X86_FEATURE_CENTAUR_MCR	( 3*32+ 3) /* Centaur MCRs (= MTRRs) */</span>
<span class="p_del">-/* cpu types for specific tunings: */</span>
<span class="p_del">-#define X86_FEATURE_K8		( 3*32+ 4) /* &quot;&quot; Opteron, Athlon64 */</span>
<span class="p_del">-#define X86_FEATURE_K7		( 3*32+ 5) /* &quot;&quot; Athlon */</span>
<span class="p_del">-#define X86_FEATURE_P3		( 3*32+ 6) /* &quot;&quot; P3 */</span>
<span class="p_del">-#define X86_FEATURE_P4		( 3*32+ 7) /* &quot;&quot; P4 */</span>
<span class="p_del">-#define X86_FEATURE_CONSTANT_TSC ( 3*32+ 8) /* TSC ticks at a constant rate */</span>
<span class="p_del">-#define X86_FEATURE_UP		( 3*32+ 9) /* smp kernel running on up */</span>
<span class="p_del">-#define X86_FEATURE_ART		( 3*32+10) /* Platform has always running timer (ART) */</span>
<span class="p_del">-#define X86_FEATURE_ARCH_PERFMON ( 3*32+11) /* Intel Architectural PerfMon */</span>
<span class="p_del">-#define X86_FEATURE_PEBS	( 3*32+12) /* Precise-Event Based Sampling */</span>
<span class="p_del">-#define X86_FEATURE_BTS		( 3*32+13) /* Branch Trace Store */</span>
<span class="p_del">-#define X86_FEATURE_SYSCALL32	( 3*32+14) /* &quot;&quot; syscall in ia32 userspace */</span>
<span class="p_del">-#define X86_FEATURE_SYSENTER32	( 3*32+15) /* &quot;&quot; sysenter in ia32 userspace */</span>
<span class="p_del">-#define X86_FEATURE_REP_GOOD	( 3*32+16) /* rep microcode works well */</span>
<span class="p_del">-#define X86_FEATURE_MFENCE_RDTSC ( 3*32+17) /* &quot;&quot; Mfence synchronizes RDTSC */</span>
<span class="p_del">-#define X86_FEATURE_LFENCE_RDTSC ( 3*32+18) /* &quot;&quot; Lfence synchronizes RDTSC */</span>
<span class="p_del">-#define X86_FEATURE_ACC_POWER	( 3*32+19) /* AMD Accumulated Power Mechanism */</span>
<span class="p_del">-#define X86_FEATURE_NOPL	( 3*32+20) /* The NOPL (0F 1F) instructions */</span>
<span class="p_del">-#define X86_FEATURE_ALWAYS	( 3*32+21) /* &quot;&quot; Always-present feature */</span>
<span class="p_del">-#define X86_FEATURE_XTOPOLOGY	( 3*32+22) /* cpu topology enum extensions */</span>
<span class="p_del">-#define X86_FEATURE_TSC_RELIABLE ( 3*32+23) /* TSC is known to be reliable */</span>
<span class="p_del">-#define X86_FEATURE_NONSTOP_TSC	( 3*32+24) /* TSC does not stop in C states */</span>
<span class="p_del">-#define X86_FEATURE_CPUID	( 3*32+25) /* CPU has CPUID instruction itself */</span>
<span class="p_del">-#define X86_FEATURE_EXTD_APICID	( 3*32+26) /* has extended APICID (8 bits) */</span>
<span class="p_del">-#define X86_FEATURE_AMD_DCM     ( 3*32+27) /* multi-node processor */</span>
<span class="p_del">-#define X86_FEATURE_APERFMPERF	( 3*32+28) /* APERFMPERF */</span>
<span class="p_del">-#define X86_FEATURE_NONSTOP_TSC_S3 ( 3*32+30) /* TSC doesn&#39;t stop in S3 state */</span>
<span class="p_del">-#define X86_FEATURE_TSC_KNOWN_FREQ ( 3*32+31) /* TSC has known frequency */</span>
<span class="p_add">+#define X86_FEATURE_CXMMX		( 3*32+ 0) /* Cyrix MMX extensions */</span>
<span class="p_add">+#define X86_FEATURE_K6_MTRR		( 3*32+ 1) /* AMD K6 nonstandard MTRRs */</span>
<span class="p_add">+#define X86_FEATURE_CYRIX_ARR		( 3*32+ 2) /* Cyrix ARRs (= MTRRs) */</span>
<span class="p_add">+#define X86_FEATURE_CENTAUR_MCR		( 3*32+ 3) /* Centaur MCRs (= MTRRs) */</span>
<span class="p_add">+</span>
<span class="p_add">+/* CPU types for specific tunings: */</span>
<span class="p_add">+#define X86_FEATURE_K8			( 3*32+ 4) /* &quot;&quot; Opteron, Athlon64 */</span>
<span class="p_add">+#define X86_FEATURE_K7			( 3*32+ 5) /* &quot;&quot; Athlon */</span>
<span class="p_add">+#define X86_FEATURE_P3			( 3*32+ 6) /* &quot;&quot; P3 */</span>
<span class="p_add">+#define X86_FEATURE_P4			( 3*32+ 7) /* &quot;&quot; P4 */</span>
<span class="p_add">+#define X86_FEATURE_CONSTANT_TSC	( 3*32+ 8) /* TSC ticks at a constant rate */</span>
<span class="p_add">+#define X86_FEATURE_UP			( 3*32+ 9) /* SMP kernel running on UP */</span>
<span class="p_add">+#define X86_FEATURE_ART			( 3*32+10) /* Always running timer (ART) */</span>
<span class="p_add">+#define X86_FEATURE_ARCH_PERFMON	( 3*32+11) /* Intel Architectural PerfMon */</span>
<span class="p_add">+#define X86_FEATURE_PEBS		( 3*32+12) /* Precise-Event Based Sampling */</span>
<span class="p_add">+#define X86_FEATURE_BTS			( 3*32+13) /* Branch Trace Store */</span>
<span class="p_add">+#define X86_FEATURE_SYSCALL32		( 3*32+14) /* &quot;&quot; syscall in IA32 userspace */</span>
<span class="p_add">+#define X86_FEATURE_SYSENTER32		( 3*32+15) /* &quot;&quot; sysenter in IA32 userspace */</span>
<span class="p_add">+#define X86_FEATURE_REP_GOOD		( 3*32+16) /* REP microcode works well */</span>
<span class="p_add">+#define X86_FEATURE_MFENCE_RDTSC	( 3*32+17) /* &quot;&quot; MFENCE synchronizes RDTSC */</span>
<span class="p_add">+#define X86_FEATURE_LFENCE_RDTSC	( 3*32+18) /* &quot;&quot; LFENCE synchronizes RDTSC */</span>
<span class="p_add">+#define X86_FEATURE_ACC_POWER		( 3*32+19) /* AMD Accumulated Power Mechanism */</span>
<span class="p_add">+#define X86_FEATURE_NOPL		( 3*32+20) /* The NOPL (0F 1F) instructions */</span>
<span class="p_add">+#define X86_FEATURE_ALWAYS		( 3*32+21) /* &quot;&quot; Always-present feature */</span>
<span class="p_add">+#define X86_FEATURE_XTOPOLOGY		( 3*32+22) /* CPU topology enum extensions */</span>
<span class="p_add">+#define X86_FEATURE_TSC_RELIABLE	( 3*32+23) /* TSC is known to be reliable */</span>
<span class="p_add">+#define X86_FEATURE_NONSTOP_TSC		( 3*32+24) /* TSC does not stop in C states */</span>
<span class="p_add">+#define X86_FEATURE_CPUID		( 3*32+25) /* CPU has CPUID instruction itself */</span>
<span class="p_add">+#define X86_FEATURE_EXTD_APICID		( 3*32+26) /* Extended APICID (8 bits) */</span>
<span class="p_add">+#define X86_FEATURE_AMD_DCM		( 3*32+27) /* AMD multi-node processor */</span>
<span class="p_add">+#define X86_FEATURE_APERFMPERF		( 3*32+28) /* P-State hardware coordination feedback capability (APERF/MPERF MSRs) */</span>
<span class="p_add">+#define X86_FEATURE_NONSTOP_TSC_S3	( 3*32+30) /* TSC doesn&#39;t stop in S3 state */</span>
<span class="p_add">+#define X86_FEATURE_TSC_KNOWN_FREQ	( 3*32+31) /* TSC has known frequency */</span>
 
<span class="p_del">-/* Intel-defined CPU features, CPUID level 0x00000001 (ecx), word 4 */</span>
<span class="p_del">-#define X86_FEATURE_XMM3	( 4*32+ 0) /* &quot;pni&quot; SSE-3 */</span>
<span class="p_del">-#define X86_FEATURE_PCLMULQDQ	( 4*32+ 1) /* PCLMULQDQ instruction */</span>
<span class="p_del">-#define X86_FEATURE_DTES64	( 4*32+ 2) /* 64-bit Debug Store */</span>
<span class="p_del">-#define X86_FEATURE_MWAIT	( 4*32+ 3) /* &quot;monitor&quot; Monitor/Mwait support */</span>
<span class="p_del">-#define X86_FEATURE_DSCPL	( 4*32+ 4) /* &quot;ds_cpl&quot; CPL Qual. Debug Store */</span>
<span class="p_del">-#define X86_FEATURE_VMX		( 4*32+ 5) /* Hardware virtualization */</span>
<span class="p_del">-#define X86_FEATURE_SMX		( 4*32+ 6) /* Safer mode */</span>
<span class="p_del">-#define X86_FEATURE_EST		( 4*32+ 7) /* Enhanced SpeedStep */</span>
<span class="p_del">-#define X86_FEATURE_TM2		( 4*32+ 8) /* Thermal Monitor 2 */</span>
<span class="p_del">-#define X86_FEATURE_SSSE3	( 4*32+ 9) /* Supplemental SSE-3 */</span>
<span class="p_del">-#define X86_FEATURE_CID		( 4*32+10) /* Context ID */</span>
<span class="p_del">-#define X86_FEATURE_SDBG	( 4*32+11) /* Silicon Debug */</span>
<span class="p_del">-#define X86_FEATURE_FMA		( 4*32+12) /* Fused multiply-add */</span>
<span class="p_del">-#define X86_FEATURE_CX16	( 4*32+13) /* CMPXCHG16B */</span>
<span class="p_del">-#define X86_FEATURE_XTPR	( 4*32+14) /* Send Task Priority Messages */</span>
<span class="p_del">-#define X86_FEATURE_PDCM	( 4*32+15) /* Performance Capabilities */</span>
<span class="p_del">-#define X86_FEATURE_PCID	( 4*32+17) /* Process Context Identifiers */</span>
<span class="p_del">-#define X86_FEATURE_DCA		( 4*32+18) /* Direct Cache Access */</span>
<span class="p_del">-#define X86_FEATURE_XMM4_1	( 4*32+19) /* &quot;sse4_1&quot; SSE-4.1 */</span>
<span class="p_del">-#define X86_FEATURE_XMM4_2	( 4*32+20) /* &quot;sse4_2&quot; SSE-4.2 */</span>
<span class="p_del">-#define X86_FEATURE_X2APIC	( 4*32+21) /* x2APIC */</span>
<span class="p_del">-#define X86_FEATURE_MOVBE	( 4*32+22) /* MOVBE instruction */</span>
<span class="p_del">-#define X86_FEATURE_POPCNT      ( 4*32+23) /* POPCNT instruction */</span>
<span class="p_del">-#define X86_FEATURE_TSC_DEADLINE_TIMER	( 4*32+24) /* Tsc deadline timer */</span>
<span class="p_del">-#define X86_FEATURE_AES		( 4*32+25) /* AES instructions */</span>
<span class="p_del">-#define X86_FEATURE_XSAVE	( 4*32+26) /* XSAVE/XRSTOR/XSETBV/XGETBV */</span>
<span class="p_del">-#define X86_FEATURE_OSXSAVE	( 4*32+27) /* &quot;&quot; XSAVE enabled in the OS */</span>
<span class="p_del">-#define X86_FEATURE_AVX		( 4*32+28) /* Advanced Vector Extensions */</span>
<span class="p_del">-#define X86_FEATURE_F16C	( 4*32+29) /* 16-bit fp conversions */</span>
<span class="p_del">-#define X86_FEATURE_RDRAND	( 4*32+30) /* The RDRAND instruction */</span>
<span class="p_del">-#define X86_FEATURE_HYPERVISOR	( 4*32+31) /* Running on a hypervisor */</span>
<span class="p_add">+/* Intel-defined CPU features, CPUID level 0x00000001 (ECX), word 4 */</span>
<span class="p_add">+#define X86_FEATURE_XMM3		( 4*32+ 0) /* &quot;pni&quot; SSE-3 */</span>
<span class="p_add">+#define X86_FEATURE_PCLMULQDQ		( 4*32+ 1) /* PCLMULQDQ instruction */</span>
<span class="p_add">+#define X86_FEATURE_DTES64		( 4*32+ 2) /* 64-bit Debug Store */</span>
<span class="p_add">+#define X86_FEATURE_MWAIT		( 4*32+ 3) /* &quot;monitor&quot; MONITOR/MWAIT support */</span>
<span class="p_add">+#define X86_FEATURE_DSCPL		( 4*32+ 4) /* &quot;ds_cpl&quot; CPL-qualified (filtered) Debug Store */</span>
<span class="p_add">+#define X86_FEATURE_VMX			( 4*32+ 5) /* Hardware virtualization */</span>
<span class="p_add">+#define X86_FEATURE_SMX			( 4*32+ 6) /* Safer Mode eXtensions */</span>
<span class="p_add">+#define X86_FEATURE_EST			( 4*32+ 7) /* Enhanced SpeedStep */</span>
<span class="p_add">+#define X86_FEATURE_TM2			( 4*32+ 8) /* Thermal Monitor 2 */</span>
<span class="p_add">+#define X86_FEATURE_SSSE3		( 4*32+ 9) /* Supplemental SSE-3 */</span>
<span class="p_add">+#define X86_FEATURE_CID			( 4*32+10) /* Context ID */</span>
<span class="p_add">+#define X86_FEATURE_SDBG		( 4*32+11) /* Silicon Debug */</span>
<span class="p_add">+#define X86_FEATURE_FMA			( 4*32+12) /* Fused multiply-add */</span>
<span class="p_add">+#define X86_FEATURE_CX16		( 4*32+13) /* CMPXCHG16B instruction */</span>
<span class="p_add">+#define X86_FEATURE_XTPR		( 4*32+14) /* Send Task Priority Messages */</span>
<span class="p_add">+#define X86_FEATURE_PDCM		( 4*32+15) /* Perf/Debug Capabilities MSR */</span>
<span class="p_add">+#define X86_FEATURE_PCID		( 4*32+17) /* Process Context Identifiers */</span>
<span class="p_add">+#define X86_FEATURE_DCA			( 4*32+18) /* Direct Cache Access */</span>
<span class="p_add">+#define X86_FEATURE_XMM4_1		( 4*32+19) /* &quot;sse4_1&quot; SSE-4.1 */</span>
<span class="p_add">+#define X86_FEATURE_XMM4_2		( 4*32+20) /* &quot;sse4_2&quot; SSE-4.2 */</span>
<span class="p_add">+#define X86_FEATURE_X2APIC		( 4*32+21) /* X2APIC */</span>
<span class="p_add">+#define X86_FEATURE_MOVBE		( 4*32+22) /* MOVBE instruction */</span>
<span class="p_add">+#define X86_FEATURE_POPCNT		( 4*32+23) /* POPCNT instruction */</span>
<span class="p_add">+#define X86_FEATURE_TSC_DEADLINE_TIMER	( 4*32+24) /* TSC deadline timer */</span>
<span class="p_add">+#define X86_FEATURE_AES			( 4*32+25) /* AES instructions */</span>
<span class="p_add">+#define X86_FEATURE_XSAVE		( 4*32+26) /* XSAVE/XRSTOR/XSETBV/XGETBV instructions */</span>
<span class="p_add">+#define X86_FEATURE_OSXSAVE		( 4*32+27) /* &quot;&quot; XSAVE instruction enabled in the OS */</span>
<span class="p_add">+#define X86_FEATURE_AVX			( 4*32+28) /* Advanced Vector Extensions */</span>
<span class="p_add">+#define X86_FEATURE_F16C		( 4*32+29) /* 16-bit FP conversions */</span>
<span class="p_add">+#define X86_FEATURE_RDRAND		( 4*32+30) /* RDRAND instruction */</span>
<span class="p_add">+#define X86_FEATURE_HYPERVISOR		( 4*32+31) /* Running on a hypervisor */</span>
 
 /* VIA/Cyrix/Centaur-defined CPU features, CPUID level 0xC0000001, word 5 */
<span class="p_del">-#define X86_FEATURE_XSTORE	( 5*32+ 2) /* &quot;rng&quot; RNG present (xstore) */</span>
<span class="p_del">-#define X86_FEATURE_XSTORE_EN	( 5*32+ 3) /* &quot;rng_en&quot; RNG enabled */</span>
<span class="p_del">-#define X86_FEATURE_XCRYPT	( 5*32+ 6) /* &quot;ace&quot; on-CPU crypto (xcrypt) */</span>
<span class="p_del">-#define X86_FEATURE_XCRYPT_EN	( 5*32+ 7) /* &quot;ace_en&quot; on-CPU crypto enabled */</span>
<span class="p_del">-#define X86_FEATURE_ACE2	( 5*32+ 8) /* Advanced Cryptography Engine v2 */</span>
<span class="p_del">-#define X86_FEATURE_ACE2_EN	( 5*32+ 9) /* ACE v2 enabled */</span>
<span class="p_del">-#define X86_FEATURE_PHE		( 5*32+10) /* PadLock Hash Engine */</span>
<span class="p_del">-#define X86_FEATURE_PHE_EN	( 5*32+11) /* PHE enabled */</span>
<span class="p_del">-#define X86_FEATURE_PMM		( 5*32+12) /* PadLock Montgomery Multiplier */</span>
<span class="p_del">-#define X86_FEATURE_PMM_EN	( 5*32+13) /* PMM enabled */</span>
<span class="p_add">+#define X86_FEATURE_XSTORE		( 5*32+ 2) /* &quot;rng&quot; RNG present (xstore) */</span>
<span class="p_add">+#define X86_FEATURE_XSTORE_EN		( 5*32+ 3) /* &quot;rng_en&quot; RNG enabled */</span>
<span class="p_add">+#define X86_FEATURE_XCRYPT		( 5*32+ 6) /* &quot;ace&quot; on-CPU crypto (xcrypt) */</span>
<span class="p_add">+#define X86_FEATURE_XCRYPT_EN		( 5*32+ 7) /* &quot;ace_en&quot; on-CPU crypto enabled */</span>
<span class="p_add">+#define X86_FEATURE_ACE2		( 5*32+ 8) /* Advanced Cryptography Engine v2 */</span>
<span class="p_add">+#define X86_FEATURE_ACE2_EN		( 5*32+ 9) /* ACE v2 enabled */</span>
<span class="p_add">+#define X86_FEATURE_PHE			( 5*32+10) /* PadLock Hash Engine */</span>
<span class="p_add">+#define X86_FEATURE_PHE_EN		( 5*32+11) /* PHE enabled */</span>
<span class="p_add">+#define X86_FEATURE_PMM			( 5*32+12) /* PadLock Montgomery Multiplier */</span>
<span class="p_add">+#define X86_FEATURE_PMM_EN		( 5*32+13) /* PMM enabled */</span>
 
<span class="p_del">-/* More extended AMD flags: CPUID level 0x80000001, ecx, word 6 */</span>
<span class="p_del">-#define X86_FEATURE_LAHF_LM	( 6*32+ 0) /* LAHF/SAHF in long mode */</span>
<span class="p_del">-#define X86_FEATURE_CMP_LEGACY	( 6*32+ 1) /* If yes HyperThreading not valid */</span>
<span class="p_del">-#define X86_FEATURE_SVM		( 6*32+ 2) /* Secure virtual machine */</span>
<span class="p_del">-#define X86_FEATURE_EXTAPIC	( 6*32+ 3) /* Extended APIC space */</span>
<span class="p_del">-#define X86_FEATURE_CR8_LEGACY	( 6*32+ 4) /* CR8 in 32-bit mode */</span>
<span class="p_del">-#define X86_FEATURE_ABM		( 6*32+ 5) /* Advanced bit manipulation */</span>
<span class="p_del">-#define X86_FEATURE_SSE4A	( 6*32+ 6) /* SSE-4A */</span>
<span class="p_del">-#define X86_FEATURE_MISALIGNSSE ( 6*32+ 7) /* Misaligned SSE mode */</span>
<span class="p_del">-#define X86_FEATURE_3DNOWPREFETCH ( 6*32+ 8) /* 3DNow prefetch instructions */</span>
<span class="p_del">-#define X86_FEATURE_OSVW	( 6*32+ 9) /* OS Visible Workaround */</span>
<span class="p_del">-#define X86_FEATURE_IBS		( 6*32+10) /* Instruction Based Sampling */</span>
<span class="p_del">-#define X86_FEATURE_XOP		( 6*32+11) /* extended AVX instructions */</span>
<span class="p_del">-#define X86_FEATURE_SKINIT	( 6*32+12) /* SKINIT/STGI instructions */</span>
<span class="p_del">-#define X86_FEATURE_WDT		( 6*32+13) /* Watchdog timer */</span>
<span class="p_del">-#define X86_FEATURE_LWP		( 6*32+15) /* Light Weight Profiling */</span>
<span class="p_del">-#define X86_FEATURE_FMA4	( 6*32+16) /* 4 operands MAC instructions */</span>
<span class="p_del">-#define X86_FEATURE_TCE		( 6*32+17) /* translation cache extension */</span>
<span class="p_del">-#define X86_FEATURE_NODEID_MSR	( 6*32+19) /* NodeId MSR */</span>
<span class="p_del">-#define X86_FEATURE_TBM		( 6*32+21) /* trailing bit manipulations */</span>
<span class="p_del">-#define X86_FEATURE_TOPOEXT	( 6*32+22) /* topology extensions CPUID leafs */</span>
<span class="p_del">-#define X86_FEATURE_PERFCTR_CORE ( 6*32+23) /* core performance counter extensions */</span>
<span class="p_del">-#define X86_FEATURE_PERFCTR_NB  ( 6*32+24) /* NB performance counter extensions */</span>
<span class="p_del">-#define X86_FEATURE_BPEXT	(6*32+26) /* data breakpoint extension */</span>
<span class="p_del">-#define X86_FEATURE_PTSC	( 6*32+27) /* performance time-stamp counter */</span>
<span class="p_del">-#define X86_FEATURE_PERFCTR_LLC	( 6*32+28) /* Last Level Cache performance counter extensions */</span>
<span class="p_del">-#define X86_FEATURE_MWAITX	( 6*32+29) /* MWAIT extension (MONITORX/MWAITX) */</span>
<span class="p_add">+/* More extended AMD flags: CPUID level 0x80000001, ECX, word 6 */</span>
<span class="p_add">+#define X86_FEATURE_LAHF_LM		( 6*32+ 0) /* LAHF/SAHF in long mode */</span>
<span class="p_add">+#define X86_FEATURE_CMP_LEGACY		( 6*32+ 1) /* If yes HyperThreading not valid */</span>
<span class="p_add">+#define X86_FEATURE_SVM			( 6*32+ 2) /* Secure Virtual Machine */</span>
<span class="p_add">+#define X86_FEATURE_EXTAPIC		( 6*32+ 3) /* Extended APIC space */</span>
<span class="p_add">+#define X86_FEATURE_CR8_LEGACY		( 6*32+ 4) /* CR8 in 32-bit mode */</span>
<span class="p_add">+#define X86_FEATURE_ABM			( 6*32+ 5) /* Advanced bit manipulation */</span>
<span class="p_add">+#define X86_FEATURE_SSE4A		( 6*32+ 6) /* SSE-4A */</span>
<span class="p_add">+#define X86_FEATURE_MISALIGNSSE		( 6*32+ 7) /* Misaligned SSE mode */</span>
<span class="p_add">+#define X86_FEATURE_3DNOWPREFETCH	( 6*32+ 8) /* 3DNow prefetch instructions */</span>
<span class="p_add">+#define X86_FEATURE_OSVW		( 6*32+ 9) /* OS Visible Workaround */</span>
<span class="p_add">+#define X86_FEATURE_IBS			( 6*32+10) /* Instruction Based Sampling */</span>
<span class="p_add">+#define X86_FEATURE_XOP			( 6*32+11) /* extended AVX instructions */</span>
<span class="p_add">+#define X86_FEATURE_SKINIT		( 6*32+12) /* SKINIT/STGI instructions */</span>
<span class="p_add">+#define X86_FEATURE_WDT			( 6*32+13) /* Watchdog timer */</span>
<span class="p_add">+#define X86_FEATURE_LWP			( 6*32+15) /* Light Weight Profiling */</span>
<span class="p_add">+#define X86_FEATURE_FMA4		( 6*32+16) /* 4 operands MAC instructions */</span>
<span class="p_add">+#define X86_FEATURE_TCE			( 6*32+17) /* Translation Cache Extension */</span>
<span class="p_add">+#define X86_FEATURE_NODEID_MSR		( 6*32+19) /* NodeId MSR */</span>
<span class="p_add">+#define X86_FEATURE_TBM			( 6*32+21) /* Trailing Bit Manipulations */</span>
<span class="p_add">+#define X86_FEATURE_TOPOEXT		( 6*32+22) /* Topology extensions CPUID leafs */</span>
<span class="p_add">+#define X86_FEATURE_PERFCTR_CORE	( 6*32+23) /* Core performance counter extensions */</span>
<span class="p_add">+#define X86_FEATURE_PERFCTR_NB		( 6*32+24) /* NB performance counter extensions */</span>
<span class="p_add">+#define X86_FEATURE_BPEXT		( 6*32+26) /* Data breakpoint extension */</span>
<span class="p_add">+#define X86_FEATURE_PTSC		( 6*32+27) /* Performance time-stamp counter */</span>
<span class="p_add">+#define X86_FEATURE_PERFCTR_LLC		( 6*32+28) /* Last Level Cache performance counter extensions */</span>
<span class="p_add">+#define X86_FEATURE_MWAITX		( 6*32+29) /* MWAIT extension (MONITORX/MWAITX instructions) */</span>
 
 /*
  * Auxiliary flags: Linux defined - For features scattered in various
<span class="p_chunk">@@ -187,146 +190,154 @@</span> <span class="p_context"></span>
  *
  * Reuse free bits when adding new feature flags!
  */
<span class="p_del">-#define X86_FEATURE_RING3MWAIT	( 7*32+ 0) /* Ring 3 MONITOR/MWAIT */</span>
<span class="p_del">-#define X86_FEATURE_CPUID_FAULT ( 7*32+ 1) /* Intel CPUID faulting */</span>
<span class="p_del">-#define X86_FEATURE_CPB		( 7*32+ 2) /* AMD Core Performance Boost */</span>
<span class="p_del">-#define X86_FEATURE_EPB		( 7*32+ 3) /* IA32_ENERGY_PERF_BIAS support */</span>
<span class="p_del">-#define X86_FEATURE_CAT_L3	( 7*32+ 4) /* Cache Allocation Technology L3 */</span>
<span class="p_del">-#define X86_FEATURE_CAT_L2	( 7*32+ 5) /* Cache Allocation Technology L2 */</span>
<span class="p_del">-#define X86_FEATURE_CDP_L3	( 7*32+ 6) /* Code and Data Prioritization L3 */</span>
<span class="p_add">+#define X86_FEATURE_RING3MWAIT		( 7*32+ 0) /* Ring 3 MONITOR/MWAIT instructions */</span>
<span class="p_add">+#define X86_FEATURE_CPUID_FAULT		( 7*32+ 1) /* Intel CPUID faulting */</span>
<span class="p_add">+#define X86_FEATURE_CPB			( 7*32+ 2) /* AMD Core Performance Boost */</span>
<span class="p_add">+#define X86_FEATURE_EPB			( 7*32+ 3) /* IA32_ENERGY_PERF_BIAS support */</span>
<span class="p_add">+#define X86_FEATURE_CAT_L3		( 7*32+ 4) /* Cache Allocation Technology L3 */</span>
<span class="p_add">+#define X86_FEATURE_CAT_L2		( 7*32+ 5) /* Cache Allocation Technology L2 */</span>
<span class="p_add">+#define X86_FEATURE_CDP_L3		( 7*32+ 6) /* Code and Data Prioritization L3 */</span>
 
<span class="p_del">-#define X86_FEATURE_HW_PSTATE	( 7*32+ 8) /* AMD HW-PState */</span>
<span class="p_del">-#define X86_FEATURE_PROC_FEEDBACK ( 7*32+ 9) /* AMD ProcFeedbackInterface */</span>
<span class="p_del">-#define X86_FEATURE_SME		( 7*32+10) /* AMD Secure Memory Encryption */</span>
<span class="p_add">+#define X86_FEATURE_HW_PSTATE		( 7*32+ 8) /* AMD HW-PState */</span>
<span class="p_add">+#define X86_FEATURE_PROC_FEEDBACK	( 7*32+ 9) /* AMD ProcFeedbackInterface */</span>
<span class="p_add">+#define X86_FEATURE_SME			( 7*32+10) /* AMD Secure Memory Encryption */</span>
 
<span class="p_del">-#define X86_FEATURE_INTEL_PPIN	( 7*32+14) /* Intel Processor Inventory Number */</span>
<span class="p_del">-#define X86_FEATURE_INTEL_PT	( 7*32+15) /* Intel Processor Trace */</span>
<span class="p_del">-#define X86_FEATURE_AVX512_4VNNIW (7*32+16) /* AVX-512 Neural Network Instructions */</span>
<span class="p_del">-#define X86_FEATURE_AVX512_4FMAPS (7*32+17) /* AVX-512 Multiply Accumulation Single precision */</span>
<span class="p_add">+#define X86_FEATURE_INTEL_PPIN		( 7*32+14) /* Intel Processor Inventory Number */</span>
<span class="p_add">+#define X86_FEATURE_INTEL_PT		( 7*32+15) /* Intel Processor Trace */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_4VNNIW	( 7*32+16) /* AVX-512 Neural Network Instructions */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_4FMAPS	( 7*32+17) /* AVX-512 Multiply Accumulation Single precision */</span>
 
<span class="p_del">-#define X86_FEATURE_MBA         ( 7*32+18) /* Memory Bandwidth Allocation */</span>
<span class="p_add">+#define X86_FEATURE_MBA			( 7*32+18) /* Memory Bandwidth Allocation */</span>
 
 /* Virtualization flags: Linux defined, word 8 */
<span class="p_del">-#define X86_FEATURE_TPR_SHADOW  ( 8*32+ 0) /* Intel TPR Shadow */</span>
<span class="p_del">-#define X86_FEATURE_VNMI        ( 8*32+ 1) /* Intel Virtual NMI */</span>
<span class="p_del">-#define X86_FEATURE_FLEXPRIORITY ( 8*32+ 2) /* Intel FlexPriority */</span>
<span class="p_del">-#define X86_FEATURE_EPT         ( 8*32+ 3) /* Intel Extended Page Table */</span>
<span class="p_del">-#define X86_FEATURE_VPID        ( 8*32+ 4) /* Intel Virtual Processor ID */</span>
<span class="p_add">+#define X86_FEATURE_TPR_SHADOW		( 8*32+ 0) /* Intel TPR Shadow */</span>
<span class="p_add">+#define X86_FEATURE_VNMI		( 8*32+ 1) /* Intel Virtual NMI */</span>
<span class="p_add">+#define X86_FEATURE_FLEXPRIORITY	( 8*32+ 2) /* Intel FlexPriority */</span>
<span class="p_add">+#define X86_FEATURE_EPT			( 8*32+ 3) /* Intel Extended Page Table */</span>
<span class="p_add">+#define X86_FEATURE_VPID		( 8*32+ 4) /* Intel Virtual Processor ID */</span>
 
<span class="p_del">-#define X86_FEATURE_VMMCALL     ( 8*32+15) /* Prefer vmmcall to vmcall */</span>
<span class="p_del">-#define X86_FEATURE_XENPV       ( 8*32+16) /* &quot;&quot; Xen paravirtual guest */</span>
<span class="p_add">+#define X86_FEATURE_VMMCALL		( 8*32+15) /* Prefer VMMCALL to VMCALL */</span>
<span class="p_add">+#define X86_FEATURE_XENPV		( 8*32+16) /* &quot;&quot; Xen paravirtual guest */</span>
 
 
<span class="p_del">-/* Intel-defined CPU features, CPUID level 0x00000007:0 (ebx), word 9 */</span>
<span class="p_del">-#define X86_FEATURE_FSGSBASE	( 9*32+ 0) /* {RD/WR}{FS/GS}BASE instructions*/</span>
<span class="p_del">-#define X86_FEATURE_TSC_ADJUST	( 9*32+ 1) /* TSC adjustment MSR 0x3b */</span>
<span class="p_del">-#define X86_FEATURE_BMI1	( 9*32+ 3) /* 1st group bit manipulation extensions */</span>
<span class="p_del">-#define X86_FEATURE_HLE		( 9*32+ 4) /* Hardware Lock Elision */</span>
<span class="p_del">-#define X86_FEATURE_AVX2	( 9*32+ 5) /* AVX2 instructions */</span>
<span class="p_del">-#define X86_FEATURE_SMEP	( 9*32+ 7) /* Supervisor Mode Execution Protection */</span>
<span class="p_del">-#define X86_FEATURE_BMI2	( 9*32+ 8) /* 2nd group bit manipulation extensions */</span>
<span class="p_del">-#define X86_FEATURE_ERMS	( 9*32+ 9) /* Enhanced REP MOVSB/STOSB */</span>
<span class="p_del">-#define X86_FEATURE_INVPCID	( 9*32+10) /* Invalidate Processor Context ID */</span>
<span class="p_del">-#define X86_FEATURE_RTM		( 9*32+11) /* Restricted Transactional Memory */</span>
<span class="p_del">-#define X86_FEATURE_CQM		( 9*32+12) /* Cache QoS Monitoring */</span>
<span class="p_del">-#define X86_FEATURE_MPX		( 9*32+14) /* Memory Protection Extension */</span>
<span class="p_del">-#define X86_FEATURE_RDT_A	( 9*32+15) /* Resource Director Technology Allocation */</span>
<span class="p_del">-#define X86_FEATURE_AVX512F	( 9*32+16) /* AVX-512 Foundation */</span>
<span class="p_del">-#define X86_FEATURE_AVX512DQ	( 9*32+17) /* AVX-512 DQ (Double/Quad granular) Instructions */</span>
<span class="p_del">-#define X86_FEATURE_RDSEED	( 9*32+18) /* The RDSEED instruction */</span>
<span class="p_del">-#define X86_FEATURE_ADX		( 9*32+19) /* The ADCX and ADOX instructions */</span>
<span class="p_del">-#define X86_FEATURE_SMAP	( 9*32+20) /* Supervisor Mode Access Prevention */</span>
<span class="p_del">-#define X86_FEATURE_AVX512IFMA  ( 9*32+21) /* AVX-512 Integer Fused Multiply-Add instructions */</span>
<span class="p_del">-#define X86_FEATURE_CLFLUSHOPT	( 9*32+23) /* CLFLUSHOPT instruction */</span>
<span class="p_del">-#define X86_FEATURE_CLWB	( 9*32+24) /* CLWB instruction */</span>
<span class="p_del">-#define X86_FEATURE_AVX512PF	( 9*32+26) /* AVX-512 Prefetch */</span>
<span class="p_del">-#define X86_FEATURE_AVX512ER	( 9*32+27) /* AVX-512 Exponential and Reciprocal */</span>
<span class="p_del">-#define X86_FEATURE_AVX512CD	( 9*32+28) /* AVX-512 Conflict Detection */</span>
<span class="p_del">-#define X86_FEATURE_SHA_NI	( 9*32+29) /* SHA1/SHA256 Instruction Extensions */</span>
<span class="p_del">-#define X86_FEATURE_AVX512BW	( 9*32+30) /* AVX-512 BW (Byte/Word granular) Instructions */</span>
<span class="p_del">-#define X86_FEATURE_AVX512VL	( 9*32+31) /* AVX-512 VL (128/256 Vector Length) Extensions */</span>
<span class="p_add">+/* Intel-defined CPU features, CPUID level 0x00000007:0 (EBX), word 9 */</span>
<span class="p_add">+#define X86_FEATURE_FSGSBASE		( 9*32+ 0) /* RDFSBASE, WRFSBASE, RDGSBASE, WRGSBASE instructions*/</span>
<span class="p_add">+#define X86_FEATURE_TSC_ADJUST		( 9*32+ 1) /* TSC adjustment MSR 0x3B */</span>
<span class="p_add">+#define X86_FEATURE_BMI1		( 9*32+ 3) /* 1st group bit manipulation extensions */</span>
<span class="p_add">+#define X86_FEATURE_HLE			( 9*32+ 4) /* Hardware Lock Elision */</span>
<span class="p_add">+#define X86_FEATURE_AVX2		( 9*32+ 5) /* AVX2 instructions */</span>
<span class="p_add">+#define X86_FEATURE_SMEP		( 9*32+ 7) /* Supervisor Mode Execution Protection */</span>
<span class="p_add">+#define X86_FEATURE_BMI2		( 9*32+ 8) /* 2nd group bit manipulation extensions */</span>
<span class="p_add">+#define X86_FEATURE_ERMS		( 9*32+ 9) /* Enhanced REP MOVSB/STOSB instructions */</span>
<span class="p_add">+#define X86_FEATURE_INVPCID		( 9*32+10) /* Invalidate Processor Context ID */</span>
<span class="p_add">+#define X86_FEATURE_RTM			( 9*32+11) /* Restricted Transactional Memory */</span>
<span class="p_add">+#define X86_FEATURE_CQM			( 9*32+12) /* Cache QoS Monitoring */</span>
<span class="p_add">+#define X86_FEATURE_MPX			( 9*32+14) /* Memory Protection Extension */</span>
<span class="p_add">+#define X86_FEATURE_RDT_A		( 9*32+15) /* Resource Director Technology Allocation */</span>
<span class="p_add">+#define X86_FEATURE_AVX512F		( 9*32+16) /* AVX-512 Foundation */</span>
<span class="p_add">+#define X86_FEATURE_AVX512DQ		( 9*32+17) /* AVX-512 DQ (Double/Quad granular) Instructions */</span>
<span class="p_add">+#define X86_FEATURE_RDSEED		( 9*32+18) /* RDSEED instruction */</span>
<span class="p_add">+#define X86_FEATURE_ADX			( 9*32+19) /* ADCX and ADOX instructions */</span>
<span class="p_add">+#define X86_FEATURE_SMAP		( 9*32+20) /* Supervisor Mode Access Prevention */</span>
<span class="p_add">+#define X86_FEATURE_AVX512IFMA		( 9*32+21) /* AVX-512 Integer Fused Multiply-Add instructions */</span>
<span class="p_add">+#define X86_FEATURE_CLFLUSHOPT		( 9*32+23) /* CLFLUSHOPT instruction */</span>
<span class="p_add">+#define X86_FEATURE_CLWB		( 9*32+24) /* CLWB instruction */</span>
<span class="p_add">+#define X86_FEATURE_AVX512PF		( 9*32+26) /* AVX-512 Prefetch */</span>
<span class="p_add">+#define X86_FEATURE_AVX512ER		( 9*32+27) /* AVX-512 Exponential and Reciprocal */</span>
<span class="p_add">+#define X86_FEATURE_AVX512CD		( 9*32+28) /* AVX-512 Conflict Detection */</span>
<span class="p_add">+#define X86_FEATURE_SHA_NI		( 9*32+29) /* SHA1/SHA256 Instruction Extensions */</span>
<span class="p_add">+#define X86_FEATURE_AVX512BW		( 9*32+30) /* AVX-512 BW (Byte/Word granular) Instructions */</span>
<span class="p_add">+#define X86_FEATURE_AVX512VL		( 9*32+31) /* AVX-512 VL (128/256 Vector Length) Extensions */</span>
 
<span class="p_del">-/* Extended state features, CPUID level 0x0000000d:1 (eax), word 10 */</span>
<span class="p_del">-#define X86_FEATURE_XSAVEOPT	(10*32+ 0) /* XSAVEOPT */</span>
<span class="p_del">-#define X86_FEATURE_XSAVEC	(10*32+ 1) /* XSAVEC */</span>
<span class="p_del">-#define X86_FEATURE_XGETBV1	(10*32+ 2) /* XGETBV with ECX = 1 */</span>
<span class="p_del">-#define X86_FEATURE_XSAVES	(10*32+ 3) /* XSAVES/XRSTORS */</span>
<span class="p_add">+/* Extended state features, CPUID level 0x0000000d:1 (EAX), word 10 */</span>
<span class="p_add">+#define X86_FEATURE_XSAVEOPT		(10*32+ 0) /* XSAVEOPT instruction */</span>
<span class="p_add">+#define X86_FEATURE_XSAVEC		(10*32+ 1) /* XSAVEC instruction */</span>
<span class="p_add">+#define X86_FEATURE_XGETBV1		(10*32+ 2) /* XGETBV with ECX = 1 instruction */</span>
<span class="p_add">+#define X86_FEATURE_XSAVES		(10*32+ 3) /* XSAVES/XRSTORS instructions */</span>
 
<span class="p_del">-/* Intel-defined CPU QoS Sub-leaf, CPUID level 0x0000000F:0 (edx), word 11 */</span>
<span class="p_del">-#define X86_FEATURE_CQM_LLC	(11*32+ 1) /* LLC QoS if 1 */</span>
<span class="p_add">+/* Intel-defined CPU QoS Sub-leaf, CPUID level 0x0000000F:0 (EDX), word 11 */</span>
<span class="p_add">+#define X86_FEATURE_CQM_LLC		(11*32+ 1) /* LLC QoS if 1 */</span>
 
<span class="p_del">-/* Intel-defined CPU QoS Sub-leaf, CPUID level 0x0000000F:1 (edx), word 12 */</span>
<span class="p_del">-#define X86_FEATURE_CQM_OCCUP_LLC (12*32+ 0) /* LLC occupancy monitoring if 1 */</span>
<span class="p_del">-#define X86_FEATURE_CQM_MBM_TOTAL (12*32+ 1) /* LLC Total MBM monitoring */</span>
<span class="p_del">-#define X86_FEATURE_CQM_MBM_LOCAL (12*32+ 2) /* LLC Local MBM monitoring */</span>
<span class="p_add">+/* Intel-defined CPU QoS Sub-leaf, CPUID level 0x0000000F:1 (EDX), word 12 */</span>
<span class="p_add">+#define X86_FEATURE_CQM_OCCUP_LLC	(12*32+ 0) /* LLC occupancy monitoring */</span>
<span class="p_add">+#define X86_FEATURE_CQM_MBM_TOTAL	(12*32+ 1) /* LLC Total MBM monitoring */</span>
<span class="p_add">+#define X86_FEATURE_CQM_MBM_LOCAL	(12*32+ 2) /* LLC Local MBM monitoring */</span>
 
<span class="p_del">-/* AMD-defined CPU features, CPUID level 0x80000008 (ebx), word 13 */</span>
<span class="p_del">-#define X86_FEATURE_CLZERO	(13*32+0) /* CLZERO instruction */</span>
<span class="p_del">-#define X86_FEATURE_IRPERF	(13*32+1) /* Instructions Retired Count */</span>
<span class="p_add">+/* AMD-defined CPU features, CPUID level 0x80000008 (EBX), word 13 */</span>
<span class="p_add">+#define X86_FEATURE_CLZERO		(13*32+ 0) /* CLZERO instruction */</span>
<span class="p_add">+#define X86_FEATURE_IRPERF		(13*32+ 1) /* Instructions Retired Count */</span>
 
<span class="p_del">-/* Thermal and Power Management Leaf, CPUID level 0x00000006 (eax), word 14 */</span>
<span class="p_del">-#define X86_FEATURE_DTHERM	(14*32+ 0) /* Digital Thermal Sensor */</span>
<span class="p_del">-#define X86_FEATURE_IDA		(14*32+ 1) /* Intel Dynamic Acceleration */</span>
<span class="p_del">-#define X86_FEATURE_ARAT	(14*32+ 2) /* Always Running APIC Timer */</span>
<span class="p_del">-#define X86_FEATURE_PLN		(14*32+ 4) /* Intel Power Limit Notification */</span>
<span class="p_del">-#define X86_FEATURE_PTS		(14*32+ 6) /* Intel Package Thermal Status */</span>
<span class="p_del">-#define X86_FEATURE_HWP		(14*32+ 7) /* Intel Hardware P-states */</span>
<span class="p_del">-#define X86_FEATURE_HWP_NOTIFY	(14*32+ 8) /* HWP Notification */</span>
<span class="p_del">-#define X86_FEATURE_HWP_ACT_WINDOW (14*32+ 9) /* HWP Activity Window */</span>
<span class="p_del">-#define X86_FEATURE_HWP_EPP	(14*32+10) /* HWP Energy Perf. Preference */</span>
<span class="p_del">-#define X86_FEATURE_HWP_PKG_REQ (14*32+11) /* HWP Package Level Request */</span>
<span class="p_add">+/* Thermal and Power Management Leaf, CPUID level 0x00000006 (EAX), word 14 */</span>
<span class="p_add">+#define X86_FEATURE_DTHERM		(14*32+ 0) /* Digital Thermal Sensor */</span>
<span class="p_add">+#define X86_FEATURE_IDA			(14*32+ 1) /* Intel Dynamic Acceleration */</span>
<span class="p_add">+#define X86_FEATURE_ARAT		(14*32+ 2) /* Always Running APIC Timer */</span>
<span class="p_add">+#define X86_FEATURE_PLN			(14*32+ 4) /* Intel Power Limit Notification */</span>
<span class="p_add">+#define X86_FEATURE_PTS			(14*32+ 6) /* Intel Package Thermal Status */</span>
<span class="p_add">+#define X86_FEATURE_HWP			(14*32+ 7) /* Intel Hardware P-states */</span>
<span class="p_add">+#define X86_FEATURE_HWP_NOTIFY		(14*32+ 8) /* HWP Notification */</span>
<span class="p_add">+#define X86_FEATURE_HWP_ACT_WINDOW	(14*32+ 9) /* HWP Activity Window */</span>
<span class="p_add">+#define X86_FEATURE_HWP_EPP		(14*32+10) /* HWP Energy Perf. Preference */</span>
<span class="p_add">+#define X86_FEATURE_HWP_PKG_REQ		(14*32+11) /* HWP Package Level Request */</span>
 
<span class="p_del">-/* AMD SVM Feature Identification, CPUID level 0x8000000a (edx), word 15 */</span>
<span class="p_del">-#define X86_FEATURE_NPT		(15*32+ 0) /* Nested Page Table support */</span>
<span class="p_del">-#define X86_FEATURE_LBRV	(15*32+ 1) /* LBR Virtualization support */</span>
<span class="p_del">-#define X86_FEATURE_SVML	(15*32+ 2) /* &quot;svm_lock&quot; SVM locking MSR */</span>
<span class="p_del">-#define X86_FEATURE_NRIPS	(15*32+ 3) /* &quot;nrip_save&quot; SVM next_rip save */</span>
<span class="p_del">-#define X86_FEATURE_TSCRATEMSR  (15*32+ 4) /* &quot;tsc_scale&quot; TSC scaling support */</span>
<span class="p_del">-#define X86_FEATURE_VMCBCLEAN   (15*32+ 5) /* &quot;vmcb_clean&quot; VMCB clean bits support */</span>
<span class="p_del">-#define X86_FEATURE_FLUSHBYASID (15*32+ 6) /* flush-by-ASID support */</span>
<span class="p_del">-#define X86_FEATURE_DECODEASSISTS (15*32+ 7) /* Decode Assists support */</span>
<span class="p_del">-#define X86_FEATURE_PAUSEFILTER (15*32+10) /* filtered pause intercept */</span>
<span class="p_del">-#define X86_FEATURE_PFTHRESHOLD (15*32+12) /* pause filter threshold */</span>
<span class="p_del">-#define X86_FEATURE_AVIC	(15*32+13) /* Virtual Interrupt Controller */</span>
<span class="p_del">-#define X86_FEATURE_V_VMSAVE_VMLOAD (15*32+15) /* Virtual VMSAVE VMLOAD */</span>
<span class="p_del">-#define X86_FEATURE_VGIF	(15*32+16) /* Virtual GIF */</span>
<span class="p_add">+/* AMD SVM Feature Identification, CPUID level 0x8000000a (EDX), word 15 */</span>
<span class="p_add">+#define X86_FEATURE_NPT			(15*32+ 0) /* Nested Page Table support */</span>
<span class="p_add">+#define X86_FEATURE_LBRV		(15*32+ 1) /* LBR Virtualization support */</span>
<span class="p_add">+#define X86_FEATURE_SVML		(15*32+ 2) /* &quot;svm_lock&quot; SVM locking MSR */</span>
<span class="p_add">+#define X86_FEATURE_NRIPS		(15*32+ 3) /* &quot;nrip_save&quot; SVM next_rip save */</span>
<span class="p_add">+#define X86_FEATURE_TSCRATEMSR		(15*32+ 4) /* &quot;tsc_scale&quot; TSC scaling support */</span>
<span class="p_add">+#define X86_FEATURE_VMCBCLEAN		(15*32+ 5) /* &quot;vmcb_clean&quot; VMCB clean bits support */</span>
<span class="p_add">+#define X86_FEATURE_FLUSHBYASID		(15*32+ 6) /* flush-by-ASID support */</span>
<span class="p_add">+#define X86_FEATURE_DECODEASSISTS	(15*32+ 7) /* Decode Assists support */</span>
<span class="p_add">+#define X86_FEATURE_PAUSEFILTER		(15*32+10) /* filtered pause intercept */</span>
<span class="p_add">+#define X86_FEATURE_PFTHRESHOLD		(15*32+12) /* pause filter threshold */</span>
<span class="p_add">+#define X86_FEATURE_AVIC		(15*32+13) /* Virtual Interrupt Controller */</span>
<span class="p_add">+#define X86_FEATURE_V_VMSAVE_VMLOAD	(15*32+15) /* Virtual VMSAVE VMLOAD */</span>
<span class="p_add">+#define X86_FEATURE_VGIF		(15*32+16) /* Virtual GIF */</span>
 
<span class="p_del">-/* Intel-defined CPU features, CPUID level 0x00000007:0 (ecx), word 16 */</span>
<span class="p_del">-#define X86_FEATURE_AVX512VBMI  (16*32+ 1) /* AVX512 Vector Bit Manipulation instructions*/</span>
<span class="p_del">-#define X86_FEATURE_PKU		(16*32+ 3) /* Protection Keys for Userspace */</span>
<span class="p_del">-#define X86_FEATURE_OSPKE	(16*32+ 4) /* OS Protection Keys Enable */</span>
<span class="p_del">-#define X86_FEATURE_AVX512_VPOPCNTDQ (16*32+14) /* POPCNT for vectors of DW/QW */</span>
<span class="p_del">-#define X86_FEATURE_LA57	(16*32+16) /* 5-level page tables */</span>
<span class="p_del">-#define X86_FEATURE_RDPID	(16*32+22) /* RDPID instruction */</span>
<span class="p_add">+/* Intel-defined CPU features, CPUID level 0x00000007:0 (ECX), word 16 */</span>
<span class="p_add">+#define X86_FEATURE_AVX512VBMI		(16*32+ 1) /* AVX512 Vector Bit Manipulation instructions*/</span>
<span class="p_add">+#define X86_FEATURE_UMIP		(16*32+ 2) /* User Mode Instruction Protection */</span>
<span class="p_add">+#define X86_FEATURE_PKU			(16*32+ 3) /* Protection Keys for Userspace */</span>
<span class="p_add">+#define X86_FEATURE_OSPKE		(16*32+ 4) /* OS Protection Keys Enable */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_VBMI2	(16*32+ 6) /* Additional AVX512 Vector Bit Manipulation Instructions */</span>
<span class="p_add">+#define X86_FEATURE_GFNI		(16*32+ 8) /* Galois Field New Instructions */</span>
<span class="p_add">+#define X86_FEATURE_VAES		(16*32+ 9) /* Vector AES */</span>
<span class="p_add">+#define X86_FEATURE_VPCLMULQDQ		(16*32+10) /* Carry-Less Multiplication Double Quadword */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_VNNI		(16*32+11) /* Vector Neural Network Instructions */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_BITALG	(16*32+12) /* Support for VPOPCNT[B,W] and VPSHUF-BITQMB instructions */</span>
<span class="p_add">+#define X86_FEATURE_AVX512_VPOPCNTDQ	(16*32+14) /* POPCNT for vectors of DW/QW */</span>
<span class="p_add">+#define X86_FEATURE_LA57		(16*32+16) /* 5-level page tables */</span>
<span class="p_add">+#define X86_FEATURE_RDPID		(16*32+22) /* RDPID instruction */</span>
 
<span class="p_del">-/* AMD-defined CPU features, CPUID level 0x80000007 (ebx), word 17 */</span>
<span class="p_del">-#define X86_FEATURE_OVERFLOW_RECOV (17*32+0) /* MCA overflow recovery support */</span>
<span class="p_del">-#define X86_FEATURE_SUCCOR	(17*32+1) /* Uncorrectable error containment and recovery */</span>
<span class="p_del">-#define X86_FEATURE_SMCA	(17*32+3) /* Scalable MCA */</span>
<span class="p_add">+/* AMD-defined CPU features, CPUID level 0x80000007 (EBX), word 17 */</span>
<span class="p_add">+#define X86_FEATURE_OVERFLOW_RECOV	(17*32+ 0) /* MCA overflow recovery support */</span>
<span class="p_add">+#define X86_FEATURE_SUCCOR		(17*32+ 1) /* Uncorrectable error containment and recovery */</span>
<span class="p_add">+#define X86_FEATURE_SMCA		(17*32+ 3) /* Scalable MCA */</span>
 
 /*
  * BUG word(s)
  */
<span class="p_del">-#define X86_BUG(x)		(NCAPINTS*32 + (x))</span>
<span class="p_add">+#define X86_BUG(x)			(NCAPINTS*32 + (x))</span>
 
<span class="p_del">-#define X86_BUG_F00F		X86_BUG(0) /* Intel F00F */</span>
<span class="p_del">-#define X86_BUG_FDIV		X86_BUG(1) /* FPU FDIV */</span>
<span class="p_del">-#define X86_BUG_COMA		X86_BUG(2) /* Cyrix 6x86 coma */</span>
<span class="p_del">-#define X86_BUG_AMD_TLB_MMATCH	X86_BUG(3) /* &quot;tlb_mmatch&quot; AMD Erratum 383 */</span>
<span class="p_del">-#define X86_BUG_AMD_APIC_C1E	X86_BUG(4) /* &quot;apic_c1e&quot; AMD Erratum 400 */</span>
<span class="p_del">-#define X86_BUG_11AP		X86_BUG(5) /* Bad local APIC aka 11AP */</span>
<span class="p_del">-#define X86_BUG_FXSAVE_LEAK	X86_BUG(6) /* FXSAVE leaks FOP/FIP/FOP */</span>
<span class="p_del">-#define X86_BUG_CLFLUSH_MONITOR	X86_BUG(7) /* AAI65, CLFLUSH required before MONITOR */</span>
<span class="p_del">-#define X86_BUG_SYSRET_SS_ATTRS	X86_BUG(8) /* SYSRET doesn&#39;t fix up SS attrs */</span>
<span class="p_add">+#define X86_BUG_F00F			X86_BUG(0) /* Intel F00F */</span>
<span class="p_add">+#define X86_BUG_FDIV			X86_BUG(1) /* FPU FDIV */</span>
<span class="p_add">+#define X86_BUG_COMA			X86_BUG(2) /* Cyrix 6x86 coma */</span>
<span class="p_add">+#define X86_BUG_AMD_TLB_MMATCH		X86_BUG(3) /* &quot;tlb_mmatch&quot; AMD Erratum 383 */</span>
<span class="p_add">+#define X86_BUG_AMD_APIC_C1E		X86_BUG(4) /* &quot;apic_c1e&quot; AMD Erratum 400 */</span>
<span class="p_add">+#define X86_BUG_11AP			X86_BUG(5) /* Bad local APIC aka 11AP */</span>
<span class="p_add">+#define X86_BUG_FXSAVE_LEAK		X86_BUG(6) /* FXSAVE leaks FOP/FIP/FOP */</span>
<span class="p_add">+#define X86_BUG_CLFLUSH_MONITOR		X86_BUG(7) /* AAI65, CLFLUSH required before MONITOR */</span>
<span class="p_add">+#define X86_BUG_SYSRET_SS_ATTRS		X86_BUG(8) /* SYSRET doesn&#39;t fix up SS attrs */</span>
 #ifdef CONFIG_X86_32
 /*
  * 64-bit kernels don&#39;t use X86_BUG_ESPFIX.  Make the define conditional
  * to avoid confusion.
  */
<span class="p_del">-#define X86_BUG_ESPFIX		X86_BUG(9) /* &quot;&quot; IRET to 16-bit SS corrupts ESP/RSP high bits */</span>
<span class="p_add">+#define X86_BUG_ESPFIX			X86_BUG(9) /* &quot;&quot; IRET to 16-bit SS corrupts ESP/RSP high bits */</span>
 #endif
<span class="p_del">-#define X86_BUG_NULL_SEG	X86_BUG(10) /* Nulling a selector preserves the base */</span>
<span class="p_del">-#define X86_BUG_SWAPGS_FENCE	X86_BUG(11) /* SWAPGS without input dep on GS */</span>
<span class="p_del">-#define X86_BUG_MONITOR		X86_BUG(12) /* IPI required to wake up remote CPU */</span>
<span class="p_del">-#define X86_BUG_AMD_E400	X86_BUG(13) /* CPU is among the affected by Erratum 400 */</span>
<span class="p_add">+#define X86_BUG_NULL_SEG		X86_BUG(10) /* Nulling a selector preserves the base */</span>
<span class="p_add">+#define X86_BUG_SWAPGS_FENCE		X86_BUG(11) /* SWAPGS without input dep on GS */</span>
<span class="p_add">+#define X86_BUG_MONITOR			X86_BUG(12) /* IPI required to wake up remote CPU */</span>
<span class="p_add">+#define X86_BUG_AMD_E400		X86_BUG(13) /* CPU is among the affected by Erratum 400 */</span>
<span class="p_add">+</span>
 #endif /* _ASM_X86_CPUFEATURES_H */
<span class="p_header">diff --git a/tools/arch/x86/include/asm/disabled-features.h b/tools/arch/x86/include/asm/disabled-features.h</span>
<span class="p_header">index c10c9128f54e..14d6d5007314 100644</span>
<span class="p_header">--- a/tools/arch/x86/include/asm/disabled-features.h</span>
<span class="p_header">+++ b/tools/arch/x86/include/asm/disabled-features.h</span>
<span class="p_chunk">@@ -16,6 +16,12 @@</span> <span class="p_context"></span>
 # define DISABLE_MPX	(1&lt;&lt;(X86_FEATURE_MPX &amp; 31))
 #endif
 
<span class="p_add">+#ifdef CONFIG_X86_INTEL_UMIP</span>
<span class="p_add">+# define DISABLE_UMIP	0</span>
<span class="p_add">+#else</span>
<span class="p_add">+# define DISABLE_UMIP	(1&lt;&lt;(X86_FEATURE_UMIP &amp; 31))</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 #ifdef CONFIG_X86_64
 # define DISABLE_VME		(1&lt;&lt;(X86_FEATURE_VME &amp; 31))
 # define DISABLE_K6_MTRR	(1&lt;&lt;(X86_FEATURE_K6_MTRR &amp; 31))
<span class="p_chunk">@@ -63,7 +69,7 @@</span> <span class="p_context"></span>
 #define DISABLED_MASK13	0
 #define DISABLED_MASK14	0
 #define DISABLED_MASK15	0
<span class="p_del">-#define DISABLED_MASK16	(DISABLE_PKU|DISABLE_OSPKE|DISABLE_LA57)</span>
<span class="p_add">+#define DISABLED_MASK16	(DISABLE_PKU|DISABLE_OSPKE|DISABLE_LA57|DISABLE_UMIP)</span>
 #define DISABLED_MASK17	0
 #define DISABLED_MASK_CHECK BUILD_BUG_ON_ZERO(NCAPINTS != 18)
 
<span class="p_header">diff --git a/tools/include/uapi/asm-generic/mman.h b/tools/include/uapi/asm-generic/mman.h</span>
<span class="p_header">index 2dffcbf705b3..653687d9771b 100644</span>
<span class="p_header">--- a/tools/include/uapi/asm-generic/mman.h</span>
<span class="p_header">+++ b/tools/include/uapi/asm-generic/mman.h</span>
<span class="p_chunk">@@ -13,6 +13,7 @@</span> <span class="p_context"></span>
 #define MAP_NONBLOCK	0x10000		/* do not block on IO */
 #define MAP_STACK	0x20000		/* give out an address that is best suited for process/thread stacks */
 #define MAP_HUGETLB	0x40000		/* create a huge page mapping */
<span class="p_add">+#define MAP_SYNC	0x80000		/* perform synchronous page faults for the mapping */</span>
 
 /* Bits [26:31] are reserved, see mman-common.h for MAP_HUGETLB usage */
 
<span class="p_header">diff --git a/tools/include/uapi/drm/drm.h b/tools/include/uapi/drm/drm.h</span>
<span class="p_header">index 97677cd6964d..6fdff5945c8a 100644</span>
<span class="p_header">--- a/tools/include/uapi/drm/drm.h</span>
<span class="p_header">+++ b/tools/include/uapi/drm/drm.h</span>
<span class="p_chunk">@@ -737,6 +737,28 @@</span> <span class="p_context"> struct drm_syncobj_array {</span>
 	__u32 pad;
 };
 
<span class="p_add">+/* Query current scanout sequence number */</span>
<span class="p_add">+struct drm_crtc_get_sequence {</span>
<span class="p_add">+	__u32 crtc_id;		/* requested crtc_id */</span>
<span class="p_add">+	__u32 active;		/* return: crtc output is active */</span>
<span class="p_add">+	__u64 sequence;		/* return: most recent vblank sequence */</span>
<span class="p_add">+	__s64 sequence_ns;	/* return: most recent time of first pixel out */</span>
<span class="p_add">+};</span>
<span class="p_add">+</span>
<span class="p_add">+/* Queue event to be delivered at specified sequence. Time stamp marks</span>
<span class="p_add">+ * when the first pixel of the refresh cycle leaves the display engine</span>
<span class="p_add">+ * for the display</span>
<span class="p_add">+ */</span>
<span class="p_add">+#define DRM_CRTC_SEQUENCE_RELATIVE		0x00000001	/* sequence is relative to current */</span>
<span class="p_add">+#define DRM_CRTC_SEQUENCE_NEXT_ON_MISS		0x00000002	/* Use next sequence if we&#39;ve missed */</span>
<span class="p_add">+</span>
<span class="p_add">+struct drm_crtc_queue_sequence {</span>
<span class="p_add">+	__u32 crtc_id;</span>
<span class="p_add">+	__u32 flags;</span>
<span class="p_add">+	__u64 sequence;		/* on input, target sequence. on output, actual sequence */</span>
<span class="p_add">+	__u64 user_data;	/* user data passed to event */</span>
<span class="p_add">+};</span>
<span class="p_add">+</span>
 #if defined(__cplusplus)
 }
 #endif
<span class="p_chunk">@@ -819,6 +841,9 @@</span> <span class="p_context"> extern &quot;C&quot; {</span>
 
 #define DRM_IOCTL_WAIT_VBLANK		DRM_IOWR(0x3a, union drm_wait_vblank)
 
<span class="p_add">+#define DRM_IOCTL_CRTC_GET_SEQUENCE	DRM_IOWR(0x3b, struct drm_crtc_get_sequence)</span>
<span class="p_add">+#define DRM_IOCTL_CRTC_QUEUE_SEQUENCE	DRM_IOWR(0x3c, struct drm_crtc_queue_sequence)</span>
<span class="p_add">+</span>
 #define DRM_IOCTL_UPDATE_DRAW		DRM_IOW(0x3f, struct drm_update_draw)
 
 #define DRM_IOCTL_MODE_GETRESOURCES	DRM_IOWR(0xA0, struct drm_mode_card_res)
<span class="p_chunk">@@ -863,6 +888,11 @@</span> <span class="p_context"> extern &quot;C&quot; {</span>
 #define DRM_IOCTL_SYNCOBJ_RESET		DRM_IOWR(0xC4, struct drm_syncobj_array)
 #define DRM_IOCTL_SYNCOBJ_SIGNAL	DRM_IOWR(0xC5, struct drm_syncobj_array)
 
<span class="p_add">+#define DRM_IOCTL_MODE_CREATE_LEASE	DRM_IOWR(0xC6, struct drm_mode_create_lease)</span>
<span class="p_add">+#define DRM_IOCTL_MODE_LIST_LESSEES	DRM_IOWR(0xC7, struct drm_mode_list_lessees)</span>
<span class="p_add">+#define DRM_IOCTL_MODE_GET_LEASE	DRM_IOWR(0xC8, struct drm_mode_get_lease)</span>
<span class="p_add">+#define DRM_IOCTL_MODE_REVOKE_LEASE	DRM_IOWR(0xC9, struct drm_mode_revoke_lease)</span>
<span class="p_add">+</span>
 /**
  * Device specific ioctls should only be in their respective headers
  * The device specific ioctl range is from 0x40 to 0x9f.
<span class="p_chunk">@@ -893,6 +923,7 @@</span> <span class="p_context"> struct drm_event {</span>
 
 #define DRM_EVENT_VBLANK 0x01
 #define DRM_EVENT_FLIP_COMPLETE 0x02
<span class="p_add">+#define DRM_EVENT_CRTC_SEQUENCE	0x03</span>
 
 struct drm_event_vblank {
 	struct drm_event base;
<span class="p_chunk">@@ -903,6 +934,16 @@</span> <span class="p_context"> struct drm_event_vblank {</span>
 	__u32 crtc_id; /* 0 on older kernels that do not support this */
 };
 
<span class="p_add">+/* Event delivered at sequence. Time stamp marks when the first pixel</span>
<span class="p_add">+ * of the refresh cycle leaves the display engine for the display</span>
<span class="p_add">+ */</span>
<span class="p_add">+struct drm_event_crtc_sequence {</span>
<span class="p_add">+	struct drm_event	base;</span>
<span class="p_add">+	__u64			user_data;</span>
<span class="p_add">+	__s64			time_ns;</span>
<span class="p_add">+	__u64			sequence;</span>
<span class="p_add">+};</span>
<span class="p_add">+</span>
 /* typedef area */
 #ifndef __KERNEL__
 typedef struct drm_clip_rect drm_clip_rect_t;
<span class="p_header">diff --git a/tools/include/uapi/drm/i915_drm.h b/tools/include/uapi/drm/i915_drm.h</span>
<span class="p_header">index 9816590d3ad2..ac3c6503ca27 100644</span>
<span class="p_header">--- a/tools/include/uapi/drm/i915_drm.h</span>
<span class="p_header">+++ b/tools/include/uapi/drm/i915_drm.h</span>
<span class="p_chunk">@@ -397,10 +397,20 @@</span> <span class="p_context"> typedef struct drm_i915_irq_wait {</span>
 #define I915_PARAM_MIN_EU_IN_POOL	 39
 #define I915_PARAM_MMAP_GTT_VERSION	 40
 
<span class="p_del">-/* Query whether DRM_I915_GEM_EXECBUFFER2 supports user defined execution</span>
<span class="p_add">+/*</span>
<span class="p_add">+ * Query whether DRM_I915_GEM_EXECBUFFER2 supports user defined execution</span>
  * priorities and the driver will attempt to execute batches in priority order.
<span class="p_add">+ * The param returns a capability bitmask, nonzero implies that the scheduler</span>
<span class="p_add">+ * is enabled, with different features present according to the mask.</span>
<span class="p_add">+ *</span>
<span class="p_add">+ * The initial priority for each batch is supplied by the context and is</span>
<span class="p_add">+ * controlled via I915_CONTEXT_PARAM_PRIORITY.</span>
  */
 #define I915_PARAM_HAS_SCHEDULER	 41
<span class="p_add">+#define   I915_SCHEDULER_CAP_ENABLED	(1ul &lt;&lt; 0)</span>
<span class="p_add">+#define   I915_SCHEDULER_CAP_PRIORITY	(1ul &lt;&lt; 1)</span>
<span class="p_add">+#define   I915_SCHEDULER_CAP_PREEMPTION	(1ul &lt;&lt; 2)</span>
<span class="p_add">+</span>
 #define I915_PARAM_HUC_STATUS		 42
 
 /* Query whether DRM_I915_GEM_EXECBUFFER2 supports the ability to opt-out of
<span class="p_chunk">@@ -1309,14 +1319,16 @@</span> <span class="p_context"> struct drm_i915_reg_read {</span>
 	 * be specified
 	 */
 	__u64 offset;
<span class="p_add">+#define I915_REG_READ_8B_WA (1ul &lt;&lt; 0)</span>
<span class="p_add">+</span>
 	__u64 val; /* Return value */
 };
 /* Known registers:
  *
  * Render engine timestamp - 0x2358 + 64bit - gen7+
  * - Note this register returns an invalid value if using the default
<span class="p_del">- *   single instruction 8byte read, in order to workaround that use</span>
<span class="p_del">- *   offset (0x2538 | 1) instead.</span>
<span class="p_add">+ *   single instruction 8byte read, in order to workaround that pass</span>
<span class="p_add">+ *   flag I915_REG_READ_8B_WA in offset field.</span>
  *
  */
 
<span class="p_chunk">@@ -1359,6 +1371,10 @@</span> <span class="p_context"> struct drm_i915_gem_context_param {</span>
 #define I915_CONTEXT_PARAM_GTT_SIZE	0x3
 #define I915_CONTEXT_PARAM_NO_ERROR_CAPTURE	0x4
 #define I915_CONTEXT_PARAM_BANNABLE	0x5
<span class="p_add">+#define I915_CONTEXT_PARAM_PRIORITY	0x6</span>
<span class="p_add">+#define   I915_CONTEXT_MAX_USER_PRIORITY	1023 /* inclusive */</span>
<span class="p_add">+#define   I915_CONTEXT_DEFAULT_PRIORITY		0</span>
<span class="p_add">+#define   I915_CONTEXT_MIN_USER_PRIORITY	-1023 /* inclusive */</span>
 	__u64 value;
 };
 
<span class="p_chunk">@@ -1510,9 +1526,14 @@</span> <span class="p_context"> struct drm_i915_perf_oa_config {</span>
 	__u32 n_boolean_regs;
 	__u32 n_flex_regs;
 
<span class="p_del">-	__u64 __user mux_regs_ptr;</span>
<span class="p_del">-	__u64 __user boolean_regs_ptr;</span>
<span class="p_del">-	__u64 __user flex_regs_ptr;</span>
<span class="p_add">+	/*</span>
<span class="p_add">+	 * These fields are pointers to tuples of u32 values (register</span>
<span class="p_add">+	 * address, value). For example the expected length of the buffer</span>
<span class="p_add">+	 * pointed by mux_regs_ptr is (2 * sizeof(u32) * n_mux_regs).</span>
<span class="p_add">+	 */</span>
<span class="p_add">+	__u64 mux_regs_ptr;</span>
<span class="p_add">+	__u64 boolean_regs_ptr;</span>
<span class="p_add">+	__u64 flex_regs_ptr;</span>
 };
 
 #if defined(__cplusplus)
<span class="p_header">diff --git a/tools/include/uapi/linux/kcmp.h b/tools/include/uapi/linux/kcmp.h</span>
<span class="p_header">index 481e103da78e..ef1305010925 100644</span>
<span class="p_header">--- a/tools/include/uapi/linux/kcmp.h</span>
<span class="p_header">+++ b/tools/include/uapi/linux/kcmp.h</span>
<span class="p_chunk">@@ -1,3 +1,4 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span>
 #ifndef _UAPI_LINUX_KCMP_H
 #define _UAPI_LINUX_KCMP_H
 
<span class="p_header">diff --git a/tools/include/uapi/linux/kvm.h b/tools/include/uapi/linux/kvm.h</span>
<span class="p_header">index 7e99999d6236..282d7613fce8 100644</span>
<span class="p_header">--- a/tools/include/uapi/linux/kvm.h</span>
<span class="p_header">+++ b/tools/include/uapi/linux/kvm.h</span>
<span class="p_chunk">@@ -931,6 +931,7 @@</span> <span class="p_context"> struct kvm_ppc_resize_hpt {</span>
 #define KVM_CAP_PPC_SMT_POSSIBLE 147
 #define KVM_CAP_HYPERV_SYNIC2 148
 #define KVM_CAP_HYPERV_VP_INDEX 149
<span class="p_add">+#define KVM_CAP_S390_AIS_MIGRATION 150</span>
 
 #ifdef KVM_CAP_IRQ_ROUTING
 
<span class="p_header">diff --git a/tools/include/uapi/linux/perf_event.h b/tools/include/uapi/linux/perf_event.h</span>
<span class="p_header">index 362493a2f950..b9a4953018ed 100644</span>
<span class="p_header">--- a/tools/include/uapi/linux/perf_event.h</span>
<span class="p_header">+++ b/tools/include/uapi/linux/perf_event.h</span>
<span class="p_chunk">@@ -942,6 +942,7 @@</span> <span class="p_context"> enum perf_callchain_context {</span>
 #define PERF_AUX_FLAG_TRUNCATED		0x01	/* record was truncated to fit */
 #define PERF_AUX_FLAG_OVERWRITE		0x02	/* snapshot from overwrite mode */
 #define PERF_AUX_FLAG_PARTIAL		0x04	/* record contains gaps */
<span class="p_add">+#define PERF_AUX_FLAG_COLLISION		0x08	/* sample collided with another */</span>
 
 #define PERF_FLAG_FD_NO_GROUP		(1UL &lt;&lt; 0)
 #define PERF_FLAG_FD_OUTPUT		(1UL &lt;&lt; 1)
<span class="p_header">diff --git a/tools/include/uapi/linux/prctl.h b/tools/include/uapi/linux/prctl.h</span>
<span class="p_header">index a8d0759a9e40..af5f8c2df87a 100644</span>
<span class="p_header">--- a/tools/include/uapi/linux/prctl.h</span>
<span class="p_header">+++ b/tools/include/uapi/linux/prctl.h</span>
<span class="p_chunk">@@ -1,3 +1,4 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span>
 #ifndef _LINUX_PRCTL_H
 #define _LINUX_PRCTL_H
 
<span class="p_chunk">@@ -197,4 +198,13 @@</span> <span class="p_context"> struct prctl_mm_map {</span>
 # define PR_CAP_AMBIENT_LOWER		3
 # define PR_CAP_AMBIENT_CLEAR_ALL	4
 
<span class="p_add">+/* arm64 Scalable Vector Extension controls */</span>
<span class="p_add">+/* Flag values must be kept in sync with ptrace NT_ARM_SVE interface */</span>
<span class="p_add">+#define PR_SVE_SET_VL			50	/* set task vector length */</span>
<span class="p_add">+# define PR_SVE_SET_VL_ONEXEC		(1 &lt;&lt; 18) /* defer effect until exec */</span>
<span class="p_add">+#define PR_SVE_GET_VL			51	/* get task vector length */</span>
<span class="p_add">+/* Bits common to PR_SVE_SET_VL and PR_SVE_GET_VL */</span>
<span class="p_add">+# define PR_SVE_VL_LEN_MASK		0xffff</span>
<span class="p_add">+# define PR_SVE_VL_INHERIT		(1 &lt;&lt; 17) /* inherit across exec */</span>
<span class="p_add">+</span>
 #endif /* _LINUX_PRCTL_H */
<span class="p_header">diff --git a/tools/perf/bench/numa.c b/tools/perf/bench/numa.c</span>
<span class="p_header">index d95fdcc26f4b..944070e98a2c 100644</span>
<span class="p_header">--- a/tools/perf/bench/numa.c</span>
<span class="p_header">+++ b/tools/perf/bench/numa.c</span>
<span class="p_chunk">@@ -216,6 +216,47 @@</span> <span class="p_context"> static const char * const numa_usage[] = {</span>
 	NULL
 };
 
<span class="p_add">+/*</span>
<span class="p_add">+ * To get number of numa nodes present.</span>
<span class="p_add">+ */</span>
<span class="p_add">+static int nr_numa_nodes(void)</span>
<span class="p_add">+{</span>
<span class="p_add">+	int i, nr_nodes = 0;</span>
<span class="p_add">+</span>
<span class="p_add">+	for (i = 0; i &lt; g-&gt;p.nr_nodes; i++) {</span>
<span class="p_add">+		if (numa_bitmask_isbitset(numa_nodes_ptr, i))</span>
<span class="p_add">+			nr_nodes++;</span>
<span class="p_add">+	}</span>
<span class="p_add">+</span>
<span class="p_add">+	return nr_nodes;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+/*</span>
<span class="p_add">+ * To check if given numa node is present.</span>
<span class="p_add">+ */</span>
<span class="p_add">+static int is_node_present(int node)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return numa_bitmask_isbitset(numa_nodes_ptr, node);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+/*</span>
<span class="p_add">+ * To check given numa node has cpus.</span>
<span class="p_add">+ */</span>
<span class="p_add">+static bool node_has_cpus(int node)</span>
<span class="p_add">+{</span>
<span class="p_add">+	struct bitmask *cpu = numa_allocate_cpumask();</span>
<span class="p_add">+	unsigned int i;</span>
<span class="p_add">+</span>
<span class="p_add">+	if (cpu &amp;&amp; !numa_node_to_cpus(node, cpu)) {</span>
<span class="p_add">+		for (i = 0; i &lt; cpu-&gt;size; i++) {</span>
<span class="p_add">+			if (numa_bitmask_isbitset(cpu, i))</span>
<span class="p_add">+				return true;</span>
<span class="p_add">+		}</span>
<span class="p_add">+	}</span>
<span class="p_add">+</span>
<span class="p_add">+	return false; /* lets fall back to nocpus safely */</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 static cpu_set_t bind_to_cpu(int target_cpu)
 {
 	cpu_set_t orig_mask, mask;
<span class="p_chunk">@@ -244,12 +285,12 @@</span> <span class="p_context"> static cpu_set_t bind_to_cpu(int target_cpu)</span>
 
 static cpu_set_t bind_to_node(int target_node)
 {
<span class="p_del">-	int cpus_per_node = g-&gt;p.nr_cpus/g-&gt;p.nr_nodes;</span>
<span class="p_add">+	int cpus_per_node = g-&gt;p.nr_cpus / nr_numa_nodes();</span>
 	cpu_set_t orig_mask, mask;
 	int cpu;
 	int ret;
 
<span class="p_del">-	BUG_ON(cpus_per_node*g-&gt;p.nr_nodes != g-&gt;p.nr_cpus);</span>
<span class="p_add">+	BUG_ON(cpus_per_node * nr_numa_nodes() != g-&gt;p.nr_cpus);</span>
 	BUG_ON(!cpus_per_node);
 
 	ret = sched_getaffinity(0, sizeof(orig_mask), &amp;orig_mask);
<span class="p_chunk">@@ -649,7 +690,7 @@</span> <span class="p_context"> static int parse_setup_node_list(void)</span>
 			int i;
 
 			for (i = 0; i &lt; mul; i++) {
<span class="p_del">-				if (t &gt;= g-&gt;p.nr_tasks) {</span>
<span class="p_add">+				if (t &gt;= g-&gt;p.nr_tasks || !node_has_cpus(bind_node)) {</span>
 					printf(&quot;\n# NOTE: ignoring bind NODEs starting at NODE#%d\n&quot;, bind_node);
 					goto out;
 				}
<span class="p_chunk">@@ -964,6 +1005,8 @@</span> <span class="p_context"> static void calc_convergence(double runtime_ns_max, double *convergence)</span>
 	sum = 0;
 
 	for (node = 0; node &lt; g-&gt;p.nr_nodes; node++) {
<span class="p_add">+		if (!is_node_present(node))</span>
<span class="p_add">+			continue;</span>
 		nr = nodes[node];
 		nr_min = min(nr, nr_min);
 		nr_max = max(nr, nr_max);
<span class="p_chunk">@@ -984,8 +1027,11 @@</span> <span class="p_context"> static void calc_convergence(double runtime_ns_max, double *convergence)</span>
 	process_groups = 0;
 
 	for (node = 0; node &lt; g-&gt;p.nr_nodes; node++) {
<span class="p_del">-		int processes = count_node_processes(node);</span>
<span class="p_add">+		int processes;</span>
 
<span class="p_add">+		if (!is_node_present(node))</span>
<span class="p_add">+			continue;</span>
<span class="p_add">+		processes = count_node_processes(node);</span>
 		nr = nodes[node];
 		tprintf(&quot; %2d/%-2d&quot;, nr, processes);
 
<span class="p_chunk">@@ -1291,7 +1337,7 @@</span> <span class="p_context"> static void print_summary(void)</span>
 
 	printf(&quot;\n ###\n&quot;);
 	printf(&quot; # %d %s will execute (on %d nodes, %d CPUs):\n&quot;,
<span class="p_del">-		g-&gt;p.nr_tasks, g-&gt;p.nr_tasks == 1 ? &quot;task&quot; : &quot;tasks&quot;, g-&gt;p.nr_nodes, g-&gt;p.nr_cpus);</span>
<span class="p_add">+		g-&gt;p.nr_tasks, g-&gt;p.nr_tasks == 1 ? &quot;task&quot; : &quot;tasks&quot;, nr_numa_nodes(), g-&gt;p.nr_cpus);</span>
 	printf(&quot; #      %5dx %5ldMB global  shared mem operations\n&quot;,
 			g-&gt;p.nr_loops, g-&gt;p.bytes_global/1024/1024);
 	printf(&quot; #      %5dx %5ldMB process shared mem operations\n&quot;,
<span class="p_header">diff --git a/tools/perf/builtin-help.c b/tools/perf/builtin-help.c</span>
<span class="p_header">index bd1fedef3d1c..a0f7ed2b869b 100644</span>
<span class="p_header">--- a/tools/perf/builtin-help.c</span>
<span class="p_header">+++ b/tools/perf/builtin-help.c</span>
<span class="p_chunk">@@ -284,7 +284,7 @@</span> <span class="p_context"> static int perf_help_config(const char *var, const char *value, void *cb)</span>
 		add_man_viewer(value);
 		return 0;
 	}
<span class="p_del">-	if (!strstarts(var, &quot;man.&quot;))</span>
<span class="p_add">+	if (strstarts(var, &quot;man.&quot;))</span>
 		return add_man_viewer_info(var, value);
 
 	return 0;
<span class="p_chunk">@@ -314,7 +314,7 @@</span> <span class="p_context"> static const char *cmd_to_page(const char *perf_cmd)</span>
 
 	if (!perf_cmd)
 		return &quot;perf&quot;;
<span class="p_del">-	else if (!strstarts(perf_cmd, &quot;perf&quot;))</span>
<span class="p_add">+	else if (strstarts(perf_cmd, &quot;perf&quot;))</span>
 		return perf_cmd;
 
 	return asprintf(&amp;s, &quot;perf-%s&quot;, perf_cmd) &lt; 0 ? NULL : s;
<span class="p_header">diff --git a/tools/perf/builtin-record.c b/tools/perf/builtin-record.c</span>
<span class="p_header">index 3d7f33e19df2..003255910c05 100644</span>
<span class="p_header">--- a/tools/perf/builtin-record.c</span>
<span class="p_header">+++ b/tools/perf/builtin-record.c</span>
<span class="p_chunk">@@ -339,6 +339,22 @@</span> <span class="p_context"> static int record__open(struct record *rec)</span>
 	struct perf_evsel_config_term *err_term;
 	int rc = 0;
 
<span class="p_add">+	/*</span>
<span class="p_add">+	 * For initial_delay we need to add a dummy event so that we can track</span>
<span class="p_add">+	 * PERF_RECORD_MMAP while we wait for the initial delay to enable the</span>
<span class="p_add">+	 * real events, the ones asked by the user.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+	if (opts-&gt;initial_delay) {</span>
<span class="p_add">+		if (perf_evlist__add_dummy(evlist))</span>
<span class="p_add">+			return -ENOMEM;</span>
<span class="p_add">+</span>
<span class="p_add">+		pos = perf_evlist__first(evlist);</span>
<span class="p_add">+		pos-&gt;tracking = 0;</span>
<span class="p_add">+		pos = perf_evlist__last(evlist);</span>
<span class="p_add">+		pos-&gt;tracking = 1;</span>
<span class="p_add">+		pos-&gt;attr.enable_on_exec = 1;</span>
<span class="p_add">+	}</span>
<span class="p_add">+</span>
 	perf_evlist__config(evlist, opts, &amp;callchain_param);
 
 	evlist__for_each_entry(evlist, pos) {
<span class="p_chunk">@@ -749,17 +765,19 @@</span> <span class="p_context"> static int record__synthesize(struct record *rec, bool tail)</span>
 			goto out;
 	}
 
<span class="p_del">-	err = perf_event__synthesize_kernel_mmap(tool, process_synthesized_event,</span>
<span class="p_del">-						 machine);</span>
<span class="p_del">-	WARN_ONCE(err &lt; 0, &quot;Couldn&#39;t record kernel reference relocation symbol\n&quot;</span>
<span class="p_del">-			   &quot;Symbol resolution may be skewed if relocation was used (e.g. kexec).\n&quot;</span>
<span class="p_del">-			   &quot;Check /proc/kallsyms permission or run as root.\n&quot;);</span>
<span class="p_del">-</span>
<span class="p_del">-	err = perf_event__synthesize_modules(tool, process_synthesized_event,</span>
<span class="p_del">-					     machine);</span>
<span class="p_del">-	WARN_ONCE(err &lt; 0, &quot;Couldn&#39;t record kernel module information.\n&quot;</span>
<span class="p_del">-			   &quot;Symbol resolution may be skewed if relocation was used (e.g. kexec).\n&quot;</span>
<span class="p_del">-			   &quot;Check /proc/modules permission or run as root.\n&quot;);</span>
<span class="p_add">+	if (!perf_evlist__exclude_kernel(rec-&gt;evlist)) {</span>
<span class="p_add">+		err = perf_event__synthesize_kernel_mmap(tool, process_synthesized_event,</span>
<span class="p_add">+							 machine);</span>
<span class="p_add">+		WARN_ONCE(err &lt; 0, &quot;Couldn&#39;t record kernel reference relocation symbol\n&quot;</span>
<span class="p_add">+				   &quot;Symbol resolution may be skewed if relocation was used (e.g. kexec).\n&quot;</span>
<span class="p_add">+				   &quot;Check /proc/kallsyms permission or run as root.\n&quot;);</span>
<span class="p_add">+</span>
<span class="p_add">+		err = perf_event__synthesize_modules(tool, process_synthesized_event,</span>
<span class="p_add">+						     machine);</span>
<span class="p_add">+		WARN_ONCE(err &lt; 0, &quot;Couldn&#39;t record kernel module information.\n&quot;</span>
<span class="p_add">+				   &quot;Symbol resolution may be skewed if relocation was used (e.g. kexec).\n&quot;</span>
<span class="p_add">+				   &quot;Check /proc/modules permission or run as root.\n&quot;);</span>
<span class="p_add">+	}</span>
 
 	if (perf_guest) {
 		machines__process_guests(&amp;session-&gt;machines,
<span class="p_chunk">@@ -1693,7 +1711,7 @@</span> <span class="p_context"> int cmd_record(int argc, const char **argv)</span>
 
 	err = -ENOMEM;
 
<span class="p_del">-	if (symbol_conf.kptr_restrict)</span>
<span class="p_add">+	if (symbol_conf.kptr_restrict &amp;&amp; !perf_evlist__exclude_kernel(rec-&gt;evlist))</span>
 		pr_warning(
 &quot;WARNING: Kernel address maps (/proc/{kallsyms,modules}) are restricted,\n&quot;
 &quot;check /proc/sys/kernel/kptr_restrict.\n\n&quot;
<span class="p_header">diff --git a/tools/perf/builtin-report.c b/tools/perf/builtin-report.c</span>
<span class="p_header">index 1394cd8d96f7..af5dd038195e 100644</span>
<span class="p_header">--- a/tools/perf/builtin-report.c</span>
<span class="p_header">+++ b/tools/perf/builtin-report.c</span>
<span class="p_chunk">@@ -441,6 +441,9 @@</span> <span class="p_context"> static void report__warn_kptr_restrict(const struct report *rep)</span>
 	struct map *kernel_map = machine__kernel_map(&amp;rep-&gt;session-&gt;machines.host);
 	struct kmap *kernel_kmap = kernel_map ? map__kmap(kernel_map) : NULL;
 
<span class="p_add">+	if (perf_evlist__exclude_kernel(rep-&gt;session-&gt;evlist))</span>
<span class="p_add">+		return;</span>
<span class="p_add">+</span>
 	if (kernel_map == NULL ||
 	    (kernel_map-&gt;dso-&gt;hit &amp;&amp;
 	     (kernel_kmap-&gt;ref_reloc_sym == NULL ||
<span class="p_header">diff --git a/tools/perf/builtin-script.c b/tools/perf/builtin-script.c</span>
<span class="p_header">index 68f36dc0344f..9b43bda45a41 100644</span>
<span class="p_header">--- a/tools/perf/builtin-script.c</span>
<span class="p_header">+++ b/tools/perf/builtin-script.c</span>
<span class="p_chunk">@@ -1955,6 +1955,16 @@</span> <span class="p_context"> static int perf_script__fopen_per_event_dump(struct perf_script *script)</span>
 	struct perf_evsel *evsel;
 
 	evlist__for_each_entry(script-&gt;session-&gt;evlist, evsel) {
<span class="p_add">+		/*</span>
<span class="p_add">+		 * Already setup? I.e. we may be called twice in cases like</span>
<span class="p_add">+		 * Intel PT, one for the intel_pt// and dummy events, then</span>
<span class="p_add">+		 * for the evsels syntheized from the auxtrace info.</span>
<span class="p_add">+		 *</span>
<span class="p_add">+		 * Ses perf_script__process_auxtrace_info.</span>
<span class="p_add">+		 */</span>
<span class="p_add">+		if (evsel-&gt;priv != NULL)</span>
<span class="p_add">+			continue;</span>
<span class="p_add">+</span>
 		evsel-&gt;priv = perf_evsel_script__new(evsel, script-&gt;session-&gt;data);
 		if (evsel-&gt;priv == NULL)
 			goto out_err_fclose;
<span class="p_chunk">@@ -2838,6 +2848,25 @@</span> <span class="p_context"> int process_cpu_map_event(struct perf_tool *tool __maybe_unused,</span>
 	return set_maps(script);
 }
 
<span class="p_add">+#ifdef HAVE_AUXTRACE_SUPPORT</span>
<span class="p_add">+static int perf_script__process_auxtrace_info(struct perf_tool *tool,</span>
<span class="p_add">+					      union perf_event *event,</span>
<span class="p_add">+					      struct perf_session *session)</span>
<span class="p_add">+{</span>
<span class="p_add">+	int ret = perf_event__process_auxtrace_info(tool, event, session);</span>
<span class="p_add">+</span>
<span class="p_add">+	if (ret == 0) {</span>
<span class="p_add">+		struct perf_script *script = container_of(tool, struct perf_script, tool);</span>
<span class="p_add">+</span>
<span class="p_add">+		ret = perf_script__setup_per_event_dump(script);</span>
<span class="p_add">+	}</span>
<span class="p_add">+</span>
<span class="p_add">+	return ret;</span>
<span class="p_add">+}</span>
<span class="p_add">+#else</span>
<span class="p_add">+#define perf_script__process_auxtrace_info 0</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 int cmd_script(int argc, const char **argv)
 {
 	bool show_full_info = false;
<span class="p_chunk">@@ -2866,7 +2895,7 @@</span> <span class="p_context"> int cmd_script(int argc, const char **argv)</span>
 			.feature	 = perf_event__process_feature,
 			.build_id	 = perf_event__process_build_id,
 			.id_index	 = perf_event__process_id_index,
<span class="p_del">-			.auxtrace_info	 = perf_event__process_auxtrace_info,</span>
<span class="p_add">+			.auxtrace_info	 = perf_script__process_auxtrace_info,</span>
 			.auxtrace	 = perf_event__process_auxtrace,
 			.auxtrace_error	 = perf_event__process_auxtrace_error,
 			.stat		 = perf_event__process_stat_event,
<span class="p_header">diff --git a/tools/perf/builtin-top.c b/tools/perf/builtin-top.c</span>
<span class="p_header">index 477a8699f0b5..9e0d2645ae13 100644</span>
<span class="p_header">--- a/tools/perf/builtin-top.c</span>
<span class="p_header">+++ b/tools/perf/builtin-top.c</span>
<span class="p_chunk">@@ -77,6 +77,7 @@</span> <span class="p_context"></span>
 #include &quot;sane_ctype.h&quot;
 
 static volatile int done;
<span class="p_add">+static volatile int resize;</span>
 
 #define HEADER_LINE_NR  5
 
<span class="p_chunk">@@ -85,11 +86,13 @@</span> <span class="p_context"> static void perf_top__update_print_entries(struct perf_top *top)</span>
 	top-&gt;print_entries = top-&gt;winsize.ws_row - HEADER_LINE_NR;
 }
 
<span class="p_del">-static void perf_top__sig_winch(int sig __maybe_unused,</span>
<span class="p_del">-				siginfo_t *info __maybe_unused, void *arg)</span>
<span class="p_add">+static void winch_sig(int sig __maybe_unused)</span>
 {
<span class="p_del">-	struct perf_top *top = arg;</span>
<span class="p_add">+	resize = 1;</span>
<span class="p_add">+}</span>
 
<span class="p_add">+static void perf_top__resize(struct perf_top *top)</span>
<span class="p_add">+{</span>
 	get_term_dimensions(&amp;top-&gt;winsize);
 	perf_top__update_print_entries(top);
 }
<span class="p_chunk">@@ -473,12 +476,8 @@</span> <span class="p_context"> static bool perf_top__handle_keypress(struct perf_top *top, int c)</span>
 		case &#39;e&#39;:
 			prompt_integer(&amp;top-&gt;print_entries, &quot;Enter display entries (lines)&quot;);
 			if (top-&gt;print_entries == 0) {
<span class="p_del">-				struct sigaction act = {</span>
<span class="p_del">-					.sa_sigaction = perf_top__sig_winch,</span>
<span class="p_del">-					.sa_flags     = SA_SIGINFO,</span>
<span class="p_del">-				};</span>
<span class="p_del">-				perf_top__sig_winch(SIGWINCH, NULL, top);</span>
<span class="p_del">-				sigaction(SIGWINCH, &amp;act, NULL);</span>
<span class="p_add">+				perf_top__resize(top);</span>
<span class="p_add">+				signal(SIGWINCH, winch_sig);</span>
 			} else {
 				signal(SIGWINCH, SIG_DFL);
 			}
<span class="p_chunk">@@ -732,14 +731,16 @@</span> <span class="p_context"> static void perf_event__process_sample(struct perf_tool *tool,</span>
 	if (!machine-&gt;kptr_restrict_warned &amp;&amp;
 	    symbol_conf.kptr_restrict &amp;&amp;
 	    al.cpumode == PERF_RECORD_MISC_KERNEL) {
<span class="p_del">-		ui__warning(</span>
<span class="p_add">+		if (!perf_evlist__exclude_kernel(top-&gt;session-&gt;evlist)) {</span>
<span class="p_add">+			ui__warning(</span>
 &quot;Kernel address maps (/proc/{kallsyms,modules}) are restricted.\n\n&quot;
 &quot;Check /proc/sys/kernel/kptr_restrict.\n\n&quot;
 &quot;Kernel%s samples will not be resolved.\n&quot;,
 			  al.map &amp;&amp; !RB_EMPTY_ROOT(&amp;al.map-&gt;dso-&gt;symbols[MAP__FUNCTION]) ?
 			  &quot; modules&quot; : &quot;&quot;);
<span class="p_del">-		if (use_browser &lt;= 0)</span>
<span class="p_del">-			sleep(5);</span>
<span class="p_add">+			if (use_browser &lt;= 0)</span>
<span class="p_add">+				sleep(5);</span>
<span class="p_add">+		}</span>
 		machine-&gt;kptr_restrict_warned = true;
 	}
 
<span class="p_chunk">@@ -1030,6 +1031,11 @@</span> <span class="p_context"> static int __cmd_top(struct perf_top *top)</span>
 
 		if (hits == top-&gt;samples)
 			ret = perf_evlist__poll(top-&gt;evlist, 100);
<span class="p_add">+</span>
<span class="p_add">+		if (resize) {</span>
<span class="p_add">+			perf_top__resize(top);</span>
<span class="p_add">+			resize = 0;</span>
<span class="p_add">+		}</span>
 	}
 
 	ret = 0;
<span class="p_chunk">@@ -1352,12 +1358,8 @@</span> <span class="p_context"> int cmd_top(int argc, const char **argv)</span>
 
 	get_term_dimensions(&amp;top.winsize);
 	if (top.print_entries == 0) {
<span class="p_del">-		struct sigaction act = {</span>
<span class="p_del">-			.sa_sigaction = perf_top__sig_winch,</span>
<span class="p_del">-			.sa_flags     = SA_SIGINFO,</span>
<span class="p_del">-		};</span>
 		perf_top__update_print_entries(&amp;top);
<span class="p_del">-		sigaction(SIGWINCH, &amp;act, NULL);</span>
<span class="p_add">+		signal(SIGWINCH, winch_sig);</span>
 	}
 
 	status = __cmd_top(&amp;top);
<span class="p_header">diff --git a/tools/perf/builtin-trace.c b/tools/perf/builtin-trace.c</span>
<span class="p_header">index f2757d38c7d7..84debdbad327 100644</span>
<span class="p_header">--- a/tools/perf/builtin-trace.c</span>
<span class="p_header">+++ b/tools/perf/builtin-trace.c</span>
<span class="p_chunk">@@ -1152,12 +1152,14 @@</span> <span class="p_context"> static int trace__symbols_init(struct trace *trace, struct perf_evlist *evlist)</span>
 	if (trace-&gt;host == NULL)
 		return -ENOMEM;
 
<span class="p_del">-	if (trace_event__register_resolver(trace-&gt;host, trace__machine__resolve_kernel_addr) &lt; 0)</span>
<span class="p_del">-		return -errno;</span>
<span class="p_add">+	err = trace_event__register_resolver(trace-&gt;host, trace__machine__resolve_kernel_addr);</span>
<span class="p_add">+	if (err &lt; 0)</span>
<span class="p_add">+		goto out;</span>
 
 	err = __machine__synthesize_threads(trace-&gt;host, &amp;trace-&gt;tool, &amp;trace-&gt;opts.target,
 					    evlist-&gt;threads, trace__tool_process, false,
 					    trace-&gt;opts.proc_map_timeout, 1);
<span class="p_add">+out:</span>
 	if (err)
 		symbol__exit();
 
<span class="p_header">diff --git a/tools/perf/tests/shell/trace+probe_libc_inet_pton.sh b/tools/perf/tests/shell/trace+probe_libc_inet_pton.sh</span>
<span class="p_header">index 7a84d73324e3..8b3da21a08f1 100755</span>
<span class="p_header">--- a/tools/perf/tests/shell/trace+probe_libc_inet_pton.sh</span>
<span class="p_header">+++ b/tools/perf/tests/shell/trace+probe_libc_inet_pton.sh</span>
<span class="p_chunk">@@ -10,8 +10,8 @@</span> <span class="p_context"></span>
 
 . $(dirname $0)/lib/probe.sh
 
<span class="p_del">-ld=$(realpath /lib64/ld*.so.* | uniq)</span>
<span class="p_del">-libc=$(echo $ld | sed &#39;s/ld/libc/g&#39;)</span>
<span class="p_add">+libc=$(grep -w libc /proc/self/maps | head -1 | sed -r &#39;s/.*[[:space:]](\/.*)/\1/g&#39;)</span>
<span class="p_add">+nm -g $libc 2&gt;/dev/null | fgrep -q inet_pton || exit 254</span>
 
 trace_libc_inet_pton_backtrace() {
 	idx=0
<span class="p_chunk">@@ -37,6 +37,9 @@</span> <span class="p_context"> trace_libc_inet_pton_backtrace() {</span>
 	done
 }
 
<span class="p_add">+# Check for IPv6 interface existence</span>
<span class="p_add">+ip a sh lo | fgrep -q inet6 || exit 2</span>
<span class="p_add">+</span>
 skip_if_no_perf_probe &amp;&amp; \
 perf probe -q $libc inet_pton &amp;&amp; \
 trace_libc_inet_pton_backtrace
<span class="p_header">diff --git a/tools/perf/tests/shell/trace+probe_vfs_getname.sh b/tools/perf/tests/shell/trace+probe_vfs_getname.sh</span>
<span class="p_header">index 2e68c5f120da..2a9ef080efd0 100755</span>
<span class="p_header">--- a/tools/perf/tests/shell/trace+probe_vfs_getname.sh</span>
<span class="p_header">+++ b/tools/perf/tests/shell/trace+probe_vfs_getname.sh</span>
<span class="p_chunk">@@ -17,8 +17,10 @@</span> <span class="p_context"> skip_if_no_perf_probe || exit 2</span>
 file=$(mktemp /tmp/temporary_file.XXXXX)
 
 trace_open_vfs_getname() {
<span class="p_del">-	perf trace -e open touch $file 2&gt;&amp;1 | \</span>
<span class="p_del">-	egrep &quot; +[0-9]+\.[0-9]+ +\( +[0-9]+\.[0-9]+ ms\): +touch\/[0-9]+ open\(filename: +${file}, +flags: CREAT\|NOCTTY\|NONBLOCK\|WRONLY, +mode: +IRUGO\|IWUGO\) += +[0-9]+$&quot;</span>
<span class="p_add">+	test &quot;$(uname -m)&quot; = s390x &amp;&amp; { svc=&quot;openat&quot;; txt=&quot;dfd: +CWD, +&quot;; }</span>
<span class="p_add">+</span>
<span class="p_add">+	perf trace -e ${svc:-open} touch $file 2&gt;&amp;1 | \</span>
<span class="p_add">+	egrep &quot; +[0-9]+\.[0-9]+ +\( +[0-9]+\.[0-9]+ ms\): +touch\/[0-9]+ ${svc:-open}\(${txt}filename: +${file}, +flags: CREAT\|NOCTTY\|NONBLOCK\|WRONLY, +mode: +IRUGO\|IWUGO\) += +[0-9]+$&quot;</span>
 }
 
 
<span class="p_header">diff --git a/tools/perf/tests/task-exit.c b/tools/perf/tests/task-exit.c</span>
<span class="p_header">index bc4a7344e274..89c8e1604ca7 100644</span>
<span class="p_header">--- a/tools/perf/tests/task-exit.c</span>
<span class="p_header">+++ b/tools/perf/tests/task-exit.c</span>
<span class="p_chunk">@@ -84,7 +84,11 @@</span> <span class="p_context"> int test__task_exit(struct test *test __maybe_unused, int subtest __maybe_unused</span>
 
 	evsel = perf_evlist__first(evlist);
 	evsel-&gt;attr.task = 1;
<span class="p_add">+#ifdef __s390x__</span>
<span class="p_add">+	evsel-&gt;attr.sample_freq = 1000000;</span>
<span class="p_add">+#else</span>
 	evsel-&gt;attr.sample_freq = 1;
<span class="p_add">+#endif</span>
 	evsel-&gt;attr.inherit = 0;
 	evsel-&gt;attr.watermark = 0;
 	evsel-&gt;attr.wakeup_events = 1;
<span class="p_header">diff --git a/tools/perf/trace/beauty/mmap.c b/tools/perf/trace/beauty/mmap.c</span>
<span class="p_header">index 9e1668b2c5d7..417e3ecfe9d7 100644</span>
<span class="p_header">--- a/tools/perf/trace/beauty/mmap.c</span>
<span class="p_header">+++ b/tools/perf/trace/beauty/mmap.c</span>
<span class="p_chunk">@@ -62,6 +62,9 @@</span> <span class="p_context"> static size_t syscall_arg__scnprintf_mmap_flags(char *bf, size_t size,</span>
 	P_MMAP_FLAG(POPULATE);
 	P_MMAP_FLAG(STACK);
 	P_MMAP_FLAG(UNINITIALIZED);
<span class="p_add">+#ifdef MAP_SYNC</span>
<span class="p_add">+	P_MMAP_FLAG(SYNC);</span>
<span class="p_add">+#endif</span>
 #undef P_MMAP_FLAG
 
 	if (flags)
<span class="p_header">diff --git a/tools/perf/util/annotate.c b/tools/perf/util/annotate.c</span>
<span class="p_header">index da1c4c4a0dd8..3369c7830260 100644</span>
<span class="p_header">--- a/tools/perf/util/annotate.c</span>
<span class="p_header">+++ b/tools/perf/util/annotate.c</span>
<span class="p_chunk">@@ -165,7 +165,7 @@</span> <span class="p_context"> static void ins__delete(struct ins_operands *ops)</span>
 static int ins__raw_scnprintf(struct ins *ins, char *bf, size_t size,
 			      struct ins_operands *ops)
 {
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s %s&quot;, ins-&gt;name, ops-&gt;raw);</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s %s&quot;, ins-&gt;name, ops-&gt;raw);</span>
 }
 
 int ins__scnprintf(struct ins *ins, char *bf, size_t size,
<span class="p_chunk">@@ -230,12 +230,12 @@</span> <span class="p_context"> static int call__scnprintf(struct ins *ins, char *bf, size_t size,</span>
 			   struct ins_operands *ops)
 {
 	if (ops-&gt;target.name)
<span class="p_del">-		return scnprintf(bf, size, &quot;%-6.6s %s&quot;, ins-&gt;name, ops-&gt;target.name);</span>
<span class="p_add">+		return scnprintf(bf, size, &quot;%-6s %s&quot;, ins-&gt;name, ops-&gt;target.name);</span>
 
 	if (ops-&gt;target.addr == 0)
 		return ins__raw_scnprintf(ins, bf, size, ops);
 
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s *%&quot; PRIx64, ins-&gt;name, ops-&gt;target.addr);</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s *%&quot; PRIx64, ins-&gt;name, ops-&gt;target.addr);</span>
 }
 
 static struct ins_ops call_ops = {
<span class="p_chunk">@@ -299,7 +299,7 @@</span> <span class="p_context"> static int jump__scnprintf(struct ins *ins, char *bf, size_t size,</span>
 			c++;
 	}
 
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s %.*s%&quot; PRIx64,</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s %.*s%&quot; PRIx64,</span>
 			 ins-&gt;name, c ? c - ops-&gt;raw : 0, ops-&gt;raw,
 			 ops-&gt;target.offset);
 }
<span class="p_chunk">@@ -372,7 +372,7 @@</span> <span class="p_context"> static int lock__scnprintf(struct ins *ins, char *bf, size_t size,</span>
 	if (ops-&gt;locked.ins.ops == NULL)
 		return ins__raw_scnprintf(ins, bf, size, ops);
 
<span class="p_del">-	printed = scnprintf(bf, size, &quot;%-6.6s &quot;, ins-&gt;name);</span>
<span class="p_add">+	printed = scnprintf(bf, size, &quot;%-6s &quot;, ins-&gt;name);</span>
 	return printed + ins__scnprintf(&amp;ops-&gt;locked.ins, bf + printed,
 					size - printed, ops-&gt;locked.ops);
 }
<span class="p_chunk">@@ -448,7 +448,7 @@</span> <span class="p_context"> static int mov__parse(struct arch *arch, struct ins_operands *ops, struct map *m</span>
 static int mov__scnprintf(struct ins *ins, char *bf, size_t size,
 			   struct ins_operands *ops)
 {
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s %s,%s&quot;, ins-&gt;name,</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s %s,%s&quot;, ins-&gt;name,</span>
 			 ops-&gt;source.name ?: ops-&gt;source.raw,
 			 ops-&gt;target.name ?: ops-&gt;target.raw);
 }
<span class="p_chunk">@@ -488,7 +488,7 @@</span> <span class="p_context"> static int dec__parse(struct arch *arch __maybe_unused, struct ins_operands *ops</span>
 static int dec__scnprintf(struct ins *ins, char *bf, size_t size,
 			   struct ins_operands *ops)
 {
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s %s&quot;, ins-&gt;name,</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s %s&quot;, ins-&gt;name,</span>
 			 ops-&gt;target.name ?: ops-&gt;target.raw);
 }
 
<span class="p_chunk">@@ -500,7 +500,7 @@</span> <span class="p_context"> static struct ins_ops dec_ops = {</span>
 static int nop__scnprintf(struct ins *ins __maybe_unused, char *bf, size_t size,
 			  struct ins_operands *ops __maybe_unused)
 {
<span class="p_del">-	return scnprintf(bf, size, &quot;%-6.6s&quot;, &quot;nop&quot;);</span>
<span class="p_add">+	return scnprintf(bf, size, &quot;%-6s&quot;, &quot;nop&quot;);</span>
 }
 
 static struct ins_ops nop_ops = {
<span class="p_chunk">@@ -924,7 +924,7 @@</span> <span class="p_context"> void disasm_line__free(struct disasm_line *dl)</span>
 int disasm_line__scnprintf(struct disasm_line *dl, char *bf, size_t size, bool raw)
 {
 	if (raw || !dl-&gt;ins.ops)
<span class="p_del">-		return scnprintf(bf, size, &quot;%-6.6s %s&quot;, dl-&gt;ins.name, dl-&gt;ops.raw);</span>
<span class="p_add">+		return scnprintf(bf, size, &quot;%-6s %s&quot;, dl-&gt;ins.name, dl-&gt;ops.raw);</span>
 
 	return ins__scnprintf(&amp;dl-&gt;ins, bf, size, &amp;dl-&gt;ops);
 }
<span class="p_header">diff --git a/tools/perf/util/evlist.c b/tools/perf/util/evlist.c</span>
<span class="p_header">index c6c891e154a6..b62e523a7035 100644</span>
<span class="p_header">--- a/tools/perf/util/evlist.c</span>
<span class="p_header">+++ b/tools/perf/util/evlist.c</span>
<span class="p_chunk">@@ -257,7 +257,7 @@</span> <span class="p_context"> int perf_evlist__add_dummy(struct perf_evlist *evlist)</span>
 		.config = PERF_COUNT_SW_DUMMY,
 		.size	= sizeof(attr), /* to capture ABI version */
 	};
<span class="p_del">-	struct perf_evsel *evsel = perf_evsel__new(&amp;attr);</span>
<span class="p_add">+	struct perf_evsel *evsel = perf_evsel__new_idx(&amp;attr, evlist-&gt;nr_entries);</span>
 
 	if (evsel == NULL)
 		return -ENOMEM;
<span class="p_chunk">@@ -1786,3 +1786,15 @@</span> <span class="p_context"> void perf_evlist__toggle_bkw_mmap(struct perf_evlist *evlist,</span>
 state_err:
 	return;
 }
<span class="p_add">+</span>
<span class="p_add">+bool perf_evlist__exclude_kernel(struct perf_evlist *evlist)</span>
<span class="p_add">+{</span>
<span class="p_add">+	struct perf_evsel *evsel;</span>
<span class="p_add">+</span>
<span class="p_add">+	evlist__for_each_entry(evlist, evsel) {</span>
<span class="p_add">+		if (!evsel-&gt;attr.exclude_kernel)</span>
<span class="p_add">+			return false;</span>
<span class="p_add">+	}</span>
<span class="p_add">+</span>
<span class="p_add">+	return true;</span>
<span class="p_add">+}</span>
<span class="p_header">diff --git a/tools/perf/util/evlist.h b/tools/perf/util/evlist.h</span>
<span class="p_header">index e72ae64c11ac..491f69542920 100644</span>
<span class="p_header">--- a/tools/perf/util/evlist.h</span>
<span class="p_header">+++ b/tools/perf/util/evlist.h</span>
<span class="p_chunk">@@ -312,4 +312,6 @@</span> <span class="p_context"> perf_evlist__find_evsel_by_str(struct perf_evlist *evlist, const char *str);</span>
 
 struct perf_evsel *perf_evlist__event2evsel(struct perf_evlist *evlist,
 					    union perf_event *event);
<span class="p_add">+</span>
<span class="p_add">+bool perf_evlist__exclude_kernel(struct perf_evlist *evlist);</span>
 #endif /* __PERF_EVLIST_H */
<span class="p_header">diff --git a/tools/perf/util/evsel.c b/tools/perf/util/evsel.c</span>
<span class="p_header">index f894893c203d..d5fbcf8c7aa7 100644</span>
<span class="p_header">--- a/tools/perf/util/evsel.c</span>
<span class="p_header">+++ b/tools/perf/util/evsel.c</span>
<span class="p_chunk">@@ -733,12 +733,16 @@</span> <span class="p_context"> static void apply_config_terms(struct perf_evsel *evsel,</span>
 	list_for_each_entry(term, config_terms, list) {
 		switch (term-&gt;type) {
 		case PERF_EVSEL__CONFIG_TERM_PERIOD:
<span class="p_del">-			attr-&gt;sample_period = term-&gt;val.period;</span>
<span class="p_del">-			attr-&gt;freq = 0;</span>
<span class="p_add">+			if (!(term-&gt;weak &amp;&amp; opts-&gt;user_interval != ULLONG_MAX)) {</span>
<span class="p_add">+				attr-&gt;sample_period = term-&gt;val.period;</span>
<span class="p_add">+				attr-&gt;freq = 0;</span>
<span class="p_add">+			}</span>
 			break;
 		case PERF_EVSEL__CONFIG_TERM_FREQ:
<span class="p_del">-			attr-&gt;sample_freq = term-&gt;val.freq;</span>
<span class="p_del">-			attr-&gt;freq = 1;</span>
<span class="p_add">+			if (!(term-&gt;weak &amp;&amp; opts-&gt;user_freq != UINT_MAX)) {</span>
<span class="p_add">+				attr-&gt;sample_freq = term-&gt;val.freq;</span>
<span class="p_add">+				attr-&gt;freq = 1;</span>
<span class="p_add">+			}</span>
 			break;
 		case PERF_EVSEL__CONFIG_TERM_TIME:
 			if (term-&gt;val.time)
<span class="p_chunk">@@ -1371,7 +1375,7 @@</span> <span class="p_context"> perf_evsel__process_group_data(struct perf_evsel *leader,</span>
 static int
 perf_evsel__read_group(struct perf_evsel *leader, int cpu, int thread)
 {
<span class="p_del">-	struct perf_stat_evsel *ps = leader-&gt;priv;</span>
<span class="p_add">+	struct perf_stat_evsel *ps = leader-&gt;stats;</span>
 	u64 read_format = leader-&gt;attr.read_format;
 	int size = perf_evsel__read_size(leader);
 	u64 *data = ps-&gt;group_data;
<span class="p_header">diff --git a/tools/perf/util/evsel.h b/tools/perf/util/evsel.h</span>
<span class="p_header">index 9277df96ffda..157f49e8a772 100644</span>
<span class="p_header">--- a/tools/perf/util/evsel.h</span>
<span class="p_header">+++ b/tools/perf/util/evsel.h</span>
<span class="p_chunk">@@ -67,6 +67,7 @@</span> <span class="p_context"> struct perf_evsel_config_term {</span>
 		bool	overwrite;
 		char	*branch;
 	} val;
<span class="p_add">+	bool weak;</span>
 };
 
 struct perf_stat_evsel;
<span class="p_header">diff --git a/tools/perf/util/intel-pt-decoder/inat.h b/tools/perf/util/intel-pt-decoder/inat.h</span>
<span class="p_header">index 125ecd2a300d..52dc8d911173 100644</span>
<span class="p_header">--- a/tools/perf/util/intel-pt-decoder/inat.h</span>
<span class="p_header">+++ b/tools/perf/util/intel-pt-decoder/inat.h</span>
<span class="p_chunk">@@ -97,6 +97,16 @@</span> <span class="p_context"></span>
 #define INAT_MAKE_GROUP(grp)	((grp &lt;&lt; INAT_GRP_OFFS) | INAT_MODRM)
 #define INAT_MAKE_IMM(imm)	(imm &lt;&lt; INAT_IMM_OFFS)
 
<span class="p_add">+/* Identifiers for segment registers */</span>
<span class="p_add">+#define INAT_SEG_REG_IGNORE	0</span>
<span class="p_add">+#define INAT_SEG_REG_DEFAULT	1</span>
<span class="p_add">+#define INAT_SEG_REG_CS		2</span>
<span class="p_add">+#define INAT_SEG_REG_SS		3</span>
<span class="p_add">+#define INAT_SEG_REG_DS		4</span>
<span class="p_add">+#define INAT_SEG_REG_ES		5</span>
<span class="p_add">+#define INAT_SEG_REG_FS		6</span>
<span class="p_add">+#define INAT_SEG_REG_GS		7</span>
<span class="p_add">+</span>
 /* Attribute search APIs */
 extern insn_attr_t inat_get_opcode_attribute(insn_byte_t opcode);
 extern int inat_get_last_prefix_id(insn_byte_t last_pfx);
<span class="p_header">diff --git a/tools/perf/util/intel-pt-decoder/x86-opcode-map.txt b/tools/perf/util/intel-pt-decoder/x86-opcode-map.txt</span>
<span class="p_header">index 12e377184ee4..c4d55919fac1 100644</span>
<span class="p_header">--- a/tools/perf/util/intel-pt-decoder/x86-opcode-map.txt</span>
<span class="p_header">+++ b/tools/perf/util/intel-pt-decoder/x86-opcode-map.txt</span>
<span class="p_chunk">@@ -896,7 +896,7 @@</span> <span class="p_context"> EndTable</span>
 
 GrpTable: Grp3_1
 0: TEST Eb,Ib
<span class="p_del">-1:</span>
<span class="p_add">+1: TEST Eb,Ib</span>
 2: NOT Eb
 3: NEG Eb
 4: MUL AL,Eb
<span class="p_header">diff --git a/tools/perf/util/machine.c b/tools/perf/util/machine.c</span>
<span class="p_header">index 6a8d03c3d9b7..270f3223c6df 100644</span>
<span class="p_header">--- a/tools/perf/util/machine.c</span>
<span class="p_header">+++ b/tools/perf/util/machine.c</span>
<span class="p_chunk">@@ -172,6 +172,9 @@</span> <span class="p_context"> void machine__exit(struct machine *machine)</span>
 {
 	int i;
 
<span class="p_add">+	if (machine == NULL)</span>
<span class="p_add">+		return;</span>
<span class="p_add">+</span>
 	machine__destroy_kernel_maps(machine);
 	map_groups__exit(&amp;machine-&gt;kmaps);
 	dsos__exit(&amp;machine-&gt;dsos);
<span class="p_header">diff --git a/tools/perf/util/parse-events.c b/tools/perf/util/parse-events.c</span>
<span class="p_header">index a7fcd95961ef..170316795a18 100644</span>
<span class="p_header">--- a/tools/perf/util/parse-events.c</span>
<span class="p_header">+++ b/tools/perf/util/parse-events.c</span>
<span class="p_chunk">@@ -1116,6 +1116,7 @@</span> <span class="p_context"> do {								\</span>
 	INIT_LIST_HEAD(&amp;__t-&gt;list);				\
 	__t-&gt;type       = PERF_EVSEL__CONFIG_TERM_ ## __type;	\
 	__t-&gt;val.__name = __val;				\
<span class="p_add">+	__t-&gt;weak	= term-&gt;weak;				\</span>
 	list_add_tail(&amp;__t-&gt;list, head_terms);			\
 } while (0)
 
<span class="p_chunk">@@ -2410,6 +2411,7 @@</span> <span class="p_context"> static int new_term(struct parse_events_term **_term,</span>
 
 	*term = *temp;
 	INIT_LIST_HEAD(&amp;term-&gt;list);
<span class="p_add">+	term-&gt;weak = false;</span>
 
 	switch (term-&gt;type_val) {
 	case PARSE_EVENTS__TERM_TYPE_NUM:
<span class="p_header">diff --git a/tools/perf/util/parse-events.h b/tools/perf/util/parse-events.h</span>
<span class="p_header">index be337c266697..88108cd11b4c 100644</span>
<span class="p_header">--- a/tools/perf/util/parse-events.h</span>
<span class="p_header">+++ b/tools/perf/util/parse-events.h</span>
<span class="p_chunk">@@ -101,6 +101,9 @@</span> <span class="p_context"> struct parse_events_term {</span>
 	/* error string indexes for within parsed string */
 	int err_term;
 	int err_val;
<span class="p_add">+</span>
<span class="p_add">+	/* Coming from implicit alias */</span>
<span class="p_add">+	bool weak;</span>
 };
 
 struct parse_events_error {
<span class="p_header">diff --git a/tools/perf/util/pmu.c b/tools/perf/util/pmu.c</span>
<span class="p_header">index 07cb2ac041d7..80fb1593913a 100644</span>
<span class="p_header">--- a/tools/perf/util/pmu.c</span>
<span class="p_header">+++ b/tools/perf/util/pmu.c</span>
<span class="p_chunk">@@ -405,6 +405,11 @@</span> <span class="p_context"> static int pmu_alias_terms(struct perf_pmu_alias *alias,</span>
 			parse_events_terms__purge(&amp;list);
 			return ret;
 		}
<span class="p_add">+		/*</span>
<span class="p_add">+		 * Weak terms don&#39;t override command line options,</span>
<span class="p_add">+		 * which we don&#39;t want for implicit terms in aliases.</span>
<span class="p_add">+		 */</span>
<span class="p_add">+		cloned-&gt;weak = true;</span>
 		list_add_tail(&amp;cloned-&gt;list, &amp;list);
 	}
 	list_splice(&amp;list, terms);

</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



