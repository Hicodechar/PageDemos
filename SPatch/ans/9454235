
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>[4.4,14/21] parisc: Fix races in parisc_setup_cache_timing() - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    [4.4,14/21] parisc: Fix races in parisc_setup_cache_timing()</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=37061">gregkh@linuxfoundation.org</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Nov. 30, 2016, 9:27 a.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;20161130092655.593967587@linuxfoundation.org&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/9454235/mbox/"
   >mbox</a>
|
   <a href="/patch/9454235/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/9454235/">/patch/9454235/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
	[172.30.200.125])
	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id
	C41C760757 for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 30 Nov 2016 11:34:21 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id A719928446
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 30 Nov 2016 11:34:21 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id 9C23228458; Wed, 30 Nov 2016 11:34:21 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-6.9 required=2.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 2FA112846D
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 30 Nov 2016 11:34:20 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S933917AbcK3KBD (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Wed, 30 Nov 2016 05:01:03 -0500
Received: from mail.linuxfoundation.org ([140.211.169.12]:60380 &quot;EHLO
	mail.linuxfoundation.org&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1754011AbcK3J2D (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Wed, 30 Nov 2016 04:28:03 -0500
Received: from localhost (pes75-3-78-192-101-3.fbxo.proxad.net
	[78.192.101.3])
	by mail.linuxfoundation.org (Postfix) with ESMTPSA id 462F6932;
	Wed, 30 Nov 2016 09:28:01 +0000 (UTC)
From: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
To: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;,
	stable@vger.kernel.org, John David Anglin &lt;dave.anglin@bell.net&gt;,
	Helge Deller &lt;deller@gmx.de&gt;
Subject: [PATCH 4.4 14/21] parisc: Fix races in parisc_setup_cache_timing()
Date: Wed, 30 Nov 2016 10:27:30 +0100
Message-Id: &lt;20161130092655.593967587@linuxfoundation.org&gt;
X-Mailer: git-send-email 2.10.2
In-Reply-To: &lt;20161130092654.890709900@linuxfoundation.org&gt;
References: &lt;20161130092654.890709900@linuxfoundation.org&gt;
User-Agent: quilt/0.65
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=37061">gregkh@linuxfoundation.org</a> - Nov. 30, 2016, 9:27 a.m.</div>
<pre class="content">
4.4-stable review patch.  If anyone has any objections, please let me know.

------------------
<span class="from">
From: John David Anglin &lt;dave.anglin@bell.net&gt;</span>

commit 741dc7bf1c7c7d93b853bb55efe77baa27e1b0a9 upstream.

Helge reported to me the following startup crash:

[    0.000000] Linux version 4.8.0-1-parisc64-smp (debian-kernel@lists.debian.org) (gcc version 5.4.1 20161019 (GCC) ) #1 SMP Debian 4.8.7-1 (2016-11-13)
[    0.000000] The 64-bit Kernel has started...
[    0.000000] Kernel default page size is 4 KB. Huge pages enabled with 1 MB physical and 2 MB virtual size.
[    0.000000] Determining PDC firmware type: System Map.
[    0.000000] model 9000/785/J5000
[    0.000000] Total Memory: 2048 MB
[    0.000000] Memory: 2018528K/2097152K available (9272K kernel code, 3053K rwdata, 1319K rodata, 1024K init, 840K bss, 78624K reserved, 0K cma-reserved)
[    0.000000] virtual kernel memory layout:
[    0.000000]     vmalloc : 0x0000000000008000 - 0x000000003f000000   (1007 MB)
[    0.000000]     memory  : 0x0000000040000000 - 0x00000000c0000000   (2048 MB)
[    0.000000]       .init : 0x0000000040100000 - 0x0000000040200000   (1024 kB)
[    0.000000]       .data : 0x0000000040b0e000 - 0x0000000040f533e0   (4372 kB)
[    0.000000]       .text : 0x0000000040200000 - 0x0000000040b0e000   (9272 kB)
[    0.768910] Brought up 1 CPUs
[    0.992465] NET: Registered protocol family 16
[    2.429981] Releasing cpu 1 now, hpa=fffffffffffa2000
[    2.635751] CPU(s): 2 out of 2 PA8500 (PCX-W) at 440.000000 MHz online
[    2.726692] Setting cache flush threshold to 1024 kB
[    2.729932] Not-handled unaligned insn 0x43ffff80
[    2.798114] Setting TLB flush threshold to 140 kB
[    2.928039] Unaligned handler failed, ret = -1
[    3.000419]       _______________________________
[    3.000419]      &lt; Your System ate a SPARC! Gah! &gt;
[    3.000419]       -------------------------------
[    3.000419]              \   ^__^
[    3.000419]                  (__)\       )\/\
[    3.000419]                   U  ||----w |
[    3.000419]                      ||     ||
[    9.340055] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 4.8.0-1-parisc64-smp #1 Debian 4.8.7-1
[    9.448082] task: 00000000bfd48060 task.stack: 00000000bfd50000
[    9.528040]
[   10.760029] IASQ: 0000000000000000 0000000000000000 IAOQ: 000000004025d154 000000004025d158
[   10.868052]  IIR: 43ffff80    ISR: 0000000000340000  IOR: 000001ff54150960
[   10.960029]  CPU:        1   CR30: 00000000bfd50000 CR31: 0000000011111111
[   11.052057]  ORIG_R28: 000000004021e3b4
[   11.100045]  IAOQ[0]: irq_exit+0x94/0x120
[   11.152062]  IAOQ[1]: irq_exit+0x98/0x120
[   11.208031]  RP(r2): irq_exit+0xb8/0x120
[   11.256074] Backtrace:
[   11.288067]  [&lt;00000000402cd944&gt;] cpu_startup_entry+0x1e4/0x598
[   11.368058]  [&lt;0000000040109528&gt;] smp_callin+0x2c0/0x2f0
[   11.436308]  [&lt;00000000402b53fc&gt;] update_curr+0x18c/0x2d0
[   11.508055]  [&lt;00000000402b73b8&gt;] dequeue_entity+0x2c0/0x1030
[   11.584040]  [&lt;00000000402b3cc0&gt;] set_next_entity+0x80/0xd30
[   11.660069]  [&lt;00000000402c1594&gt;] pick_next_task_fair+0x614/0x720
[   11.740085]  [&lt;000000004020dd34&gt;] __schedule+0x394/0xa60
[   11.808054]  [&lt;000000004020e488&gt;] schedule+0x88/0x118
[   11.876039]  [&lt;0000000040283d3c&gt;] rescuer_thread+0x4d4/0x5b0
[   11.948090]  [&lt;000000004028fc4c&gt;] kthread+0x1ec/0x248
[   12.016053]  [&lt;0000000040205020&gt;] end_fault_vector+0x20/0xc0
[   12.092239]  [&lt;00000000402050c0&gt;] _switch_to_ret+0x0/0xf40
[   12.164044]
[   12.184036] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 4.8.0-1-parisc64-smp #1 Debian 4.8.7-1
[   12.244040] Backtrace:
[   12.244040]  [&lt;000000004021c480&gt;] show_stack+0x68/0x80
[   12.244040]  [&lt;00000000406f332c&gt;] dump_stack+0xec/0x168
[   12.244040]  [&lt;000000004021c74c&gt;] die_if_kernel+0x25c/0x430
[   12.244040]  [&lt;000000004022d320&gt;] handle_unaligned+0xb48/0xb50
[   12.244040]
[   12.632066] ---[ end trace 9ca05a7215c7bbb2 ]---
[   12.692036] Kernel panic - not syncing: Attempted to kill the idle task!

We have the insn 0x43ffff80 in IIR but from IAOQ we should have:
   4025d150:   0f f3 20 df     ldd,s r19(r31),r31
   4025d154:   0f 9f 00 9c     ldw r31(ret0),ret0
   4025d158:   bf 80 20 58     cmpb,*&lt;&gt; r0,ret0,4025d18c &lt;irq_exit+0xcc&gt;

Cpu0 has just completed running parisc_setup_cache_timing:

[    2.429981] Releasing cpu 1 now, hpa=fffffffffffa2000
[    2.635751] CPU(s): 2 out of 2 PA8500 (PCX-W) at 440.000000 MHz online
[    2.726692] Setting cache flush threshold to 1024 kB
[    2.729932] Not-handled unaligned insn 0x43ffff80
[    2.798114] Setting TLB flush threshold to 140 kB
[    2.928039] Unaligned handler failed, ret = -1
<span class="quote">
&gt;From the backtrace, cpu1 is in smp_callin:</span>

void __init smp_callin(void)
{
       int slave_id = cpu_now_booting;

       smp_cpu_init(slave_id);
       preempt_disable();

       flush_cache_all_local(); /* start with known state */
       flush_tlb_all_local(NULL);

       local_irq_enable();  /* Interrupts have been off until now */

       cpu_startup_entry(CPUHP_AP_ONLINE_IDLE);

So, it has just flushed its caches and the TLB. It would seem either the
flushes in parisc_setup_cache_timing or smp_callin have corrupted kernel
memory.

The attached patch reworks parisc_setup_cache_timing to remove the races
in setting the cache and TLB flush thresholds. It also corrects the
number of bytes flushed in the TLB calculation.

The patch flushes the cache and TLB on cpu0 before starting the
secondary processors so that they are started from a known state.

Tested with a few reboots on c8000.
<span class="signed-off-by">
Signed-off-by: John David Anglin  &lt;dave.anglin@bell.net&gt;</span>
<span class="signed-off-by">Signed-off-by: Helge Deller &lt;deller@gmx.de&gt;</span>
<span class="signed-off-by">Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</span>

---
 arch/parisc/kernel/cache.c |   31 ++++++++++++-------------------
 arch/parisc/kernel/setup.c |    4 ++++
 2 files changed, 16 insertions(+), 19 deletions(-)
</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
<span class="p_header">--- a/arch/parisc/kernel/cache.c</span>
<span class="p_header">+++ b/arch/parisc/kernel/cache.c</span>
<span class="p_chunk">@@ -351,6 +351,7 @@</span> <span class="p_context"> void __init parisc_setup_cache_timing(vo</span>
 {
 	unsigned long rangetime, alltime;
 	unsigned long size, start;
<span class="p_add">+	unsigned long threshold;</span>
 
 	alltime = mfctl(16);
 	flush_data_cache();
<span class="p_chunk">@@ -364,17 +365,12 @@</span> <span class="p_context"> void __init parisc_setup_cache_timing(vo</span>
 	printk(KERN_DEBUG &quot;Whole cache flush %lu cycles, flushing %lu bytes %lu cycles\n&quot;,
 		alltime, size, rangetime);
 
<span class="p_del">-	/* Racy, but if we see an intermediate value, it&#39;s ok too... */</span>
<span class="p_del">-	parisc_cache_flush_threshold = size * alltime / rangetime;</span>
<span class="p_del">-</span>
<span class="p_del">-	parisc_cache_flush_threshold = L1_CACHE_ALIGN(parisc_cache_flush_threshold);</span>
<span class="p_del">-	if (!parisc_cache_flush_threshold)</span>
<span class="p_del">-		parisc_cache_flush_threshold = FLUSH_THRESHOLD;</span>
<span class="p_del">-</span>
<span class="p_del">-	if (parisc_cache_flush_threshold &gt; cache_info.dc_size)</span>
<span class="p_del">-		parisc_cache_flush_threshold = cache_info.dc_size;</span>
<span class="p_del">-</span>
<span class="p_del">-	printk(KERN_INFO &quot;Setting cache flush threshold to %lu kB\n&quot;,</span>
<span class="p_add">+	threshold = L1_CACHE_ALIGN(size * alltime / rangetime);</span>
<span class="p_add">+	if (threshold &gt; cache_info.dc_size)</span>
<span class="p_add">+		threshold = cache_info.dc_size;</span>
<span class="p_add">+	if (threshold)</span>
<span class="p_add">+		parisc_cache_flush_threshold = threshold;</span>
<span class="p_add">+	printk(KERN_INFO &quot;Cache flush threshold set to %lu KiB\n&quot;,</span>
 		parisc_cache_flush_threshold/1024);
 
 	/* calculate TLB flush threshold */
<span class="p_chunk">@@ -383,7 +379,7 @@</span> <span class="p_context"> void __init parisc_setup_cache_timing(vo</span>
 	flush_tlb_all();
 	alltime = mfctl(16) - alltime;
 
<span class="p_del">-	size = PAGE_SIZE;</span>
<span class="p_add">+	size = 0;</span>
 	start = (unsigned long) _text;
 	rangetime = mfctl(16);
 	while (start &lt; (unsigned long) _end) {
<span class="p_chunk">@@ -396,13 +392,10 @@</span> <span class="p_context"> void __init parisc_setup_cache_timing(vo</span>
 	printk(KERN_DEBUG &quot;Whole TLB flush %lu cycles, flushing %lu bytes %lu cycles\n&quot;,
 		alltime, size, rangetime);
 
<span class="p_del">-	parisc_tlb_flush_threshold = size * alltime / rangetime;</span>
<span class="p_del">-	parisc_tlb_flush_threshold *= num_online_cpus();</span>
<span class="p_del">-	parisc_tlb_flush_threshold = PAGE_ALIGN(parisc_tlb_flush_threshold);</span>
<span class="p_del">-	if (!parisc_tlb_flush_threshold)</span>
<span class="p_del">-		parisc_tlb_flush_threshold = FLUSH_TLB_THRESHOLD;</span>
<span class="p_del">-</span>
<span class="p_del">-	printk(KERN_INFO &quot;Setting TLB flush threshold to %lu kB\n&quot;,</span>
<span class="p_add">+	threshold = PAGE_ALIGN(num_online_cpus() * size * alltime / rangetime);</span>
<span class="p_add">+	if (threshold)</span>
<span class="p_add">+		parisc_tlb_flush_threshold = threshold;</span>
<span class="p_add">+	printk(KERN_INFO &quot;TLB flush threshold set to %lu KiB\n&quot;,</span>
 		parisc_tlb_flush_threshold/1024);
 }
 
<span class="p_header">--- a/arch/parisc/kernel/setup.c</span>
<span class="p_header">+++ b/arch/parisc/kernel/setup.c</span>
<span class="p_chunk">@@ -334,6 +334,10 @@</span> <span class="p_context"> static int __init parisc_init(void)</span>
 	/* tell PDC we&#39;re Linux. Nevermind failure. */
 	pdc_stable_write(0x40, &amp;osid, sizeof(osid));
 	
<span class="p_add">+	/* start with known state */</span>
<span class="p_add">+	flush_cache_all_local();</span>
<span class="p_add">+	flush_tlb_all_local(NULL);</span>
<span class="p_add">+</span>
 	processor_init();
 #ifdef CONFIG_SMP
 	pr_info(&quot;CPU(s): %d out of %d %s at %d.%06d MHz online\n&quot;,

</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



