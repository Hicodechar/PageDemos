
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>[11/33] dma-mapping: move swiotlb arch helpers to a new header - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    [11/33] dma-mapping: move swiotlb arch helpers to a new header</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=99">Christoph Hellwig</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Jan. 10, 2018, 8 a.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;20180110080027.13879-12-hch@lst.de&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/10154489/mbox/"
   >mbox</a>
|
   <a href="/patch/10154489/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/10154489/">/patch/10154489/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
	[172.30.200.125])
	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id
	3F5DE602D8 for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 10 Jan 2018 08:17:17 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 3224927FA9
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 10 Jan 2018 08:17:17 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id 25E6E28112; Wed, 10 Jan 2018 08:17:17 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-6.8 required=2.0 tests=BAYES_00,DKIM_SIGNED,
	RCVD_IN_DNSWL_HI,T_DKIM_INVALID autolearn=unavailable version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id C082527FA9
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 10 Jan 2018 08:17:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S965288AbeAJIBT (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Wed, 10 Jan 2018 03:01:19 -0500
Received: from bombadil.infradead.org ([65.50.211.133]:37479 &quot;EHLO
	bombadil.infradead.org&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S965157AbeAJIBM (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Wed, 10 Jan 2018 03:01:12 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=infradead.org; s=bombadil.20170209;
	h=References:In-Reply-To:Message-Id:
	Date:Subject:Cc:To:From:Sender:Reply-To:MIME-Version:Content-Type:
	Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
	Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
	List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
	bh=Kv4SsLqnU/WwHiAJ90njeFom65Azwk4VfG+bZiaTqfs=;
	b=Dqp7OqBzMKuYPWycr/pXtuIw5
	uxVqjb1Xn42f1Jsisx4vAnOtwT+RJRHjPzQVuhPA7WS7Etg/A9BHKev8qsfOuw/fgwPkAWlDsO7GJ
	2VPVmwjW6AxjP96NRvsATAqH0EuoMhL49TkzqtOupNRtC0SwgwdxAQYS1JtxGFplZwq2DdjFAwaIZ
	bs1UB/4RbDP7KyCDSwS4UBD23kDRcOlzJtI+EknpzpQoDb+No5rJa8H3WbpxxKc10U0dcT+cVht+B
	OlrX2nY+BpeHHaPnb1D4PxmoOGhRkgtveyQWaDOtvd3Wl0OaC7yDrvMSgAiWgOFpfziHS32hv3HNb
	UhCF2Lq5Q==;
Received: from clnet-p099-196.ikbnet.co.at ([83.175.99.196] helo=localhost)
	by bombadil.infradead.org with esmtpsa (Exim 4.89 #1 (Red Hat
	Linux)) id 1eZBJn-0004TX-Vv; Wed, 10 Jan 2018 08:01:04 +0000
From: Christoph Hellwig &lt;hch@lst.de&gt;
To: iommu@lists.linux-foundation.org
Cc: Konrad Rzeszutek Wilk &lt;konrad@darnok.org&gt;,
	linux-alpha@vger.kernel.org, linux-snps-arc@lists.infradead.org,
	linux-arm-kernel@lists.infradead.org, linux-c6x-dev@linux-c6x.org,
	linux-cris-kernel@axis.com, linux-hexagon@vger.kernel.org,
	linux-ia64@vger.kernel.org, linux-m68k@lists.linux-m68k.org,
	linux-metag@vger.kernel.org, Michal Simek &lt;monstr@monstr.eu&gt;,
	linux-mips@linux-mips.org, linux-parisc@vger.kernel.org,
	linuxppc-dev@lists.ozlabs.org, patches@groups.riscv.org,
	linux-s390@vger.kernel.org, linux-sh@vger.kernel.org,
	sparclinux@vger.kernel.org, Guan Xuetao &lt;gxt@mprc.pku.edu.cn&gt;,
	x86@kernel.org, linux-arch@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: [PATCH 11/33] dma-mapping: move swiotlb arch helpers to a new header
Date: Wed, 10 Jan 2018 09:00:05 +0100
Message-Id: &lt;20180110080027.13879-12-hch@lst.de&gt;
X-Mailer: git-send-email 2.14.2
In-Reply-To: &lt;20180110080027.13879-1-hch@lst.de&gt;
References: &lt;20180110080027.13879-1-hch@lst.de&gt;
X-SRS-Rewrite: SMTP reverse-path rewritten from &lt;hch@infradead.org&gt; by
	bombadil.infradead.org. See http://www.infradead.org/rpr.html
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=99">Christoph Hellwig</a> - Jan. 10, 2018, 8 a.m.</div>
<pre class="content">
phys_to_dma, dma_to_phys and dma_capable are helpers published by
architecture code for use of swiotlb and xen-swiotlb only.  Drivers are
not supposed to use these directly, but use the DMA API instead.

Move these to a new asm/dma-direct.h helper, included by a
linux/dma-direct.h wrapper that provides the default linear mapping
unless the architecture wants to override it.
<span class="signed-off-by">
Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;</span>
---
 MAINTAINERS                                        |  1 +
 arch/Kconfig                                       |  4 +++
 arch/arm/Kconfig                                   |  1 +
 arch/arm/include/asm/dma-direct.h                  | 36 ++++++++++++++++++++++
 arch/arm/include/asm/dma-mapping.h                 | 31 -------------------
 arch/arm64/include/asm/dma-mapping.h               | 22 -------------
 arch/arm64/mm/dma-mapping.c                        |  2 +-
 arch/ia64/include/asm/dma-mapping.h                | 18 -----------
 arch/mips/Kconfig                                  |  2 ++
 arch/mips/include/asm/dma-direct.h                 |  1 +
 arch/mips/include/asm/dma-mapping.h                |  8 -----
 .../include/asm/mach-cavium-octeon/dma-coherence.h |  8 +++++
 arch/mips/include/asm/mach-generic/dma-coherence.h | 12 --------
 .../include/asm/mach-loongson64/dma-coherence.h    |  8 +++++
 arch/powerpc/Kconfig                               |  1 +
 arch/powerpc/include/asm/dma-direct.h              | 29 +++++++++++++++++
 arch/powerpc/include/asm/dma-mapping.h             | 25 ---------------
 arch/tile/include/asm/dma-mapping.h                | 18 -----------
 arch/unicore32/include/asm/dma-mapping.h           | 18 -----------
 arch/x86/Kconfig                                   |  1 +
 arch/x86/include/asm/dma-direct.h                  | 30 ++++++++++++++++++
 arch/x86/include/asm/dma-mapping.h                 | 26 ----------------
 arch/x86/kernel/amd_gart_64.c                      |  1 +
 arch/x86/kernel/pci-dma.c                          |  2 +-
 arch/x86/kernel/pci-nommu.c                        |  2 +-
 arch/x86/kernel/pci-swiotlb.c                      |  2 +-
 arch/x86/mm/mem_encrypt.c                          |  2 +-
 arch/x86/pci/sta2x11-fixup.c                       |  1 +
 arch/xtensa/include/asm/dma-mapping.h              | 10 ------
 drivers/crypto/marvell/cesa.c                      |  1 +
 drivers/mtd/nand/qcom_nandc.c                      |  1 +
 drivers/xen/swiotlb-xen.c                          |  2 +-
 include/linux/dma-direct.h                         | 32 +++++++++++++++++++
 lib/swiotlb.c                                      |  2 +-
 34 files changed, 165 insertions(+), 195 deletions(-)
 create mode 100644 arch/arm/include/asm/dma-direct.h
 create mode 100644 arch/mips/include/asm/dma-direct.h
 create mode 100644 arch/powerpc/include/asm/dma-direct.h
 create mode 100644 arch/x86/include/asm/dma-direct.h
 create mode 100644 include/linux/dma-direct.h
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109631">Vladimir Murzin</a> - Jan. 10, 2018, 9:31 a.m.</div>
<pre class="content">
On 10/01/18 08:00, Christoph Hellwig wrote:
<span class="quote">&gt; index 9110988b92a1..f00833acb626 100644</span>
<span class="quote">&gt; --- a/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h</span>
<span class="quote">&gt; +++ b/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h</span>
<span class="quote">&gt; @@ -61,6 +61,14 @@ static inline void plat_post_dma_flush(struct device *dev)</span>
<span class="quote">&gt;  {</span>
<span class="quote">&gt;  }</span>
<span class="quote">&gt;  </span>
<span class="quote">&gt; +static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="quote">&gt; +{</span>
<span class="quote">&gt; +	if (!dev-&gt;dma_mask)</span>
<span class="quote">&gt; +		return false;</span>
<span class="quote">&gt; +</span>
<span class="quote">&gt; +	return addr + size &lt;= *dev-&gt;dma_mask;</span>
<span class="quote">&gt; +}</span>
<span class="quote">&gt; +</span>

I know it is copy&amp;paste, but it seems it has off by one error and it should be

return addr + size - 1 &lt;= *dev-&gt;dma_mask;
<span class="quote">

&gt;  dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr);</span>
<span class="quote">&gt;  phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr);</span>
<span class="quote">&gt;  </span>

snip...
<span class="quote">
&gt; diff --git a/arch/mips/include/asm/mach-loongson64/dma-coherence.h b/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="quote">&gt; index 1602a9e9e8c2..5cfda8f893e9 100644</span>
<span class="quote">&gt; --- a/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="quote">&gt; +++ b/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="quote">&gt; @@ -17,6 +17,14 @@</span>
<span class="quote">&gt;  </span>
<span class="quote">&gt;  struct device;</span>
<span class="quote">&gt;  </span>
<span class="quote">&gt; +static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="quote">&gt; +{</span>
<span class="quote">&gt; +	if (!dev-&gt;dma_mask)</span>
<span class="quote">&gt; +		return false;</span>
<span class="quote">&gt; +</span>
<span class="quote">&gt; +	return addr + size &lt;= *dev-&gt;dma_mask;</span>


ditto

Cheers
Vladimir
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=77581">Robin Murphy</a> - Jan. 10, 2018, 2:56 p.m.</div>
<pre class="content">
On 10/01/18 08:00, Christoph Hellwig wrote:
<span class="quote">&gt; phys_to_dma, dma_to_phys and dma_capable are helpers published by</span>
<span class="quote">&gt; architecture code for use of swiotlb and xen-swiotlb only.  Drivers are</span>
<span class="quote">&gt; not supposed to use these directly, but use the DMA API instead.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Move these to a new asm/dma-direct.h helper, included by a</span>
<span class="quote">&gt; linux/dma-direct.h wrapper that provides the default linear mapping</span>
<span class="quote">&gt; unless the architecture wants to override it.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;</span>
<span class="quote">&gt; ---</span>
[...]
<span class="quote">&gt;   drivers/crypto/marvell/cesa.c                      |  1 +</span>
<span class="quote">&gt;   drivers/mtd/nand/qcom_nandc.c                      |  1 +</span>

I took a look at these, and it seems their phys_to_dma() usage is doing 
the thing which we subsequently formalised as dma_map_resource(). I&#39;ve 
had a crack at a quick patch to update the CESA driver; qcom_nandc looks 
slightly more complex in that the changes probably need to span the BAM 
dmaengine driver as well.

In the process, though, I stumbled across gen_pool_dma_alloc() - yuck, 
something needs doing there, for sure...

Robin.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=99">Christoph Hellwig</a> - Jan. 10, 2018, 3:22 p.m.</div>
<pre class="content">
On Wed, Jan 10, 2018 at 09:31:45AM +0000, Vladimir Murzin wrote:
<span class="quote">&gt; I know it is copy&amp;paste, but it seems it has off by one error and it should be</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>

I&#39;ve added a new patch to fix the mips dma_capable() definition,
thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=99">Christoph Hellwig</a> - Jan. 10, 2018, 3:26 p.m.</div>
<pre class="content">
On Wed, Jan 10, 2018 at 02:56:01PM +0000, Robin Murphy wrote:
<span class="quote">&gt; I took a look at these, and it seems their phys_to_dma() usage is doing the </span>
<span class="quote">&gt; thing which we subsequently formalised as dma_map_resource(). I&#39;ve had a </span>
<span class="quote">&gt; crack at a quick patch to update the CESA driver; qcom_nandc looks slightly </span>
<span class="quote">&gt; more complex in that the changes probably need to span the BAM dmaengine </span>
<span class="quote">&gt; driver as well.</span>

Sounds great, although probably something for the next merge window.

In the meantime does this patch looks good to you?
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=77581">Robin Murphy</a> - Jan. 10, 2018, 3:31 p.m.</div>
<pre class="content">
On 10/01/18 15:26, Christoph Hellwig wrote:
<span class="quote">&gt; On Wed, Jan 10, 2018 at 02:56:01PM +0000, Robin Murphy wrote:</span>
<span class="quote">&gt;&gt; I took a look at these, and it seems their phys_to_dma() usage is doing the</span>
<span class="quote">&gt;&gt; thing which we subsequently formalised as dma_map_resource(). I&#39;ve had a</span>
<span class="quote">&gt;&gt; crack at a quick patch to update the CESA driver; qcom_nandc looks slightly</span>
<span class="quote">&gt;&gt; more complex in that the changes probably need to span the BAM dmaengine</span>
<span class="quote">&gt;&gt; driver as well.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Sounds great, although probably something for the next merge window.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; In the meantime does this patch looks good to you?</span>

Yes indeed, modulo Vladimir&#39;s comments - it does seem prudent to fix the 
obvious off-by-ones as we touch them. I&#39;ve wanted to do something like 
this for ages, but never got around to it myself.

Thanks,
Robin.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=99">Christoph Hellwig</a> - Jan. 10, 2018, 3:40 p.m.</div>
<pre class="content">
On Wed, Jan 10, 2018 at 03:31:08PM +0000, Robin Murphy wrote:
<span class="quote">&gt; Yes indeed, modulo Vladimir&#39;s comments - it does seem prudent to fix the </span>
<span class="quote">&gt; obvious off-by-ones as we touch them. I&#39;ve wanted to do something like this </span>
<span class="quote">&gt; for ages, but never got around to it myself.</span>

I&#39;ve fixed these now in a separate patch.  I&#39;m taking this as an
Acked-by.
</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
<span class="p_header">diff --git a/MAINTAINERS b/MAINTAINERS</span>
<span class="p_header">index 95c3fa1f520f..d2cfdcce1db5 100644</span>
<span class="p_header">--- a/MAINTAINERS</span>
<span class="p_header">+++ b/MAINTAINERS</span>
<span class="p_chunk">@@ -4338,6 +4338,7 @@</span> <span class="p_context"> F:	lib/dma-noop.c</span>
 F:	lib/dma-virt.c
 F:	drivers/base/dma-mapping.c
 F:	drivers/base/dma-coherent.c
<span class="p_add">+F:	include/linux/dma-direct.h</span>
 F:	include/linux/dma-mapping.h
 
 DME1737 HARDWARE MONITOR DRIVER
<span class="p_header">diff --git a/arch/Kconfig b/arch/Kconfig</span>
<span class="p_header">index 400b9e1b2f27..3edf118ad777 100644</span>
<span class="p_header">--- a/arch/Kconfig</span>
<span class="p_header">+++ b/arch/Kconfig</span>
<span class="p_chunk">@@ -938,6 +938,10 @@</span> <span class="p_context"> config STRICT_MODULE_RWX</span>
 	  and non-text memory will be made non-executable. This provides
 	  protection against certain security exploits (e.g. writing to text)
 
<span class="p_add">+# select if the architecture provides an asm/dma-direct.h header</span>
<span class="p_add">+config ARCH_HAS_PHYS_TO_DMA</span>
<span class="p_add">+	bool</span>
<span class="p_add">+</span>
 config ARCH_HAS_REFCOUNT
 	bool
 	help
<span class="p_header">diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig</span>
<span class="p_header">index 51c8df561077..00d889a37965 100644</span>
<span class="p_header">--- a/arch/arm/Kconfig</span>
<span class="p_header">+++ b/arch/arm/Kconfig</span>
<span class="p_chunk">@@ -8,6 +8,7 @@</span> <span class="p_context"> config ARM</span>
 	select ARCH_HAS_DEVMEM_IS_ALLOWED
 	select ARCH_HAS_ELF_RANDOMIZE
 	select ARCH_HAS_SET_MEMORY
<span class="p_add">+	select ARCH_HAS_PHYS_TO_DMA</span>
 	select ARCH_HAS_STRICT_KERNEL_RWX if MMU &amp;&amp; !XIP_KERNEL
 	select ARCH_HAS_STRICT_MODULE_RWX if MMU
 	select ARCH_HAS_TICK_BROADCAST if GENERIC_CLOCKEVENTS_BROADCAST
<span class="p_header">diff --git a/arch/arm/include/asm/dma-direct.h b/arch/arm/include/asm/dma-direct.h</span>
new file mode 100644
<span class="p_header">index 000000000000..5b0a8a421894</span>
<span class="p_header">--- /dev/null</span>
<span class="p_header">+++ b/arch/arm/include/asm/dma-direct.h</span>
<span class="p_chunk">@@ -0,0 +1,36 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="p_add">+#ifndef ASM_ARM_DMA_DIRECT_H</span>
<span class="p_add">+#define ASM_ARM_DMA_DIRECT_H 1</span>
<span class="p_add">+</span>
<span class="p_add">+static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	unsigned int offset = paddr &amp; ~PAGE_MASK;</span>
<span class="p_add">+	return pfn_to_dma(dev, __phys_to_pfn(paddr)) + offset;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t dev_addr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	unsigned int offset = dev_addr &amp; ~PAGE_MASK;</span>
<span class="p_add">+	return __pfn_to_phys(dma_to_pfn(dev, dev_addr)) + offset;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+	u64 limit, mask;</span>
<span class="p_add">+</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return 0;</span>
<span class="p_add">+</span>
<span class="p_add">+	mask = *dev-&gt;dma_mask;</span>
<span class="p_add">+</span>
<span class="p_add">+	limit = (mask + 1) &amp; ~mask;</span>
<span class="p_add">+	if (limit &amp;&amp; size &gt; limit)</span>
<span class="p_add">+		return 0;</span>
<span class="p_add">+</span>
<span class="p_add">+	if ((addr | (addr + size - 1)) &amp; ~mask)</span>
<span class="p_add">+		return 0;</span>
<span class="p_add">+</span>
<span class="p_add">+	return 1;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+#endif /* ASM_ARM_DMA_DIRECT_H */</span>
<span class="p_header">diff --git a/arch/arm/include/asm/dma-mapping.h b/arch/arm/include/asm/dma-mapping.h</span>
<span class="p_header">index daf837423a76..5fb1b7fbdfbe 100644</span>
<span class="p_header">--- a/arch/arm/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/arm/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -109,37 +109,6 @@</span> <span class="p_context"> static inline bool is_device_dma_coherent(struct device *dev)</span>
 	return dev-&gt;archdata.dma_coherent;
 }
 
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned int offset = paddr &amp; ~PAGE_MASK;</span>
<span class="p_del">-	return pfn_to_dma(dev, __phys_to_pfn(paddr)) + offset;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t dev_addr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned int offset = dev_addr &amp; ~PAGE_MASK;</span>
<span class="p_del">-	return __pfn_to_phys(dma_to_pfn(dev, dev_addr)) + offset;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	u64 limit, mask;</span>
<span class="p_del">-</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	mask = *dev-&gt;dma_mask;</span>
<span class="p_del">-</span>
<span class="p_del">-	limit = (mask + 1) &amp; ~mask;</span>
<span class="p_del">-	if (limit &amp;&amp; size &gt; limit)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	if ((addr | (addr + size - 1)) &amp; ~mask)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	return 1;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static inline void dma_mark_clean(void *addr, size_t size) { }
 
 /**
<span class="p_header">diff --git a/arch/arm64/include/asm/dma-mapping.h b/arch/arm64/include/asm/dma-mapping.h</span>
<span class="p_header">index eada887a93bf..400fa67d3b5a 100644</span>
<span class="p_header">--- a/arch/arm64/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/arm64/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -50,28 +50,6 @@</span> <span class="p_context"> static inline bool is_device_dma_coherent(struct device *dev)</span>
 	return dev-&gt;archdata.dma_coherent;
 }
 
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	dma_addr_t dev_addr = (dma_addr_t)paddr;</span>
<span class="p_del">-</span>
<span class="p_del">-	return dev_addr - ((dma_addr_t)dev-&gt;dma_pfn_offset &lt;&lt; PAGE_SHIFT);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t dev_addr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	phys_addr_t paddr = (phys_addr_t)dev_addr;</span>
<span class="p_del">-</span>
<span class="p_del">-	return paddr + ((phys_addr_t)dev-&gt;dma_pfn_offset &lt;&lt; PAGE_SHIFT);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return false;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static inline void dma_mark_clean(void *addr, size_t size)
 {
 }
<span class="p_header">diff --git a/arch/arm64/mm/dma-mapping.c b/arch/arm64/mm/dma-mapping.c</span>
<span class="p_header">index b45c5bcaeccb..f3a637b98487 100644</span>
<span class="p_header">--- a/arch/arm64/mm/dma-mapping.c</span>
<span class="p_header">+++ b/arch/arm64/mm/dma-mapping.c</span>
<span class="p_chunk">@@ -24,7 +24,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/export.h&gt;
 #include &lt;linux/slab.h&gt;
 #include &lt;linux/genalloc.h&gt;
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/dma-contiguous.h&gt;
 #include &lt;linux/vmalloc.h&gt;
 #include &lt;linux/swiotlb.h&gt;
<span class="p_header">diff --git a/arch/ia64/include/asm/dma-mapping.h b/arch/ia64/include/asm/dma-mapping.h</span>
<span class="p_header">index c1bab526a046..eabee56d995c 100644</span>
<span class="p_header">--- a/arch/ia64/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/ia64/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -27,22 +27,4 @@</span> <span class="p_context"> static inline const struct dma_map_ops *get_arch_dma_ops(struct bus_type *bus)</span>
 	return platform_dma_get_ops(NULL);
 }
 
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return paddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return daddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 #endif /* _ASM_IA64_DMA_MAPPING_H */
<span class="p_header">diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig</span>
<span class="p_header">index 350a990fc719..4b0c26b2e9b7 100644</span>
<span class="p_header">--- a/arch/mips/Kconfig</span>
<span class="p_header">+++ b/arch/mips/Kconfig</span>
<span class="p_chunk">@@ -429,6 +429,7 @@</span> <span class="p_context"> config MACH_LOONGSON32</span>
 
 config MACH_LOONGSON64
 	bool &quot;Loongson-2/3 family of machines&quot;
<span class="p_add">+	select ARCH_HAS_PHYS_TO_DMA</span>
 	select SYS_SUPPORTS_ZBOOT
 	help
 	  This enables the support of Loongson-2/3 family of machines.
<span class="p_chunk">@@ -877,6 +878,7 @@</span> <span class="p_context"> config MIKROTIK_RB532</span>
 config CAVIUM_OCTEON_SOC
 	bool &quot;Cavium Networks Octeon SoC based boards&quot;
 	select CEVT_R4K
<span class="p_add">+	select ARCH_HAS_PHYS_TO_DMA</span>
 	select ARCH_PHYS_ADDR_T_64BIT
 	select DMA_COHERENT
 	select SYS_SUPPORTS_64BIT_KERNEL
<span class="p_header">diff --git a/arch/mips/include/asm/dma-direct.h b/arch/mips/include/asm/dma-direct.h</span>
new file mode 100644
<span class="p_header">index 000000000000..f32f15530aba</span>
<span class="p_header">--- /dev/null</span>
<span class="p_header">+++ b/arch/mips/include/asm/dma-direct.h</span>
<span class="p_chunk">@@ -0,0 +1 @@</span> <span class="p_context"></span>
<span class="p_add">+#include &lt;asm/dma-coherence.h&gt;</span>
<span class="p_header">diff --git a/arch/mips/include/asm/dma-mapping.h b/arch/mips/include/asm/dma-mapping.h</span>
<span class="p_header">index 0d9418d264f9..676c14cfc580 100644</span>
<span class="p_header">--- a/arch/mips/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/mips/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -17,14 +17,6 @@</span> <span class="p_context"> static inline const struct dma_map_ops *get_arch_dma_ops(struct bus_type *bus)</span>
 	return mips_dma_map_ops;
 }
 
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return false;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static inline void dma_mark_clean(void *addr, size_t size) {}
 
 #define arch_setup_dma_ops arch_setup_dma_ops
<span class="p_header">diff --git a/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h b/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h</span>
<span class="p_header">index 9110988b92a1..f00833acb626 100644</span>
<span class="p_header">--- a/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h</span>
<span class="p_header">+++ b/arch/mips/include/asm/mach-cavium-octeon/dma-coherence.h</span>
<span class="p_chunk">@@ -61,6 +61,14 @@</span> <span class="p_context"> static inline void plat_post_dma_flush(struct device *dev)</span>
 {
 }
 
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return false;</span>
<span class="p_add">+</span>
<span class="p_add">+	return addr + size &lt;= *dev-&gt;dma_mask;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr);
 phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr);
 
<span class="p_header">diff --git a/arch/mips/include/asm/mach-generic/dma-coherence.h b/arch/mips/include/asm/mach-generic/dma-coherence.h</span>
<span class="p_header">index 61addb1677e9..8ad7a40ca786 100644</span>
<span class="p_header">--- a/arch/mips/include/asm/mach-generic/dma-coherence.h</span>
<span class="p_header">+++ b/arch/mips/include/asm/mach-generic/dma-coherence.h</span>
<span class="p_chunk">@@ -70,16 +70,4 @@</span> <span class="p_context"> static inline void plat_post_dma_flush(struct device *dev)</span>
 }
 #endif
 
<span class="p_del">-#ifdef CONFIG_SWIOTLB</span>
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return paddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return daddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
 #endif /* __ASM_MACH_GENERIC_DMA_COHERENCE_H */
<span class="p_header">diff --git a/arch/mips/include/asm/mach-loongson64/dma-coherence.h b/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="p_header">index 1602a9e9e8c2..5cfda8f893e9 100644</span>
<span class="p_header">--- a/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="p_header">+++ b/arch/mips/include/asm/mach-loongson64/dma-coherence.h</span>
<span class="p_chunk">@@ -17,6 +17,14 @@</span> <span class="p_context"></span>
 
 struct device;
 
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return false;</span>
<span class="p_add">+</span>
<span class="p_add">+	return addr + size &lt;= *dev-&gt;dma_mask;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 extern dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr);
 extern phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr);
 static inline dma_addr_t plat_map_dma_mem(struct device *dev, void *addr,
<span class="p_header">diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig</span>
<span class="p_header">index c51e6ce42e7a..887285eb684a 100644</span>
<span class="p_header">--- a/arch/powerpc/Kconfig</span>
<span class="p_header">+++ b/arch/powerpc/Kconfig</span>
<span class="p_chunk">@@ -139,6 +139,7 @@</span> <span class="p_context"> config PPC</span>
 	select ARCH_HAS_ELF_RANDOMIZE
 	select ARCH_HAS_FORTIFY_SOURCE
 	select ARCH_HAS_GCOV_PROFILE_ALL
<span class="p_add">+	select ARCH_HAS_PHYS_TO_DMA</span>
 	select ARCH_HAS_PMEM_API                if PPC64
 	select ARCH_HAS_SCALED_CPUTIME		if VIRT_CPU_ACCOUNTING_NATIVE
 	select ARCH_HAS_SG_CHAIN
<span class="p_header">diff --git a/arch/powerpc/include/asm/dma-direct.h b/arch/powerpc/include/asm/dma-direct.h</span>
new file mode 100644
<span class="p_header">index 000000000000..a5b59c765426</span>
<span class="p_header">--- /dev/null</span>
<span class="p_header">+++ b/arch/powerpc/include/asm/dma-direct.h</span>
<span class="p_chunk">@@ -0,0 +1,29 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="p_add">+#ifndef ASM_POWERPC_DMA_DIRECT_H</span>
<span class="p_add">+#define ASM_POWERPC_DMA_DIRECT_H 1</span>
<span class="p_add">+</span>
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+#ifdef CONFIG_SWIOTLB</span>
<span class="p_add">+	struct dev_archdata *sd = &amp;dev-&gt;archdata;</span>
<span class="p_add">+</span>
<span class="p_add">+	if (sd-&gt;max_direct_dma_addr &amp;&amp; addr + size &gt; sd-&gt;max_direct_dma_addr)</span>
<span class="p_add">+		return false;</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return false;</span>
<span class="p_add">+</span>
<span class="p_add">+	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return paddr + get_dma_offset(dev);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return daddr - get_dma_offset(dev);</span>
<span class="p_add">+}</span>
<span class="p_add">+#endif /* ASM_POWERPC_DMA_DIRECT_H */</span>
<span class="p_header">diff --git a/arch/powerpc/include/asm/dma-mapping.h b/arch/powerpc/include/asm/dma-mapping.h</span>
<span class="p_header">index 592c7f418aa0..f6ab51205a85 100644</span>
<span class="p_header">--- a/arch/powerpc/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/powerpc/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -112,31 +112,6 @@</span> <span class="p_context"> extern int dma_set_mask(struct device *dev, u64 dma_mask);</span>
 
 extern u64 __dma_get_required_mask(struct device *dev);
 
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-#ifdef CONFIG_SWIOTLB</span>
<span class="p_del">-	struct dev_archdata *sd = &amp;dev-&gt;archdata;</span>
<span class="p_del">-</span>
<span class="p_del">-	if (sd-&gt;max_direct_dma_addr &amp;&amp; addr + size &gt; sd-&gt;max_direct_dma_addr)</span>
<span class="p_del">-		return false;</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return false;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return paddr + get_dma_offset(dev);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return daddr - get_dma_offset(dev);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 #define ARCH_HAS_DMA_MMAP_COHERENT
 
 #endif /* __KERNEL__ */
<span class="p_header">diff --git a/arch/tile/include/asm/dma-mapping.h b/arch/tile/include/asm/dma-mapping.h</span>
<span class="p_header">index 97ad62878290..75b8aaa4e70b 100644</span>
<span class="p_header">--- a/arch/tile/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/tile/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -44,26 +44,8 @@</span> <span class="p_context"> static inline void set_dma_offset(struct device *dev, dma_addr_t off)</span>
 	dev-&gt;archdata.dma_offset = off;
 }
 
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return paddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return daddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static inline void dma_mark_clean(void *addr, size_t size) {}
 
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 #define HAVE_ARCH_DMA_SET_MASK 1
 int dma_set_mask(struct device *dev, u64 mask);
 
<span class="p_header">diff --git a/arch/unicore32/include/asm/dma-mapping.h b/arch/unicore32/include/asm/dma-mapping.h</span>
<span class="p_header">index ac608c2f6af6..5cb250bf2d8c 100644</span>
<span class="p_header">--- a/arch/unicore32/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/unicore32/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -25,24 +25,6 @@</span> <span class="p_context"> static inline const struct dma_map_ops *get_arch_dma_ops(struct bus_type *bus)</span>
 	return &amp;swiotlb_dma_map_ops;
 }
 
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (dev &amp;&amp; dev-&gt;dma_mask)</span>
<span class="p_del">-		return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-</span>
<span class="p_del">-	return 1;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return paddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return daddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static inline void dma_mark_clean(void *addr, size_t size) {}
 
 #endif /* __KERNEL__ */
<span class="p_header">diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig</span>
<span class="p_header">index d4fc98c50378..f6f4328103c0 100644</span>
<span class="p_header">--- a/arch/x86/Kconfig</span>
<span class="p_header">+++ b/arch/x86/Kconfig</span>
<span class="p_chunk">@@ -54,6 +54,7 @@</span> <span class="p_context"> config X86</span>
 	select ARCH_HAS_FORTIFY_SOURCE
 	select ARCH_HAS_GCOV_PROFILE_ALL
 	select ARCH_HAS_KCOV			if X86_64
<span class="p_add">+	select ARCH_HAS_PHYS_TO_DMA</span>
 	select ARCH_HAS_PMEM_API		if X86_64
 	# Causing hangs/crashes, see the commit that added this change for details.
 	select ARCH_HAS_REFCOUNT
<span class="p_header">diff --git a/arch/x86/include/asm/dma-direct.h b/arch/x86/include/asm/dma-direct.h</span>
new file mode 100644
<span class="p_header">index 000000000000..1295bc622ebe</span>
<span class="p_header">--- /dev/null</span>
<span class="p_header">+++ b/arch/x86/include/asm/dma-direct.h</span>
<span class="p_chunk">@@ -0,0 +1,30 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="p_add">+#ifndef ASM_X86_DMA_DIRECT_H</span>
<span class="p_add">+#define ASM_X86_DMA_DIRECT_H 1</span>
<span class="p_add">+</span>
<span class="p_add">+#include &lt;linux/mem_encrypt.h&gt;</span>
<span class="p_add">+</span>
<span class="p_add">+#ifdef CONFIG_X86_DMA_REMAP /* Platform code defines bridge-specific code */</span>
<span class="p_add">+bool dma_capable(struct device *dev, dma_addr_t addr, size_t size);</span>
<span class="p_add">+dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr);</span>
<span class="p_add">+phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr);</span>
<span class="p_add">+#else</span>
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return 0;</span>
<span class="p_add">+</span>
<span class="p_add">+	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return __sme_set(paddr);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return __sme_clr(daddr);</span>
<span class="p_add">+}</span>
<span class="p_add">+#endif /* CONFIG_X86_DMA_REMAP */</span>
<span class="p_add">+#endif /* ASM_X86_DMA_DIRECT_H */</span>
<span class="p_header">diff --git a/arch/x86/include/asm/dma-mapping.h b/arch/x86/include/asm/dma-mapping.h</span>
<span class="p_header">index 0350d99bb8fd..dfdc9357a349 100644</span>
<span class="p_header">--- a/arch/x86/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/x86/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -12,7 +12,6 @@</span> <span class="p_context"></span>
 #include &lt;asm/io.h&gt;
 #include &lt;asm/swiotlb.h&gt;
 #include &lt;linux/dma-contiguous.h&gt;
<span class="p_del">-#include &lt;linux/mem_encrypt.h&gt;</span>
 
 #ifdef CONFIG_ISA
 # define ISA_DMA_BIT_MASK DMA_BIT_MASK(24)
<span class="p_chunk">@@ -42,31 +41,6 @@</span> <span class="p_context"> extern void dma_generic_free_coherent(struct device *dev, size_t size,</span>
 				      void *vaddr, dma_addr_t dma_addr,
 				      unsigned long attrs);
 
<span class="p_del">-#ifdef CONFIG_X86_DMA_REMAP /* Platform code defines bridge-specific code */</span>
<span class="p_del">-extern bool dma_capable(struct device *dev, dma_addr_t addr, size_t size);</span>
<span class="p_del">-extern dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr);</span>
<span class="p_del">-extern phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr);</span>
<span class="p_del">-#else</span>
<span class="p_del">-</span>
<span class="p_del">-static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	if (!dev-&gt;dma_mask)</span>
<span class="p_del">-		return 0;</span>
<span class="p_del">-</span>
<span class="p_del">-	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return __sme_set(paddr);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return __sme_clr(daddr);</span>
<span class="p_del">-}</span>
<span class="p_del">-#endif /* CONFIG_X86_DMA_REMAP */</span>
<span class="p_del">-</span>
 static inline unsigned long dma_alloc_coherent_mask(struct device *dev,
 						    gfp_t gfp)
 {
<span class="p_header">diff --git a/arch/x86/kernel/amd_gart_64.c b/arch/x86/kernel/amd_gart_64.c</span>
<span class="p_header">index cc0e8bc0ea3f..ecd486cb06ab 100644</span>
<span class="p_header">--- a/arch/x86/kernel/amd_gart_64.c</span>
<span class="p_header">+++ b/arch/x86/kernel/amd_gart_64.c</span>
<span class="p_chunk">@@ -31,6 +31,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/io.h&gt;
 #include &lt;linux/gfp.h&gt;
 #include &lt;linux/atomic.h&gt;
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;asm/mtrr.h&gt;
 #include &lt;asm/pgtable.h&gt;
 #include &lt;asm/proto.h&gt;
<span class="p_header">diff --git a/arch/x86/kernel/pci-dma.c b/arch/x86/kernel/pci-dma.c</span>
<span class="p_header">index 599d7462eccc..8439e6de6156 100644</span>
<span class="p_header">--- a/arch/x86/kernel/pci-dma.c</span>
<span class="p_header">+++ b/arch/x86/kernel/pci-dma.c</span>
<span class="p_chunk">@@ -1,5 +1,5 @@</span> <span class="p_context"></span>
 // SPDX-License-Identifier: GPL-2.0
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/dma-debug.h&gt;
 #include &lt;linux/dmar.h&gt;
 #include &lt;linux/export.h&gt;
<span class="p_header">diff --git a/arch/x86/kernel/pci-nommu.c b/arch/x86/kernel/pci-nommu.c</span>
<span class="p_header">index b0caae27e1b7..618285e475c6 100644</span>
<span class="p_header">--- a/arch/x86/kernel/pci-nommu.c</span>
<span class="p_header">+++ b/arch/x86/kernel/pci-nommu.c</span>
<span class="p_chunk">@@ -1,7 +1,7 @@</span> <span class="p_context"></span>
 // SPDX-License-Identifier: GPL-2.0
 /* Fallback functions when the main IOMMU code is not compiled in. This
    code is roughly equivalent to i386. */
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/scatterlist.h&gt;
 #include &lt;linux/string.h&gt;
 #include &lt;linux/gfp.h&gt;
<span class="p_header">diff --git a/arch/x86/kernel/pci-swiotlb.c b/arch/x86/kernel/pci-swiotlb.c</span>
<span class="p_header">index 53bd05ea90d8..9d3e35c33d94 100644</span>
<span class="p_header">--- a/arch/x86/kernel/pci-swiotlb.c</span>
<span class="p_header">+++ b/arch/x86/kernel/pci-swiotlb.c</span>
<span class="p_chunk">@@ -6,7 +6,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/init.h&gt;
 #include &lt;linux/swiotlb.h&gt;
 #include &lt;linux/bootmem.h&gt;
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/mem_encrypt.h&gt;
 
 #include &lt;asm/iommu.h&gt;
<span class="p_header">diff --git a/arch/x86/mm/mem_encrypt.c b/arch/x86/mm/mem_encrypt.c</span>
<span class="p_header">index 391b13402e40..09532c935da0 100644</span>
<span class="p_header">--- a/arch/x86/mm/mem_encrypt.c</span>
<span class="p_header">+++ b/arch/x86/mm/mem_encrypt.c</span>
<span class="p_chunk">@@ -15,7 +15,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/linkage.h&gt;
 #include &lt;linux/init.h&gt;
 #include &lt;linux/mm.h&gt;
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/swiotlb.h&gt;
 #include &lt;linux/mem_encrypt.h&gt;
 
<span class="p_header">diff --git a/arch/x86/pci/sta2x11-fixup.c b/arch/x86/pci/sta2x11-fixup.c</span>
<span class="p_header">index 53d600217973..75577c1490c4 100644</span>
<span class="p_header">--- a/arch/x86/pci/sta2x11-fixup.c</span>
<span class="p_header">+++ b/arch/x86/pci/sta2x11-fixup.c</span>
<span class="p_chunk">@@ -26,6 +26,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/pci_ids.h&gt;
 #include &lt;linux/export.h&gt;
 #include &lt;linux/list.h&gt;
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;asm/iommu.h&gt;
 
 #define STA2X11_SWIOTLB_SIZE (4*1024*1024)
<span class="p_header">diff --git a/arch/xtensa/include/asm/dma-mapping.h b/arch/xtensa/include/asm/dma-mapping.h</span>
<span class="p_header">index 153bf2370988..44098800dad7 100644</span>
<span class="p_header">--- a/arch/xtensa/include/asm/dma-mapping.h</span>
<span class="p_header">+++ b/arch/xtensa/include/asm/dma-mapping.h</span>
<span class="p_chunk">@@ -23,14 +23,4 @@</span> <span class="p_context"> static inline const struct dma_map_ops *get_arch_dma_ops(struct bus_type *bus)</span>
 	return &amp;xtensa_dma_map_ops;
 }
 
<span class="p_del">-static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return (dma_addr_t)paddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)</span>
<span class="p_del">-{</span>
<span class="p_del">-	return (phys_addr_t)daddr;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 #endif	/* _XTENSA_DMA_MAPPING_H */
<span class="p_header">diff --git a/drivers/crypto/marvell/cesa.c b/drivers/crypto/marvell/cesa.c</span>
<span class="p_header">index 293832488cc9..3a0c40081ffb 100644</span>
<span class="p_header">--- a/drivers/crypto/marvell/cesa.c</span>
<span class="p_header">+++ b/drivers/crypto/marvell/cesa.c</span>
<span class="p_chunk">@@ -24,6 +24,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/scatterlist.h&gt;
 #include &lt;linux/slab.h&gt;
 #include &lt;linux/module.h&gt;
<span class="p_add">+#include &lt;linux/dma-direct.h&gt; /* XXX: drivers shall never use this directly! */</span>
 #include &lt;linux/clk.h&gt;
 #include &lt;linux/of.h&gt;
 #include &lt;linux/of_platform.h&gt;
<span class="p_header">diff --git a/drivers/mtd/nand/qcom_nandc.c b/drivers/mtd/nand/qcom_nandc.c</span>
<span class="p_header">index 2656c1ac5646..411cdfd12a85 100644</span>
<span class="p_header">--- a/drivers/mtd/nand/qcom_nandc.c</span>
<span class="p_header">+++ b/drivers/mtd/nand/qcom_nandc.c</span>
<span class="p_chunk">@@ -23,6 +23,7 @@</span> <span class="p_context"></span>
 #include &lt;linux/of_device.h&gt;
 #include &lt;linux/delay.h&gt;
 #include &lt;linux/dma/qcom_bam_dma.h&gt;
<span class="p_add">+#include &lt;linux/dma-direct.h&gt; /* XXX: drivers shall never use this directly! */</span>
 
 /* NANDc reg offsets */
 #define	NAND_FLASH_CMD			0x00
<span class="p_header">diff --git a/drivers/xen/swiotlb-xen.c b/drivers/xen/swiotlb-xen.c</span>
<span class="p_header">index 82fc54f8eb77..5bb72d3f8337 100644</span>
<span class="p_header">--- a/drivers/xen/swiotlb-xen.c</span>
<span class="p_header">+++ b/drivers/xen/swiotlb-xen.c</span>
<span class="p_chunk">@@ -36,7 +36,7 @@</span> <span class="p_context"></span>
 #define pr_fmt(fmt) &quot;xen:&quot; KBUILD_MODNAME &quot;: &quot; fmt
 
 #include &lt;linux/bootmem.h&gt;
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/export.h&gt;
 #include &lt;xen/swiotlb-xen.h&gt;
 #include &lt;xen/page.h&gt;
<span class="p_header">diff --git a/include/linux/dma-direct.h b/include/linux/dma-direct.h</span>
new file mode 100644
<span class="p_header">index 000000000000..2cc1b6558944</span>
<span class="p_header">--- /dev/null</span>
<span class="p_header">+++ b/include/linux/dma-direct.h</span>
<span class="p_chunk">@@ -0,0 +1,32 @@</span> <span class="p_context"></span>
<span class="p_add">+/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="p_add">+#ifndef _LINUX_DMA_DIRECT_H</span>
<span class="p_add">+#define _LINUX_DMA_DIRECT_H 1</span>
<span class="p_add">+</span>
<span class="p_add">+#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+</span>
<span class="p_add">+#ifdef CONFIG_ARCH_HAS_PHYS_TO_DMA</span>
<span class="p_add">+#include &lt;asm/dma-direct.h&gt;</span>
<span class="p_add">+#else</span>
<span class="p_add">+static inline dma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	dma_addr_t dev_addr = (dma_addr_t)paddr;</span>
<span class="p_add">+</span>
<span class="p_add">+	return dev_addr - ((dma_addr_t)dev-&gt;dma_pfn_offset &lt;&lt; PAGE_SHIFT);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline phys_addr_t dma_to_phys(struct device *dev, dma_addr_t dev_addr)</span>
<span class="p_add">+{</span>
<span class="p_add">+	phys_addr_t paddr = (phys_addr_t)dev_addr;</span>
<span class="p_add">+</span>
<span class="p_add">+	return paddr + ((phys_addr_t)dev-&gt;dma_pfn_offset &lt;&lt; PAGE_SHIFT);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size)</span>
<span class="p_add">+{</span>
<span class="p_add">+	if (!dev-&gt;dma_mask)</span>
<span class="p_add">+		return false;</span>
<span class="p_add">+</span>
<span class="p_add">+	return addr + size - 1 &lt;= *dev-&gt;dma_mask;</span>
<span class="p_add">+}</span>
<span class="p_add">+#endif /* !CONFIG_ARCH_HAS_PHYS_TO_DMA */</span>
<span class="p_add">+#endif /* _LINUX_DMA_DIRECT_H */</span>
<span class="p_header">diff --git a/lib/swiotlb.c b/lib/swiotlb.c</span>
<span class="p_header">index cea19aaf303c..6583f3512386 100644</span>
<span class="p_header">--- a/lib/swiotlb.c</span>
<span class="p_header">+++ b/lib/swiotlb.c</span>
<span class="p_chunk">@@ -18,7 +18,7 @@</span> <span class="p_context"></span>
  */
 
 #include &lt;linux/cache.h&gt;
<span class="p_del">-#include &lt;linux/dma-mapping.h&gt;</span>
<span class="p_add">+#include &lt;linux/dma-direct.h&gt;</span>
 #include &lt;linux/mm.h&gt;
 #include &lt;linux/export.h&gt;
 #include &lt;linux/spinlock.h&gt;

</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



