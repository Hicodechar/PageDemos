
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>[llvmlinux] percpu | bitmap issue? (Cannot boot on bare metal due to a kernel NULL pointer dereference) - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    [llvmlinux] percpu | bitmap issue? (Cannot boot on bare metal due to a kernel NULL pointer dereference)</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=41441">Sedat Dilek</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Sept. 9, 2015, 10:05 a.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;CA+icZUWo1-7Kqo36Dp-pjjq1hUdiqvwhZhvaXM1RwA8mqter_A@mail.gmail.com&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/7145581/mbox/"
   >mbox</a>
|
   <a href="/patch/7145581/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/7145581/">/patch/7145581/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
X-Original-To: patchwork-LKML@patchwork.kernel.org
Delivered-To: patchwork-parsemail@patchwork2.web.kernel.org
Received: from mail.kernel.org (mail.kernel.org [198.145.29.136])
	by patchwork2.web.kernel.org (Postfix) with ESMTP id A6FC5BEEC1
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  9 Sep 2015 10:06:15 +0000 (UTC)
Received: from mail.kernel.org (localhost [127.0.0.1])
	by mail.kernel.org (Postfix) with ESMTP id 5E6C9207D2
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  9 Sep 2015 10:06:13 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.kernel.org (Postfix) with ESMTP id F335E207E7
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed,  9 Sep 2015 10:06:09 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1754776AbbIIKGE (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Wed, 9 Sep 2015 06:06:04 -0400
Received: from mail-yk0-f178.google.com ([209.85.160.178]:33672 &quot;EHLO
	mail-yk0-f178.google.com&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1752119AbbIIKFw (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Wed, 9 Sep 2015 06:05:52 -0400
Received: by ykei199 with SMTP id i199so7057864yke.0
	for &lt;linux-kernel@vger.kernel.org&gt;;
	Wed, 09 Sep 2015 03:05:51 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=gmail.com; s=20120113;
	h=mime-version:reply-to:in-reply-to:references:date:message-id
	:subject:from:to:cc:content-type;
	bh=OzrorjNUwoOrV+Hfc7Z6WuVY2PPMf0aMNrlcod61xlw=;
	b=CJjmuwZrAqr6iKSw+t/6pUVcO9C8vIGkl1GaT7i9XgPyBFCHVQuVFyPkfOZAR5fcVi
	UYtJzN2NGIcQerCKK+E1RGPm49XhnAax+VW8zjUtQjinAUpBhTqBLP15C6XJc/TVOtzo
	lsPK67S7deXPXIIMpOiVTDdqEllVBrhG8GePDQ8Dhe+YV0aU71BbD5ctNV23xlfS4E0l
	B263WeYS/HBHgwzx5yLbWUEWqUwnfHVKuFav0KeKUiLTjFSx15v2gyOr5W3I9pNWs+00
	qHOg9lxrY8u25YHR1HTS5Gfh2dxCb60PcqOuPOCT6Xg9uPJPIUueZFwCbpetRo1RhSlk
	0DFA==
MIME-Version: 1.0
X-Received: by 10.170.50.210 with SMTP id 201mr36669464yks.65.1441793151191; 
	Wed, 09 Sep 2015 03:05:51 -0700 (PDT)
Received: by 10.103.3.66 with HTTP; Wed, 9 Sep 2015 03:05:50 -0700 (PDT)
Reply-To: sedat.dilek@gmail.com
In-Reply-To: &lt;CA+icZUVTHJGkg9mTs3TSy3U4VX_cTyNpwNeX9R+73Y9=ZD_E0A@mail.gmail.com&gt;
References: &lt;CA+icZUUNac0fx8hyVtJXS5q+1WMUdGaXvW7x8e8fL-bkekA5rA@mail.gmail.com&gt;
	&lt;CA+icZUUbhu2i3c8FEH7wTjXwYqSMuS+SBk19GhfbUW4+uLeDHw@mail.gmail.com&gt;
	&lt;CA+icZUUs3KEydWRgu_Y+YqS4TcCNp2DUw3Y+KfBzX7aPg_kzLw@mail.gmail.com&gt;
	&lt;20150909022945.GB1998@dhcp-17-102.nay.redhat.com&gt;
	&lt;CA+icZUUgVEaYmToXd6j4sHT2PW3CH++B7DcO-Mj48W2rBD6yAQ@mail.gmail.com&gt;
	&lt;20150909032541.GC1998@dhcp-17-102.nay.redhat.com&gt;
	&lt;CA+icZUWOcDAeu+e7aP9J5ZwpKOgjuMKtJyeM8McHZe33EM65Og@mail.gmail.com&gt;
	&lt;CA+icZUXNWWHrx4mgzudafMwq1HOZd5FZY2QTicY5a-eYF=D8Kg@mail.gmail.com&gt;
	&lt;20150909071410.GD1998@dhcp-17-102.nay.redhat.com&gt;
	&lt;CA+icZUVTHJGkg9mTs3TSy3U4VX_cTyNpwNeX9R+73Y9=ZD_E0A@mail.gmail.com&gt;
Date: Wed, 9 Sep 2015 12:05:50 +0200
Message-ID: &lt;CA+icZUWo1-7Kqo36Dp-pjjq1hUdiqvwhZhvaXM1RwA8mqter_A@mail.gmail.com&gt;
Subject: Re: [llvmlinux] percpu | bitmap issue? (Cannot boot on bare metal
	due to a kernel NULL pointer dereference)
From: Sedat Dilek &lt;sedat.dilek@gmail.com&gt;
To: Baoquan He &lt;bhe@redhat.com&gt;
Cc: Denys Vlasenko &lt;dvlasenk@redhat.com&gt;, Tejun Heo &lt;tj@kernel.org&gt;,
	Christoph Lameter &lt;cl@linux.com&gt;, LKML &lt;linux-kernel@vger.kernel.org&gt;,
	Andrew Morton &lt;akpm@linux-foundation.org&gt;,
	David Rientjes &lt;rientjes@google.com&gt;,
	Linus Torvalds &lt;torvalds@linux-foundation.org&gt;,
	Peter Zijlstra &lt;peterz@infradead.org&gt;,
	Thomas Gleixner &lt;tglx@linutronix.de&gt;,
	Thomas Graf &lt;tgraf@suug.ch&gt;, Ingo Molnar &lt;mingo@kernel.org&gt;,
	&quot;the arch/x86 maintainers&quot; &lt;x86@kernel.org&gt;
Content-Type: multipart/mixed; boundary=001a1135c3c29e6f36051f4da037
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Spam-Status: No, score=-6.8 required=5.0 tests=BAYES_00,
	DKIM_ADSP_CUSTOM_MED, 
	DKIM_SIGNED, FREEMAIL_FROM, RCVD_IN_DNSWL_HI, T_DKIM_INVALID,
	T_RP_MATCHES_RCVD, 
	T_TVD_MIME_EPI, UNPARSEABLE_RELAY autolearn=unavailable version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on mail.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=41441">Sedat Dilek</a> - Sept. 9, 2015, 10:05 a.m.</div>
<pre class="content">
I can boot into a CLANG v3.7 compiled Linux-kernel when lib/bitmap is
compiled with GCC (here: v4.9).

CONFIG_OPTIMIZE_INLINING has no effect on this.

Attached are the single llvmlinux patch for AMD64 (x86_64), my
kernel-config and 2 objdumps with bitmap.o file alltogether.

[ objdumps ]

$ objdump -drw bitmap.o

$ objdump -D -Mintel bitmap.o

Thanks to all involved people (including not-CCed folks from LLVMLinux project).

If I can help, please poke me.

- Sedat -
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=137">Peter Zijlstra</a> - Sept. 9, 2015, 12:54 p.m.</div>
<pre class="content">
On Wed, Sep 09, 2015 at 12:05:50PM +0200, Sedat Dilek wrote:
<span class="quote">&gt; I can boot into a CLANG v3.7 compiled Linux-kernel when lib/bitmap is</span>
<span class="quote">&gt; compiled with GCC (here: v4.9).</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; CONFIG_OPTIMIZE_INLINING has no effect on this.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Attached are the single llvmlinux patch for AMD64 (x86_64), my</span>
<span class="quote">&gt; kernel-config and 2 objdumps with bitmap.o file alltogether.</span>

I suggest you go tell the LLVM people their compiler is broken.
--
To unsubscribe from this list: send the line &quot;unsubscribe linux-kernel&quot; in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  http://www.tux.org/lkml/
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=41441">Sedat Dilek</a> - Sept. 12, 2015, 9:22 p.m.</div>
<pre class="content">
On Wed, Sep 9, 2015 at 2:54 PM, Peter Zijlstra &lt;peterz@infradead.org&gt; wrote:
<span class="quote">&gt; On Wed, Sep 09, 2015 at 12:05:50PM +0200, Sedat Dilek wrote:</span>
<span class="quote">&gt;&gt; I can boot into a CLANG v3.7 compiled Linux-kernel when lib/bitmap is</span>
<span class="quote">&gt;&gt; compiled with GCC (here: v4.9).</span>
<span class="quote">&gt;&gt;</span>
<span class="quote">&gt;&gt; CONFIG_OPTIMIZE_INLINING has no effect on this.</span>
<span class="quote">&gt;&gt;</span>
<span class="quote">&gt;&gt; Attached are the single llvmlinux patch for AMD64 (x86_64), my</span>
<span class="quote">&gt;&gt; kernel-config and 2 objdumps with bitmap.o file alltogether.</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; I suggest you go tell the LLVM people their compiler is broken.</span>

It looks like an inline-optimization bug in CLANG when the compiler&#39;s
optimization-level is higher than -O2.

Level -O0 and -O1 are OK - I can boot in such Linux-kernel v4.2.

With Level -Oz when CONFIG_CC_OPTIMIZE_FOR_SIZE=y (equivalent to GCC&#39;s
-Os) the objdump looked sane but I cannot boot on bare metal.
Re-compiling lib/bitmap with -O0 or -O1 is fine again.

- Sedat -

[1] http://lists.linuxfoundation.org/pipermail/llvmlinux/2015-September/001355.html
--
To unsubscribe from this list: send the line &quot;unsubscribe linux-kernel&quot; in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  http://www.tux.org/lkml/
</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
Behan Webster (19):
      kbuild-clang-detect
      kbuild, LLVMLinux: Add better clang cross build support
      kbuild, LLVMLinux: Add more compiler options for clang
      kbuild, LLVMLinux: Fix asm-offset generation to work with clang
      mpi, LLVMLinux: Fix ASM for clang in mpi
      mpi, LLVMLinux: Remove use of extern inline from lib/mpi
      mpi, LLVMLinux: Don&#39;t use __attribute__ ((mode(QI))) for lib/mpi
      mpi, LLVMLinux: Remove unused headers from mpi-internal.h
      md, sysfs, LLVMLinux: Remove nested function from bcache sysfs
      scsi, megaraid, sas, LLVMLinux: Remove inline
      DO-NOT-UPSTREAM scsi, osd, LLVMLinux: Remove __weak attribute
      exofs, LLVMLinux: Remove VLAIS from exofs
      md, raid10, LLVMLinux: Remove VLAIS from raid10 driver
      fs, nfs, LLVMLinux: Remove VLAIS from nfs
      net, wimax, i2400, LLVMLinux: Remove VLAIS from wimax i2400m driver
      Mark inline functions as __maybe_unused
      LLVMLinux: use -Oz instead of -Os when using clang
      makefile-print
      kbuild: LLVMLinux: Clang doesn&#39;t support the gcc flags set by CONFIG_ARCH_HWEIGHT_CFLAGS

Jan-Simon Möller (3):
      x86: LLVMLinux: Add option for clang in export of memcpy.
      WORKAROUND DO-NOT-UPSTREAM x86, boot: Work around clang PR18415.
      Revert &quot;x86: Align jump targets to 1-byte boundaries&quot;

Mark Charlebois (3):
      Kbuild: LLVMLinux: Disable the use of the Integrated Assembler when compiling with Clang
      fs, LLVMLinux: Remove warning from COMPATIBLE_IOCTL
      kbuild, LLVMLinux: Add -Werror to cc-option to support clang

Sedat Dilek (2):
      Revert &quot;ppp: fix device unregistration upon netns deletion&quot;
      Merge branch &#39;for-4.2/net-fixes&#39; into 4.2.0-2-llvmlinux-small

Vinícius Tinti (3):
      kbuild: LLVMLinux: Add support to generate LLVM bitcode files
      apparmor: LLVMLinux: Remove VLAIS
      DO-NOT-UPSTREAM xen, LLVMLinux: Remove VLAIS from xen mmu

 .gitignore                                |  1 +
 Kbuild                                    |  8 ++--
 Makefile                                  | 59 +++++++++++++++++------
 arch/x86/Makefile                         |  6 ---
 arch/x86/boot/memory.c                    |  7 ++-
 arch/x86/boot/string.h                    |  2 +
 arch/x86/um/ksyms.c                       |  2 +-
 arch/x86/xen/mmu.c                        | 35 +++++++-------
 drivers/md/bcache/sysfs.c                 | 10 ++--
 drivers/md/raid10.c                       | 16 +++----
 drivers/net/ppp/ppp_generic.c             | 78 ++++++++++++++-----------------
 drivers/net/wimax/i2400m/fw.c             |  2 +-
 drivers/scsi/megaraid/megaraid_sas_base.c |  2 +-
 fs/compat_ioctl.c                         |  2 +-
 fs/exofs/Kconfig                          |  2 +-
 fs/exofs/super.c                          | 22 ++++-----
 fs/nfs/Kconfig                            |  2 +-
 fs/nfs/objlayout/objio_osd.c              |  5 +-
 include/linux/compiler-gcc.h              | 10 ++--
 include/linux/kbuild.h                    |  6 +--
 include/scsi/osd_types.h                  |  2 +-
 lib/Makefile                              |  2 +
 lib/mpi/Makefile                          |  2 +
 lib/mpi/longlong.h                        |  9 ++--
 lib/mpi/mpi-inline.h                      |  2 +-
 lib/mpi/mpi-internal.h                    | 10 +---
 scripts/Kbuild.include                    |  6 +--
 scripts/Makefile.build                    | 14 ++++++
 scripts/mod/Makefile                      |  8 ++--
 security/apparmor/crypto.c                | 17 +++----
 30 files changed, 188 insertions(+), 161 deletions(-)

<span class="p_header">diff --git a/.gitignore b/.gitignore</span>
<span class="p_header">index 4ad4a98b884b..bbd5f34bd5c5 100644</span>
<span class="p_header">--- a/.gitignore</span>
<span class="p_header">+++ b/.gitignore</span>
<span class="p_chunk">@@ -33,6 +33,7 @@</span> <span class="p_context"></span>
 *.lzo
 *.patch
 *.gcno
<span class="p_add">+*.ll</span>
 modules.builtin
 Module.symvers
 *.dwo
<span class="p_header">diff --git a/Kbuild b/Kbuild</span>
<span class="p_header">index f55cefd9bf29..0bbb86358942 100644</span>
<span class="p_header">--- a/Kbuild</span>
<span class="p_header">+++ b/Kbuild</span>
<span class="p_chunk">@@ -8,10 +8,10 @@</span> <span class="p_context"></span>
 
 # Default sed regexp - multiline due to syntax constraints
 define sed-y
<span class="p_del">-	&quot;/^-&gt;/{s:-&gt;#\(.*\):/* \1 */:; \</span>
<span class="p_del">-	s:^-&gt;\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_del">-	s:^-&gt;\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_del">-	s:-&gt;::; p;}&quot;</span>
<span class="p_add">+	&quot;/^@-&gt;/{s:@-&gt;#\(.*\):/* \1 */:; \</span>
<span class="p_add">+	s:^@-&gt;\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_add">+	s:^@-&gt;\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_add">+	s:@-&gt;::; p;}&quot;</span>
 endef
 
 # Use filechk to avoid rebuilds when a header changes, but the resulting file
<span class="p_header">diff --git a/Makefile b/Makefile</span>
<span class="p_header">index c3615937df38..0e333fd142a1 100644</span>
<span class="p_header">--- a/Makefile</span>
<span class="p_header">+++ b/Makefile</span>
<span class="p_chunk">@@ -302,7 +302,7 @@</span> <span class="p_context"> HOSTCXXFLAGS = -O2</span>
 
 ifeq ($(shell $(HOSTCC) -v 2&gt;&amp;1 | grep -c &quot;clang version&quot;), 1)
 HOSTCFLAGS  += -Wno-unused-value -Wno-unused-parameter \
<span class="p_del">-		-Wno-missing-field-initializers -fno-delete-null-pointer-checks</span>
<span class="p_add">+		-Wno-missing-field-initializers</span>
 endif
 
 # Decide whether to build built-in, modular, or both.
<span class="p_chunk">@@ -366,6 +366,26 @@</span> <span class="p_context"> CFLAGS_KERNEL	=</span>
 AFLAGS_KERNEL	=
 CFLAGS_GCOV	= -fprofile-arcs -ftest-coverage
 
<span class="p_add">+ifeq ($(shell $(CC) -v 2&gt;&amp;1 | grep -c &quot;clang version&quot;), 1)</span>
<span class="p_add">+COMPILER := clang</span>
<span class="p_add">+else</span>
<span class="p_add">+COMPILER := gcc</span>
<span class="p_add">+endif</span>
<span class="p_add">+export COMPILER</span>
<span class="p_add">+</span>
<span class="p_add">+ifeq ($(COMPILER),clang)</span>
<span class="p_add">+ifneq ($(CROSS_COMPILE),)</span>
<span class="p_add">+CLANG_TARGET	:= -target $(notdir $(CROSS_COMPILE:%-=%))</span>
<span class="p_add">+GCC_TOOLCHAIN	:= $(dir $(CROSS_COMPILE))</span>
<span class="p_add">+endif</span>
<span class="p_add">+ifneq ($(GCC_TOOLCHAIN),)</span>
<span class="p_add">+CLANG_GCC_TC	:= -gcc-toolchain $(GCC_TOOLCHAIN)</span>
<span class="p_add">+endif</span>
<span class="p_add">+ifneq ($(CLANG_ENABLE_IA),1)</span>
<span class="p_add">+CLANG_IA_FLAG	= -no-integrated-as</span>
<span class="p_add">+endif</span>
<span class="p_add">+CLANG_FLAGS	:= $(CLANG_TARGET) $(CLANG_GCC_TC) $(CLANG_IA_FLAG)</span>
<span class="p_add">+endif</span>
 
 # Use USERINCLUDE when you must reference the UAPI directories only.
 USERINCLUDE    := \
<span class="p_chunk">@@ -391,11 +411,11 @@</span> <span class="p_context"> KBUILD_CFLAGS   := -Wall -Wundef -Wstrict-prototypes -Wno-trigraphs \</span>
 		   -fno-strict-aliasing -fno-common \
 		   -Werror-implicit-function-declaration \
 		   -Wno-format-security \
<span class="p_del">-		   -std=gnu89</span>
<span class="p_add">+		   -std=gnu89 $(CLANG_FLAGS)</span>
 
 KBUILD_AFLAGS_KERNEL :=
 KBUILD_CFLAGS_KERNEL :=
<span class="p_del">-KBUILD_AFLAGS   := -D__ASSEMBLY__</span>
<span class="p_add">+KBUILD_AFLAGS   := -D__ASSEMBLY__ $(CLANG_FLAGS)</span>
 KBUILD_AFLAGS_MODULE  := -DMODULE
 KBUILD_CFLAGS_MODULE  := -DMODULE
 KBUILD_LDFLAGS_MODULE := -T $(srctree)/scripts/module-common.lds
<span class="p_chunk">@@ -604,10 +624,9 @@</span> <span class="p_context"> ARCH_AFLAGS :=</span>
 ARCH_CFLAGS :=
 include arch/$(SRCARCH)/Makefile
 
<span class="p_del">-KBUILD_CFLAGS	+= $(call cc-option,-fno-delete-null-pointer-checks,)</span>
<span class="p_del">-</span>
 ifdef CONFIG_CC_OPTIMIZE_FOR_SIZE
<span class="p_del">-KBUILD_CFLAGS	+= -Os $(call cc-disable-warning,maybe-uninitialized,)</span>
<span class="p_add">+KBUILD_CFLAGS	+= $(call cc-option,-Oz,-Os)</span>
<span class="p_add">+KBUILD_CFLAGS	+= $(call cc-disable-warning,maybe-uninitialized,)</span>
 else
 KBUILD_CFLAGS	+= -O2
 endif
<span class="p_chunk">@@ -666,28 +685,26 @@</span> <span class="p_context"> endif</span>
 endif
 KBUILD_CFLAGS += $(stackp-flag)
 
<span class="p_del">-ifeq ($(shell $(CC) -v 2&gt;&amp;1 | grep -c &quot;clang version&quot;), 1)</span>
<span class="p_del">-COMPILER := clang</span>
<span class="p_del">-else</span>
<span class="p_del">-COMPILER := gcc</span>
<span class="p_del">-endif</span>
<span class="p_del">-export COMPILER</span>
<span class="p_del">-</span>
 ifeq ($(COMPILER),clang)
 KBUILD_CPPFLAGS += $(call cc-option,-Qunused-arguments,)
<span class="p_del">-KBUILD_CPPFLAGS += $(call cc-option,-Wno-unknown-warning-option,)</span>
 KBUILD_CFLAGS += $(call cc-disable-warning, unused-variable)
 KBUILD_CFLAGS += $(call cc-disable-warning, format-invalid-specifier)
 KBUILD_CFLAGS += $(call cc-disable-warning, gnu)
<span class="p_add">+KBUILD_CFLAGS += -Wno-asm-operand-widths</span>
<span class="p_add">+KBUILD_CFLAGS += -Wno-initializer-overrides</span>
<span class="p_add">+KBUILD_CFLAGS += -fno-builtin</span>
<span class="p_add">+</span>
 # Quiet clang warning: comparison of unsigned expression &lt; 0 is always false
 KBUILD_CFLAGS += $(call cc-disable-warning, tautological-compare)
<span class="p_add">+</span>
 # CLANG uses a _MergedGlobals as optimization, but this breaks modpost, as the
 # source of a reference will be _MergedGlobals and not on of the whitelisted names.
 # See modpost pattern 2
 KBUILD_CFLAGS += $(call cc-option, -mno-global-merge,)
<span class="p_del">-KBUILD_CFLAGS += $(call cc-option, -fcatch-undefined-behavior)</span>
<span class="p_add">+</span>
 else
 
<span class="p_add">+KBUILD_CFLAGS += $(call cc-option,-fno-delete-null-pointer-checks,)</span>
 # This warning generated too much noise in a regular build.
 # Use make W=1 to enable this warning (see scripts/Makefile.build)
 KBUILD_CFLAGS += $(call cc-disable-warning, unused-but-set-variable)
<span class="p_chunk">@@ -1263,6 +1280,8 @@</span> <span class="p_context"> help:</span>
 	@echo  &#39;                    (default: $$(INSTALL_MOD_PATH)/lib/firmware)&#39;
 	@echo  &#39;  dir/            - Build all files in dir and below&#39;
 	@echo  &#39;  dir/file.[oisS] - Build specified target only&#39;
<span class="p_add">+	@echo  &#39;  dir/file.ll     - Build the LLVM bitcode file&#39;</span>
<span class="p_add">+	@echo  &#39;                    (requires compiler support for LLVM bitcode generation)&#39;</span>
 	@echo  &#39;  dir/file.lst    - Build specified mixed source/assembly target only&#39;
 	@echo  &#39;                    (requires a recent binutils and recent build (System.map))&#39;
 	@echo  &#39;  dir/file.ko     - Build module including final link&#39;
<span class="p_chunk">@@ -1539,6 +1558,10 @@</span> <span class="p_context"> endif</span>
 	$(Q)$(MAKE) $(build)=$(build-dir) $(target-dir)$(notdir $@)
 %.symtypes: %.c prepare scripts FORCE
 	$(Q)$(MAKE) $(build)=$(build-dir) $(target-dir)$(notdir $@)
<span class="p_add">+%.ll: %.c prepare scripts FORCE</span>
<span class="p_add">+	$(Q)$(MAKE) $(build)=$(build-dir) $(target-dir)$(notdir $@)</span>
<span class="p_add">+%.ll: %.S prepare scripts FORCE</span>
<span class="p_add">+	$(Q)$(MAKE) $(build)=$(build-dir) $(target-dir)$(notdir $@)</span>
 
 # Modules
 /: prepare scripts FORCE
<span class="p_chunk">@@ -1594,3 +1617,9 @@</span> <span class="p_context"> FORCE:</span>
 # Declare the contents of the .PHONY variable as phony.  We keep that
 # information in a variable so we can use it in if_changed and friends.
 .PHONY: $(PHONY)
<span class="p_add">+</span>
<span class="p_add">+print-%:</span>
<span class="p_add">+	@echo &#39;$*=$($*)&#39;</span>
<span class="p_add">+	@echo &#39;  origin = $(origin $*)&#39;</span>
<span class="p_add">+	@echo &#39;  flavor = $(flavor $*)&#39;</span>
<span class="p_add">+	@echo &#39;  value  = $(value $*)&#39;</span>
<span class="p_header">diff --git a/arch/x86/Makefile b/arch/x86/Makefile</span>
<span class="p_header">index 118e6debc483..4fea5e90c941 100644</span>
<span class="p_header">--- a/arch/x86/Makefile</span>
<span class="p_header">+++ b/arch/x86/Makefile</span>
<span class="p_chunk">@@ -77,12 +77,6 @@</span> <span class="p_context"> else</span>
         KBUILD_AFLAGS += -m64
         KBUILD_CFLAGS += -m64
 
<span class="p_del">-        # Align jump targets to 1 byte, not the default 16 bytes:</span>
<span class="p_del">-        KBUILD_CFLAGS += -falign-jumps=1</span>
<span class="p_del">-</span>
<span class="p_del">-        # Pack loops tightly as well:</span>
<span class="p_del">-        KBUILD_CFLAGS += -falign-loops=1</span>
<span class="p_del">-</span>
         # Don&#39;t autogenerate traditional x87 instructions
         KBUILD_CFLAGS += $(call cc-option,-mno-80387)
         KBUILD_CFLAGS += $(call cc-option,-mno-fp-ret-in-387)
<span class="p_header">diff --git a/arch/x86/boot/memory.c b/arch/x86/boot/memory.c</span>
<span class="p_header">index db75d07c3645..7af65046dfad 100644</span>
<span class="p_header">--- a/arch/x86/boot/memory.c</span>
<span class="p_header">+++ b/arch/x86/boot/memory.c</span>
<span class="p_chunk">@@ -63,8 +63,13 @@</span> <span class="p_context"> static int detect_memory_e820(void)</span>
 			count = 0;
 			break;
 		}
<span class="p_del">-</span>
<span class="p_add">+#ifdef __clang__</span>
<span class="p_add">+		/* PR18415 */</span>
<span class="p_add">+		memcpy(desc, &amp;buf, sizeof(*desc));</span>
<span class="p_add">+		desc++;</span>
<span class="p_add">+#else</span>
 		*desc++ = buf;
<span class="p_add">+#endif</span>
 		count++;
 	} while (ireg.ebx &amp;&amp; count &lt; ARRAY_SIZE(boot_params.e820_map));
 
<span class="p_header">diff --git a/arch/x86/boot/string.h b/arch/x86/boot/string.h</span>
<span class="p_header">index 725e820602b1..3e07af1d80e3 100644</span>
<span class="p_header">--- a/arch/x86/boot/string.h</span>
<span class="p_header">+++ b/arch/x86/boot/string.h</span>
<span class="p_chunk">@@ -14,8 +14,10 @@</span> <span class="p_context"> int memcmp(const void *s1, const void *s2, size_t len);</span>
  * Access builtin version by default. If one needs to use optimized version,
  * do &quot;undef memcpy&quot; in .c file and link against right string.c
  */
<span class="p_add">+#ifndef __clang__ /* PR18415 */</span>
 #define memcpy(d,s,l) __builtin_memcpy(d,s,l)
 #define memset(d,c,l) __builtin_memset(d,c,l)
 #define memcmp	__builtin_memcmp
<span class="p_add">+#endif</span>
 
 #endif /* BOOT_STRING_H */
<span class="p_header">diff --git a/arch/x86/um/ksyms.c b/arch/x86/um/ksyms.c</span>
<span class="p_header">index 2e8f43ec6214..04aedcecd887 100644</span>
<span class="p_header">--- a/arch/x86/um/ksyms.c</span>
<span class="p_header">+++ b/arch/x86/um/ksyms.c</span>
<span class="p_chunk">@@ -4,7 +4,7 @@</span> <span class="p_context"></span>
 
 #ifndef CONFIG_X86_32
 /*XXX: we need them because they would be exported by x86_64 */
<span class="p_del">-#if (__GNUC__ == 4 &amp;&amp; __GNUC_MINOR__ &gt;= 3) || __GNUC__ &gt; 4</span>
<span class="p_add">+#if (__GNUC__ == 4 &amp;&amp; __GNUC_MINOR__ &gt;= 3) || __GNUC__ &gt; 4 || defined(__clang__)</span>
 EXPORT_SYMBOL(memcpy);
 #else
 EXPORT_SYMBOL(__memcpy);
<span class="p_header">diff --git a/arch/x86/xen/mmu.c b/arch/x86/xen/mmu.c</span>
<span class="p_header">index dd151b2045b0..0c12e370860e 100644</span>
<span class="p_header">--- a/arch/x86/xen/mmu.c</span>
<span class="p_header">+++ b/arch/x86/xen/mmu.c</span>
<span class="p_chunk">@@ -1271,36 +1271,37 @@</span> <span class="p_context"> static void xen_flush_tlb_others(const struct cpumask *cpus,</span>
 				 struct mm_struct *mm, unsigned long start,
 				 unsigned long end)
 {
<span class="p_del">-	struct {</span>
<span class="p_del">-		struct mmuext_op op;</span>
<span class="p_del">-#ifdef CONFIG_SMP</span>
<span class="p_del">-		DECLARE_BITMAP(mask, num_processors);</span>
<span class="p_del">-#else</span>
<span class="p_del">-		DECLARE_BITMAP(mask, NR_CPUS);</span>
<span class="p_del">-#endif</span>
<span class="p_del">-	} *args;</span>
 	struct multicall_space mcs;
<span class="p_add">+	struct mmuext_op *op;</span>
<span class="p_add">+	struct cpumask *mask;</span>
 
 	trace_xen_mmu_flush_tlb_others(cpus, mm, start, end);
 
 	if (cpumask_empty(cpus))
 		return;		/* nothing to do */
 
<span class="p_del">-	mcs = xen_mc_entry(sizeof(*args));</span>
<span class="p_del">-	args = mcs.args;</span>
<span class="p_del">-	args-&gt;op.arg2.vcpumask = to_cpumask(args-&gt;mask);</span>
<span class="p_add">+#ifdef CONFIG_SMP</span>
<span class="p_add">+	mcs = xen_mc_entry(sizeof(struct mmuext_op) + BITS_TO_LONGS(num_processors)*sizeof(unsigned long));</span>
<span class="p_add">+#else</span>
<span class="p_add">+	mcs = xen_mc_entry(sizeof(struct mmuext_op) + BITS_TO_LONGS(NR_CPUS)*sizeof(unsigned long));</span>
<span class="p_add">+#endif</span>
<span class="p_add">+	/* Extract fields */</span>
<span class="p_add">+	op = mcs.args;</span>
<span class="p_add">+	mask = to_cpumask(mcs.args + sizeof(struct mmuext_op));</span>
<span class="p_add">+</span>
<span class="p_add">+	op-&gt;arg2.vcpumask = mask;</span>
 
 	/* Remove us, and any offline CPUS. */
<span class="p_del">-	cpumask_and(to_cpumask(args-&gt;mask), cpus, cpu_online_mask);</span>
<span class="p_del">-	cpumask_clear_cpu(smp_processor_id(), to_cpumask(args-&gt;mask));</span>
<span class="p_add">+	cpumask_and(mask, cpus, cpu_online_mask);</span>
<span class="p_add">+	cpumask_clear_cpu(smp_processor_id(), mask);</span>
 
<span class="p_del">-	args-&gt;op.cmd = MMUEXT_TLB_FLUSH_MULTI;</span>
<span class="p_add">+	op-&gt;cmd = MMUEXT_TLB_FLUSH_MULTI;</span>
 	if (end != TLB_FLUSH_ALL &amp;&amp; (end - start) &lt;= PAGE_SIZE) {
<span class="p_del">-		args-&gt;op.cmd = MMUEXT_INVLPG_MULTI;</span>
<span class="p_del">-		args-&gt;op.arg1.linear_addr = start;</span>
<span class="p_add">+		op-&gt;cmd = MMUEXT_INVLPG_MULTI;</span>
<span class="p_add">+		op-&gt;arg1.linear_addr = start;</span>
 	}
 
<span class="p_del">-	MULTI_mmuext_op(mcs.mc, &amp;args-&gt;op, 1, NULL, DOMID_SELF);</span>
<span class="p_add">+	MULTI_mmuext_op(mcs.mc, op, 1, NULL, DOMID_SELF);</span>
 
 	xen_mc_issue(PARAVIRT_LAZY_MMU);
 }
<span class="p_header">diff --git a/drivers/md/bcache/sysfs.c b/drivers/md/bcache/sysfs.c</span>
<span class="p_header">index b3ff57d61dde..53d8baa741fb 100644</span>
<span class="p_header">--- a/drivers/md/bcache/sysfs.c</span>
<span class="p_header">+++ b/drivers/md/bcache/sysfs.c</span>
<span class="p_chunk">@@ -731,6 +731,11 @@</span> <span class="p_context"> static struct attribute *bch_cache_set_internal_files[] = {</span>
 };
 KTYPE(bch_cache_set_internal);
 
<span class="p_add">+static int __bch_cache_cmp(const void *l, const void *r)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return *((uint16_t *) r) - *((uint16_t *) l);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 SHOW(__bch_cache)
 {
 	struct cache *ca = container_of(kobj, struct cache, kobj);
<span class="p_chunk">@@ -755,9 +760,6 @@</span> <span class="p_context"> SHOW(__bch_cache)</span>
 					       CACHE_REPLACEMENT(&amp;ca-&gt;sb));
 
 	if (attr == &amp;sysfs_priority_stats) {
<span class="p_del">-		int cmp(const void *l, const void *r)</span>
<span class="p_del">-		{	return *((uint16_t *) r) - *((uint16_t *) l); }</span>
<span class="p_del">-</span>
 		struct bucket *b;
 		size_t n = ca-&gt;sb.nbuckets, i;
 		size_t unused = 0, available = 0, dirty = 0, meta = 0;
<span class="p_chunk">@@ -786,7 +788,7 @@</span> <span class="p_context"> SHOW(__bch_cache)</span>
 			p[i] = ca-&gt;buckets[i].prio;
 		mutex_unlock(&amp;ca-&gt;set-&gt;bucket_lock);
 
<span class="p_del">-		sort(p, n, sizeof(uint16_t), cmp, NULL);</span>
<span class="p_add">+		sort(p, n, sizeof(uint16_t), __bch_cache_cmp, NULL);</span>
 
 		while (n &amp;&amp;
 		       !cached[n - 1])
<span class="p_header">diff --git a/drivers/md/raid10.c b/drivers/md/raid10.c</span>
<span class="p_header">index 38c58e19cfce..f3d0859c07da 100644</span>
<span class="p_header">--- a/drivers/md/raid10.c</span>
<span class="p_header">+++ b/drivers/md/raid10.c</span>
<span class="p_chunk">@@ -711,11 +711,9 @@</span> <span class="p_context"> static int raid10_mergeable_bvec(struct mddev *mddev,</span>
 		max = biovec-&gt;bv_len;
 
 	if (mddev-&gt;merge_check_needed) {
<span class="p_del">-		struct {</span>
<span class="p_del">-			struct r10bio r10_bio;</span>
<span class="p_del">-			struct r10dev devs[conf-&gt;copies];</span>
<span class="p_del">-		} on_stack;</span>
<span class="p_del">-		struct r10bio *r10_bio = &amp;on_stack.r10_bio;</span>
<span class="p_add">+		/* Allocate space for r10bio on stack */</span>
<span class="p_add">+		u8 r10bio_on_stack[sizeof(struct r10bio) + conf-&gt;copies * sizeof(struct r10dev)];</span>
<span class="p_add">+		struct r10bio *r10_bio = (struct r10bio*) r10bio_on_stack;</span>
 		int s;
 		if (conf-&gt;reshape_progress != MaxSector) {
 			/* Cannot give any guidance during reshape */
<span class="p_chunk">@@ -4548,11 +4546,9 @@</span> <span class="p_context"> static int handle_reshape_read_error(struct mddev *mddev,</span>
 	/* Use sync reads to get the blocks from somewhere else */
 	int sectors = r10_bio-&gt;sectors;
 	struct r10conf *conf = mddev-&gt;private;
<span class="p_del">-	struct {</span>
<span class="p_del">-		struct r10bio r10_bio;</span>
<span class="p_del">-		struct r10dev devs[conf-&gt;copies];</span>
<span class="p_del">-	} on_stack;</span>
<span class="p_del">-	struct r10bio *r10b = &amp;on_stack.r10_bio;</span>
<span class="p_add">+	/* Allocate space for r10bio on stack */</span>
<span class="p_add">+	u8 r10bio_on_stack[sizeof(struct r10bio) + conf-&gt;copies * sizeof(struct r10dev)];</span>
<span class="p_add">+	struct r10bio *r10b = (struct r10bio *) r10bio_on_stack;</span>
 	int slot = 0;
 	int idx = 0;
 	struct bio_vec *bvec = r10_bio-&gt;master_bio-&gt;bi_io_vec;
<span class="p_header">diff --git a/drivers/net/ppp/ppp_generic.c b/drivers/net/ppp/ppp_generic.c</span>
<span class="p_header">index fa8f5046afe9..9d15566521a7 100644</span>
<span class="p_header">--- a/drivers/net/ppp/ppp_generic.c</span>
<span class="p_header">+++ b/drivers/net/ppp/ppp_generic.c</span>
<span class="p_chunk">@@ -269,9 +269,9 @@</span> <span class="p_context"> static void ppp_ccp_peek(struct ppp *ppp, struct sk_buff *skb, int inbound);</span>
 static void ppp_ccp_closed(struct ppp *ppp);
 static struct compressor *find_compressor(int type);
 static void ppp_get_stats(struct ppp *ppp, struct ppp_stats *st);
<span class="p_del">-static struct ppp *ppp_create_interface(struct net *net, int unit,</span>
<span class="p_del">-					struct file *file, int *retp);</span>
<span class="p_add">+static struct ppp *ppp_create_interface(struct net *net, int unit, int *retp);</span>
 static void init_ppp_file(struct ppp_file *pf, int kind);
<span class="p_add">+static void ppp_shutdown_interface(struct ppp *ppp);</span>
 static void ppp_destroy_interface(struct ppp *ppp);
 static struct ppp *ppp_find_unit(struct ppp_net *pn, int unit);
 static struct channel *ppp_find_channel(struct ppp_net *pn, int unit);
<span class="p_chunk">@@ -392,10 +392,8 @@</span> <span class="p_context"> static int ppp_release(struct inode *unused, struct file *file)</span>
 		file-&gt;private_data = NULL;
 		if (pf-&gt;kind == INTERFACE) {
 			ppp = PF_TO_PPP(pf);
<span class="p_del">-			rtnl_lock();</span>
 			if (file == ppp-&gt;owner)
<span class="p_del">-				unregister_netdevice(ppp-&gt;dev);</span>
<span class="p_del">-			rtnl_unlock();</span>
<span class="p_add">+				ppp_shutdown_interface(ppp);</span>
 		}
 		if (atomic_dec_and_test(&amp;pf-&gt;refcnt)) {
 			switch (pf-&gt;kind) {
<span class="p_chunk">@@ -595,10 +593,8 @@</span> <span class="p_context"> static long ppp_ioctl(struct file *file, unsigned int cmd, unsigned long arg)</span>
 		mutex_lock(&amp;ppp_mutex);
 		if (pf-&gt;kind == INTERFACE) {
 			ppp = PF_TO_PPP(pf);
<span class="p_del">-			rtnl_lock();</span>
 			if (file == ppp-&gt;owner)
<span class="p_del">-				unregister_netdevice(ppp-&gt;dev);</span>
<span class="p_del">-			rtnl_unlock();</span>
<span class="p_add">+				ppp_shutdown_interface(ppp);</span>
 		}
 		if (atomic_long_read(&amp;file-&gt;f_count) &lt; 2) {
 			ppp_release(NULL, file);
<span class="p_chunk">@@ -842,10 +838,11 @@</span> <span class="p_context"> static int ppp_unattached_ioctl(struct net *net, struct ppp_file *pf,</span>
 		/* Create a new ppp unit */
 		if (get_user(unit, p))
 			break;
<span class="p_del">-		ppp = ppp_create_interface(net, unit, file, &amp;err);</span>
<span class="p_add">+		ppp = ppp_create_interface(net, unit, &amp;err);</span>
 		if (!ppp)
 			break;
 		file-&gt;private_data = &amp;ppp-&gt;file;
<span class="p_add">+		ppp-&gt;owner = file;</span>
 		err = -EFAULT;
 		if (put_user(ppp-&gt;file.index, p))
 			break;
<span class="p_chunk">@@ -919,16 +916,6 @@</span> <span class="p_context"> static __net_init int ppp_init_net(struct net *net)</span>
 static __net_exit void ppp_exit_net(struct net *net)
 {
 	struct ppp_net *pn = net_generic(net, ppp_net_id);
<span class="p_del">-	struct ppp *ppp;</span>
<span class="p_del">-	LIST_HEAD(list);</span>
<span class="p_del">-	int id;</span>
<span class="p_del">-</span>
<span class="p_del">-	rtnl_lock();</span>
<span class="p_del">-	idr_for_each_entry(&amp;pn-&gt;units_idr, ppp, id)</span>
<span class="p_del">-		unregister_netdevice_queue(ppp-&gt;dev, &amp;list);</span>
<span class="p_del">-</span>
<span class="p_del">-	unregister_netdevice_many(&amp;list);</span>
<span class="p_del">-	rtnl_unlock();</span>
 
 	idr_destroy(&amp;pn-&gt;units_idr);
 }
<span class="p_chunk">@@ -1101,28 +1088,8 @@</span> <span class="p_context"> static int ppp_dev_init(struct net_device *dev)</span>
 	return 0;
 }
 
<span class="p_del">-static void ppp_dev_uninit(struct net_device *dev)</span>
<span class="p_del">-{</span>
<span class="p_del">-	struct ppp *ppp = netdev_priv(dev);</span>
<span class="p_del">-	struct ppp_net *pn = ppp_pernet(ppp-&gt;ppp_net);</span>
<span class="p_del">-</span>
<span class="p_del">-	ppp_lock(ppp);</span>
<span class="p_del">-	ppp-&gt;closing = 1;</span>
<span class="p_del">-	ppp_unlock(ppp);</span>
<span class="p_del">-</span>
<span class="p_del">-	mutex_lock(&amp;pn-&gt;all_ppp_mutex);</span>
<span class="p_del">-	unit_put(&amp;pn-&gt;units_idr, ppp-&gt;file.index);</span>
<span class="p_del">-	mutex_unlock(&amp;pn-&gt;all_ppp_mutex);</span>
<span class="p_del">-</span>
<span class="p_del">-	ppp-&gt;owner = NULL;</span>
<span class="p_del">-</span>
<span class="p_del">-	ppp-&gt;file.dead = 1;</span>
<span class="p_del">-	wake_up_interruptible(&amp;ppp-&gt;file.rwait);</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
 static const struct net_device_ops ppp_netdev_ops = {
 	.ndo_init	 = ppp_dev_init,
<span class="p_del">-	.ndo_uninit      = ppp_dev_uninit,</span>
 	.ndo_start_xmit  = ppp_start_xmit,
 	.ndo_do_ioctl    = ppp_net_ioctl,
 	.ndo_get_stats64 = ppp_get_stats64,
<span class="p_chunk">@@ -2700,8 +2667,8 @@</span> <span class="p_context"> ppp_get_stats(struct ppp *ppp, struct ppp_stats *st)</span>
  * or if there is already a unit with the requested number.
  * unit == -1 means allocate a new number.
  */
<span class="p_del">-static struct ppp *ppp_create_interface(struct net *net, int unit,</span>
<span class="p_del">-					struct file *file, int *retp)</span>
<span class="p_add">+static struct ppp *</span>
<span class="p_add">+ppp_create_interface(struct net *net, int unit, int *retp)</span>
 {
 	struct ppp *ppp;
 	struct ppp_net *pn;
<span class="p_chunk">@@ -2721,7 +2688,6 @@</span> <span class="p_context"> static struct ppp *ppp_create_interface(struct net *net, int unit,</span>
 	ppp-&gt;mru = PPP_MRU;
 	init_ppp_file(&amp;ppp-&gt;file, INTERFACE);
 	ppp-&gt;file.hdrlen = PPP_HDRLEN - 2;	/* don&#39;t count proto bytes */
<span class="p_del">-	ppp-&gt;owner = file;</span>
 	for (i = 0; i &lt; NUM_NP; ++i)
 		ppp-&gt;npmode[i] = NPMODE_PASS;
 	INIT_LIST_HEAD(&amp;ppp-&gt;channels);
<span class="p_chunk">@@ -2810,6 +2776,34 @@</span> <span class="p_context"> init_ppp_file(struct ppp_file *pf, int kind)</span>
 }
 
 /*
<span class="p_add">+ * Take down a ppp interface unit - called when the owning file</span>
<span class="p_add">+ * (the one that created the unit) is closed or detached.</span>
<span class="p_add">+ */</span>
<span class="p_add">+static void ppp_shutdown_interface(struct ppp *ppp)</span>
<span class="p_add">+{</span>
<span class="p_add">+	struct ppp_net *pn;</span>
<span class="p_add">+</span>
<span class="p_add">+	pn = ppp_pernet(ppp-&gt;ppp_net);</span>
<span class="p_add">+	mutex_lock(&amp;pn-&gt;all_ppp_mutex);</span>
<span class="p_add">+</span>
<span class="p_add">+	/* This will call dev_close() for us. */</span>
<span class="p_add">+	ppp_lock(ppp);</span>
<span class="p_add">+	if (!ppp-&gt;closing) {</span>
<span class="p_add">+		ppp-&gt;closing = 1;</span>
<span class="p_add">+		ppp_unlock(ppp);</span>
<span class="p_add">+		unregister_netdev(ppp-&gt;dev);</span>
<span class="p_add">+		unit_put(&amp;pn-&gt;units_idr, ppp-&gt;file.index);</span>
<span class="p_add">+	} else</span>
<span class="p_add">+		ppp_unlock(ppp);</span>
<span class="p_add">+</span>
<span class="p_add">+	ppp-&gt;file.dead = 1;</span>
<span class="p_add">+	ppp-&gt;owner = NULL;</span>
<span class="p_add">+	wake_up_interruptible(&amp;ppp-&gt;file.rwait);</span>
<span class="p_add">+</span>
<span class="p_add">+	mutex_unlock(&amp;pn-&gt;all_ppp_mutex);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+/*</span>
  * Free the memory used by a ppp unit.  This is only called once
  * there are no channels connected to the unit and no file structs
  * that reference the unit.
<span class="p_header">diff --git a/drivers/net/wimax/i2400m/fw.c b/drivers/net/wimax/i2400m/fw.c</span>
<span class="p_header">index c9c711dcd0e6..a89b5685e68b 100644</span>
<span class="p_header">--- a/drivers/net/wimax/i2400m/fw.c</span>
<span class="p_header">+++ b/drivers/net/wimax/i2400m/fw.c</span>
<span class="p_chunk">@@ -652,7 +652,7 @@</span> <span class="p_context"> static int i2400m_download_chunk(struct i2400m *i2400m, const void *chunk,</span>
 	struct device *dev = i2400m_dev(i2400m);
 	struct {
 		struct i2400m_bootrom_header cmd;
<span class="p_del">-		u8 cmd_payload[chunk_len];</span>
<span class="p_add">+		u8 cmd_payload[];</span>
 	} __packed *buf;
 	struct i2400m_bootrom_header ack;
 
<span class="p_header">diff --git a/drivers/scsi/megaraid/megaraid_sas_base.c b/drivers/scsi/megaraid/megaraid_sas_base.c</span>
<span class="p_header">index 71b884dae27c..8aeb7c72aab8 100644</span>
<span class="p_header">--- a/drivers/scsi/megaraid/megaraid_sas_base.c</span>
<span class="p_header">+++ b/drivers/scsi/megaraid/megaraid_sas_base.c</span>
<span class="p_chunk">@@ -228,7 +228,7 @@</span> <span class="p_context"> struct megasas_cmd *megasas_get_cmd(struct megasas_instance</span>
  * @instance:		Adapter soft state
  * @cmd:		Command packet to be returned to free command pool
  */
<span class="p_del">-inline void</span>
<span class="p_add">+void</span>
 megasas_return_cmd(struct megasas_instance *instance, struct megasas_cmd *cmd)
 {
 	unsigned long flags;
<span class="p_header">diff --git a/fs/compat_ioctl.c b/fs/compat_ioctl.c</span>
<span class="p_header">index 48851f6ea6ec..67ffab2d33b9 100644</span>
<span class="p_header">--- a/fs/compat_ioctl.c</span>
<span class="p_header">+++ b/fs/compat_ioctl.c</span>
<span class="p_chunk">@@ -811,7 +811,7 @@</span> <span class="p_context"> static int compat_ioctl_preallocate(struct file *file,</span>
  */
 #define XFORM(i) (((i) ^ ((i) &lt;&lt; 27) ^ ((i) &lt;&lt; 17)) &amp; 0xffffffff)
 
<span class="p_del">-#define COMPATIBLE_IOCTL(cmd) XFORM(cmd),</span>
<span class="p_add">+#define COMPATIBLE_IOCTL(cmd) XFORM((u32)cmd),</span>
 /* ioctl should not be warned about even if it&#39;s not implemented.
    Valid reasons to use this:
    - It is implemented with -&gt;compat_ioctl on some device, but programs
<span class="p_header">diff --git a/fs/exofs/Kconfig b/fs/exofs/Kconfig</span>
<span class="p_header">index 86194b2f799d..492746f9e61b 100644</span>
<span class="p_header">--- a/fs/exofs/Kconfig</span>
<span class="p_header">+++ b/fs/exofs/Kconfig</span>
<span class="p_chunk">@@ -1,6 +1,6 @@</span> <span class="p_context"></span>
 config EXOFS_FS
 	tristate &quot;exofs: OSD based file system support&quot;
<span class="p_del">-	depends on SCSI_OSD_ULD</span>
<span class="p_add">+	depends on SCSI_OSD_ULD &amp;&amp; BROKEN</span>
 	help
 	  EXOFS is a file system that uses an OSD storage device,
 	  as its backing storage.
<span class="p_header">diff --git a/fs/exofs/super.c b/fs/exofs/super.c</span>
<span class="p_header">index b795c567b5e1..2357dc538bb7 100644</span>
<span class="p_header">--- a/fs/exofs/super.c</span>
<span class="p_header">+++ b/fs/exofs/super.c</span>
<span class="p_chunk">@@ -546,27 +546,25 @@</span> <span class="p_context"> static int exofs_devs_2_odi(struct exofs_dt_device_info *dt_dev,</span>
 static int __alloc_dev_table(struct exofs_sb_info *sbi, unsigned numdevs,
 		      struct exofs_dev **peds)
 {
<span class="p_del">-	struct __alloc_ore_devs_and_exofs_devs {</span>
<span class="p_del">-		/* Twice bigger table: See exofs_init_comps() and comment at</span>
<span class="p_del">-		 * exofs_read_lookup_dev_table()</span>
<span class="p_del">-		 */</span>
<span class="p_del">-		struct ore_dev *oreds[numdevs * 2 - 1];</span>
<span class="p_del">-		struct exofs_dev eds[numdevs];</span>
<span class="p_del">-	} *aoded;</span>
<span class="p_add">+	size_t numoreds = numdevs * 2 - 1;</span>
 	struct exofs_dev *eds;
 	unsigned i;
 
<span class="p_del">-	aoded = kzalloc(sizeof(*aoded), GFP_KERNEL);</span>
<span class="p_del">-	if (unlikely(!aoded)) {</span>
<span class="p_add">+	/* Twice bigger table: See exofs_init_comps() and comment at</span>
<span class="p_add">+	 * exofs_read_lookup_dev_table()</span>
<span class="p_add">+	 * XXX: why -1?</span>
<span class="p_add">+	 */</span>
<span class="p_add">+	sbi-&gt;oc.ods = kzalloc(numoreds * sizeof(struct ore_dev) +</span>
<span class="p_add">+			      numdevs * sizeof(struct exofs_dev), GFP_KERNEL);</span>
<span class="p_add">+	if (unlikely(!sbi-&gt;oc.ods)) {</span>
 		EXOFS_ERR(&quot;ERROR: failed allocating Device array[%d]\n&quot;,
 			  numdevs);
 		return -ENOMEM;
 	}
 
<span class="p_del">-	sbi-&gt;oc.ods = aoded-&gt;oreds;</span>
<span class="p_del">-	*peds = eds = aoded-&gt;eds;</span>
<span class="p_add">+	*peds = eds = (void *)sbi-&gt;oc.ods[numoreds];</span>
 	for (i = 0; i &lt; numdevs; ++i)
<span class="p_del">-		aoded-&gt;oreds[i] = &amp;eds[i].ored;</span>
<span class="p_add">+		sbi-&gt;oc.ods[i] = &amp;eds[i].ored;</span>
 	return 0;
 }
 
<span class="p_header">diff --git a/fs/nfs/Kconfig b/fs/nfs/Kconfig</span>
<span class="p_header">index f31fd0dd92c6..e6ef7b3725db 100644</span>
<span class="p_header">--- a/fs/nfs/Kconfig</span>
<span class="p_header">+++ b/fs/nfs/Kconfig</span>
<span class="p_chunk">@@ -125,7 +125,7 @@</span> <span class="p_context"> config PNFS_BLOCK</span>
 
 config PNFS_OBJLAYOUT
 	tristate
<span class="p_del">-	depends on NFS_V4_1 &amp;&amp; SCSI_OSD_ULD</span>
<span class="p_add">+	depends on NFS_V4_1 &amp;&amp; SCSI_OSD_ULD &amp;&amp; BROKEN</span>
 	default NFS_V4
 
 config PNFS_FLEXFILE_LAYOUT
<span class="p_header">diff --git a/fs/nfs/objlayout/objio_osd.c b/fs/nfs/objlayout/objio_osd.c</span>
<span class="p_header">index 5aaed363556a..9259037f1cec 100644</span>
<span class="p_header">--- a/fs/nfs/objlayout/objio_osd.c</span>
<span class="p_header">+++ b/fs/nfs/objlayout/objio_osd.c</span>
<span class="p_chunk">@@ -301,10 +301,11 @@</span> <span class="p_context"> objio_alloc_io_state(struct pnfs_layout_hdr *pnfs_layout_type, bool is_reading,</span>
 	int ret;
 	struct __alloc_objio_state {
 		struct objio_state objios;
<span class="p_del">-		struct pnfs_osd_ioerr ioerrs[objio_seg-&gt;oc.numdevs];</span>
<span class="p_add">+		struct pnfs_osd_ioerr ioerrs[];</span>
 	} *aos;
 
<span class="p_del">-	aos = kzalloc(sizeof(*aos), gfp_flags);</span>
<span class="p_add">+	aos = kzalloc(sizeof(*aos) + objio_seg-&gt;oc.numdevs *</span>
<span class="p_add">+		      sizeof(struct pnfs_osd_ioerr), gfp_flags);</span>
 	if (unlikely(!aos))
 		return -ENOMEM;
 
<span class="p_header">diff --git a/include/linux/compiler-gcc.h b/include/linux/compiler-gcc.h</span>
<span class="p_header">index dfaa7b3e9ae9..929a3f0d2b08 100644</span>
<span class="p_header">--- a/include/linux/compiler-gcc.h</span>
<span class="p_header">+++ b/include/linux/compiler-gcc.h</span>
<span class="p_chunk">@@ -70,14 +70,14 @@</span> <span class="p_context"></span>
  */
 #if !defined(CONFIG_ARCH_SUPPORTS_OPTIMIZED_INLINING) ||		\
     !defined(CONFIG_OPTIMIZE_INLINING) || (__GNUC__ &lt; 4)
<span class="p_del">-#define inline		inline		__attribute__((always_inline)) notrace</span>
<span class="p_del">-#define __inline__	__inline__	__attribute__((always_inline)) notrace</span>
<span class="p_add">+#define inline		inline		__attribute__((always_inline)) notrace __maybe_unused</span>
<span class="p_add">+#define __inline__	__inline__	__attribute__((always_inline)) notrace __maybe_unused</span>
 #define __inline	__inline	__attribute__((always_inline)) notrace
 #else
 /* A lot of inline functions can cause havoc with function tracing */
<span class="p_del">-#define inline		inline		notrace</span>
<span class="p_del">-#define __inline__	__inline__	notrace</span>
<span class="p_del">-#define __inline	__inline	notrace</span>
<span class="p_add">+#define inline		inline		notrace __maybe_unused</span>
<span class="p_add">+#define __inline__	__inline__	notrace __maybe_unused</span>
<span class="p_add">+#define __inline	__inline	notrace __maybe_unused</span>
 #endif
 
 #define __always_inline	inline __attribute__((always_inline))
<span class="p_header">diff --git a/include/linux/kbuild.h b/include/linux/kbuild.h</span>
<span class="p_header">index 22a72198c14b..75fa2c3e0e1d 100644</span>
<span class="p_header">--- a/include/linux/kbuild.h</span>
<span class="p_header">+++ b/include/linux/kbuild.h</span>
<span class="p_chunk">@@ -2,14 +2,14 @@</span> <span class="p_context"></span>
 #define __LINUX_KBUILD_H
 
 #define DEFINE(sym, val) \
<span class="p_del">-        asm volatile(&quot;\n-&gt;&quot; #sym &quot; %0 &quot; #val : : &quot;i&quot; (val))</span>
<span class="p_add">+	asm volatile(&quot;\n@-&gt;&quot; #sym &quot; %0 &quot; #val : : &quot;i&quot; (val))</span>
 
<span class="p_del">-#define BLANK() asm volatile(&quot;\n-&gt;&quot; : : )</span>
<span class="p_add">+#define BLANK() asm volatile(&quot;\n@-&gt;&quot; : : )</span>
 
 #define OFFSET(sym, str, mem) \
 	DEFINE(sym, offsetof(struct str, mem))
 
 #define COMMENT(x) \
<span class="p_del">-	asm volatile(&quot;\n-&gt;#&quot; x)</span>
<span class="p_add">+	asm volatile(&quot;\n@-&gt;#&quot; x)</span>
 
 #endif
<span class="p_header">diff --git a/include/scsi/osd_types.h b/include/scsi/osd_types.h</span>
<span class="p_header">index 48e8a165e136..c7ae7211d15d 100644</span>
<span class="p_header">--- a/include/scsi/osd_types.h</span>
<span class="p_header">+++ b/include/scsi/osd_types.h</span>
<span class="p_chunk">@@ -28,7 +28,7 @@</span> <span class="p_context"> struct osd_obj_id {</span>
 	osd_id id;
 };
 
<span class="p_del">-static const struct __weak osd_obj_id osd_root_object = {0, 0};</span>
<span class="p_add">+static const struct osd_obj_id osd_root_object __maybe_unused = {0, 0};</span>
 
 struct osd_attr {
 	u32 attr_page;
<span class="p_header">diff --git a/lib/Makefile b/lib/Makefile</span>
<span class="p_header">index 6897b527581a..068188564a6a 100644</span>
<span class="p_header">--- a/lib/Makefile</span>
<span class="p_header">+++ b/lib/Makefile</span>
<span class="p_chunk">@@ -55,7 +55,9 @@</span> <span class="p_context"> obj-$(CONFIG_CHECK_SIGNATURE) += check_signature.o</span>
 obj-$(CONFIG_DEBUG_LOCKING_API_SELFTESTS) += locking-selftest.o
 
 GCOV_PROFILE_hweight.o := n
<span class="p_add">+ifneq ($(COMPILER),clang)</span>
 CFLAGS_hweight.o = $(subst $(quote),,$(CONFIG_ARCH_HWEIGHT_CFLAGS))
<span class="p_add">+endif</span>
 obj-$(CONFIG_GENERIC_HWEIGHT) += hweight.o
 
 obj-$(CONFIG_BTREE) += btree.o
<span class="p_header">diff --git a/lib/mpi/Makefile b/lib/mpi/Makefile</span>
<span class="p_header">index 019a68c90144..d5553f6b9f09 100644</span>
<span class="p_header">--- a/lib/mpi/Makefile</span>
<span class="p_header">+++ b/lib/mpi/Makefile</span>
<span class="p_chunk">@@ -4,6 +4,8 @@</span> <span class="p_context"></span>
 
 obj-$(CONFIG_MPILIB) = mpi.o
 
<span class="p_add">+CFLAGS_KERNEL += $(call cc-option,-fheinous-gnu-extensions)</span>
<span class="p_add">+</span>
 mpi-y = \
 	generic_mpih-lshift.o		\
 	generic_mpih-mul1.o		\
<span class="p_header">diff --git a/lib/mpi/longlong.h b/lib/mpi/longlong.h</span>
<span class="p_header">index a89d041592c8..d4477621f1eb 100644</span>
<span class="p_header">--- a/lib/mpi/longlong.h</span>
<span class="p_header">+++ b/lib/mpi/longlong.h</span>
<span class="p_chunk">@@ -193,8 +193,7 @@</span> <span class="p_context"> extern UDItype __udiv_qrnnd(UDItype *, UDItype, UDItype, UDItype);</span>
 		&quot;rI&quot; ((USItype)(bl)))
 #if defined __ARM_ARCH_2__ || defined __ARM_ARCH_3__
 #define umul_ppmm(xh, xl, a, b) \
<span class="p_del">-	__asm__ (&quot;%@ Inlined umul_ppmm\n&quot; \</span>
<span class="p_del">-		&quot;mov	%|r0, %2, lsr #16		@ AAAA\n&quot; \</span>
<span class="p_add">+	__asm__ (&quot;mov	%|r0, %2, lsr #16		@ AAAA\n&quot; \</span>
 		&quot;mov	%|r2, %3, lsr #16		@ BBBB\n&quot; \
 		&quot;bic	%|r1, %2, %|r0, lsl #16		@ aaaa\n&quot; \
 		&quot;bic	%0, %3, %|r2, lsl #16		@ bbbb\n&quot; \
<span class="p_chunk">@@ -213,10 +212,8 @@</span> <span class="p_context"> extern UDItype __udiv_qrnnd(UDItype *, UDItype, UDItype, UDItype);</span>
 	: &quot;r0&quot;, &quot;r1&quot;, &quot;r2&quot;)
 #else
 #define umul_ppmm(xh, xl, a, b) \
<span class="p_del">-	__asm__ (&quot;%@ Inlined umul_ppmm\n&quot; \</span>
<span class="p_del">-		&quot;umull %r1, %r0, %r2, %r3&quot; \</span>
<span class="p_del">-	: &quot;=&amp;r&quot; ((USItype)(xh)), \</span>
<span class="p_del">-			&quot;=r&quot; ((USItype)(xl)) \</span>
<span class="p_add">+	__asm__ (&quot;umull %1, %0, %2, %3&quot; \</span>
<span class="p_add">+	: &quot;=&amp;r&quot; ((xh)), &quot;=r&quot; ((xl)) \</span>
 	: &quot;r&quot; ((USItype)(a)), \
 			&quot;r&quot; ((USItype)(b)) \
 	: &quot;r0&quot;, &quot;r1&quot;)
<span class="p_header">diff --git a/lib/mpi/mpi-inline.h b/lib/mpi/mpi-inline.h</span>
<span class="p_header">index e2b39852b30a..c245ea31f785 100644</span>
<span class="p_header">--- a/lib/mpi/mpi-inline.h</span>
<span class="p_header">+++ b/lib/mpi/mpi-inline.h</span>
<span class="p_chunk">@@ -30,7 +30,7 @@</span> <span class="p_context"></span>
 #define G10_MPI_INLINE_H
 
 #ifndef G10_MPI_INLINE_DECL
<span class="p_del">-#define G10_MPI_INLINE_DECL  extern inline</span>
<span class="p_add">+#define G10_MPI_INLINE_DECL  static inline</span>
 #endif
 
 G10_MPI_INLINE_DECL mpi_limb_t
<span class="p_header">diff --git a/lib/mpi/mpi-internal.h b/lib/mpi/mpi-internal.h</span>
<span class="p_header">index c65dd1bff45a..09e9f13c5ba0 100644</span>
<span class="p_header">--- a/lib/mpi/mpi-internal.h</span>
<span class="p_header">+++ b/lib/mpi/mpi-internal.h</span>
<span class="p_chunk">@@ -168,20 +168,12 @@</span> <span class="p_context"> void mpi_rshift_limbs(MPI a, unsigned int count);</span>
 int mpi_lshift_limbs(MPI a, unsigned int count);
 
 /*-- mpihelp-add.c --*/
<span class="p_del">-mpi_limb_t mpihelp_add_1(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr,</span>
<span class="p_del">-			 mpi_size_t s1_size, mpi_limb_t s2_limb);</span>
 mpi_limb_t mpihelp_add_n(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr,
 			 mpi_ptr_t s2_ptr, mpi_size_t size);
<span class="p_del">-mpi_limb_t mpihelp_add(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr, mpi_size_t s1_size,</span>
<span class="p_del">-		       mpi_ptr_t s2_ptr, mpi_size_t s2_size);</span>
 
 /*-- mpihelp-sub.c --*/
<span class="p_del">-mpi_limb_t mpihelp_sub_1(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr,</span>
<span class="p_del">-			 mpi_size_t s1_size, mpi_limb_t s2_limb);</span>
 mpi_limb_t mpihelp_sub_n(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr,
 			 mpi_ptr_t s2_ptr, mpi_size_t size);
<span class="p_del">-mpi_limb_t mpihelp_sub(mpi_ptr_t res_ptr, mpi_ptr_t s1_ptr, mpi_size_t s1_size,</span>
<span class="p_del">-		       mpi_ptr_t s2_ptr, mpi_size_t s2_size);</span>
 
 /*-- mpihelp-cmp.c --*/
 int mpihelp_cmp(mpi_ptr_t op1_ptr, mpi_ptr_t op2_ptr, mpi_size_t size);
<span class="p_chunk">@@ -238,7 +230,7 @@</span> <span class="p_context"> mpi_limb_t mpihelp_rshift(mpi_ptr_t wp, mpi_ptr_t up, mpi_size_t usize,</span>
 #define W_TYPE_SIZE BITS_PER_MPI_LIMB
 typedef mpi_limb_t UWtype;
 typedef unsigned int UHWtype;
<span class="p_del">-#if defined(__GNUC__)</span>
<span class="p_add">+#if defined(__GNUC__) &amp;&amp; !defined(__clang__)</span>
 typedef unsigned int UQItype __attribute__ ((mode(QI)));
 typedef int SItype __attribute__ ((mode(SI)));
 typedef unsigned int USItype __attribute__ ((mode(SI)));
<span class="p_header">diff --git a/scripts/Kbuild.include b/scripts/Kbuild.include</span>
<span class="p_header">index d3437b82ac25..bd5a3e26a277 100644</span>
<span class="p_header">--- a/scripts/Kbuild.include</span>
<span class="p_header">+++ b/scripts/Kbuild.include</span>
<span class="p_chunk">@@ -111,12 +111,12 @@</span> <span class="p_context"> as-instr = $(call try-run,\</span>
 # Usage: cflags-y += $(call cc-option,-march=winchip-c6,-march=i586)
 
 cc-option = $(call try-run,\
<span class="p_del">-	$(CC) $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) $(1) -c -x c /dev/null -o &quot;$$TMP&quot;,$(1),$(2))</span>
<span class="p_add">+	$(CC) -Werror $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) $(1) -c -x c /dev/null -o &quot;$$TMP&quot;,$(1),$(2))</span>
 
 # cc-option-yn
 # Usage: flag := $(call cc-option-yn,-march=winchip-c6)
 cc-option-yn = $(call try-run,\
<span class="p_del">-	$(CC) $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) $(1) -c -x c /dev/null -o &quot;$$TMP&quot;,y,n)</span>
<span class="p_add">+	$(CC) -Werror $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) $(1) -c -x c /dev/null -o &quot;$$TMP&quot;,y,n)</span>
 
 # cc-option-align
 # Prefix align with either -falign or -malign
<span class="p_chunk">@@ -126,7 +126,7 @@</span> <span class="p_context"> cc-option-align = $(subst -functions=0,,\</span>
 # cc-disable-warning
 # Usage: cflags-y += $(call cc-disable-warning,unused-but-set-variable)
 cc-disable-warning = $(call try-run,\
<span class="p_del">-	$(CC) $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) -W$(strip $(1)) -c -x c /dev/null -o &quot;$$TMP&quot;,-Wno-$(strip $(1)))</span>
<span class="p_add">+	$(CC) -Werror $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) -W$(strip $(1)) -c -x c /dev/null -o &quot;$$TMP&quot;,-Wno-$(strip $(1)))</span>
 
 # cc-version
 cc-version = $(shell $(CONFIG_SHELL) $(srctree)/scripts/gcc-version.sh $(CC))
<span class="p_header">diff --git a/scripts/Makefile.build b/scripts/Makefile.build</span>
<span class="p_header">index 01df30af4d4a..6ff524dac82b 100644</span>
<span class="p_header">--- a/scripts/Makefile.build</span>
<span class="p_header">+++ b/scripts/Makefile.build</span>
<span class="p_chunk">@@ -174,6 +174,20 @@</span> <span class="p_context"> cmd_cc_symtypes_c =                                                         \</span>
 $(obj)/%.symtypes : $(src)/%.c FORCE
 	$(call cmd,cc_symtypes_c)
 
<span class="p_add">+# LLVM bitcode</span>
<span class="p_add">+# Generate .ll files from .s and .c</span>
<span class="p_add">+quiet_cmd_cc_ll_c = CC $(quiet_modtag)  $@</span>
<span class="p_add">+      cmd_cc_ll_c = $(CC) $(c_flags) -emit-llvm -S -o $@ $&lt;</span>
<span class="p_add">+</span>
<span class="p_add">+$(obj)/%.ll: $(src)/%.c FORCE</span>
<span class="p_add">+	$(call if_changed_dep,cc_ll_c)</span>
<span class="p_add">+</span>
<span class="p_add">+quiet_cmd_as_ll_S = CPP $(quiet_modtag) $@</span>
<span class="p_add">+      cmd_as_ll_S = $(CPP) $(a_flags)   -o $@ $&lt;</span>
<span class="p_add">+</span>
<span class="p_add">+$(obj)/%.ll: $(src)/%.S FORCE</span>
<span class="p_add">+	$(call if_changed_dep,as_ll_S)</span>
<span class="p_add">+</span>
 # C (.c) files
 # The C file is compiled and updated dependency information is generated.
 # (See cmd_cc_o_c + relevant part of rule_cc_o_c)
<span class="p_header">diff --git a/scripts/mod/Makefile b/scripts/mod/Makefile</span>
<span class="p_header">index c11212ff3510..86f6b852cd93 100644</span>
<span class="p_header">--- a/scripts/mod/Makefile</span>
<span class="p_header">+++ b/scripts/mod/Makefile</span>
<span class="p_chunk">@@ -6,10 +6,10 @@</span> <span class="p_context"> modpost-objs	:= modpost.o file2alias.o sumversion.o</span>
 devicetable-offsets-file := devicetable-offsets.h
 
 define sed-y
<span class="p_del">-	&quot;/^-&gt;/{s:-&gt;#\(.*\):/* \1 */:; \</span>
<span class="p_del">-	s:^-&gt;\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_del">-	s:^-&gt;\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_del">-	s:-&gt;::; p;}&quot;</span>
<span class="p_add">+	&quot;/^@-&gt;/{s:@-&gt;#\(.*\):/* \1 */:; \</span>
<span class="p_add">+	s:^@-&gt;\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_add">+	s:^@-&gt;\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \</span>
<span class="p_add">+	s:@-&gt;::; p;}&quot;</span>
 endef
 
 quiet_cmd_offsets = GEN     $@
<span class="p_header">diff --git a/security/apparmor/crypto.c b/security/apparmor/crypto.c</span>
<span class="p_header">index 532471d0b3a0..c948247e90c2 100644</span>
<span class="p_header">--- a/security/apparmor/crypto.c</span>
<span class="p_header">+++ b/security/apparmor/crypto.c</span>
<span class="p_chunk">@@ -32,10 +32,7 @@</span> <span class="p_context"> unsigned int aa_hash_size(void)</span>
 int aa_calc_profile_hash(struct aa_profile *profile, u32 version, void *start,
 			 size_t len)
 {
<span class="p_del">-	struct {</span>
<span class="p_del">-		struct shash_desc shash;</span>
<span class="p_del">-		char ctx[crypto_shash_descsize(apparmor_tfm)];</span>
<span class="p_del">-	} desc;</span>
<span class="p_add">+	SHASH_DESC_ON_STACK(shash, apparmor_tfm);</span>
 	int error = -ENOMEM;
 	u32 le32_version = cpu_to_le32(version);
 
<span class="p_chunk">@@ -46,19 +43,19 @@</span> <span class="p_context"> int aa_calc_profile_hash(struct aa_profile *profile, u32 version, void *start,</span>
 	if (!profile-&gt;hash)
 		goto fail;
 
<span class="p_del">-	desc.shash.tfm = apparmor_tfm;</span>
<span class="p_del">-	desc.shash.flags = 0;</span>
<span class="p_add">+	shash-&gt;tfm = apparmor_tfm;</span>
<span class="p_add">+	shash-&gt;flags = 0;</span>
 
<span class="p_del">-	error = crypto_shash_init(&amp;desc.shash);</span>
<span class="p_add">+	error = crypto_shash_init(shash);</span>
 	if (error)
 		goto fail;
<span class="p_del">-	error = crypto_shash_update(&amp;desc.shash, (u8 *) &amp;le32_version, 4);</span>
<span class="p_add">+	error = crypto_shash_update(shash, (u8 *) &amp;le32_version, 4);</span>
 	if (error)
 		goto fail;
<span class="p_del">-	error = crypto_shash_update(&amp;desc.shash, (u8 *) start, len);</span>
<span class="p_add">+	error = crypto_shash_update(shash, (u8 *) start, len);</span>
 	if (error)
 		goto fail;
<span class="p_del">-	error = crypto_shash_final(&amp;desc.shash, profile-&gt;hash);</span>
<span class="p_add">+	error = crypto_shash_final(shash, profile-&gt;hash);</span>
 	if (error)
 		goto fail;
 
</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



