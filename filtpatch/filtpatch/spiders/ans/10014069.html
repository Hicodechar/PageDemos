
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>n900 in next-20170901 - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    n900 in next-20170901</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Oct. 18, 2017, 8:29 a.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;20171018082927.GB27595@js1304-P5Q-DELUXE&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/10014069/mbox/"
   >mbox</a>
|
   <a href="/patch/10014069/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/10014069/">/patch/10014069/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
	[172.30.200.125])
	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id
	DCB3F60215 for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 18 Oct 2017 08:26:07 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id CA76D28AF8
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 18 Oct 2017 08:26:07 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id BF41E28AFC; Wed, 18 Oct 2017 08:26:07 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-6.9 required=2.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=unavailable version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 82D1A28AF9
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Wed, 18 Oct 2017 08:26:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S936102AbdJRI0C (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Wed, 18 Oct 2017 04:26:02 -0400
Received: from LGEAMRELO13.lge.com ([156.147.23.53]:59911 &quot;EHLO
	lgeamrelo13.lge.com&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S933772AbdJRI0A (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Wed, 18 Oct 2017 04:26:00 -0400
Received: from unknown (HELO lgeamrelo01.lge.com) (156.147.1.125)
	by 156.147.23.53 with ESMTP; 18 Oct 2017 17:25:56 +0900
X-Original-SENDERIP: 156.147.1.125
X-Original-MAILFROM: iamjoonsoo.kim@lge.com
Received: from unknown (HELO localhost) (10.177.222.138)
	by 156.147.1.125 with ESMTP; 18 Oct 2017 17:25:55 +0900
X-Original-SENDERIP: 10.177.222.138
X-Original-MAILFROM: iamjoonsoo.kim@lge.com
Date: Wed, 18 Oct 2017 17:29:28 +0900
From: Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt;
To: Tony Lindgren &lt;tony@atomide.com&gt;
Cc: Pavel Machek &lt;pavel@ucw.cz&gt;, pali.rohar@gmail.com, sre@kernel.org,
	kernel list &lt;linux-kernel@vger.kernel.org&gt;,
	linux-arm-kernel &lt;linux-arm-kernel@lists.infradead.org&gt;,
	linux-omap@vger.kernel.org, khilman@kernel.org,
	aaro.koskinen@iki.fi, ivo.g.dimitrov.75@gmail.com,
	patrikbachan@gmail.com, serge@hallyn.com, abcloriens@gmail.com,
	&quot;Aneesh Kumar K.V&quot; &lt;aneesh.kumar@linux.vnet.ibm.com&gt;,
	Vlastimil Babka &lt;vbabka@suse.cz&gt;,
	Andrew Morton &lt;akpm@linux-foundation.org&gt;,
	Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;,
	Russell King &lt;linux@armlinux.org.uk&gt;
Subject: Re: n900 in next-20170901
Message-ID: &lt;20171018082927.GB27595@js1304-P5Q-DELUXE&gt;
References: &lt;20170905233241.GA19231@js1304-P5Q-DELUXE&gt;
	&lt;20170906133057.GH5024@atomide.com&gt;
	&lt;20170907073038.GA2111@js1304-P5Q-DELUXE&gt;
	&lt;20170907161650.GP5024@atomide.com&gt;
	&lt;20170913075516.GA25036@js1304-P5Q-DELUXE&gt;
	&lt;20170913163126.GS5024@atomide.com&gt;
	&lt;20170915065608.GA8567@js1304-P5Q-DELUXE&gt;
	&lt;20170921172811.GB4394@atomide.com&gt;
	&lt;20170925080806.GA9837@js1304-P5Q-DELUXE&gt;
	&lt;20170925145437.GG4394@atomide.com&gt;
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: &lt;20170925145437.GG4394@atomide.com&gt;
User-Agent: Mutt/1.5.21 (2010-09-15)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Oct. 18, 2017, 8:29 a.m.</div>
<pre class="content">
On Mon, Sep 25, 2017 at 07:54:37AM -0700, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170925 01:06]:</span>
<span class="quote">&gt; &gt; On Thu, Sep 21, 2017 at 10:28:11AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170914 23:55]:</span>
<span class="quote">&gt; &gt; &gt; &gt; On Wed, Sep 13, 2017 at 09:31:27AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Yes I disabled CONFIG_HIGHMEM and n900 boots. To disable it,</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; you need to remove it from arch/arm/mach-omap2/Kconfig that</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; selects it if ARCH_OMAP2PLUS_TYPICAL is selected.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Okay. Problem would be related to address traslation. I&#39;d like to</span>
<span class="quote">&gt; &gt; &gt; &gt; check address traslation more. Could you apply following patch and</span>
<span class="quote">&gt; &gt; &gt; &gt; test it? And, please send me the dmesg log and your kernel config.</span>
<span class="quote">&gt; &gt; &gt; &gt; Please test this with CONFIG_DEBUG_VIRTUAL = n and CONFIG_CMA_DEBUG=y and</span>
<span class="quote">&gt; &gt; &gt; &gt; CONFIG_HIGHMEM=y and with kernel bootparam &#39;ignore_loglevel&#39;.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; It would be really appreciate if you send me two logs for before/after</span>
<span class="quote">&gt; &gt; &gt; &gt; commit 9caf25f996e8.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Sorry for the delays, I finally got around testing this for you.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; No problem! I really appreciate your help!</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Compile with your patch failed for modules with __virt_to_phys_debug</span>
<span class="quote">&gt; &gt; &gt; being undefined so I added EXPORT_SYMBOL there. I also enabled DEBUG_LL</span>
<span class="quote">&gt; &gt; &gt; and EARLYPRINTK to get output.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Below is dmesg output for 9caf25f996e8 + your patch. I&#39;ll send you</span>
<span class="quote">&gt; &gt; &gt; the full logs separately.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Hmm...there is only one caller for the CMA memory, that is, atomic_pool_init().</span>
<span class="quote">&gt; &gt; Could you test one more time with 9caf25f996e8 + following patch?  I&#39;d like to</span>
<span class="quote">&gt; &gt; know the actual user for the CMA memory.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Hmm not getting any stack with that patch after manually applying</span>
<span class="quote">&gt; it because of tabs to spaces mangling.</span>

Sorry for long delay.

Seems like your system doesn&#39;t use any CMA memory by CMA API.

Could you test one more thing?
This one is to disable CMA memory allocation from the page allocator.
With this, we can be sure that CMA memory isn&#39;t used at all.

If there is no difference with this patch, that is, the system down,
I think that some initialization step is broken. In this case, please
test following patch.

I make a branch in github that all these patch is applied.
Feel free to use it.

https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901

Thanks.

---------------&gt;8----------------------
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Oct. 19, 2017, 6:30 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171018 01:27]:
<span class="quote">&gt; On Mon, Sep 25, 2017 at 07:54:37AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170925 01:06]:</span>
<span class="quote">&gt; &gt; &gt; On Thu, Sep 21, 2017 at 10:28:11AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170914 23:55]:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; On Wed, Sep 13, 2017 at 09:31:27AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; Yes I disabled CONFIG_HIGHMEM and n900 boots. To disable it,</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; you need to remove it from arch/arm/mach-omap2/Kconfig that</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; selects it if ARCH_OMAP2PLUS_TYPICAL is selected.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Okay. Problem would be related to address traslation. I&#39;d like to</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; check address traslation more. Could you apply following patch and</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; test it? And, please send me the dmesg log and your kernel config.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Please test this with CONFIG_DEBUG_VIRTUAL = n and CONFIG_CMA_DEBUG=y and</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; CONFIG_HIGHMEM=y and with kernel bootparam &#39;ignore_loglevel&#39;.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; It would be really appreciate if you send me two logs for before/after</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; commit 9caf25f996e8.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Sorry for the delays, I finally got around testing this for you.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; No problem! I really appreciate your help!</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Compile with your patch failed for modules with __virt_to_phys_debug</span>
<span class="quote">&gt; &gt; &gt; &gt; being undefined so I added EXPORT_SYMBOL there. I also enabled DEBUG_LL</span>
<span class="quote">&gt; &gt; &gt; &gt; and EARLYPRINTK to get output.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Below is dmesg output for 9caf25f996e8 + your patch. I&#39;ll send you</span>
<span class="quote">&gt; &gt; &gt; &gt; the full logs separately.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Hmm...there is only one caller for the CMA memory, that is, atomic_pool_init().</span>
<span class="quote">&gt; &gt; &gt; Could you test one more time with 9caf25f996e8 + following patch?  I&#39;d like to</span>
<span class="quote">&gt; &gt; &gt; know the actual user for the CMA memory.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Hmm not getting any stack with that patch after manually applying</span>
<span class="quote">&gt; &gt; it because of tabs to spaces mangling.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Sorry for long delay.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Seems like your system doesn&#39;t use any CMA memory by CMA API.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Could you test one more thing?</span>
<span class="quote">&gt; This one is to disable CMA memory allocation from the page allocator.</span>
<span class="quote">&gt; With this, we can be sure that CMA memory isn&#39;t used at all.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; If there is no difference with this patch, that is, the system down,</span>
<span class="quote">&gt; I think that some initialization step is broken. In this case, please</span>
<span class="quote">&gt; test following patch.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; I make a branch in github that all these patch is applied.</span>
<span class="quote">&gt; Feel free to use it.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>

Still not booting, dmesg output of your test branch below.

Regards,

Tony

8&lt; -------------------------
[    0.000000] Booting Linux on physical CPU 0x0
[    0.000000] Linux version 4.13.0-rc7-next-20170901-00010-gf93e559a038d (tmlind@sampyla) (gcc version 6.3.1 20170109 (crosstool-NG crosstool-ng-1.23.0)) #475 SMP Thu Oct 19 11:09:34 PDT 2017
[    0.000000] CPU: ARMv7 Processor [411fc083] revision 3 (ARMv7), cr=10c5387d
[    0.000000] CPU: PIPT / VIPT nonaliasing data cache, VIPT nonaliasing instruction cache
[    0.000000] OF: fdt: Machine model: Nokia N900
[    0.000000] Memory policy: Data cache writeback
[    0.000000] cma: Reserved 16 MiB at 0x8e800000
[    0.000000] CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
[    0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00010-gf93e559a038d #475
[    0.000000] Hardware name: Nokia RX-51 board
[    0.000000] [&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[    0.000000] [&lt;c010caec&gt;] (show_stack) from [&lt;c082eac4&gt;] (dump_stack+0xac/0xe0)
[    0.000000] [&lt;c082eac4&gt;] (dump_stack) from [&lt;c0c06f10&gt;] (dma_contiguous_remap+0x64/0x168)
[    0.000000] [&lt;c0c06f10&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[    0.000000] [&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[    0.000000] [&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[    0.000000] [&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
[    0.000000] CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
[    0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00010-gf93e559a038d #475
[    0.000000] Hardware name: Nokia RX-51 board
[    0.000000] [&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[    0.000000] [&lt;c010caec&gt;] (show_stack) from [&lt;c082eac4&gt;] (dump_stack+0xac/0xe0)
[    0.000000] [&lt;c082eac4&gt;] (dump_stack) from [&lt;c0c06f50&gt;] (dma_contiguous_remap+0xa4/0x168)
[    0.000000] [&lt;c0c06f50&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[    0.000000] [&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[    0.000000] [&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[    0.000000] [&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
[    0.000000] CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
[    0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00010-gf93e559a038d #475
[    0.000000] Hardware name: Nokia RX-51 board
[    0.000000] [&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[    0.000000] [&lt;c010caec&gt;] (show_stack) from [&lt;c082eac4&gt;] (dump_stack+0xac/0xe0)
[    0.000000] [&lt;c082eac4&gt;] (dump_stack) from [&lt;c0c06fcc&gt;] (dma_contiguous_remap+0x120/0x168)
[    0.000000] [&lt;c0c06fcc&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[    0.000000] [&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[    0.000000] [&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[    0.000000] [&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
[    0.000000] On node 0 totalpages: 65024
[    0.000000] free_area_init_node: node 0, pgdat c0dc5040, node_mem_map cfa8b000
[    0.000000]   Normal zone: 572 pages used for memmap
[    0.000000]   Normal zone: 0 pages reserved
[    0.000000]   Normal zone: 65024 pages, LIFO batch:15
[    0.000000] CPU: All CPU(s) started in SVC mode.
[    0.000000] OMAP3430/3530 ES3.1 (l2cache iva sgx neon isp)
[    0.000000] random: fast init done
[    0.000000] percpu: Embedded 18 pages/cpu @cfd9c000 s41644 r8192 d23892 u73728
[    0.000000] pcpu-alloc: s41644 r8192 d23892 u73728 alloc=18*4096
[    0.000000] pcpu-alloc: [0] 0 
[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 64452
[    0.000000] Kernel command line: root=/dev/nfs ip=dhcp console=ttyO2,115200 memmap=2M$0x88000000 ramoops.mem_address=0x88000000 ramoops.mem_size=0x200000 ramoops.record_size=0x40000 debug earlyprintk init=/root/init
[    0.000000] PID hash table entries: 1024 (order: 0, 4096 bytes)
[    0.000000] Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
[    0.000000] Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
[    0.000000] Memory: 220052K/260096K available (8192K kernel code, 816K rwdata, 2420K rodata, 1024K init, 7557K bss, 23660K reserved, 16384K cma-reserved, 0K highmem)
[    0.000000] Virtual kernel memory layout:
[    0.000000]     vector  : 0xffff0000 - 0xffff1000   (   4 kB)
[    0.000000]     fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
[    0.000000]     vmalloc : 0xd0000000 - 0xff800000   ( 760 MB)
[    0.000000]     lowmem  : 0xc0000000 - 0xcfe00000   ( 254 MB)
[    0.000000]     pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)
[    0.000000]     modules : 0xbf000000 - 0xbfe00000   (  14 MB)
[    0.000000]       .text : 0xc0008000 - 0xc0900000   (9184 kB)
[    0.000000]       .init : 0xc0c00000 - 0xc0d00000   (1024 kB)
[    0.000000]       .data : 0xc0d00000 - 0xc0dcc280   ( 817 kB)
[    0.000000]        .bss : 0xc0dce000 - 0xc152f644   (7558 kB)
[    0.000000] Running RCU self tests
[    0.000000] Hierarchical RCU implementation.
[    0.000000] 	RCU event tracing is enabled.
[    0.000000] 	RCU lockdep checking is enabled.
[    0.000000] 	RCU restricting CPUs from NR_CPUS=2 to nr_cpu_ids=1.
[    0.000000] RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
[    0.000000] NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
[    0.000000] IRQ: Found an INTC at 0xfa200000 (revision 4.0) with 96 interrupts
[    0.000000] Clocking rate (Crystal/Core/MPU): 19.2/332/500 MHz
[    0.000000] OMAP clockevent source: timer1 at 32768 Hz
[    0.000000] clocksource: 32k_counter: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 58327039986419 ns
[    0.000030] sched_clock: 32 bits at 32kHz, resolution 30517ns, wraps every 65535999984741ns
[    0.000061] OMAP clocksource: 32k_counter at 32768 Hz
[    0.002716] Console: colour dummy device 80x30
[    0.002807] WARNING: Your &#39;console=ttyO2&#39; has been replaced by &#39;ttyS2&#39;
[    0.002838] This ensures that you still see kernel messages. Please
[    0.002868] update your kernel commandline.
[    0.002899] Lock dependency validator: Copyright (c) 2006 Red Hat, Inc., Ingo Molnar
[    0.002929] ... MAX_LOCKDEP_SUBCLASSES:  8
[    0.002960] ... MAX_LOCK_DEPTH:          48
[    0.002990] ... MAX_LOCKDEP_KEYS:        8191
[    0.003021] ... CLASSHASH_SIZE:          4096
[    0.003051] ... MAX_LOCKDEP_ENTRIES:     32768
[    0.003082] ... MAX_LOCKDEP_CHAINS:      65536
[    0.003112] ... CHAINHASH_SIZE:          32768
[    0.003143]  memory used by lock dependency info: 4655 kB
[    0.003173]  per task-struct memory footprint: 1536 bytes
[    0.003234] Calibrating delay loop... 493.97 BogoMIPS (lpj=2469888)
[    0.104431] pid_max: default: 32768 minimum: 301
[    0.105895] Security Framework initialized
[    0.106658] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
[    0.106781] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
[    0.116973] CPU: Testing write buffer coherency: ok
[    0.121459] CPU0: thread -1, cpu 0, socket -1, mpidr 0
[    0.128570] Setting up static identity map for 0x80100000 - 0x80100078
[    0.130950] Hierarchical SRCU implementation.
[    0.140258] smp: Bringing up secondary CPUs ...
[    0.140380] smp: Brought up 1 node, 1 CPU
[    0.140502] SMP: Total of 1 processors activated (493.97 BogoMIPS).
[    0.140594] CPU: All CPU(s) started in SVC mode.
[    0.152923] devtmpfs: initialized
[    0.661376] Built 1 zonelists, mobility grouping on.  Total pages: 59109
[    0.665405] VFP support v0.3: implementor 41 architecture 3 part 30 variant c rev 1
[    0.669372] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
[    0.669586] futex hash table entries: 256 (order: 2, 16384 bytes)
[    0.671386] pinctrl core: initialized pinctrl subsystem
[    0.690399] NET: Registered protocol family 16
[    0.691802] __alloc_from_contiguous
[    0.691925] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.13.0-rc7-next-20170901-00010-gf93e559a038d #475
[    0.692016] Hardware name: Nokia RX-51 board
[    0.692138] [&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[    0.692260] [&lt;c010caec&gt;] (show_stack) from [&lt;c082eac4&gt;] (dump_stack+0xac/0xe0)
[    0.692382] [&lt;c082eac4&gt;] (dump_stack) from [&lt;c011653c&gt;] (__alloc_from_contiguous+0x30/0xf8)
[    0.692504] [&lt;c011653c&gt;] (__alloc_from_contiguous) from [&lt;c0c06d60&gt;] (atomic_pool_init+0x7c/0x178)
[    0.692626] [&lt;c0c06d60&gt;] (atomic_pool_init) from [&lt;c0101df4&gt;] (do_one_initcall+0x3c/0x170)
[    0.692718] [&lt;c0101df4&gt;] (do_one_initcall) from [&lt;c0c00ee4&gt;] (kernel_init_freeable+0x1fc/0x2c4)
[    0.692840] [&lt;c0c00ee4&gt;] (kernel_init_freeable) from [&lt;c0842a0c&gt;] (kernel_init+0x8/0x110)
[    0.692962] [&lt;c0842a0c&gt;] (kernel_init) from [&lt;c0107d78&gt;] (ret_from_fork+0x14/0x3c)
[    0.726104] DMA: preallocated 256 KiB pool for atomic coherent allocations
[    1.273651] omap_hwmod: mcbsp2_sidetone using broken dt data from mcbsp
[    1.289337] omap_hwmod: mcbsp3_sidetone using broken dt data from mcbsp
[    1.796203] cpuidle: using governor menu
[    1.798645] SRAM_ADDR: omap_map_sram: P: 0x40208000 - 0x4020f000
[    1.798736] SRAM_ADDR: omap_map_sram: V: 0xd0050000 - 0xd0057000
[    1.798889] SRAM_ADDR: omap_sram_push_address: 0xd0056f00 - 0xd0056ffc
[    1.798980] SRAM_ADDR: omap_sram_push_address: 0xd0056e98 - 0xd0056f00
[    1.799163] Reprogramming SDRC clock to 332000000 Hz
[    1.865997] gpio gpiochip0: (gpio): added GPIO chardev (254:0)
[    1.868011] gpiochip_setup_dev: registered GPIOs 0 to 31 on device: gpiochip0 (gpio)
[    1.868835] OMAP GPIO hardware version 2.5
[    1.880462] gpio gpiochip1: (gpio): added GPIO chardev (254:1)
[    1.882446] gpiochip_setup_dev: registered GPIOs 32 to 63 on device: gpiochip1 (gpio)
[    1.894042] gpio gpiochip2: (gpio): added GPIO chardev (254:2)
[    1.895568] gpiochip_setup_dev: registered GPIOs 64 to 95 on device: gpiochip2 (gpio)
[    1.907318] gpio gpiochip3: (gpio): added GPIO chardev (254:3)
[    1.908843] gpiochip_setup_dev: registered GPIOs 96 to 127 on device: gpiochip3 (gpio)
[    1.920501] gpio gpiochip4: (gpio): added GPIO chardev (254:4)
[    1.922424] gpiochip_setup_dev: registered GPIOs 128 to 159 on device: gpiochip4 (gpio)
[    1.933990] gpio gpiochip5: (gpio): added GPIO chardev (254:5)
[    1.935485] gpiochip_setup_dev: registered GPIOs 160 to 191 on device: gpiochip5 (gpio)
[    2.065551] omap-gpmc 6e000000.gpmc: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_gpmc_pins, deferring probe
[    2.119781] hw-breakpoint: debug architecture 0x4 unsupported.
[    2.123596] omap4_sram_init:Unable to allocate sram needed to handle errata I688
[    2.123748] omap4_sram_init:Unable to get sram pool needed to handle errata I688
[    2.131469] Reserving DMA channels 0 and 1 for HS ROM code
[    2.131591] OMAP DMA hardware revision 4.0
[    2.426635] omap-dma-engine 48056000.dma-controller: OMAP DMA engine driver
[    2.460449] omap-iommu 480bd400.mmu: 480bd400.mmu registered
[    2.465270] iommu: Adding device 480bc000.isp to group 0
[    2.477874] SCSI subsystem initialized
[    2.481719] libata version 3.00 loaded.
[    2.485290] omap_i2c 48070000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c1_pins, deferring probe
[    2.485931] omap_i2c 48072000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c2_pins, deferring probe
[    2.486511] omap_i2c 48060000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c3_pins, deferring probe
[    2.488647] pps_core: LinuxPPS API ver. 1 registered
[    2.488739] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;
[    2.489166] PTP clock support registered
[    2.505584] clocksource: Switched to clocksource 32k_counter
[    3.327270] VFS: Disk quotas dquot_6.6.0
[    3.328155] VFS: Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)
[    3.490722] NET: Registered protocol family 2
[    3.497497] TCP established hash table entries: 2048 (order: 1, 8192 bytes)
[    3.497741] TCP bind hash table entries: 2048 (order: 4, 81920 bytes)
[    3.498992] TCP: Hash tables configured (established 2048 bind 2048)
[    3.500183] UDP hash table entries: 256 (order: 2, 24576 bytes)
[    3.500701] UDP-Lite hash table entries: 256 (order: 2, 24576 bytes)
[    3.503479] NET: Registered protocol family 1
[    3.511474] RPC: Registered named UNIX socket transport module.
[    3.511627] RPC: Registered udp transport module.
[    3.511749] RPC: Registered tcp transport module.
[    3.511871] RPC: Registered tcp NFSv4.1 backchannel transport module.
[    3.538238] hw perfevents: no interrupt-affinity property for /pmu@54000000, guessing.
[    3.540618] hw perfevents: enabled with armv7_cortex_a8 PMU driver, 5 counters available
[    3.572448] audit: initializing netlink subsys (disabled)
[    3.587646] audit: type=2000 audit(3.571:1): state=initialized audit_enabled=0 res=1
[    3.590087] workingset: timestamp_bits=14 max_order=16 bucket_order=2
[    3.602478] NFS: Registering the id_resolver key type
[    3.603515] Key type id_resolver registered
[    3.603668] Key type id_legacy registered
[    3.604309] jffs2: version 2.2. (NAND) (SUMMARY)  © 2001-2006 Red Hat, Inc.
[    3.637115] io scheduler noop registered
[    3.637237] io scheduler deadline registered
[    3.637512] io scheduler cfq registered (default)
[    3.637634] io scheduler mq-deadline registered
[    3.637756] io scheduler kyber registered
[    3.658416] pinctrl-single 48002030.pinmux: 284 pins at pa fa002030 size 568
[    3.663146] pinctrl-single 48002a00.pinmux: 46 pins at pa fa002a00 size 92
[    3.668548] pinctrl-single 480025d8.pinmux: 18 pins at pa fa0025d8 size 36
[    3.711212] Serial: 8250/16550 driver, 6 ports, IRQ sharing enabled
[    3.759765] 4806c000.serial: ttyS1 at MMIO 0x4806c000 (irq = 89, base_baud = 3000000) is a 8250
[    3.774414] 49020000.serial: ttyS2 at MMIO 0x49020000 (irq = 90, base_baud = 3000000) is a 8250
[    5.113739] console [ttyS2] enabled
[    5.301635] brd: module loaded
[    5.439788] loop: module loaded
[    5.459564] mtdoops: mtd device (mtddev=name/number) must be supplied
[    5.530944] mdio_bus fixed-0: GPIO lookup for consumer reset
[    5.537200] mdio_bus fixed-0: using lookup tables for GPIO lookup
[    5.543701] mdio_bus fixed-0: lookup for GPIO reset failed
[    5.550903] libphy: Fixed MDIO Bus: probed
[    5.582519] i2c /dev entries driver
[    5.603973] omap_hsmmc 4809c000.mmc: GPIO lookup for consumer cd
[    5.610595] omap_hsmmc 4809c000.mmc: using device tree for GPIO lookup
[    5.617767] of_get_named_gpiod_flags: parsed &#39;cd-gpios&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39; - status (0)
[    5.629211] omap_hsmmc 4809c000.mmc: Got CD GPIO
[    5.634033] omap_hsmmc 4809c000.mmc: GPIO lookup for consumer wp
[    5.640502] omap_hsmmc 4809c000.mmc: using device tree for GPIO lookup
[    5.647491] of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpios&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39;
[    5.657928] of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpio&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39;
[    5.668212] omap_hsmmc 4809c000.mmc: using lookup tables for GPIO lookup
[    5.675109] omap_hsmmc 4809c000.mmc: lookup for GPIO wp failed
[    5.693267] omap_hsmmc 480b4000.mmc: GPIO lookup for consumer wp
[    5.699981] omap_hsmmc 480b4000.mmc: using device tree for GPIO lookup
[    5.707031] of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpios&#39; property of node &#39;/ocp@68000000/mmc@480b4000[0]&#39;
[    5.717437] of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpio&#39; property of node &#39;/ocp@68000000/mmc@480b4000[0]&#39;
[    5.727752] omap_hsmmc 480b4000.mmc: using lookup tables for GPIO lookup
[    5.734619] omap_hsmmc 480b4000.mmc: lookup for GPIO wp failed
[    5.749328] ledtrig-cpu: registered to indicate activity on CPUs
[    5.761383] oprofile: using arm/armv7
[    5.767517] Initializing XFRM netlink socket
[    5.773590] NET: Registered protocol family 10
[    5.789123] Segment Routing with IPv6
[    5.793579] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver
[    5.808959] NET: Registered protocol family 17
[    5.813842] NET: Registered protocol family 15
[    5.819976] Key type dns_resolver registered
[    5.825561] omap2_set_init_voltage: unable to find boot up OPP for vdd_mpu_iva
[    5.832977] omap2_set_init_voltage: unable to set vdd_mpu_iva
[    5.839263] omap2_set_init_voltage: unable to find boot up OPP for vdd_core
[    5.846710] omap2_set_init_voltage: unable to set vdd_core
[    5.864746] save_secure_sram() returns 00000019
[    5.869445] save_secure_sram()&#39;s param: 0: 0x4
[    5.874023] save_secure_sram()&#39;s param: 1: 0x8e700000
[    5.879211] save_secure_sram()&#39;s param: 2: 0x0
[    5.883789] save_secure_sram()&#39;s param: 3: 0x1
[    5.888366] save_secure_sram()&#39;s param: 4: 0x1
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Oct. 20, 2017, 1:55 a.m.</div>
<pre class="content">
On Thu, Oct 19, 2017 at 11:30:34AM -0700, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171018 01:27]:</span>
<span class="quote">&gt; &gt; On Mon, Sep 25, 2017 at 07:54:37AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170925 01:06]:</span>
<span class="quote">&gt; &gt; &gt; &gt; On Thu, Sep 21, 2017 at 10:28:11AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [170914 23:55]:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; On Wed, Sep 13, 2017 at 09:31:27AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; &gt; Yes I disabled CONFIG_HIGHMEM and n900 boots. To disable it,</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; &gt; you need to remove it from arch/arm/mach-omap2/Kconfig that</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; &gt; selects it if ARCH_OMAP2PLUS_TYPICAL is selected.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; Okay. Problem would be related to address traslation. I&#39;d like to</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; check address traslation more. Could you apply following patch and</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; test it? And, please send me the dmesg log and your kernel config.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; Please test this with CONFIG_DEBUG_VIRTUAL = n and CONFIG_CMA_DEBUG=y and</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; CONFIG_HIGHMEM=y and with kernel bootparam &#39;ignore_loglevel&#39;.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; It would be really appreciate if you send me two logs for before/after</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; commit 9caf25f996e8.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Sorry for the delays, I finally got around testing this for you.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; No problem! I really appreciate your help!</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Compile with your patch failed for modules with __virt_to_phys_debug</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; being undefined so I added EXPORT_SYMBOL there. I also enabled DEBUG_LL</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; and EARLYPRINTK to get output.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Below is dmesg output for 9caf25f996e8 + your patch. I&#39;ll send you</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; the full logs separately.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Hmm...there is only one caller for the CMA memory, that is, atomic_pool_init().</span>
<span class="quote">&gt; &gt; &gt; &gt; Could you test one more time with 9caf25f996e8 + following patch?  I&#39;d like to</span>
<span class="quote">&gt; &gt; &gt; &gt; know the actual user for the CMA memory.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Hmm not getting any stack with that patch after manually applying</span>
<span class="quote">&gt; &gt; &gt; it because of tabs to spaces mangling.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Sorry for long delay.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Seems like your system doesn&#39;t use any CMA memory by CMA API.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Could you test one more thing?</span>
<span class="quote">&gt; &gt; This one is to disable CMA memory allocation from the page allocator.</span>
<span class="quote">&gt; &gt; With this, we can be sure that CMA memory isn&#39;t used at all.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; If there is no difference with this patch, that is, the system down,</span>
<span class="quote">&gt; &gt; I think that some initialization step is broken. In this case, please</span>
<span class="quote">&gt; &gt; test following patch.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; I make a branch in github that all these patch is applied.</span>
<span class="quote">&gt; &gt; Feel free to use it.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Still not booting, dmesg output of your test branch below.</span>

Oops... I made a mistak. Could you test with reverting commit
c977ee2803787363187d6aca9cebdabc793c6531 (&quot;omap: forcibly call
save_secure_ram_context() for test&quot;) in that branch?
Without reverting it, it doesn&#39;t call &#39;smc&#39; so it always cause a
hang.

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Oct. 20, 2017, 5:31 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171019 18:53]:
<span class="quote">&gt; Oops... I made a mistak. Could you test with reverting commit</span>
<span class="quote">&gt; c977ee2803787363187d6aca9cebdabc793c6531 (&quot;omap: forcibly call</span>
<span class="quote">&gt; save_secure_ram_context() for test&quot;) in that branch?</span>
<span class="quote">&gt; Without reverting it, it doesn&#39;t call &#39;smc&#39; so it always cause a</span>
<span class="quote">&gt; hang.</span>

Oops I should have noticed that one. Here you go with commit
c977ee280378 reverted. Still not booting.

Regards,

Tony

8&lt; ---------------------------
Booting Linux on physical CPU 0x0
Linux version 4.13.0-rc7-next-20170901-00011-geca3cddaf1a8 (tmlind@sampyla) (gcc version 6.3.1 20170109 (crosstool-NG crosstool-ng-1.23.0)) #541 SMP Fri Oct 20 10:15:45 PDT 2017
CPU: ARMv7 Processor [411fc083] revision 3 (ARMv7), cr=10c5387d
CPU: PIPT / VIPT nonaliasing data cache, VIPT nonaliasing instruction cache
OF: fdt: Machine model: Nokia N900
Memory policy: Data cache writeback
cma: Reserved 16 MiB at 0x8e800000
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00011-geca3cddaf1a8 #541
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eae4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eae4&gt;] (dump_stack) from [&lt;c0c06f10&gt;] (dma_contiguous_remap+0x64/0x168)
[&lt;c0c06f10&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00011-geca3cddaf1a8 #541
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eae4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eae4&gt;] (dump_stack) from [&lt;c0c06f50&gt;] (dma_contiguous_remap+0xa4/0x168)
[&lt;c0c06f50&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00011-geca3cddaf1a8 #541
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eae4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eae4&gt;] (dump_stack) from [&lt;c0c06fcc&gt;] (dma_contiguous_remap+0x120/0x168)
[&lt;c0c06fcc&gt;] (dma_contiguous_remap) from [&lt;c0c08114&gt;] (paging_init+0x324/0x700)
[&lt;c0c08114&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
On node 0 totalpages: 65024
free_area_init_node: node 0, pgdat c0dc5040, node_mem_map cfa8b000
  Normal zone: 572 pages used for memmap
  Normal zone: 0 pages reserved
  Normal zone: 65024 pages, LIFO batch:15
CPU: All CPU(s) started in SVC mode.
OMAP3430/3530 ES3.1 (l2cache iva sgx neon isp)
random: fast init done
percpu: Embedded 18 pages/cpu @cfd9c000 s41644 r8192 d23892 u73728
pcpu-alloc: s41644 r8192 d23892 u73728 alloc=18*4096
pcpu-alloc: [0] 0
Built 1 zonelists, mobility grouping on.  Total pages: 64452
Kernel command line: root=/dev/nfs ip=dhcp console=ttyO2,115200 memmap=2M$0x88000000 ramoops.mem_address=0x88000000 ramoops.mem_size=0x200000 ramoops.record_size=0x40000 debug earlyprintk init=/root/init
PID hash table entries: 1024 (order: 0, 4096 bytes)
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 220052K/260096K available (8192K kernel code, 816K rwdata, 2420K rodata, 1024K init, 7557K bss, 23660K reserved, 16384K cma-reserved, 0K highmem)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0000000 - 0xff800000   ( 760 MB)
    lowmem  : 0xc0000000 - 0xcfe00000   ( 254 MB)
    pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)
    modules : 0xbf000000 - 0xbfe00000   (  14 MB)
      .text : 0xc0008000 - 0xc0900000   (9184 kB)
      .init : 0xc0c00000 - 0xc0d00000   (1024 kB)
      .data : 0xc0d00000 - 0xc0dcc280   ( 817 kB)
       .bss : 0xc0dce000 - 0xc152f644   (7558 kB)
Running RCU self tests
Hierarchical RCU implementation.
	RCU event tracing is enabled.
	RCU lockdep checking is enabled.
	RCU restricting CPUs from NR_CPUS=2 to nr_cpu_ids=1.
RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
IRQ: Found an INTC at 0xfa200000 (revision 4.0) with 96 interrupts
Clocking rate (Crystal/Core/MPU): 19.2/332/500 MHz
OMAP clockevent source: timer1 at 32768 Hz
clocksource: 32k_counter: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 58327039986419 ns
sched_clock: 32 bits at 32kHz, resolution 30517ns, wraps every 65535999984741ns
OMAP clocksource: 32k_counter at 32768 Hz
Console: colour dummy device 80x30
WARNING: Your &#39;console=ttyO2&#39; has been replaced by &#39;ttyS2&#39;
This ensures that you still see kernel messages. Please
update your kernel commandline.
Lock dependency validator: Copyright (c) 2006 Red Hat, Inc., Ingo Molnar
... MAX_LOCKDEP_SUBCLASSES:  8
... MAX_LOCK_DEPTH:          48
... MAX_LOCKDEP_KEYS:        8191
... CLASSHASH_SIZE:          4096
... MAX_LOCKDEP_ENTRIES:     32768
... MAX_LOCKDEP_CHAINS:      65536
... CHAINHASH_SIZE:          32768
 memory used by lock dependency info: 4655 kB
 per task-struct memory footprint: 1536 bytes
Calibrating delay loop... 493.97 BogoMIPS (lpj=2469888)
pid_max: default: 32768 minimum: 301
Security Framework initialized
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
CPU0: thread -1, cpu 0, socket -1, mpidr 0
Setting up static identity map for 0x80100000 - 0x80100078
Hierarchical SRCU implementation.
smp: Bringing up secondary CPUs ...
smp: Brought up 1 node, 1 CPU
SMP: Total of 1 processors activated (493.97 BogoMIPS).
CPU: All CPU(s) started in SVC mode.
devtmpfs: initialized
Built 1 zonelists, mobility grouping on.  Total pages: 59109
VFP support v0.3: implementor 41 architecture 3 part 30 variant c rev 1
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: 2, 16384 bytes)
pinctrl core: initialized pinctrl subsystem
NET: Registered protocol family 16
__alloc_from_contiguous
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.13.0-rc7-next-20170901-00011-geca3cddaf1a8 #541
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eae4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eae4&gt;] (dump_stack) from [&lt;c011653c&gt;] (__alloc_from_contiguous+0x30/0xf8)
[&lt;c011653c&gt;] (__alloc_from_contiguous) from [&lt;c0c06d60&gt;] (atomic_pool_init+0x7c/0x178)
[&lt;c0c06d60&gt;] (atomic_pool_init) from [&lt;c0101df4&gt;] (do_one_initcall+0x3c/0x170)
[&lt;c0101df4&gt;] (do_one_initcall) from [&lt;c0c00ee4&gt;] (kernel_init_freeable+0x1fc/0x2c4)
[&lt;c0c00ee4&gt;] (kernel_init_freeable) from [&lt;c0842a2c&gt;] (kernel_init+0x8/0x110)
[&lt;c0842a2c&gt;] (kernel_init) from [&lt;c0107d78&gt;] (ret_from_fork+0x14/0x3c)
DMA: preallocated 256 KiB pool for atomic coherent allocations
omap_hwmod: mcbsp2_sidetone using broken dt data from mcbsp
omap_hwmod: mcbsp3_sidetone using broken dt data from mcbsp
cpuidle: using governor menu
SRAM_ADDR: omap_map_sram: P: 0x40208000 - 0x4020f000
SRAM_ADDR: omap_map_sram: V: 0xd0050000 - 0xd0057000
SRAM_ADDR: omap_sram_push_address: 0xd0056f00 - 0xd0056ffc
SRAM_ADDR: omap_sram_push_address: 0xd0056e90 - 0xd0056efc
Reprogramming SDRC clock to 332000000 Hz
gpio gpiochip0: (gpio): added GPIO chardev (254:0)
gpiochip_setup_dev: registered GPIOs 0 to 31 on device: gpiochip0 (gpio)
OMAP GPIO hardware version 2.5
gpio gpiochip1: (gpio): added GPIO chardev (254:1)
gpiochip_setup_dev: registered GPIOs 32 to 63 on device: gpiochip1 (gpio)
gpio gpiochip2: (gpio): added GPIO chardev (254:2)
gpiochip_setup_dev: registered GPIOs 64 to 95 on device: gpiochip2 (gpio)
gpio gpiochip3: (gpio): added GPIO chardev (254:3)
gpiochip_setup_dev: registered GPIOs 96 to 127 on device: gpiochip3 (gpio)
gpio gpiochip4: (gpio): added GPIO chardev (254:4)
gpiochip_setup_dev: registered GPIOs 128 to 159 on device: gpiochip4 (gpio)
gpio gpiochip5: (gpio): added GPIO chardev (254:5)
gpiochip_setup_dev: registered GPIOs 160 to 191 on device: gpiochip5 (gpio)
omap-gpmc 6e000000.gpmc: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_gpmc_pins, deferring probe
hw-breakpoint: debug architecture 0x4 unsupported.
omap4_sram_init:Unable to allocate sram needed to handle errata I688
omap4_sram_init:Unable to get sram pool needed to handle errata I688
Reserving DMA channels 0 and 1 for HS ROM code
OMAP DMA hardware revision 4.0
omap-dma-engine 48056000.dma-controller: OMAP DMA engine driver
omap-iommu 480bd400.mmu: 480bd400.mmu registered
iommu: Adding device 480bc000.isp to group 0
SCSI subsystem initialized
libata version 3.00 loaded.
omap_i2c 48070000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c1_pins, deferring probe
omap_i2c 48072000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c2_pins, deferring probe
omap_i2c 48060000.i2c: could not find pctldev for node /ocp@68000000/l4@48000000/scm@2000/pinmux@30/pinmux_i2c3_pins, deferring probe
pps_core: LinuxPPS API ver. 1 registered
pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;
PTP clock support registered
clocksource: Switched to clocksource 32k_counter
VFS: Disk quotas dquot_6.6.0
VFS: Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)
NET: Registered protocol family 2
TCP established hash table entries: 2048 (order: 1, 8192 bytes)
TCP bind hash table entries: 2048 (order: 4, 81920 bytes)
TCP: Hash tables configured (established 2048 bind 2048)
UDP hash table entries: 256 (order: 2, 24576 bytes)
UDP-Lite hash table entries: 256 (order: 2, 24576 bytes)
NET: Registered protocol family 1
RPC: Registered named UNIX socket transport module.
RPC: Registered udp transport module.
RPC: Registered tcp transport module.
RPC: Registered tcp NFSv4.1 backchannel transport module.
hw perfevents: no interrupt-affinity property for /pmu@54000000, guessing.
hw perfevents: enabled with armv7_cortex_a8 PMU driver, 5 counters available
audit: initializing netlink subsys (disabled)
audit: type=2000 audit(3.541:1): state=initialized audit_enabled=0 res=1
workingset: timestamp_bits=14 max_order=16 bucket_order=2
NFS: Registering the id_resolver key type
Key type id_resolver registered
Key type id_legacy registered
jffs2: version 2.2. (NAND) (SUMMARY)  © 2001-2006 Red Hat, Inc.
io scheduler noop registered
io scheduler deadline registered
io scheduler cfq registered (default)
io scheduler mq-deadline registered
io scheduler kyber registered
pinctrl-single 48002030.pinmux: 284 pins at pa fa002030 size 568
pinctrl-single 48002a00.pinmux: 46 pins at pa fa002a00 size 92
pinctrl-single 480025d8.pinmux: 18 pins at pa fa0025d8 size 36
Serial: 8250/16550 driver, 6 ports, IRQ sharing enabled
4806c000.serial: ttyS1 at MMIO 0x4806c000 (irq = 89, base_baud = 3000000) is a 8250
49020000.serial: ttyS2 at MMIO 0x49020000 (irq = 90, base_baud = 3000000) is a 8250
console [ttyS2] enabled
brd: module loaded
loop: module loaded
mtdoops: mtd device (mtddev=name/number) must be supplied
mdio_bus fixed-0: GPIO lookup for consumer reset
mdio_bus fixed-0: using lookup tables for GPIO lookup
mdio_bus fixed-0: lookup for GPIO reset failed
libphy: Fixed MDIO Bus: probed
i2c /dev entries driver
omap_hsmmc 4809c000.mmc: GPIO lookup for consumer cd
omap_hsmmc 4809c000.mmc: using device tree for GPIO lookup
of_get_named_gpiod_flags: parsed &#39;cd-gpios&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39; - status (0)
omap_hsmmc 4809c000.mmc: Got CD GPIO
omap_hsmmc 4809c000.mmc: GPIO lookup for consumer wp
omap_hsmmc 4809c000.mmc: using device tree for GPIO lookup
of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpios&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39;
of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpio&#39; property of node &#39;/ocp@68000000/mmc@4809c000[0]&#39;
omap_hsmmc 4809c000.mmc: using lookup tables for GPIO lookup
omap_hsmmc 4809c000.mmc: lookup for GPIO wp failed
omap_hsmmc 480b4000.mmc: GPIO lookup for consumer wp
omap_hsmmc 480b4000.mmc: using device tree for GPIO lookup
of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpios&#39; property of node &#39;/ocp@68000000/mmc@480b4000[0]&#39;
of_get_named_gpiod_flags: can&#39;t parse &#39;wp-gpio&#39; property of node &#39;/ocp@68000000/mmc@480b4000[0]&#39;
omap_hsmmc 480b4000.mmc: using lookup tables for GPIO lookup
omap_hsmmc 480b4000.mmc: lookup for GPIO wp failed
ledtrig-cpu: registered to indicate activity on CPUs
oprofile: using arm/armv7
Initializing XFRM netlink socket
NET: Registered protocol family 10
Segment Routing with IPv6
sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver
NET: Registered protocol family 17
NET: Registered protocol family 15
Key type dns_resolver registered
omap2_set_init_voltage: unable to find boot up OPP for vdd_mpu_iva
omap2_set_init_voltage: unable to set vdd_mpu_iva
omap2_set_init_voltage: unable to find boot up OPP for vdd_core
omap2_set_init_voltage: unable to set vdd_core
save_secure_sram() returns 0000ff02
save_secure_sram()&#39;s param: 0: 0x4
save_secure_sram()&#39;s param: 1: 0x8e700000
save_secure_sram()&#39;s param: 2: 0x0
save_secure_sram()&#39;s param: 3: 0x1
save_secure_sram()&#39;s param: 4: 0x1
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Oct. 23, 2017, 4:53 a.m.</div>
<pre class="content">
On Fri, Oct 20, 2017 at 10:31:47AM -0700, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171019 18:53]:</span>
<span class="quote">&gt; &gt; Oops... I made a mistak. Could you test with reverting commit</span>
<span class="quote">&gt; &gt; c977ee2803787363187d6aca9cebdabc793c6531 (&quot;omap: forcibly call</span>
<span class="quote">&gt; &gt; save_secure_ram_context() for test&quot;) in that branch?</span>
<span class="quote">&gt; &gt; Without reverting it, it doesn&#39;t call &#39;smc&#39; so it always cause a</span>
<span class="quote">&gt; &gt; hang.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Oops I should have noticed that one. Here you go with commit</span>
<span class="quote">&gt; c977ee280378 reverted. Still not booting.</span>

Still very thanks to you. :)

Okay. Could you test my updated branch? In there, I also disable
atomic_pool initialization and disable to remap the CMA area in order
to completely make any operation on CMA area as no-op.

And, it enables memblock_debug to check how memblock region is
allocated.

https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Oct. 25, 2017, 5:31 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171022 21:51]:
<span class="quote">&gt; On Fri, Oct 20, 2017 at 10:31:47AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171019 18:53]:</span>
<span class="quote">&gt; &gt; &gt; Oops... I made a mistak. Could you test with reverting commit</span>
<span class="quote">&gt; &gt; &gt; c977ee2803787363187d6aca9cebdabc793c6531 (&quot;omap: forcibly call</span>
<span class="quote">&gt; &gt; &gt; save_secure_ram_context() for test&quot;) in that branch?</span>
<span class="quote">&gt; &gt; &gt; Without reverting it, it doesn&#39;t call &#39;smc&#39; so it always cause a</span>
<span class="quote">&gt; &gt; &gt; hang.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Oops I should have noticed that one. Here you go with commit</span>
<span class="quote">&gt; &gt; c977ee280378 reverted. Still not booting.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Still very thanks to you. :)</span>

No problem, sorry for the delay in testing this one.
<span class="quote">
&gt; Okay. Could you test my updated branch? In there, I also disable</span>
<span class="quote">&gt; atomic_pool initialization and disable to remap the CMA area in order</span>
<span class="quote">&gt; to completely make any operation on CMA area as no-op.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; And, it enables memblock_debug to check how memblock region is</span>
<span class="quote">&gt; allocated.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>

Great, this branch boots on n900! Early parts of the dmesg attached
below.

Regards,

Tony

8&lt; --------------------------
Booting Linux on physical CPU 0x0
Linux version 4.13.0-rc7-next-20170901-00015-g32cc67b3e8c6 (tmlind@sampyla) (gcc version 6.3.1 20170109 (crosstool-NG crosstool-ng-1.23.0)) #544 SMP Wed Oct 25 10:22:42 PDT 2017
CPU: ARMv7 Processor [411fc083] revision 3 (ARMv7), cr=10c5387d
CPU: PIPT / VIPT nonaliasing data cache, VIPT nonaliasing instruction cache
OF: fdt: Machine model: Nokia N900
memblock_add: [0x80000000-0x8fffffff] early_init_dt_scan_memory+0xec/0x158
Memory policy: Data cache writeback
memblock_reserve: [0x80100000-0x8152f643] arm_memblock_init+0x30/0x1b0
memblock_reserve: [0x80004000-0x80007fff] arm_memblock_init+0x13c/0x1b0
memblock_reserve: [0x8ff00000-0x8fffffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8ff00000-0x8fffffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fe00000-0x8fefffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8fe00000-0x8fefffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fccb000-0x8fcddfff] arm_memblock_init+0x150/0x1b0
memblock_reserve: [0x8fccb000-0x8fcddfff] early_init_fdt_scan_reserved_mem+0x58/0x7c
memblock_reserve: [0x8e800000-0x8f7fffff] memblock_alloc_range_nid+0x38/0x50
cma: Reserved 16 MiB at 0x8e800000
MEMBLOCK configuration:
 memory size = 0x0fe00000 reserved size = 0x02446644
 memory.cnt  = 0x1
 memory[0x0]	[0x80000000-0x8fdfffff], 0x0fe00000 bytes flags: 0x0
 reserved.cnt  = 0x4
 reserved[0x0]	[0x80004000-0x80007fff], 0x00004000 bytes flags: 0x0
 reserved[0x1]	[0x80100000-0x8152f643], 0x0142f644 bytes flags: 0x0
 reserved[0x2]	[0x8e800000-0x8f7fffff], 0x01000000 bytes flags: 0x0
 reserved[0x3]	[0x8fccb000-0x8fcddfff], 0x00013000 bytes flags: 0x0
memblock_reserve: [0x8fdfe000-0x8fdfffff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfd000-0x8fdfdfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcee8-0x8fdfcfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcec0-0x8fdfcee7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce98-0x8fdfcebf] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce70-0x8fdfce97] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce48-0x8fdfce6f] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce20-0x8fdfce47] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfb000-0x8fdfbfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfa000-0x8fdfafff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdf9000-0x8fdf9fff] memblock_alloc_range_nid+0x38/0x50
On node 0 totalpages: 65024
memblock_virt_alloc_try_nid_nopanic: 2359296 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 alloc_node_mem_map.constprop.10+0x68/0xb4
memblock_reserve: [0x8fa8b000-0x8fccafff] memblock_virt_alloc_internal+0xfc/0x1c0
free_area_init_node: node 0, pgdat c0dc5040, node_mem_map cfa8b000
  Normal zone: 572 pages used for memmap
  Normal zone: 0 pages reserved
  Normal zone: 65024 pages, LIFO batch:15
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfce00-0x8fdfce0f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfcdc0-0x8fdfcdcf] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 32 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 setup_arch+0x6e8/0xc94
memblock_reserve: [0x8fdfcd80-0x8fdfcd9f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_reserve: [0x8fdb0548-0x8fdf8fff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcde8-0x8fdfcdff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcdd0-0x8fdfcde7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcda4-0x8fdfcdbe] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd64-0x8fdfcd7e] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd48-0x8fdfcd62] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd30-0x8fdfcd47] memblock_alloc_range_nid+0x38/0x50
CPU: All CPU(s) started in SVC mode.
OMAP3430/3530 ES3.1 (l2cache iva sgx neon isp)
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfcd00-0x8fdfcd07] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfccc0-0x8fdfccc7] memblock_virt_alloc_internal+0xfc/0x1c0
random: fast init done
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0x9c/0x3fc
memblock_reserve: [0x8fdfcc00-0x8fdfccb6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xc0/0x3fc
memblock_reserve: [0x8fdfcb40-0x8fdfcbf6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xe4/0x3fc
memblock_reserve: [0x8fdfca80-0x8fdfcb36] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_alloc_info+0x4c/0x88
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_embed_first_chunk+0x464/0x714
memblock_reserve: [0x8fdae540-0x8fdaf53f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 73728 bytes align=0x1000 nid=-1 from=0xbfffffff max_addr=0x0 pcpu_dfl_fc_alloc+0x3c/0x44
memblock_reserve: [0x8fd9c000-0x8fdadfff] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdae000-0x0000008fdadfff] pcpu_embed_first_chunk+0x5d8/0x714
percpu: Embedded 18 pages/cpu @cfd9c000 s41644 r8192 d23892 u73728
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0xf0/0x678
memblock_reserve: [0x8fdfca40-0x8fdfca43] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x110/0x678
memblock_reserve: [0x8fdfca00-0x8fdfca03] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x130/0x678
memblock_reserve: [0x8fdfc9c0-0x8fdfc9c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x150/0x678
memblock_reserve: [0x8fdfc980-0x8fdfc983] memblock_virt_alloc_internal+0xfc/0x1c0
pcpu-alloc: s41644 r8192 d23892 u73728 alloc=18*4096
pcpu-alloc: [0] 0
memblock_virt_alloc_try_nid: 128 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x41c/0x678
memblock_reserve: [0x8fdfc900-0x8fdfc97f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc880-0x8fdfc8c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 384 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc700-0x8fdfc87f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 388 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdfc540-0x8fdfc6c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 60 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc500-0x8fdfc53b] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc480-0x8fdfc4c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 768 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc180-0x8fdfc47f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 772 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdae200-0x8fdae503] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 120 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc100-0x8fdfc177] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdaf540-0x0000008fdb053f] pcpu_embed_first_chunk+0x664/0x714
__memblock_free_early: [0x0000008fdae540-0x0000008fdaf53f] pcpu_embed_first_chunk+0x6c4/0x714
Built 1 zonelists, mobility grouping on.  Total pages: 64452
Kernel command line: root=/dev/nfs ip=dhcp console=ttyO2,115200 memmap=2M$0x88000000 ramoops.mem_address=0x88000000 ramoops.mem_size=0x200000 ramoops.record_size=0x40000 debug earlyprintk init=/root/init
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
PID hash table entries: 1024 (order: 0, 4096 bytes)
memblock_virt_alloc_try_nid_nopanic: 131072 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd7c000-0x8fd9bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
memblock_virt_alloc_try_nid_nopanic: 65536 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd6c000-0x8fd7bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 220052K/260096K available (8192K kernel code, 816K rwdata, 2420K rodata, 1024K init, 7557K bss, 23660K reserved, 16384K cma-reserved, 0K highmem)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0000000 - 0xff800000   ( 760 MB)
    lowmem  : 0xc0000000 - 0xcfe00000   ( 254 MB)
    pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)
    modules : 0xbf000000 - 0xbfe00000   (  14 MB)
      .text : 0xc0008000 - 0xc0900000   (9184 kB)
      .init : 0xc0c00000 - 0xc0d00000   (1024 kB)
      .data : 0xc0d00000 - 0xc0dcc280   ( 817 kB)
       .bss : 0xc0dce000 - 0xc152f644   (7558 kB)
Running RCU self tests
Hierarchical RCU implementation.
	RCU event tracing is enabled.
	RCU lockdep checking is enabled.
	RCU restricting CPUs from NR_CPUS=2 to nr_cpu_ids=1.
RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
IRQ: Found an INTC at 0xfa200000 (revision 4.0) with 96 interrupts
Clocking rate (Crystal/Core/MPU): 19.2/332/500 MHz
OMAP clockevent source: timer1 at 32768 Hz
clocksource: 32k_counter: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 58327039986419 ns
sched_clock: 32 bits at 32kHz, resolution 30517ns, wraps every 65535999984741ns
OMAP clocksource: 32k_counter at 32768 Hz
Console: colour dummy device 80x30
WARNING: Your &#39;console=ttyO2&#39; has been replaced by &#39;ttyS2&#39;
This ensures that you still see kernel messages. Please
update your kernel commandline.
Lock dependency validator: Copyright (c) 2006 Red Hat, Inc., Ingo Molnar
... MAX_LOCKDEP_SUBCLASSES:  8
... MAX_LOCK_DEPTH:          48
... MAX_LOCKDEP_KEYS:        8191
... CLASSHASH_SIZE:          4096
... MAX_LOCKDEP_ENTRIES:     32768
... MAX_LOCKDEP_CHAINS:      65536
... CHAINHASH_SIZE:          32768
 memory used by lock dependency info: 4655 kB
 per task-struct memory footprint: 1536 bytes
Calibrating delay loop... 493.97 BogoMIPS (lpj=2469888)
pid_max: default: 32768 minimum: 301
Security Framework initialized
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
CPU0: thread -1, cpu 0, socket -1, mpidr 0
Setting up static identity map for 0x80100000 - 0x80100078
Hierarchical SRCU implementation.
smp: Bringing up secondary CPUs ...
smp: Brought up 1 node, 1 CPU
SMP: Total of 1 processors activated (493.97 BogoMIPS).
CPU: All CPU(s) started in SVC mode.
devtmpfs: initialized
Built 1 zonelists, mobility grouping on.  Total pages: 59109
VFP support v0.3: implementor 41 architecture 3 part 30 variant c rev 1
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: 2, 16384 bytes)
pinctrl core: initialized pinctrl subsystem
...
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Oct. 26, 2017, 4:48 a.m.</div>
<pre class="content">
On Wed, Oct 25, 2017 at 10:31:38AM -0700, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171022 21:51]:</span>
<span class="quote">&gt; &gt; On Fri, Oct 20, 2017 at 10:31:47AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171019 18:53]:</span>
<span class="quote">&gt; &gt; &gt; &gt; Oops... I made a mistak. Could you test with reverting commit</span>
<span class="quote">&gt; &gt; &gt; &gt; c977ee2803787363187d6aca9cebdabc793c6531 (&quot;omap: forcibly call</span>
<span class="quote">&gt; &gt; &gt; &gt; save_secure_ram_context() for test&quot;) in that branch?</span>
<span class="quote">&gt; &gt; &gt; &gt; Without reverting it, it doesn&#39;t call &#39;smc&#39; so it always cause a</span>
<span class="quote">&gt; &gt; &gt; &gt; hang.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Oops I should have noticed that one. Here you go with commit</span>
<span class="quote">&gt; &gt; &gt; c977ee280378 reverted. Still not booting.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Still very thanks to you. :)</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; No problem, sorry for the delay in testing this one.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; Okay. Could you test my updated branch? In there, I also disable</span>
<span class="quote">&gt; &gt; atomic_pool initialization and disable to remap the CMA area in order</span>
<span class="quote">&gt; &gt; to completely make any operation on CMA area as no-op.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; And, it enables memblock_debug to check how memblock region is</span>
<span class="quote">&gt; &gt; allocated.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Great, this branch boots on n900! Early parts of the dmesg attached</span>
<span class="quote">&gt; below.</span>

Sound good. Perhaps, problem is due to the cache management. With my
patchset, direct mapping for CMA area is cleared in
dma_contiguous_remap() if CONFIG_HIGHMEM. I guess that proper cache
operation is required there.

Could you test my newly updated branch again? I re-enable
dma_contiguous_remap() to clear direct mapping for CMA area and add
proper(?) cache operation although I&#39;m not the expert on that area.

https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Oct. 26, 2017, 2:16 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171025 21:45]:
<span class="quote">&gt; On Wed, Oct 25, 2017 at 10:31:38AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; Great, this branch boots on n900! Early parts of the dmesg attached</span>
<span class="quote">&gt; &gt; below.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Sound good. Perhaps, problem is due to the cache management. With my</span>
<span class="quote">&gt; patchset, direct mapping for CMA area is cleared in</span>
<span class="quote">&gt; dma_contiguous_remap() if CONFIG_HIGHMEM. I guess that proper cache</span>
<span class="quote">&gt; operation is required there.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Could you test my newly updated branch again? I re-enable</span>
<span class="quote">&gt; dma_contiguous_remap() to clear direct mapping for CMA area and add</span>
<span class="quote">&gt; proper(?) cache operation although I&#39;m not the expert on that area.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>

Yeah that one boots too, dmesg below. I wonder why flushing the range
with dmac_flush_range() and outer_flush_range() no longer seems enough
though?

Reverting the arch/arm/mm/dma-mapping.c changes in your patch
&quot;arm/dma: re-enable to remap the CMA area and flush cache before
remapping&quot; also boots, but produces the following build warnings:

arch/arm/mm/dma-mapping.c: In function &#39;dma_contiguous_remap&#39;:
arch/arm/mm/dma-mapping.c:503:20: warning: passing argument 1 of
&#39;cpu_cache.dma_flush_range&#39; makes pointer from integer without a
cast [-Wint-conversion]
dmac_flush_range(map.virtual, map.virtual + map.length);
                    ^~~
arch/arm/mm/dma-mapping.c:503:20: note: expected &#39;const void *&#39; but
argument is of type &#39;long unsigned int&#39;
arch/arm/mm/dma-mapping.c:503:33: warning: passing argument 2 of
&#39;cpu_cache.dma_flush_range&#39; makes pointer from integer without a
cast [-Wint-conversion]
dmac_flush_range(map.virtual, map.virtual + map.length);

Regards,

Tony

8&lt; -----------------------
Linux version 4.13.0-rc7-next-20170901-00016-g69a5a607f945 (tmlind@sampyla) (gcc version 6.3.1 20170109 (crosstool-NG crosstool-ng-1.23.0)) #546 SMP Thu Oct 26 07:03:19 PDT 2017
CPU: ARMv7 Processor [411fc083] revision 3 (ARMv7), cr=10c5387d
CPU: PIPT / VIPT nonaliasing data cache, VIPT nonaliasing instruction cache
OF: fdt: Machine model: Nokia N900
memblock_add: [0x80000000-0x8fffffff] early_init_dt_scan_memory+0xec/0x158
Memory policy: Data cache writeback
memblock_reserve: [0x80100000-0x8152f643] arm_memblock_init+0x30/0x1b0
memblock_reserve: [0x80004000-0x80007fff] arm_memblock_init+0x13c/0x1b0
memblock_reserve: [0x8ff00000-0x8fffffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8ff00000-0x8fffffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fe00000-0x8fefffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8fe00000-0x8fefffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fccb000-0x8fcddfff] arm_memblock_init+0x150/0x1b0
memblock_reserve: [0x8fccb000-0x8fcddfff] early_init_fdt_scan_reserved_mem+0x58/0x7c
memblock_reserve: [0x8e800000-0x8f7fffff] memblock_alloc_range_nid+0x38/0x50
cma: Reserved 16 MiB at 0x8e800000
MEMBLOCK configuration:
 memory size = 0x0fe00000 reserved size = 0x02446644
 memory.cnt  = 0x1
 memory[0x0]	[0x80000000-0x8fdfffff], 0x0fe00000 bytes flags: 0x0
 reserved.cnt  = 0x4
 reserved[0x0]	[0x80004000-0x80007fff], 0x00004000 bytes flags: 0x0
 reserved[0x1]	[0x80100000-0x8152f643], 0x0142f644 bytes flags: 0x0
 reserved[0x2]	[0x8e800000-0x8f7fffff], 0x01000000 bytes flags: 0x0
 reserved[0x3]	[0x8fccb000-0x8fcddfff], 0x00013000 bytes flags: 0x0
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00016-g69a5a607f945 #546
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082e9e4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082e9e4&gt;] (dump_stack) from [&lt;c0c06d9c&gt;] (dma_contiguous_remap+0x60/0x140)
[&lt;c0c06d9c&gt;] (dma_contiguous_remap) from [&lt;c0c07f7c&gt;] (paging_init+0x324/0x700)
[&lt;c0c07f7c&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00016-g69a5a607f945 #546
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082e9e4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082e9e4&gt;] (dump_stack) from [&lt;c0c06dcc&gt;] (dma_contiguous_remap+0x90/0x140)
[&lt;c0c06dcc&gt;] (dma_contiguous_remap) from [&lt;c0c07f7c&gt;] (paging_init+0x324/0x700)
[&lt;c0c07f7c&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00016-g69a5a607f945 #546
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082e9e4&gt;] (dump_stack+0xac/0xe0)
[&lt;c082e9e4&gt;] (dump_stack) from [&lt;c0c06e34&gt;] (dma_contiguous_remap+0xf8/0x140)
[&lt;c0c06e34&gt;] (dma_contiguous_remap) from [&lt;c0c07f7c&gt;] (paging_init+0x324/0x700)
[&lt;c0c07f7c&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
memblock_reserve: [0x8fdfe000-0x8fdfffff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfd000-0x8fdfdfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcee8-0x8fdfcfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcec0-0x8fdfcee7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce98-0x8fdfcebf] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce70-0x8fdfce97] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce48-0x8fdfce6f] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce20-0x8fdfce47] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfb000-0x8fdfbfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfa000-0x8fdfafff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdf9000-0x8fdf9fff] memblock_alloc_range_nid+0x38/0x50
On node 0 totalpages: 65024
memblock_virt_alloc_try_nid_nopanic: 2359296 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 alloc_node_mem_map.constprop.10+0x68/0xb4
memblock_reserve: [0x8fa8b000-0x8fccafff] memblock_virt_alloc_internal+0xfc/0x1c0
free_area_init_node: node 0, pgdat c0dc5040, node_mem_map cfa8b000
  Normal zone: 572 pages used for memmap
  Normal zone: 0 pages reserved
  Normal zone: 65024 pages, LIFO batch:15
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfce00-0x8fdfce0f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfcdc0-0x8fdfcdcf] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 32 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 setup_arch+0x6e8/0xc94
memblock_reserve: [0x8fdfcd80-0x8fdfcd9f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_reserve: [0x8fdb0548-0x8fdf8fff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcde8-0x8fdfcdff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcdd0-0x8fdfcde7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcda4-0x8fdfcdbe] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd64-0x8fdfcd7e] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd48-0x8fdfcd62] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd30-0x8fdfcd47] memblock_alloc_range_nid+0x38/0x50
CPU: All CPU(s) started in SVC mode.
OMAP3430/3530 ES3.1 (l2cache iva sgx neon isp)
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfcd00-0x8fdfcd07] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfccc0-0x8fdfccc7] memblock_virt_alloc_internal+0xfc/0x1c0
random: fast init done
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0x9c/0x3fc
memblock_reserve: [0x8fdfcc00-0x8fdfccb6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xc0/0x3fc
memblock_reserve: [0x8fdfcb40-0x8fdfcbf6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xe4/0x3fc
memblock_reserve: [0x8fdfca80-0x8fdfcb36] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_alloc_info+0x4c/0x88
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_embed_first_chunk+0x464/0x714
memblock_reserve: [0x8fdae540-0x8fdaf53f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 73728 bytes align=0x1000 nid=-1 from=0xbfffffff max_addr=0x0 pcpu_dfl_fc_alloc+0x3c/0x44
memblock_reserve: [0x8fd9c000-0x8fdadfff] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdae000-0x0000008fdadfff] pcpu_embed_first_chunk+0x5d8/0x714
percpu: Embedded 18 pages/cpu @cfd9c000 s41644 r8192 d23892 u73728
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0xf0/0x678
memblock_reserve: [0x8fdfca40-0x8fdfca43] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x110/0x678
memblock_reserve: [0x8fdfca00-0x8fdfca03] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x130/0x678
memblock_reserve: [0x8fdfc9c0-0x8fdfc9c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x150/0x678
memblock_reserve: [0x8fdfc980-0x8fdfc983] memblock_virt_alloc_internal+0xfc/0x1c0
pcpu-alloc: s41644 r8192 d23892 u73728 alloc=18*4096
pcpu-alloc: [0] 0
memblock_virt_alloc_try_nid: 128 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x41c/0x678
memblock_reserve: [0x8fdfc900-0x8fdfc97f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc880-0x8fdfc8c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 384 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc700-0x8fdfc87f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 388 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdfc540-0x8fdfc6c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 60 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc500-0x8fdfc53b] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc480-0x8fdfc4c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 768 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc180-0x8fdfc47f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 772 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdae200-0x8fdae503] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 120 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc100-0x8fdfc177] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdaf540-0x0000008fdb053f] pcpu_embed_first_chunk+0x664/0x714
__memblock_free_early: [0x0000008fdae540-0x0000008fdaf53f] pcpu_embed_first_chunk+0x6c4/0x714
Built 1 zonelists, mobility grouping on.  Total pages: 64452
Kernel command line: root=/dev/nfs ip=dhcp console=ttyO2,115200 memmap=2M$0x88000000 ramoops.mem_address=0x88000000 ramoops.mem_size=0x200000 ramoops.record_size=0x40000 debug earlyprintk init=/root/init
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
PID hash table entries: 1024 (order: 0, 4096 bytes)
memblock_virt_alloc_try_nid_nopanic: 131072 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd7c000-0x8fd9bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
memblock_virt_alloc_try_nid_nopanic: 65536 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd6c000-0x8fd7bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 220052K/260096K available (8192K kernel code, 816K rwdata, 2420K rodata, 1024K init, 7557K bss, 23660K reserved, 16384K cma-reserved, 0K highmem)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0000000 - 0xff800000   ( 760 MB)
    lowmem  : 0xc0000000 - 0xcfe00000   ( 254 MB)
    pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)
    modules : 0xbf000000 - 0xbfe00000   (  14 MB)
      .text : 0xc0008000 - 0xc0900000   (9184 kB)
      .init : 0xc0c00000 - 0xc0d00000   (1024 kB)
      .data : 0xc0d00000 - 0xc0dcc280   ( 817 kB)
       .bss : 0xc0dce000 - 0xc152f644   (7558 kB)
Running RCU self tests
Hierarchical RCU implementation.
	RCU event tracing is enabled.
	RCU lockdep checking is enabled.
	RCU restricting CPUs from NR_CPUS=2 to nr_cpu_ids=1.
RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
IRQ: Found an INTC at 0xfa200000 (revision 4.0) with 96 interrupts
Clocking rate (Crystal/Core/MPU): 19.2/332/500 MHz
OMAP clockevent source: timer1 at 32768 Hz
clocksource: 32k_counter: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 58327039986419 ns
sched_clock: 32 bits at 32kHz, resolution 30517ns, wraps every 65535999984741ns
OMAP clocksource: 32k_counter at 32768 Hz
Console: colour dummy device 80x30
WARNING: Your &#39;console=ttyO2&#39; has been replaced by &#39;ttyS2&#39;
This ensures that you still see kernel messages. Please
update your kernel commandline.
Lock dependency validator: Copyright (c) 2006 Red Hat, Inc., Ingo Molnar
... MAX_LOCKDEP_SUBCLASSES:  8
... MAX_LOCK_DEPTH:          48
... MAX_LOCKDEP_KEYS:        8191
... CLASSHASH_SIZE:          4096
... MAX_LOCKDEP_ENTRIES:     32768
... MAX_LOCKDEP_CHAINS:      65536
... CHAINHASH_SIZE:          32768
 memory used by lock dependency info: 4655 kB
 per task-struct memory footprint: 1536 bytes
Calibrating delay loop... 493.97 BogoMIPS (lpj=2469888)
...
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 7, 2017, 5:33 a.m.</div>
<pre class="content">
Hello,

Sorry for dealy. I was on vacation during last week.

On Thu, Oct 26, 2017 at 07:16:27AM -0700, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171025 21:45]:</span>
<span class="quote">&gt; &gt; On Wed, Oct 25, 2017 at 10:31:38AM -0700, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; Great, this branch boots on n900! Early parts of the dmesg attached</span>
<span class="quote">&gt; &gt; &gt; below.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Sound good. Perhaps, problem is due to the cache management. With my</span>
<span class="quote">&gt; &gt; patchset, direct mapping for CMA area is cleared in</span>
<span class="quote">&gt; &gt; dma_contiguous_remap() if CONFIG_HIGHMEM. I guess that proper cache</span>
<span class="quote">&gt; &gt; operation is required there.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Could you test my newly updated branch again? I re-enable</span>
<span class="quote">&gt; &gt; dma_contiguous_remap() to clear direct mapping for CMA area and add</span>
<span class="quote">&gt; &gt; proper(?) cache operation although I&#39;m not the expert on that area.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Yeah that one boots too, dmesg below. I wonder why flushing the range</span>
<span class="quote">&gt; with dmac_flush_range() and outer_flush_range() no longer seems enough</span>
<span class="quote">&gt; though?</span>

I don&#39;t know the reason. AFAIK, it should be enough to flush cpu cache
before clearing page table entry, however, it doesn&#39;t work for n900.

flush_cache_all() has not only d-cache flushing but also i-cache
flushing. So, I&#39;d like to test effect of i-cache flushing.

Could you test follwing updated branch?

https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901

It has three relevant commits on top and enables CMA memory use.

&quot;arm/dma: remove i-cache flush&quot;
&quot;arm/dma: flush i-cache and d-cache separately&quot;
&quot;arm/dma: call flush_cache_all() and don&#39;t do outer cache operation&quot;

I think that flush_cache_all() here looks fine because size of CMA
area is usually large enough to use flush_cache_all() but
understanding root cause would be important so I ask this test. If u
don&#39;t mind, please test each commit with reverting one by one and let
me know the result of each test.
<span class="quote">
&gt; Reverting the arch/arm/mm/dma-mapping.c changes in your patch</span>
<span class="quote">&gt; &quot;arm/dma: re-enable to remap the CMA area and flush cache before</span>
<span class="quote">&gt; remapping&quot; also boots, but produces the following build warnings:</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; arch/arm/mm/dma-mapping.c: In function &#39;dma_contiguous_remap&#39;:</span>
<span class="quote">&gt; arch/arm/mm/dma-mapping.c:503:20: warning: passing argument 1 of</span>
<span class="quote">&gt; &#39;cpu_cache.dma_flush_range&#39; makes pointer from integer without a</span>
<span class="quote">&gt; cast [-Wint-conversion]</span>
<span class="quote">&gt; dmac_flush_range(map.virtual, map.virtual + map.length);</span>
<span class="quote">&gt;                     ^~~</span>
<span class="quote">&gt; arch/arm/mm/dma-mapping.c:503:20: note: expected &#39;const void *&#39; but</span>
<span class="quote">&gt; argument is of type &#39;long unsigned int&#39;</span>
<span class="quote">&gt; arch/arm/mm/dma-mapping.c:503:33: warning: passing argument 2 of</span>
<span class="quote">&gt; &#39;cpu_cache.dma_flush_range&#39; makes pointer from integer without a</span>
<span class="quote">&gt; cast [-Wint-conversion]</span>
<span class="quote">&gt; dmac_flush_range(map.virtual, map.virtual + map.length);</span>

Thanks for info.
I think that incorrect type would not be related to this problem.

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Nov. 7, 2017, 3:48 p.m.</div>
<pre class="content">
Hi,

* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171107 05:30]:
<span class="quote">&gt; Could you test follwing updated branch?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; It has three relevant commits on top and enables CMA memory use.</span>

Okie dokie.
<span class="quote">
&gt; &quot;arm/dma: remove i-cache flush&quot;</span>

Your branch at the above commit is not booting on n900.
<span class="quote">
&gt; &quot;arm/dma: flush i-cache and d-cache separately&quot;</span>

Not booting at this commit either.
<span class="quote">
&gt; &quot;arm/dma: call flush_cache_all() and don&#39;t do outer cache operation&quot;</span>

Not booting at this commit either.

Earlier commit f14f3479c0d7 (&quot;arm/dma: re-enable to remap the CMA
area and flush cache before remapping&quot;) in you branch boots.

Then the following commit d6512d6d0171 (&quot;Revert &quot;arm/mm: disable
atomic_pool&quot;&quot;) won&#39;t boot.

Also your tree at commit 6d0525cef962 (&quot;arm/dma: remove i-cache
flush&quot;) with only commit d6512d6d0171 (&quot;Revert &quot;arm/mm: disable
atomic_pool&quot;&quot;) reverted boots on n900.

So it seems the issue is currently at the atomic_pool_init()
related code?

Regards,

Tony
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 8, 2017, 7:46 a.m.</div>
<pre class="content">
On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:
<span class="quote">&gt; Hi,</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171107 05:30]:</span>
<span class="quote">&gt; &gt; Could you test follwing updated branch?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; It has three relevant commits on top and enables CMA memory use.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Okie dokie.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; &quot;arm/dma: remove i-cache flush&quot;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Your branch at the above commit is not booting on n900.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; &quot;arm/dma: flush i-cache and d-cache separately&quot;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Not booting at this commit either.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; &quot;arm/dma: call flush_cache_all() and don&#39;t do outer cache operation&quot;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Not booting at this commit either.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Earlier commit f14f3479c0d7 (&quot;arm/dma: re-enable to remap the CMA</span>
<span class="quote">&gt; area and flush cache before remapping&quot;) in you branch boots.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Then the following commit d6512d6d0171 (&quot;Revert &quot;arm/mm: disable</span>
<span class="quote">&gt; atomic_pool&quot;&quot;) won&#39;t boot.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Also your tree at commit 6d0525cef962 (&quot;arm/dma: remove i-cache</span>
<span class="quote">&gt; flush&quot;) with only commit d6512d6d0171 (&quot;Revert &quot;arm/mm: disable</span>
<span class="quote">&gt; atomic_pool&quot;&quot;) reverted boots on n900.</span>

Thanks a lot!
<span class="quote">
&gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; related code?</span>

Yes, your test showed it although I can&#39;t find any clue in
atomic_pool_init().

Could you test updated branch?

https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901

There are two relevant commits.

arm/dma: stop dma allocation before __dma_alloc_remap()
arm/dma: disable atomic pool after dma allocation

atomic pool initialization will be done partially to check
exact point of failure. These are brain-dead commits however I have no
idea what&#39;s going on here until now. :/

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Nov. 8, 2017, 4:34 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171108 07:43]:
<span class="quote">&gt; On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; &gt; related code?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Yes, your test showed it although I can&#39;t find any clue in</span>
<span class="quote">&gt; atomic_pool_init().</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Could you test updated branch?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; There are two relevant commits.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; arm/dma: stop dma allocation before __dma_alloc_remap()</span>
<span class="quote">&gt; arm/dma: disable atomic pool after dma allocation</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; atomic pool initialization will be done partially to check</span>
<span class="quote">&gt; exact point of failure. These are brain-dead commits however I have no</span>
<span class="quote">&gt; idea what&#39;s going on here until now. :/</span>

OK that booted, dmesg output below. Hopefully that provides
you with some more clues.

Regards,

Tony

8&lt; ---------------------
Linux version 4.13.0-rc7-next-20170901-00024-gcf9a104b2f62 (tmlind@sampyla) (gcc version 6.3.1 20170109 (crosstool-NG crosstool-ng-1.23.0)) #568 SMP Wed Nov 8 08:25:47 PST 2017
CPU: ARMv7 Processor [411fc083] revision 3 (ARMv7), cr=10c5387d
CPU: PIPT / VIPT nonaliasing data cache, VIPT nonaliasing instruction cache
OF: fdt: Machine model: Nokia N900
memblock_add: [0x80000000-0x8fffffff] early_init_dt_scan_memory+0xec/0x158
Memory policy: Data cache writeback
memblock_reserve: [0x80100000-0x8152f643] arm_memblock_init+0x30/0x1b0
memblock_reserve: [0x80004000-0x80007fff] arm_memblock_init+0x13c/0x1b0
memblock_reserve: [0x8ff00000-0x8fffffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8ff00000-0x8fffffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fe00000-0x8fefffff] memblock_alloc_range_nid+0x38/0x50
   memblock_free: [0x8fe00000-0x8fefffff] arm_memblock_steal+0x30/0x48
memblock_reserve: [0x8fccb000-0x8fcddfff] arm_memblock_init+0x150/0x1b0
memblock_reserve: [0x8fccb000-0x8fcddfff] early_init_fdt_scan_reserved_mem+0x58/0x7c
memblock_reserve: [0x8e800000-0x8f7fffff] memblock_alloc_range_nid+0x38/0x50
cma: Reserved 16 MiB at 0x8e800000
MEMBLOCK configuration:
 memory size = 0x0fe00000 reserved size = 0x02446644
 memory.cnt  = 0x1
 memory[0x0]	[0x80000000-0x8fdfffff], 0x0fe00000 bytes flags: 0x0
 reserved.cnt  = 0x4
 reserved[0x0]	[0x80004000-0x80007fff], 0x00004000 bytes flags: 0x0
 reserved[0x1]	[0x80100000-0x8152f643], 0x0142f644 bytes flags: 0x0
 reserved[0x2]	[0x8e800000-0x8f7fffff], 0x01000000 bytes flags: 0x0
 reserved[0x3]	[0x8fccb000-0x8fcddfff], 0x00013000 bytes flags: 0x0
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00024-gcf9a104b2f62 #568
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eb04&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eb04&gt;] (dump_stack) from [&lt;c0c06e94&gt;] (dma_contiguous_remap+0x70/0x144)
[&lt;c0c06e94&gt;] (dma_contiguous_remap) from [&lt;c0c08068&gt;] (paging_init+0x324/0x700)
[&lt;c0c08068&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00024-gcf9a104b2f62 #568
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eb04&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eb04&gt;] (dump_stack) from [&lt;c0c06eb8&gt;] (dma_contiguous_remap+0x94/0x144)
[&lt;c0c06eb8&gt;] (dma_contiguous_remap) from [&lt;c0c08068&gt;] (paging_init+0x324/0x700)
[&lt;c0c08068&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
CMA_ADDR: __phys_to_virt_debug: 0x8e800000 to 0xce800000
CPU: 0 PID: 0 Comm: swapper Not tainted 4.13.0-rc7-next-20170901-00024-gcf9a104b2f62 #568
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eb04&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eb04&gt;] (dump_stack) from [&lt;c0c06f24&gt;] (dma_contiguous_remap+0x100/0x144)
[&lt;c0c06f24&gt;] (dma_contiguous_remap) from [&lt;c0c08068&gt;] (paging_init+0x324/0x700)
[&lt;c0c08068&gt;] (paging_init) from [&lt;c0c042ac&gt;] (setup_arch+0x5b4/0xc94)
[&lt;c0c042ac&gt;] (setup_arch) from [&lt;c0c00940&gt;] (start_kernel+0x54/0x3fc)
[&lt;c0c00940&gt;] (start_kernel) from [&lt;8000807c&gt;] (0x8000807c)
memblock_reserve: [0x8fdfe000-0x8fdfffff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfd000-0x8fdfdfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcee8-0x8fdfcfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcec0-0x8fdfcee7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce98-0x8fdfcebf] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce70-0x8fdfce97] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce48-0x8fdfce6f] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfce20-0x8fdfce47] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfb000-0x8fdfbfff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfa000-0x8fdfafff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdf9000-0x8fdf9fff] memblock_alloc_range_nid+0x38/0x50
On node 0 totalpages: 65024
memblock_virt_alloc_try_nid_nopanic: 2359296 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 alloc_node_mem_map.constprop.10+0x68/0xb4
memblock_reserve: [0x8fa8b000-0x8fccafff] memblock_virt_alloc_internal+0xfc/0x1c0
free_area_init_node: node 0, pgdat c0dc5040, node_mem_map cfa8b000
  Normal zone: 572 pages used for memmap
  Normal zone: 0 pages reserved
  Normal zone: 65024 pages, LIFO batch:15
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfce00-0x8fdfce0f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 16 bytes align=0x0 nid=0 from=0x0 max_addr=0x0 setup_usemap.constprop.12+0x5c/0x6c
memblock_reserve: [0x8fdfcdc0-0x8fdfcdcf] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 32 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 setup_arch+0x6e8/0xc94
memblock_reserve: [0x8fdfcd80-0x8fdfcd9f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_reserve: [0x8fdb0548-0x8fdf8fff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcde8-0x8fdfcdff] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcdd0-0x8fdfcde7] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcda4-0x8fdfcdbe] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd64-0x8fdfcd7e] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd48-0x8fdfcd62] memblock_alloc_range_nid+0x38/0x50
memblock_reserve: [0x8fdfcd30-0x8fdfcd47] memblock_alloc_range_nid+0x38/0x50
CPU: All CPU(s) started in SVC mode.
OMAP3430/3530 ES3.1 (l2cache iva sgx neon isp)
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfcd00-0x8fdfcd07] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 8 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 omap2_clk_legacy_provider_init+0x2c/0x44
memblock_reserve: [0x8fdfccc0-0x8fdfccc7] memblock_virt_alloc_internal+0xfc/0x1c0
random: fast init done
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0x9c/0x3fc
memblock_reserve: [0x8fdfcc00-0x8fdfccb6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xc0/0x3fc
memblock_reserve: [0x8fdfcb40-0x8fdfcbf6] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 183 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 start_kernel+0xe4/0x3fc
memblock_reserve: [0x8fdfca80-0x8fdfcb36] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_alloc_info+0x4c/0x88
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_embed_first_chunk+0x464/0x714
memblock_reserve: [0x8fdae540-0x8fdaf53f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid_nopanic: 73728 bytes align=0x1000 nid=-1 from=0xbfffffff max_addr=0x0 pcpu_dfl_fc_alloc+0x3c/0x44
memblock_reserve: [0x8fd9c000-0x8fdadfff] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdae000-0x0000008fdadfff] pcpu_embed_first_chunk+0x5d8/0x714
percpu: Embedded 18 pages/cpu @cfd9c000 s41644 r8192 d23892 u73728
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0xf0/0x678
memblock_reserve: [0x8fdfca40-0x8fdfca43] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x110/0x678
memblock_reserve: [0x8fdfca00-0x8fdfca03] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x130/0x678
memblock_reserve: [0x8fdfc9c0-0x8fdfc9c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 4 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x150/0x678
memblock_reserve: [0x8fdfc980-0x8fdfc983] memblock_virt_alloc_internal+0xfc/0x1c0
pcpu-alloc: s41644 r8192 d23892 u73728 alloc=18*4096
pcpu-alloc: [0] 0
memblock_virt_alloc_try_nid: 128 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_setup_first_chunk+0x41c/0x678
memblock_reserve: [0x8fdfc900-0x8fdfc97f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc880-0x8fdfc8c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 384 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc700-0x8fdfc87f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 388 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdfc540-0x8fdfc6c3] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 60 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc500-0x8fdfc53b] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 69 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0x64/0x2b4
memblock_reserve: [0x8fdfc480-0x8fdfc4c4] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 768 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xa8/0x2b4
memblock_reserve: [0x8fdfc180-0x8fdfc47f] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 772 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xc8/0x2b4
memblock_reserve: [0x8fdae200-0x8fdae503] memblock_virt_alloc_internal+0xfc/0x1c0
memblock_virt_alloc_try_nid: 120 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 pcpu_alloc_first_chunk+0xf4/0x2b4
memblock_reserve: [0x8fdfc100-0x8fdfc177] memblock_virt_alloc_internal+0xfc/0x1c0
__memblock_free_early: [0x0000008fdaf540-0x0000008fdb053f] pcpu_embed_first_chunk+0x664/0x714
__memblock_free_early: [0x0000008fdae540-0x0000008fdaf53f] pcpu_embed_first_chunk+0x6c4/0x714
Built 1 zonelists, mobility grouping on.  Total pages: 64452
Kernel command line: root=/dev/nfs ip=dhcp console=ttyO2,115200 memmap=2M$0x88000000 ramoops.mem_address=0x88000000 ramoops.mem_size=0x200000 ramoops.record_size=0x40000 debug earlyprintk init=/root/init
memblock_virt_alloc_try_nid_nopanic: 4096 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fdaf540-0x8fdb053f] memblock_virt_alloc_internal+0xfc/0x1c0
PID hash table entries: 1024 (order: 0, 4096 bytes)
memblock_virt_alloc_try_nid_nopanic: 131072 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd7c000-0x8fd9bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
memblock_virt_alloc_try_nid_nopanic: 65536 bytes align=0x0 nid=-1 from=0x0 max_addr=0x0 alloc_large_system_hash+0x180/0x268
memblock_reserve: [0x8fd6c000-0x8fd7bfff] memblock_virt_alloc_internal+0xfc/0x1c0
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 220052K/260096K available (8192K kernel code, 816K rwdata, 2420K rodata, 1024K init, 7557K bss, 23660K reserved, 16384K cma-reserved, 0K highmem)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0000000 - 0xff800000   ( 760 MB)
    lowmem  : 0xc0000000 - 0xcfe00000   ( 254 MB)
    pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)
    modules : 0xbf000000 - 0xbfe00000   (  14 MB)
      .text : 0xc0008000 - 0xc0900000   (9184 kB)
      .init : 0xc0c00000 - 0xc0d00000   (1024 kB)
      .data : 0xc0d00000 - 0xc0dcc280   ( 817 kB)
       .bss : 0xc0dce000 - 0xc152f644   (7558 kB)
Running RCU self tests
Hierarchical RCU implementation.
	RCU event tracing is enabled.
	RCU lockdep checking is enabled.
	RCU restricting CPUs from NR_CPUS=2 to nr_cpu_ids=1.
RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
IRQ: Found an INTC at 0xfa200000 (revision 4.0) with 96 interrupts
Clocking rate (Crystal/Core/MPU): 19.2/332/500 MHz
OMAP clockevent source: timer1 at 32768 Hz
clocksource: 32k_counter: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 58327039986419 ns
sched_clock: 32 bits at 32kHz, resolution 30517ns, wraps every 65535999984741ns
OMAP clocksource: 32k_counter at 32768 Hz
Console: colour dummy device 80x30
WARNING: Your &#39;console=ttyO2&#39; has been replaced by &#39;ttyS2&#39;
This ensures that you still see kernel messages. Please
update your kernel commandline.
Lock dependency validator: Copyright (c) 2006 Red Hat, Inc., Ingo Molnar
... MAX_LOCKDEP_SUBCLASSES:  8
... MAX_LOCK_DEPTH:          48
... MAX_LOCKDEP_KEYS:        8191
... CLASSHASH_SIZE:          4096
... MAX_LOCKDEP_ENTRIES:     32768
... MAX_LOCKDEP_CHAINS:      65536
... CHAINHASH_SIZE:          32768
 memory used by lock dependency info: 4655 kB
 per task-struct memory footprint: 1536 bytes
Calibrating delay loop... 493.97 BogoMIPS (lpj=2469888)
pid_max: default: 32768 minimum: 301
Security Framework initialized
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
CPU0: thread -1, cpu 0, socket -1, mpidr 0
Setting up static identity map for 0x80100000 - 0x80100078
Hierarchical SRCU implementation.
smp: Bringing up secondary CPUs ...
smp: Brought up 1 node, 1 CPU
SMP: Total of 1 processors activated (493.97 BogoMIPS).
CPU: All CPU(s) started in SVC mode.
devtmpfs: initialized
Built 1 zonelists, mobility grouping on.  Total pages: 59109
VFP support v0.3: implementor 41 architecture 3 part 30 variant c rev 1
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: 2, 16384 bytes)
pinctrl core: initialized pinctrl subsystem
NET: Registered protocol family 16
__alloc_from_contiguous
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.13.0-rc7-next-20170901-00024-gcf9a104b2f62 #568
Hardware name: Nokia RX-51 board
[&lt;c0110b38&gt;] (unwind_backtrace) from [&lt;c010caec&gt;] (show_stack+0x10/0x14)
[&lt;c010caec&gt;] (show_stack) from [&lt;c082eb04&gt;] (dump_stack+0xac/0xe0)
[&lt;c082eb04&gt;] (dump_stack) from [&lt;c0118b94&gt;] (__alloc_from_contiguous.constprop.7+0x28/0x68)
[&lt;c0118b94&gt;] (__alloc_from_contiguous.constprop.7) from [&lt;c0c06d3c&gt;] (atomic_pool_init+0x58/0xf0)
[&lt;c0c06d3c&gt;] (atomic_pool_init) from [&lt;c0101df4&gt;] (do_one_initcall+0x3c/0x170)
[&lt;c0101df4&gt;] (do_one_initcall) from [&lt;c0c00ee4&gt;] (kernel_init_freeable+0x1fc/0x2c4)
[&lt;c0c00ee4&gt;] (kernel_init_freeable) from [&lt;c0842a4c&gt;] (kernel_init+0x8/0x110)
[&lt;c0842a4c&gt;] (kernel_init) from [&lt;c0107d78&gt;] (ret_from_fork+0x14/0x3c)
atomic_pool_init: DMA: disable atomic_pool
omap_hwmod: mcbsp2_sidetone using broken dt data from mcbsp
omap_hwmod: mcbsp3_sidetone using broken dt data from mcbsp
cpuidle: using governor menu
SRAM_ADDR: omap_map_sram: P: 0x40208000 - 0x4020f000
SRAM_ADDR: omap_map_sram: V: 0xd0008000 - 0xd000f000
SRAM_ADDR: omap_sram_push_address: 0xd000ef00 - 0xd000effc
SRAM_ADDR: omap_sram_push_address: 0xd000ee90 - 0xd000eefc
Reprogramming SDRC clock to 332000000 Hz
...
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 9, 2017, 12:08 a.m.</div>
<pre class="content">
On Wed, Nov 08, 2017 at 08:34:13AM -0800, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171108 07:43]:</span>
<span class="quote">&gt; &gt; On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; &gt; &gt; related code?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Yes, your test showed it although I can&#39;t find any clue in</span>
<span class="quote">&gt; &gt; atomic_pool_init().</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Could you test updated branch?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; There are two relevant commits.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; arm/dma: stop dma allocation before __dma_alloc_remap()</span>
<span class="quote">&gt; &gt; arm/dma: disable atomic pool after dma allocation</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; atomic pool initialization will be done partially to check</span>
<span class="quote">&gt; &gt; exact point of failure. These are brain-dead commits however I have no</span>
<span class="quote">&gt; &gt; idea what&#39;s going on here until now. :/</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; OK that booted, dmesg output below. Hopefully that provides</span>
<span class="quote">&gt; you with some more clues.</span>

Thanks!

Could you let me know which one is booted? Both of them? or just top
commit (&quot;arm/dma: stop dma allocation before __dma_alloc_remap()&quot;)?

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Nov. 9, 2017, 12:11 a.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171109 00:05]:
<span class="quote">&gt; On Wed, Nov 08, 2017 at 08:34:13AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171108 07:43]:</span>
<span class="quote">&gt; &gt; &gt; On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; &gt; &gt; &gt; related code?</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Yes, your test showed it although I can&#39;t find any clue in</span>
<span class="quote">&gt; &gt; &gt; atomic_pool_init().</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Could you test updated branch?</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; There are two relevant commits.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; arm/dma: stop dma allocation before __dma_alloc_remap()</span>
<span class="quote">&gt; &gt; &gt; arm/dma: disable atomic pool after dma allocation</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; atomic pool initialization will be done partially to check</span>
<span class="quote">&gt; &gt; &gt; exact point of failure. These are brain-dead commits however I have no</span>
<span class="quote">&gt; &gt; &gt; idea what&#39;s going on here until now. :/</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; OK that booted, dmesg output below. Hopefully that provides</span>
<span class="quote">&gt; &gt; you with some more clues.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Thanks!</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Could you let me know which one is booted? Both of them? or just top</span>
<span class="quote">&gt; commit (&quot;arm/dma: stop dma allocation before __dma_alloc_remap()&quot;)?</span>

Oh OK. Only the top commit boots.

Regards,

Tony
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 9, 2017, 12:36 a.m.</div>
<pre class="content">
On Wed, Nov 08, 2017 at 04:11:13PM -0800, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171109 00:05]:</span>
<span class="quote">&gt; &gt; On Wed, Nov 08, 2017 at 08:34:13AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171108 07:43]:</span>
<span class="quote">&gt; &gt; &gt; &gt; On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; related code?</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Yes, your test showed it although I can&#39;t find any clue in</span>
<span class="quote">&gt; &gt; &gt; &gt; atomic_pool_init().</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; Could you test updated branch?</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; There are two relevant commits.</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; arm/dma: stop dma allocation before __dma_alloc_remap()</span>
<span class="quote">&gt; &gt; &gt; &gt; arm/dma: disable atomic pool after dma allocation</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; atomic pool initialization will be done partially to check</span>
<span class="quote">&gt; &gt; &gt; &gt; exact point of failure. These are brain-dead commits however I have no</span>
<span class="quote">&gt; &gt; &gt; &gt; idea what&#39;s going on here until now. :/</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; OK that booted, dmesg output below. Hopefully that provides</span>
<span class="quote">&gt; &gt; &gt; you with some more clues.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Thanks!</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Could you let me know which one is booted? Both of them? or just top</span>
<span class="quote">&gt; &gt; commit (&quot;arm/dma: stop dma allocation before __dma_alloc_remap()&quot;)?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Oh OK. Only the top commit boots.</span>

Okay! I will try to analyze!

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 9, 2017, 3:50 a.m.</div>
<pre class="content">
On Thu, Nov 09, 2017 at 09:36:39AM +0900, Joonsoo Kim wrote:
<span class="quote">&gt; On Wed, Nov 08, 2017 at 04:11:13PM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171109 00:05]:</span>
<span class="quote">&gt; &gt; &gt; On Wed, Nov 08, 2017 at 08:34:13AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171108 07:43]:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; On Tue, Nov 07, 2017 at 07:48:42AM -0800, Tony Lindgren wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; So it seems the issue is currently at the atomic_pool_init()</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; &gt; related code?</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Yes, your test showed it although I can&#39;t find any clue in</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; atomic_pool_init().</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; Could you test updated branch?</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; https://github.com/JoonsooKim/linux/tree/cma-debug4-next-20180901</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; There are two relevant commits.</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; arm/dma: stop dma allocation before __dma_alloc_remap()</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; arm/dma: disable atomic pool after dma allocation</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; atomic pool initialization will be done partially to check</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; exact point of failure. These are brain-dead commits however I have no</span>
<span class="quote">&gt; &gt; &gt; &gt; &gt; idea what&#39;s going on here until now. :/</span>
<span class="quote">&gt; &gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; &gt; OK that booted, dmesg output below. Hopefully that provides</span>
<span class="quote">&gt; &gt; &gt; &gt; you with some more clues.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Thanks!</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Could you let me know which one is booted? Both of them? or just top</span>
<span class="quote">&gt; &gt; &gt; commit (&quot;arm/dma: stop dma allocation before __dma_alloc_remap()&quot;)?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Oh OK. Only the top commit boots.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Okay! I will try to analyze!</span>
<span class="quote">&gt; </span>

Could you test following two commits on my updated branch?

&quot;arm/dma: vmalloc area allocation&quot;
&quot;arm/dma: defer atomic pool initialization&quot;

I suspect that changed virtual address of the sram due to early
__dma_alloc_remap() call causes the problem and above two commits test
this theory.

Thanks.
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=109">Tony Lindgren</a> - Nov. 9, 2017, 3:08 p.m.</div>
<pre class="content">
* Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171109 03:47]:
<span class="quote">&gt; Could you test following two commits on my updated branch?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &quot;arm/dma: vmalloc area allocation&quot;</span>

Won&#39;t boot at this commit:

[    6.747283] save_secure_sram() returns 0000ff02
[    6.751983] save_secure_sram()&#39;s param: 0: 0x4
[    6.756561] save_secure_sram()&#39;s param: 1: 0x8e700000
[    6.761749] save_secure_sram()&#39;s param: 2: 0x0
[    6.766326] save_secure_sram()&#39;s param: 3: 0x1
[    6.770904] save_secure_sram()&#39;s param: 4: 0x1
<span class="quote">
&gt; &quot;arm/dma: defer atomic pool initialization&quot;</span>

Boots at this commit.
<span class="quote">
&gt; I suspect that changed virtual address of the sram due to early</span>
<span class="quote">&gt; __dma_alloc_remap() call causes the problem and above two commits test</span>
<span class="quote">&gt; this theory.</span>

Hmm OK. Does your first patch above now have the initcall issue too?
It boots if I make that also subsys_initcall and then I get:

[    2.078094] vmalloc_pool_init: DMA: get vmalloc area: d0010000

Regards,

Tony
</pre>
</div>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=57221">Joonsoo Kim</a> - Nov. 10, 2017, 12:13 a.m.</div>
<pre class="content">
On Thu, Nov 09, 2017 at 07:08:54AM -0800, Tony Lindgren wrote:
<span class="quote">&gt; * Joonsoo Kim &lt;iamjoonsoo.kim@lge.com&gt; [171109 03:47]:</span>
<span class="quote">&gt; &gt; Could you test following two commits on my updated branch?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; &quot;arm/dma: vmalloc area allocation&quot;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Won&#39;t boot at this commit:</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; [    6.747283] save_secure_sram() returns 0000ff02</span>
<span class="quote">&gt; [    6.751983] save_secure_sram()&#39;s param: 0: 0x4</span>
<span class="quote">&gt; [    6.756561] save_secure_sram()&#39;s param: 1: 0x8e700000</span>
<span class="quote">&gt; [    6.761749] save_secure_sram()&#39;s param: 2: 0x0</span>
<span class="quote">&gt; [    6.766326] save_secure_sram()&#39;s param: 3: 0x1</span>
<span class="quote">&gt; [    6.770904] save_secure_sram()&#39;s param: 4: 0x1</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; &quot;arm/dma: defer atomic pool initialization&quot;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Boots at this commit.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; I suspect that changed virtual address of the sram due to early</span>
<span class="quote">&gt; &gt; __dma_alloc_remap() call causes the problem and above two commits test</span>
<span class="quote">&gt; &gt; this theory.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Hmm OK. Does your first patch above now have the initcall issue too?</span>
<span class="quote">&gt; It boots if I make that also subsys_initcall and then I get:</span>
<span class="quote">
&gt; [    2.078094] vmalloc_pool_init: DMA: get vmalloc area: d0010000</span>

Yes, first patch has the initcall issue and it&#39;s intentional in order
to check the theory. I checked following log for this.

- Boot failure
SRAM_ADDR: omap_map_sram: P: 0x40208000 - 0x4020f000
SRAM_ADDR: omap_map_sram: V: 0xd0050000 - 0xd0057000

- Boot success
SRAM_ADDR: omap_map_sram: P: 0x40208000 - 0x4020f000
SRAM_ADDR: omap_map_sram: V: 0xd0008000 - 0xd000f000

When failure, virtual address for sram is higher than normal one due
to vmalloc area allocation in __dma_alloc_remap(). If it is deferred,
virtual address is the same with success case and then the system work.

So, my next theory is that there is n900 specific assumption that sram
should have that address. Could you check if any working tree for n900
which doesn&#39;t have my CMA series work or not with adding
&quot;arm/dma: vmalloc area allocation&quot;?

Thanks.
</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
<span class="p_header">diff --git a/mm/page_alloc.c b/mm/page_alloc.c</span>
<span class="p_header">index 6dbc49e..1e48e67 100644</span>
<span class="p_header">--- a/mm/page_alloc.c</span>
<span class="p_header">+++ b/mm/page_alloc.c</span>
<span class="p_chunk">@@ -1861,7 +1861,7 @@</span> <span class="p_context"> static int fallbacks[MIGRATE_TYPES][4] = {</span>
 static struct page *__rmqueue_cma_fallback(struct zone *zone,
                                        unsigned int order)
 {
<span class="p_del">-       return __rmqueue_smallest(zone, order, MIGRATE_CMA);</span>
<span class="p_add">+       return NULL;</span>
 }
 #else
 static inline struct page *__rmqueue_cma_fallback(struct zone *zone,

<span class="p_del">-----------------&gt;8----------------------</span>
<span class="p_header">diff --git a/arch/arm/mm/dma-mapping.c b/arch/arm/mm/dma-mapping.c</span>
<span class="p_header">index c68f34a..c72b4c3 100644</span>
<span class="p_header">--- a/arch/arm/mm/dma-mapping.c</span>
<span class="p_header">+++ b/arch/arm/mm/dma-mapping.c</span>
<span class="p_chunk">@@ -497,6 +497,9 @@</span> <span class="p_context"> void __init dma_contiguous_remap(void)</span>
                map.length = end - start;
                map.type = MT_MEMORY_DMA_READY;
 
<span class="p_add">+               dmac_flush_range(map.virtual, map.virtual + map.length);</span>
<span class="p_add">+               outer_flush_range(start, end);</span>
<span class="p_add">+</span>
                /*
                 * Clear previous low-memory mapping to ensure that the
                 * TLB does not see any conflicting entries, then flush
<span class="p_chunk">@@ -510,6 +513,7 @@</span> <span class="p_context"> void __init dma_contiguous_remap(void)</span>
                     addr += PMD_SIZE)
                        pmd_clear(pmd_off_k(addr));
 
<span class="p_add">+               flush_cache_all();</span>
                flush_tlb_kernel_range(__phys_to_virt(start),
                                       __phys_to_virt(end));
 

</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



