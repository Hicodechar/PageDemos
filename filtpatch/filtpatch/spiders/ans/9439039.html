
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>Linux 4.4.34 - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
  <script type="text/javascript" src="/static/js/common.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.js"></script>

 </head>
 <body>
  <div id="title">
  <h1 style="float: left;">
     <a
      href="/">Patchwork</a>
    Linux 4.4.34</h1>
  <div id="auth">

     <a href="/user/login/">login</a>
     <br/>
     <a href="/register/">register</a>
     <br/>
     <a href="/mail/">mail settings</a>

   </div>
   <div style="clear: both;"></div>
  </div>
  <div id="nav">
   <div id="navleft">
   
    <strong>Project</strong>: LKML
     :
     <a href="/project/LKML/list/"
      >patches</a>
     :
     <a href="/project/LKML/"
      >project info</a>
    
     :
     <a href="/"
     >other projects</a>
     
    
   </div>
   <div id="navright">
    <a href="/help/about/">about</a>
   </div>
   <div style="clear: both"></div>
  </div>

  <div id="content">

<script language="JavaScript" type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<table class="patchmeta">
 <tr>
  <th>Submitter</th>
  <td><a href="/project/LKML/list/?submitter=37061">gregkh@linuxfoundation.org</a></td>
 </tr>
 <tr>
  <th>Date</th>
  <td>Nov. 21, 2016, 9:28 a.m.</td>
 </tr>
 <tr>
  <th>Message ID</th>
  <td>&lt;20161121092859.GB20976@kroah.com&gt;</td>
 </tr>
 <tr>
  <th>Download</th>
  <td>
   <a href="/patch/9439039/mbox/"
   >mbox</a>
|
   <a href="/patch/9439039/raw/"
   >patch</a>

   </td>
 </tr>
 <tr>
  <th>Permalink</th>
  <td><a href="/patch/9439039/">/patch/9439039/</a>
 </tr>
  <tr>
   <th>State</th>
   <td>New</td>
  </tr>


 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-kernel-owner@kernel.org&gt;
Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org
	[172.30.200.125])
	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id
	6C660600BA for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Mon, 21 Nov 2016 09:29:20 +0000 (UTC)
Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 56FF0204BA
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Mon, 21 Nov 2016 09:29:20 +0000 (UTC)
Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486)
	id 4970528A70; Mon, 21 Nov 2016 09:29:20 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	pdx-wl-mail.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-6.9 required=2.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id E671F28A6E
	for &lt;patchwork-LKML@patchwork.kernel.org&gt;;
	Mon, 21 Nov 2016 09:29:13 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1753776AbcKUJ2y (ORCPT
	&lt;rfc822;patchwork-LKML@patchwork.kernel.org&gt;);
	Mon, 21 Nov 2016 04:28:54 -0500
Received: from mail.linuxfoundation.org ([140.211.169.12]:40568 &quot;EHLO
	mail.linuxfoundation.org&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1753733AbcKUJ2v (ORCPT
	&lt;rfc822;linux-kernel@vger.kernel.org&gt;);
	Mon, 21 Nov 2016 04:28:51 -0500
Received: from localhost (pes75-3-78-192-101-3.fbxo.proxad.net
	[78.192.101.3])
	by mail.linuxfoundation.org (Postfix) with ESMTPSA id 0D9002C;
	Mon, 21 Nov 2016 09:28:48 +0000 (UTC)
Date: Mon, 21 Nov 2016 10:28:59 +0100
From: Greg KH &lt;gregkh@linuxfoundation.org&gt;
To: linux-kernel@vger.kernel.org, Andrew Morton &lt;akpm@linux-foundation.org&gt;,
	torvalds@linux-foundation.org, stable@vger.kernel.org
Cc: lwn@lwn.net, Jiri Slaby &lt;jslaby@suse.cz&gt;
Subject: Re: Linux 4.4.34
Message-ID: &lt;20161121092859.GB20976@kroah.com&gt;
References: &lt;20161121092855.GA20976@kroah.com&gt;
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: &lt;20161121092855.GA20976@kroah.com&gt;
User-Agent: Mutt/1.7.1 (2016-10-04)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: &lt;linux-kernel.vger.kernel.org&gt;
X-Mailing-List: linux-kernel@vger.kernel.org
X-Virus-Scanned: ClamAV using ClamSMTP
</pre>
   </div>
  </td>
 </tr>
</table>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>



<h2>Comments</h2>

<div class="comment">
<div class="meta"><a href="/project/LKML/list/?submitter=37061">gregkh@linuxfoundation.org</a> - Nov. 21, 2016, 9:28 a.m.</div>
<pre class="content">

</pre>
</div>



<h2>Patch</h2>
<div class="patch">
<pre class="content">
<span class="p_header">diff --git a/Makefile b/Makefile</span>
<span class="p_header">index a513c045c8de..30924aabf1b4 100644</span>
<span class="p_header">--- a/Makefile</span>
<span class="p_header">+++ b/Makefile</span>
<span class="p_chunk">@@ -1,6 +1,6 @@</span> <span class="p_context"></span>
 VERSION = 4
 PATCHLEVEL = 4
<span class="p_del">-SUBLEVEL = 33</span>
<span class="p_add">+SUBLEVEL = 34</span>
 EXTRAVERSION =
 NAME = Blurry Fish Butt
 
<span class="p_header">diff --git a/arch/sparc/include/asm/mmu_64.h b/arch/sparc/include/asm/mmu_64.h</span>
<span class="p_header">index 70067ce184b1..f7de0dbc38af 100644</span>
<span class="p_header">--- a/arch/sparc/include/asm/mmu_64.h</span>
<span class="p_header">+++ b/arch/sparc/include/asm/mmu_64.h</span>
<span class="p_chunk">@@ -92,7 +92,8 @@</span> <span class="p_context"> struct tsb_config {</span>
 typedef struct {
 	spinlock_t		lock;
 	unsigned long		sparc64_ctx_val;
<span class="p_del">-	unsigned long		huge_pte_count;</span>
<span class="p_add">+	unsigned long		hugetlb_pte_count;</span>
<span class="p_add">+	unsigned long		thp_pte_count;</span>
 	struct tsb_config	tsb_block[MM_NUM_TSBS];
 	struct hv_tsb_descr	tsb_descr[MM_NUM_TSBS];
 } mm_context_t;
<span class="p_header">diff --git a/arch/sparc/include/asm/uaccess_64.h b/arch/sparc/include/asm/uaccess_64.h</span>
<span class="p_header">index ea6e9a20f3ff..f428512481f9 100644</span>
<span class="p_header">--- a/arch/sparc/include/asm/uaccess_64.h</span>
<span class="p_header">+++ b/arch/sparc/include/asm/uaccess_64.h</span>
<span class="p_chunk">@@ -98,7 +98,6 @@</span> <span class="p_context"> struct exception_table_entry {</span>
         unsigned int insn, fixup;
 };
 
<span class="p_del">-void __ret_efault(void);</span>
 void __retl_efault(void);
 
 /* Uh, these should become the main single-value transfer routines..
<span class="p_chunk">@@ -179,20 +178,6 @@</span> <span class="p_context"> int __put_user_bad(void);</span>
 	 __gu_ret;							     \
 })
 
<span class="p_del">-#define __get_user_nocheck_ret(data, addr, size, type, retval) ({	\</span>
<span class="p_del">-	register unsigned long __gu_val __asm__ (&quot;l1&quot;);			\</span>
<span class="p_del">-	switch (size) {							\</span>
<span class="p_del">-	case 1: __get_user_asm_ret(__gu_val, ub, addr, retval); break;	\</span>
<span class="p_del">-	case 2: __get_user_asm_ret(__gu_val, uh, addr, retval); break;	\</span>
<span class="p_del">-	case 4: __get_user_asm_ret(__gu_val, uw, addr, retval); break;	\</span>
<span class="p_del">-	case 8: __get_user_asm_ret(__gu_val, x, addr, retval); break;	\</span>
<span class="p_del">-	default:							\</span>
<span class="p_del">-		if (__get_user_bad())					\</span>
<span class="p_del">-			return retval;					\</span>
<span class="p_del">-	}								\</span>
<span class="p_del">-	data = (__force type) __gu_val;					\</span>
<span class="p_del">-})</span>
<span class="p_del">-</span>
 #define __get_user_asm(x, size, addr, ret)				\
 __asm__ __volatile__(							\
 		&quot;/* Get user asm, inline. */\n&quot;				\
<span class="p_chunk">@@ -214,80 +199,35 @@</span> <span class="p_context"> __asm__ __volatile__(							\</span>
 	       : &quot;=r&quot; (ret), &quot;=r&quot; (x) : &quot;r&quot; (__m(addr)),		\
 		 &quot;i&quot; (-EFAULT))
 
<span class="p_del">-#define __get_user_asm_ret(x, size, addr, retval)			\</span>
<span class="p_del">-if (__builtin_constant_p(retval) &amp;&amp; retval == -EFAULT)			\</span>
<span class="p_del">-	__asm__ __volatile__(						\</span>
<span class="p_del">-		&quot;/* Get user asm ret, inline. */\n&quot;			\</span>
<span class="p_del">-	&quot;1:\t&quot;	&quot;ld&quot;#size &quot;a [%1] %%asi, %0\n\n\t&quot;			\</span>
<span class="p_del">-		&quot;.section __ex_table,\&quot;a\&quot;\n\t&quot;				\</span>
<span class="p_del">-		&quot;.align	4\n\t&quot;						\</span>
<span class="p_del">-		&quot;.word	1b,__ret_efault\n\n\t&quot;				\</span>
<span class="p_del">-		&quot;.previous\n\t&quot;						\</span>
<span class="p_del">-	       : &quot;=r&quot; (x) : &quot;r&quot; (__m(addr)));				\</span>
<span class="p_del">-else									\</span>
<span class="p_del">-	__asm__ __volatile__(						\</span>
<span class="p_del">-		&quot;/* Get user asm ret, inline. */\n&quot;			\</span>
<span class="p_del">-	&quot;1:\t&quot;	&quot;ld&quot;#size &quot;a [%1] %%asi, %0\n\n\t&quot;			\</span>
<span class="p_del">-		&quot;.section .fixup,#alloc,#execinstr\n\t&quot;			\</span>
<span class="p_del">-		&quot;.align	4\n&quot;						\</span>
<span class="p_del">-	&quot;3:\n\t&quot;							\</span>
<span class="p_del">-		&quot;ret\n\t&quot;						\</span>
<span class="p_del">-		&quot; restore %%g0, %2, %%o0\n\n\t&quot;				\</span>
<span class="p_del">-		&quot;.previous\n\t&quot;						\</span>
<span class="p_del">-		&quot;.section __ex_table,\&quot;a\&quot;\n\t&quot;				\</span>
<span class="p_del">-		&quot;.align	4\n\t&quot;						\</span>
<span class="p_del">-		&quot;.word	1b, 3b\n\n\t&quot;					\</span>
<span class="p_del">-		&quot;.previous\n\t&quot;						\</span>
<span class="p_del">-	       : &quot;=r&quot; (x) : &quot;r&quot; (__m(addr)), &quot;i&quot; (retval))</span>
<span class="p_del">-</span>
 int __get_user_bad(void);
 
 unsigned long __must_check ___copy_from_user(void *to,
 					     const void __user *from,
 					     unsigned long size);
<span class="p_del">-unsigned long copy_from_user_fixup(void *to, const void __user *from,</span>
<span class="p_del">-				   unsigned long size);</span>
 static inline unsigned long __must_check
 copy_from_user(void *to, const void __user *from, unsigned long size)
 {
<span class="p_del">-	unsigned long ret = ___copy_from_user(to, from, size);</span>
<span class="p_del">-</span>
<span class="p_del">-	if (unlikely(ret))</span>
<span class="p_del">-		ret = copy_from_user_fixup(to, from, size);</span>
<span class="p_del">-</span>
<span class="p_del">-	return ret;</span>
<span class="p_add">+	return ___copy_from_user(to, from, size);</span>
 }
 #define __copy_from_user copy_from_user
 
 unsigned long __must_check ___copy_to_user(void __user *to,
 					   const void *from,
 					   unsigned long size);
<span class="p_del">-unsigned long copy_to_user_fixup(void __user *to, const void *from,</span>
<span class="p_del">-				 unsigned long size);</span>
 static inline unsigned long __must_check
 copy_to_user(void __user *to, const void *from, unsigned long size)
 {
<span class="p_del">-	unsigned long ret = ___copy_to_user(to, from, size);</span>
<span class="p_del">-</span>
<span class="p_del">-	if (unlikely(ret))</span>
<span class="p_del">-		ret = copy_to_user_fixup(to, from, size);</span>
<span class="p_del">-	return ret;</span>
<span class="p_add">+	return ___copy_to_user(to, from, size);</span>
 }
 #define __copy_to_user copy_to_user
 
 unsigned long __must_check ___copy_in_user(void __user *to,
 					   const void __user *from,
 					   unsigned long size);
<span class="p_del">-unsigned long copy_in_user_fixup(void __user *to, void __user *from,</span>
<span class="p_del">-				 unsigned long size);</span>
 static inline unsigned long __must_check
 copy_in_user(void __user *to, void __user *from, unsigned long size)
 {
<span class="p_del">-	unsigned long ret = ___copy_in_user(to, from, size);</span>
<span class="p_del">-</span>
<span class="p_del">-	if (unlikely(ret))</span>
<span class="p_del">-		ret = copy_in_user_fixup(to, from, size);</span>
<span class="p_del">-	return ret;</span>
<span class="p_add">+	return ___copy_in_user(to, from, size);</span>
 }
 #define __copy_in_user copy_in_user
 
<span class="p_header">diff --git a/arch/sparc/kernel/dtlb_prot.S b/arch/sparc/kernel/dtlb_prot.S</span>
<span class="p_header">index d668ca149e64..4087a62f96b0 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/dtlb_prot.S</span>
<span class="p_header">+++ b/arch/sparc/kernel/dtlb_prot.S</span>
<span class="p_chunk">@@ -25,13 +25,13 @@</span> <span class="p_context"></span>
 
 /* PROT ** ICACHE line 2: More real fault processing */
 	ldxa		[%g4] ASI_DMMU, %g5		! Put tagaccess in %g5
<span class="p_add">+	srlx		%g5, PAGE_SHIFT, %g5</span>
<span class="p_add">+	sllx		%g5, PAGE_SHIFT, %g5		! Clear context ID bits</span>
 	bgu,pn		%xcc, winfix_trampoline		! Yes, perform winfixup
 	 mov		FAULT_CODE_DTLB | FAULT_CODE_WRITE, %g4
 	ba,pt		%xcc, sparc64_realfault_common	! Nope, normal fault
 	 nop
 	nop
<span class="p_del">-	nop</span>
<span class="p_del">-	nop</span>
 
 /* PROT ** ICACHE line 3: Unused...	*/
 	nop
<span class="p_header">diff --git a/arch/sparc/kernel/head_64.S b/arch/sparc/kernel/head_64.S</span>
<span class="p_header">index 51faf92ace00..7eeeb1d5a410 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/head_64.S</span>
<span class="p_header">+++ b/arch/sparc/kernel/head_64.S</span>
<span class="p_chunk">@@ -922,47 +922,11 @@</span> <span class="p_context"> prom_tba:	.xword	0</span>
 tlb_type:	.word	0	/* Must NOT end up in BSS */
 	.section	&quot;.fixup&quot;,#alloc,#execinstr
 
<span class="p_del">-	.globl	__ret_efault, __retl_efault, __ret_one, __retl_one</span>
<span class="p_del">-ENTRY(__ret_efault)</span>
<span class="p_del">-	ret</span>
<span class="p_del">-	 restore %g0, -EFAULT, %o0</span>
<span class="p_del">-ENDPROC(__ret_efault)</span>
<span class="p_del">-</span>
 ENTRY(__retl_efault)
 	retl
 	 mov	-EFAULT, %o0
 ENDPROC(__retl_efault)
 
<span class="p_del">-ENTRY(__retl_one)</span>
<span class="p_del">-	retl</span>
<span class="p_del">-	 mov	1, %o0</span>
<span class="p_del">-ENDPROC(__retl_one)</span>
<span class="p_del">-</span>
<span class="p_del">-ENTRY(__retl_one_fp)</span>
<span class="p_del">-	VISExitHalf</span>
<span class="p_del">-	retl</span>
<span class="p_del">-	 mov	1, %o0</span>
<span class="p_del">-ENDPROC(__retl_one_fp)</span>
<span class="p_del">-</span>
<span class="p_del">-ENTRY(__ret_one_asi)</span>
<span class="p_del">-	wr	%g0, ASI_AIUS, %asi</span>
<span class="p_del">-	ret</span>
<span class="p_del">-	 restore %g0, 1, %o0</span>
<span class="p_del">-ENDPROC(__ret_one_asi)</span>
<span class="p_del">-</span>
<span class="p_del">-ENTRY(__retl_one_asi)</span>
<span class="p_del">-	wr	%g0, ASI_AIUS, %asi</span>
<span class="p_del">-	retl</span>
<span class="p_del">-	 mov	1, %o0</span>
<span class="p_del">-ENDPROC(__retl_one_asi)</span>
<span class="p_del">-</span>
<span class="p_del">-ENTRY(__retl_one_asi_fp)</span>
<span class="p_del">-	wr	%g0, ASI_AIUS, %asi</span>
<span class="p_del">-	VISExitHalf</span>
<span class="p_del">-	retl</span>
<span class="p_del">-	 mov	1, %o0</span>
<span class="p_del">-ENDPROC(__retl_one_asi_fp)</span>
<span class="p_del">-</span>
 ENTRY(__retl_o1)
 	retl
 	 mov	%o1, %o0
<span class="p_header">diff --git a/arch/sparc/kernel/jump_label.c b/arch/sparc/kernel/jump_label.c</span>
<span class="p_header">index 59bbeff55024..07933b9e9ce0 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/jump_label.c</span>
<span class="p_header">+++ b/arch/sparc/kernel/jump_label.c</span>
<span class="p_chunk">@@ -13,19 +13,30 @@</span> <span class="p_context"></span>
 void arch_jump_label_transform(struct jump_entry *entry,
 			       enum jump_label_type type)
 {
<span class="p_del">-	u32 val;</span>
 	u32 *insn = (u32 *) (unsigned long) entry-&gt;code;
<span class="p_add">+	u32 val;</span>
 
 	if (type == JUMP_LABEL_JMP) {
 		s32 off = (s32)entry-&gt;target - (s32)entry-&gt;code;
<span class="p_add">+		bool use_v9_branch = false;</span>
<span class="p_add">+</span>
<span class="p_add">+		BUG_ON(off &amp; 3);</span>
 
 #ifdef CONFIG_SPARC64
<span class="p_del">-		/* ba,pt %xcc, . + (off &lt;&lt; 2) */</span>
<span class="p_del">-		val = 0x10680000 | ((u32) off &gt;&gt; 2);</span>
<span class="p_del">-#else</span>
<span class="p_del">-		/* ba . + (off &lt;&lt; 2) */</span>
<span class="p_del">-		val = 0x10800000 | ((u32) off &gt;&gt; 2);</span>
<span class="p_add">+		if (off &lt;= 0xfffff &amp;&amp; off &gt;= -0x100000)</span>
<span class="p_add">+			use_v9_branch = true;</span>
 #endif
<span class="p_add">+		if (use_v9_branch) {</span>
<span class="p_add">+			/* WDISP19 - target is . + immed &lt;&lt; 2 */</span>
<span class="p_add">+			/* ba,pt %xcc, . + off */</span>
<span class="p_add">+			val = 0x10680000 | (((u32) off &gt;&gt; 2) &amp; 0x7ffff);</span>
<span class="p_add">+		} else {</span>
<span class="p_add">+			/* WDISP22 - target is . + immed &lt;&lt; 2 */</span>
<span class="p_add">+			BUG_ON(off &gt; 0x7fffff);</span>
<span class="p_add">+			BUG_ON(off &lt; -0x800000);</span>
<span class="p_add">+			/* ba . + off */</span>
<span class="p_add">+			val = 0x10800000 | (((u32) off &gt;&gt; 2) &amp; 0x3fffff);</span>
<span class="p_add">+		}</span>
 	} else {
 		val = 0x01000000;
 	}
<span class="p_header">diff --git a/arch/sparc/kernel/ktlb.S b/arch/sparc/kernel/ktlb.S</span>
<span class="p_header">index ef0d8e9e1210..f22bec0db645 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/ktlb.S</span>
<span class="p_header">+++ b/arch/sparc/kernel/ktlb.S</span>
<span class="p_chunk">@@ -20,6 +20,10 @@</span> <span class="p_context"> kvmap_itlb:</span>
 	mov		TLB_TAG_ACCESS, %g4
 	ldxa		[%g4] ASI_IMMU, %g4
 
<span class="p_add">+	/* The kernel executes in context zero, therefore we do not</span>
<span class="p_add">+	 * need to clear the context ID bits out of %g4 here.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+</span>
 	/* sun4v_itlb_miss branches here with the missing virtual
 	 * address already loaded into %g4
 	 */
<span class="p_chunk">@@ -128,6 +132,10 @@</span> <span class="p_context"> kvmap_dtlb:</span>
 	mov		TLB_TAG_ACCESS, %g4
 	ldxa		[%g4] ASI_DMMU, %g4
 
<span class="p_add">+	/* The kernel executes in context zero, therefore we do not</span>
<span class="p_add">+	 * need to clear the context ID bits out of %g4 here.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+</span>
 	/* sun4v_dtlb_miss branches here with the missing virtual
 	 * address already loaded into %g4
 	 */
<span class="p_chunk">@@ -251,6 +259,10 @@</span> <span class="p_context"> kvmap_dtlb_longpath:</span>
 	nop
 	.previous
 
<span class="p_add">+	/* The kernel executes in context zero, therefore we do not</span>
<span class="p_add">+	 * need to clear the context ID bits out of %g5 here.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+</span>
 	be,pt	%xcc, sparc64_realfault_common
 	 mov	FAULT_CODE_DTLB, %g4
 	ba,pt	%xcc, winfix_trampoline
<span class="p_header">diff --git a/arch/sparc/kernel/sparc_ksyms_64.c b/arch/sparc/kernel/sparc_ksyms_64.c</span>
<span class="p_header">index a92d5d2c46a3..51b25325a961 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/sparc_ksyms_64.c</span>
<span class="p_header">+++ b/arch/sparc/kernel/sparc_ksyms_64.c</span>
<span class="p_chunk">@@ -27,7 +27,6 @@</span> <span class="p_context"> EXPORT_SYMBOL(__flushw_user);</span>
 EXPORT_SYMBOL_GPL(real_hard_smp_processor_id);
 
 /* from head_64.S */
<span class="p_del">-EXPORT_SYMBOL(__ret_efault);</span>
 EXPORT_SYMBOL(tlb_type);
 EXPORT_SYMBOL(sun4v_chip_type);
 EXPORT_SYMBOL(prom_root_node);
<span class="p_header">diff --git a/arch/sparc/kernel/tsb.S b/arch/sparc/kernel/tsb.S</span>
<span class="p_header">index be98685c14c6..d568c8207af7 100644</span>
<span class="p_header">--- a/arch/sparc/kernel/tsb.S</span>
<span class="p_header">+++ b/arch/sparc/kernel/tsb.S</span>
<span class="p_chunk">@@ -29,13 +29,17 @@</span> <span class="p_context"></span>
 	 */
 tsb_miss_dtlb:
 	mov		TLB_TAG_ACCESS, %g4
<span class="p_add">+	ldxa		[%g4] ASI_DMMU, %g4</span>
<span class="p_add">+	srlx		%g4, PAGE_SHIFT, %g4</span>
 	ba,pt		%xcc, tsb_miss_page_table_walk
<span class="p_del">-	 ldxa		[%g4] ASI_DMMU, %g4</span>
<span class="p_add">+	 sllx		%g4, PAGE_SHIFT, %g4</span>
 
 tsb_miss_itlb:
 	mov		TLB_TAG_ACCESS, %g4
<span class="p_add">+	ldxa		[%g4] ASI_IMMU, %g4</span>
<span class="p_add">+	srlx		%g4, PAGE_SHIFT, %g4</span>
 	ba,pt		%xcc, tsb_miss_page_table_walk
<span class="p_del">-	 ldxa		[%g4] ASI_IMMU, %g4</span>
<span class="p_add">+	 sllx		%g4, PAGE_SHIFT, %g4</span>
 
 	/* At this point we have:
 	 * %g1 --	PAGE_SIZE TSB entry address
<span class="p_chunk">@@ -284,6 +288,10 @@</span> <span class="p_context"> tsb_do_dtlb_fault:</span>
 	nop
 	.previous
 
<span class="p_add">+	/* Clear context ID bits.  */</span>
<span class="p_add">+	srlx		%g5, PAGE_SHIFT, %g5</span>
<span class="p_add">+	sllx		%g5, PAGE_SHIFT, %g5</span>
<span class="p_add">+</span>
 	be,pt	%xcc, sparc64_realfault_common
 	 mov	FAULT_CODE_DTLB, %g4
 	ba,pt	%xcc, winfix_trampoline
<span class="p_header">diff --git a/arch/sparc/lib/GENcopy_from_user.S b/arch/sparc/lib/GENcopy_from_user.S</span>
<span class="p_header">index b7d0bd6b1406..69a439fa2fc1 100644</span>
<span class="p_header">--- a/arch/sparc/lib/GENcopy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/GENcopy_from_user.S</span>
<span class="p_chunk">@@ -3,11 +3,11 @@</span> <span class="p_context"></span>
  * Copyright (C) 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/GENcopy_to_user.S b/arch/sparc/lib/GENcopy_to_user.S</span>
<span class="p_header">index 780550e1afc7..9947427ce354 100644</span>
<span class="p_header">--- a/arch/sparc/lib/GENcopy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/GENcopy_to_user.S</span>
<span class="p_chunk">@@ -3,11 +3,11 @@</span> <span class="p_context"></span>
  * Copyright (C) 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/GENmemcpy.S b/arch/sparc/lib/GENmemcpy.S</span>
<span class="p_header">index 89358ee94851..059ea24ad73d 100644</span>
<span class="p_header">--- a/arch/sparc/lib/GENmemcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/GENmemcpy.S</span>
<span class="p_chunk">@@ -4,21 +4,18 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #define GLOBAL_SPARE	%g7
 #else
 #define GLOBAL_SPARE	%g5
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 
 #ifndef LOAD
<span class="p_chunk">@@ -45,6 +42,29 @@</span> <span class="p_context"></span>
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+</span>
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+ENTRY(GEN_retl_o4_1)</span>
<span class="p_add">+	add	%o4, %o2, %o4</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o4, 1, %o0</span>
<span class="p_add">+ENDPROC(GEN_retl_o4_1)</span>
<span class="p_add">+ENTRY(GEN_retl_g1_8)</span>
<span class="p_add">+	add	%g1, %o2, %g1</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%g1, 8, %o0</span>
<span class="p_add">+ENDPROC(GEN_retl_g1_8)</span>
<span class="p_add">+ENTRY(GEN_retl_o2_4)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 4, %o0</span>
<span class="p_add">+ENDPROC(GEN_retl_o2_4)</span>
<span class="p_add">+ENTRY(GEN_retl_o2_1)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(GEN_retl_o2_1)</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 	.align		64
 
 	.globl	FUNC_NAME
<span class="p_chunk">@@ -73,8 +93,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	sub		%g0, %o4, %o4
 	sub		%o2, %o4, %o2
 1:	subcc		%o4, 1, %o4
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %g1),GEN_retl_o4_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o0),GEN_retl_o4_1)</span>
 	add		%o1, 1, %o1
 	bne,pt		%XCC, 1b
 	add		%o0, 1, %o0
<span class="p_chunk">@@ -82,8 +102,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	andn		%o2, 0x7, %g1
 	sub		%o2, %g1, %o2
 1:	subcc		%g1, 0x8, %g1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g2))</span>
<span class="p_del">-	EX_ST(STORE(stx, %g2, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g2),GEN_retl_g1_8)</span>
<span class="p_add">+	EX_ST(STORE(stx, %g2, %o0),GEN_retl_g1_8)</span>
 	add		%o1, 0x8, %o1
 	bne,pt		%XCC, 1b
 	 add		%o0, 0x8, %o0
<span class="p_chunk">@@ -100,8 +120,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 1:
 	subcc		%o2, 4, %o2
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stw, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %g1),GEN_retl_o2_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %g1, %o1 + %o3),GEN_retl_o2_4)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 4, %o1
 
<span class="p_chunk">@@ -111,8 +131,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	.align		32
 90:
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %g1),GEN_retl_o2_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o1 + %o3),GEN_retl_o2_1)</span>
 	bgu,pt		%XCC, 90b
 	 add		%o1, 1, %o1
 	retl
<span class="p_header">diff --git a/arch/sparc/lib/Makefile b/arch/sparc/lib/Makefile</span>
<span class="p_header">index 3269b0234093..4f2384a4286a 100644</span>
<span class="p_header">--- a/arch/sparc/lib/Makefile</span>
<span class="p_header">+++ b/arch/sparc/lib/Makefile</span>
<span class="p_chunk">@@ -38,7 +38,7 @@</span> <span class="p_context"> lib-$(CONFIG_SPARC64) +=  NG4patch.o NG4copy_page.o NG4clear_page.o NG4memset.o</span>
 lib-$(CONFIG_SPARC64) += GENmemcpy.o GENcopy_from_user.o GENcopy_to_user.o
 lib-$(CONFIG_SPARC64) += GENpatch.o GENpage.o GENbzero.o
 
<span class="p_del">-lib-$(CONFIG_SPARC64) += copy_in_user.o user_fixup.o memmove.o</span>
<span class="p_add">+lib-$(CONFIG_SPARC64) += copy_in_user.o memmove.o</span>
 lib-$(CONFIG_SPARC64) += mcount.o ipcsum.o xor.o hweight.o ffs.o
 
 obj-$(CONFIG_SPARC64) += iomap.o
<span class="p_header">diff --git a/arch/sparc/lib/NG2copy_from_user.S b/arch/sparc/lib/NG2copy_from_user.S</span>
<span class="p_header">index d5242b8c4f94..b79a6998d87c 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG2copy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG2copy_from_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_LD_FP(x)		\</span>
<span class="p_add">+#define EX_LD_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NG2copy_to_user.S b/arch/sparc/lib/NG2copy_to_user.S</span>
<span class="p_header">index 4e962d993b10..dcec55f254ab 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG2copy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG2copy_to_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_ST_FP(x)		\</span>
<span class="p_add">+#define EX_ST_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NG2memcpy.S b/arch/sparc/lib/NG2memcpy.S</span>
<span class="p_header">index d5f585df2f3f..c629dbd121b6 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG2memcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG2memcpy.S</span>
<span class="p_chunk">@@ -4,6 +4,7 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #include &lt;asm/visasm.h&gt;
 #include &lt;asm/asi.h&gt;
 #define GLOBAL_SPARE	%g7
<span class="p_chunk">@@ -32,21 +33,17 @@</span> <span class="p_context"></span>
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 #ifndef EX_LD_FP
<span class="p_del">-#define EX_LD_FP(x)	x</span>
<span class="p_add">+#define EX_LD_FP(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 #ifndef EX_ST_FP
<span class="p_del">-#define EX_ST_FP(x)	x</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_add">+#define EX_ST_FP(x,y)	x</span>
 #endif
 
 #ifndef LOAD
<span class="p_chunk">@@ -140,45 +137,110 @@</span> <span class="p_context"></span>
 	fsrc2		%x6, %f12; \
 	fsrc2		%x7, %f14;
 #define FREG_LOAD_1(base, x0) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1)</span>
 #define FREG_LOAD_2(base, x0, x1) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1);</span>
 #define FREG_LOAD_3(base, x0, x1, x2) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x10, %x2));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x10, %x2), NG2_retl_o2_plus_g1);</span>
 #define FREG_LOAD_4(base, x0, x1, x2, x3) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x10, %x2)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x18, %x3));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x10, %x2), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x18, %x3), NG2_retl_o2_plus_g1);</span>
 #define FREG_LOAD_5(base, x0, x1, x2, x3, x4) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x10, %x2)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x18, %x3)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x20, %x4));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x10, %x2), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x18, %x3), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x20, %x4), NG2_retl_o2_plus_g1);</span>
 #define FREG_LOAD_6(base, x0, x1, x2, x3, x4, x5) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x10, %x2)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x18, %x3)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x20, %x4)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x28, %x5));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x10, %x2), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x18, %x3), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x20, %x4), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x28, %x5), NG2_retl_o2_plus_g1);</span>
 #define FREG_LOAD_7(base, x0, x1, x2, x3, x4, x5, x6) \
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x00, %x0)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x08, %x1)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x10, %x2)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x18, %x3)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x20, %x4)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x28, %x5)); \</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, base + 0x30, %x6));</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x00, %x0), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x08, %x1), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x10, %x2), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x18, %x3), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x20, %x4), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x28, %x5), NG2_retl_o2_plus_g1); \</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, base + 0x30, %x6), NG2_retl_o2_plus_g1);</span>
 
 	.register	%g2,#scratch
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+__restore_fp:</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+__restore_asi:</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 wr	%g0, ASI_AIUS, %asi</span>
<span class="p_add">+ENTRY(NG2_retl_o2)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 mov	%o2, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_1)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_4)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, 4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_4)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_8)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, 8, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_8)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_o4_plus_1)</span>
<span class="p_add">+	add	%o4, 1, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_o4_plus_1)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_o4_plus_8)</span>
<span class="p_add">+	add	%o4, 8, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_o4_plus_8)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_o4_plus_16)</span>
<span class="p_add">+	add	%o4, 16, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_o4_plus_16)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_g1_fp)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_g1_fp)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_g1_plus_64_fp)</span>
<span class="p_add">+	add	%g1, 64, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_g1_plus_64_fp)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+	add	%g1, 1, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_and_7_plus_o4)</span>
<span class="p_add">+	and	%o2, 7, %o2</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_and_7_plus_o4)</span>
<span class="p_add">+ENTRY(NG2_retl_o2_and_7_plus_o4_plus_8)</span>
<span class="p_add">+	and	%o2, 7, %o2</span>
<span class="p_add">+	add	%o4, 8, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG2_retl_o2_and_7_plus_o4_plus_8)</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 	.align		64
 
 	.globl	FUNC_NAME
<span class="p_chunk">@@ -230,8 +292,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	sub		%g0, %o4, %o4	! bytes to align dst
 	sub		%o2, %o4, %o2
 1:	subcc		%o4, 1, %o4
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %g1), NG2_retl_o2_plus_o4_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o0), NG2_retl_o2_plus_o4_plus_1)</span>
 	add		%o1, 1, %o1
 	bne,pt		%XCC, 1b
 	add		%o0, 1, %o0
<span class="p_chunk">@@ -281,11 +343,11 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	 nop
 	/* fall through for 0 &lt; low bits &lt; 8 */
 110:	sub		%o4, 64, %g2
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%g2, %f0))</span>
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%g2, %f0), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f6, f8, f10, f12, f14, f16)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_8(f16, f18, f20, f22, f24, f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -296,10 +358,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 120:	sub		%o4, 56, %g2
 	FREG_LOAD_7(%g2, f0, f2, f4, f6, f8, f10, f12)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f6, f8, f10, f12, f16, f18)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_7(f18, f20, f22, f24, f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -310,10 +372,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 130:	sub		%o4, 48, %g2
 	FREG_LOAD_6(%g2, f0, f2, f4, f6, f8, f10)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f6, f8, f10, f16, f18, f20)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_6(f20, f22, f24, f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -324,10 +386,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 140:	sub		%o4, 40, %g2
 	FREG_LOAD_5(%g2, f0, f2, f4, f6, f8)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f6, f8, f16, f18, f20, f22)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_5(f22, f24, f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -338,10 +400,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 150:	sub		%o4, 32, %g2
 	FREG_LOAD_4(%g2, f0, f2, f4, f6)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f6, f16, f18, f20, f22, f24)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_4(f24, f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -352,10 +414,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 160:	sub		%o4, 24, %g2
 	FREG_LOAD_3(%g2, f0, f2, f4)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f4, f16, f18, f20, f22, f24, f26)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_3(f26, f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -366,10 +428,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 170:	sub		%o4, 16, %g2
 	FREG_LOAD_2(%g2, f0, f2)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f2, f16, f18, f20, f22, f24, f26, f28)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_2(f28, f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -380,10 +442,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 180:	sub		%o4, 8, %g2
 	FREG_LOAD_1(%g2, f0)
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f16))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f16), NG2_retl_o2_plus_g1)</span>
 	FREG_FROB(f0, f16, f18, f20, f22, f24, f26, f28, f30)
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	FREG_MOVE_1(f30)
 	subcc		%g1, 64, %g1
 	add		%o4, 64, %o4
<span class="p_chunk">@@ -393,10 +455,10 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	 nop
 
 190:
<span class="p_del">-1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3))</span>
<span class="p_add">+1:	EX_ST_FP(STORE_INIT(%g0, %o4 + %g3), NG2_retl_o2_plus_g1)</span>
 	subcc		%g1, 64, %g1
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o4, %f0))</span>
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3))</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o4, %f0), NG2_retl_o2_plus_g1_plus_64)</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f0, %o4 + %g3), NG2_retl_o2_plus_g1_plus_64)</span>
 	add		%o4, 64, %o4
 	bne,pt		%xcc, 1b
 	 LOAD(prefetch, %o4 + 64, #one_read)
<span class="p_chunk">@@ -423,28 +485,28 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	andn		%o2, 0xf, %o4
 	and		%o2, 0xf, %o2
 1:	subcc		%o4, 0x10, %o4
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %o5))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %o5), NG2_retl_o2_plus_o4_plus_16)</span>
 	add		%o1, 0x08, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g1))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g1), NG2_retl_o2_plus_o4_plus_16)</span>
 	sub		%o1, 0x08, %o1
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_o4_plus_16)</span>
 	add		%o1, 0x8, %o1
<span class="p_del">-	EX_ST(STORE(stx, %g1, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_ST(STORE(stx, %g1, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_o4_plus_8)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 0x8, %o1
 73:	andcc		%o2, 0x8, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%o2, 0x8, %o2
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %o5), NG2_retl_o2_plus_8)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_8)</span>
 	add		%o1, 0x8, %o1
 1:	andcc		%o2, 0x4, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%o2, 0x4, %o2
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stw, %o5, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %o5), NG2_retl_o2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %o5, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_4)</span>
 	add		%o1, 0x4, %o1
 1:	cmp		%o2, 0
 	be,pt		%XCC, 85f
<span class="p_chunk">@@ -460,8 +522,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	sub		%o2, %g1, %o2
 
 1:	subcc		%g1, 1, %g1
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stb, %o5, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %o5), NG2_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %o5, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_g1_plus_1)</span>
 	bgu,pt		%icc, 1b
 	 add		%o1, 1, %o1
 
<span class="p_chunk">@@ -477,16 +539,16 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 8:	mov		64, GLOBAL_SPARE
 	andn		%o1, 0x7, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g2))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g2), NG2_retl_o2)</span>
 	sub		GLOBAL_SPARE, %g1, GLOBAL_SPARE
 	andn		%o2, 0x7, %o4
 	sllx		%g2, %g1, %g2
 1:	add		%o1, 0x8, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g3), NG2_retl_o2_and_7_plus_o4)</span>
 	subcc		%o4, 0x8, %o4
 	srlx		%g3, GLOBAL_SPARE, %o5
 	or		%o5, %g2, %o5
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o0))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o0), NG2_retl_o2_and_7_plus_o4_plus_8)</span>
 	add		%o0, 0x8, %o0
 	bgu,pt		%icc, 1b
 	 sllx		%g3, %g1, %g2
<span class="p_chunk">@@ -506,8 +568,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 1:
 	subcc		%o2, 4, %o2
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stw, %g1, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %g1), NG2_retl_o2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %g1, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_4)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 4, %o1
 
<span class="p_chunk">@@ -517,8 +579,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	.align		32
 90:
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %g1), NG2_retl_o2_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o1 + GLOBAL_SPARE), NG2_retl_o2_plus_1)</span>
 	bgu,pt		%XCC, 90b
 	 add		%o1, 1, %o1
 	retl
<span class="p_header">diff --git a/arch/sparc/lib/NG4copy_from_user.S b/arch/sparc/lib/NG4copy_from_user.S</span>
<span class="p_header">index 2e8ee7ad07a9..16a286c1a528 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG4copy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG4copy_from_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 2012 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x, y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_LD_FP(x)		\</span>
<span class="p_add">+#define EX_LD_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NG4copy_to_user.S b/arch/sparc/lib/NG4copy_to_user.S</span>
<span class="p_header">index be0bf4590df8..6b0276ffc858 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG4copy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG4copy_to_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 2012 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_ST_FP(x)		\</span>
<span class="p_add">+#define EX_ST_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_asi_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NG4memcpy.S b/arch/sparc/lib/NG4memcpy.S</span>
<span class="p_header">index 8e13ee1f4454..75bb93b1437f 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NG4memcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NG4memcpy.S</span>
<span class="p_chunk">@@ -4,6 +4,7 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #include &lt;asm/visasm.h&gt;
 #include &lt;asm/asi.h&gt;
 #define GLOBAL_SPARE	%g7
<span class="p_chunk">@@ -46,22 +47,19 @@</span> <span class="p_context"></span>
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 #ifndef EX_LD_FP
<span class="p_del">-#define EX_LD_FP(x)	x</span>
<span class="p_add">+#define EX_LD_FP(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 #ifndef EX_ST_FP
<span class="p_del">-#define EX_ST_FP(x)	x</span>
<span class="p_add">+#define EX_ST_FP(x,y)	x</span>
 #endif
 
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_del">-#endif</span>
 
 #ifndef LOAD
 #define LOAD(type,addr,dest)	type [addr], dest
<span class="p_chunk">@@ -94,6 +92,158 @@</span> <span class="p_context"></span>
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+__restore_asi_fp:</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+__restore_asi:</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 wr	%g0, ASI_AIUS, %asi</span>
<span class="p_add">+</span>
<span class="p_add">+ENTRY(NG4_retl_o2)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 mov	%o2, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_1)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_4)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, 4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_4)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5_plus_4)</span>
<span class="p_add">+	add	%o5, 4, %o5</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5_plus_4)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5_plus_8)</span>
<span class="p_add">+	add	%o5, 8, %o5</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5_plus_8)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5_plus_16)</span>
<span class="p_add">+	add	%o5, 16, %o5</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5_plus_16)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5_plus_24)</span>
<span class="p_add">+	add	%o5, 24, %o5</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5_plus_24)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o5_plus_32)</span>
<span class="p_add">+	add	%o5, 32, %o5</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o5, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o5_plus_32)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_g1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_g1)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+	add	%g1, 1, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_g1_plus_8)</span>
<span class="p_add">+	add	%g1, 8, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_g1_plus_8)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_8)</span>
<span class="p_add">+	add	%o4, 8, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_8)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_16)</span>
<span class="p_add">+	add	%o4, 16, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_16)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_24)</span>
<span class="p_add">+	add	%o4, 24, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_24)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_32)</span>
<span class="p_add">+	add	%o4, 32, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_32)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_40)</span>
<span class="p_add">+	add	%o4, 40, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_40)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_48)</span>
<span class="p_add">+	add	%o4, 48, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_48)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_56)</span>
<span class="p_add">+	add	%o4, 56, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_56)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	add	%o4, 64, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_fp)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_8_fp)</span>
<span class="p_add">+	add	%o4, 8, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_8_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_16_fp)</span>
<span class="p_add">+	add	%o4, 16, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_16_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_24_fp)</span>
<span class="p_add">+	add	%o4, 24, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_24_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_32_fp)</span>
<span class="p_add">+	add	%o4, 32, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_32_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_40_fp)</span>
<span class="p_add">+	add	%o4, 40, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_40_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_48_fp)</span>
<span class="p_add">+	add	%o4, 48, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_48_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_56_fp)</span>
<span class="p_add">+	add	%o4, 56, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_56_fp)</span>
<span class="p_add">+ENTRY(NG4_retl_o2_plus_o4_plus_64_fp)</span>
<span class="p_add">+	add	%o4, 64, %o4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi_fp</span>
<span class="p_add">+	 add	%o2, %o4, %o0</span>
<span class="p_add">+ENDPROC(NG4_retl_o2_plus_o4_plus_64_fp)</span>
<span class="p_add">+#endif</span>
 	.align		64
 
 	.globl	FUNC_NAME
<span class="p_chunk">@@ -124,12 +274,13 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	brz,pt		%g1, 51f
 	 sub		%o2, %g1, %o2
 
<span class="p_del">-1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g2))</span>
<span class="p_add">+</span>
<span class="p_add">+1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g2), NG4_retl_o2_plus_g1)</span>
 	add		%o1, 1, %o1
 	subcc		%g1, 1, %g1
 	add		%o0, 1, %o0
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stb, %g2, %o0 - 0x01))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g2, %o0 - 0x01), NG4_retl_o2_plus_g1_plus_1)</span>
 
 51:	LOAD(prefetch, %o1 + 0x040, #n_reads_strong)
 	LOAD(prefetch, %o1 + 0x080, #n_reads_strong)
<span class="p_chunk">@@ -154,43 +305,43 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	brz,pt		%g1, .Llarge_aligned
 	 sub		%o2, %g1, %o2
 
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g2))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g2), NG4_retl_o2_plus_g1)</span>
 	add		%o1, 8, %o1
 	subcc		%g1, 8, %g1
 	add		%o0, 8, %o0
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stx, %g2, %o0 - 0x08))</span>
<span class="p_add">+	 EX_ST(STORE(stx, %g2, %o0 - 0x08), NG4_retl_o2_plus_g1_plus_8)</span>
 
 .Llarge_aligned:
 	/* len &gt;= 0x80 &amp;&amp; src 8-byte aligned &amp;&amp; dest 8-byte aligned */
 	andn		%o2, 0x3f, %o4
 	sub		%o2, %o4, %o2
 
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1), NG4_retl_o2_plus_o4)</span>
 	add		%o1, 0x40, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x38, %g2))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x38, %g2), NG4_retl_o2_plus_o4)</span>
 	subcc		%o4, 0x40, %o4
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x30, %g3))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x28, GLOBAL_SPARE))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x20, %o5))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g1, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x30, %g3), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x28, GLOBAL_SPARE), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x20, %o5), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g1, %o0), NG4_retl_o2_plus_o4_plus_64)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0), NG4_retl_o2_plus_o4_plus_56)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x18, %g2))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x18, %g2), NG4_retl_o2_plus_o4_plus_48)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0), NG4_retl_o2_plus_o4_plus_48)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x10, %g3))</span>
<span class="p_del">-	EX_ST(STORE_INIT(GLOBAL_SPARE, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x10, %g3), NG4_retl_o2_plus_o4_plus_40)</span>
<span class="p_add">+	EX_ST(STORE_INIT(GLOBAL_SPARE, %o0), NG4_retl_o2_plus_o4_plus_40)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 - 0x08, GLOBAL_SPARE))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o5, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 - 0x08, GLOBAL_SPARE), NG4_retl_o2_plus_o4_plus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o5, %o0), NG4_retl_o2_plus_o4_plus_32)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0), NG4_retl_o2_plus_o4_plus_24)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0), NG4_retl_o2_plus_o4_plus_16)</span>
 	add		%o0, 0x08, %o0
<span class="p_del">-	EX_ST(STORE_INIT(GLOBAL_SPARE, %o0))</span>
<span class="p_add">+	EX_ST(STORE_INIT(GLOBAL_SPARE, %o0), NG4_retl_o2_plus_o4_plus_8)</span>
 	add		%o0, 0x08, %o0
 	bne,pt		%icc, 1b
 	 LOAD(prefetch, %o1 + 0x200, #n_reads_strong)
<span class="p_chunk">@@ -216,17 +367,17 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	sub		%o2, %o4, %o2
 	alignaddr	%o1, %g0, %g1
 	add		%o1, %o4, %o1
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x00, %f0))</span>
<span class="p_del">-1:	EX_LD_FP(LOAD(ldd, %g1 + 0x08, %f2))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x00, %f0), NG4_retl_o2_plus_o4)</span>
<span class="p_add">+1:	EX_LD_FP(LOAD(ldd, %g1 + 0x08, %f2), NG4_retl_o2_plus_o4)</span>
 	subcc		%o4, 0x40, %o4
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x10, %f4))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x18, %f6))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x20, %f8))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x28, %f10))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x30, %f12))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x38, %f14))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x10, %f4), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x18, %f6), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x20, %f8), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x28, %f10), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x30, %f12), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x38, %f14), NG4_retl_o2_plus_o4_plus_64)</span>
 	faligndata	%f0, %f2, %f16
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %g1 + 0x40, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %g1 + 0x40, %f0), NG4_retl_o2_plus_o4_plus_64)</span>
 	faligndata	%f2, %f4, %f18
 	add		%g1, 0x40, %g1
 	faligndata	%f4, %f6, %f20
<span class="p_chunk">@@ -235,14 +386,14 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	faligndata	%f10, %f12, %f26
 	faligndata	%f12, %f14, %f28
 	faligndata	%f14, %f0, %f30
<span class="p_del">-	EX_ST_FP(STORE(std, %f16, %o0 + 0x00))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f18, %o0 + 0x08))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f20, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f22, %o0 + 0x18))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f24, %o0 + 0x20))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f26, %o0 + 0x28))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f28, %o0 + 0x30))</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f30, %o0 + 0x38))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f16, %o0 + 0x00), NG4_retl_o2_plus_o4_plus_64)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f18, %o0 + 0x08), NG4_retl_o2_plus_o4_plus_56)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f20, %o0 + 0x10), NG4_retl_o2_plus_o4_plus_48)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f22, %o0 + 0x18), NG4_retl_o2_plus_o4_plus_40)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f24, %o0 + 0x20), NG4_retl_o2_plus_o4_plus_32)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f26, %o0 + 0x28), NG4_retl_o2_plus_o4_plus_24)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f28, %o0 + 0x30), NG4_retl_o2_plus_o4_plus_16)</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f30, %o0 + 0x38), NG4_retl_o2_plus_o4_plus_8)</span>
 	add		%o0, 0x40, %o0
 	bne,pt		%icc, 1b
 	 LOAD(prefetch, %g1 + 0x200, #n_reads_strong)
<span class="p_chunk">@@ -270,37 +421,38 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	andncc		%o2, 0x20 - 1, %o5
 	be,pn		%icc, 2f
 	 sub		%o2, %o5, %o2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x08, %g2))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x10, GLOBAL_SPARE))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x18, %o4))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1), NG4_retl_o2_plus_o5)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x08, %g2), NG4_retl_o2_plus_o5)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x10, GLOBAL_SPARE), NG4_retl_o2_plus_o5)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x18, %o4), NG4_retl_o2_plus_o5)</span>
 	add		%o1, 0x20, %o1
 	subcc		%o5, 0x20, %o5
<span class="p_del">-	EX_ST(STORE(stx, %g1, %o0 + 0x00))</span>
<span class="p_del">-	EX_ST(STORE(stx, %g2, %o0 + 0x08))</span>
<span class="p_del">-	EX_ST(STORE(stx, GLOBAL_SPARE, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o4, %o0 + 0x18))</span>
<span class="p_add">+	EX_ST(STORE(stx, %g1, %o0 + 0x00), NG4_retl_o2_plus_o5_plus_32)</span>
<span class="p_add">+	EX_ST(STORE(stx, %g2, %o0 + 0x08), NG4_retl_o2_plus_o5_plus_24)</span>
<span class="p_add">+	EX_ST(STORE(stx, GLOBAL_SPARE, %o0 + 0x10), NG4_retl_o2_plus_o5_plus_24)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o4, %o0 + 0x18), NG4_retl_o2_plus_o5_plus_8)</span>
 	bne,pt		%icc, 1b
 	 add		%o0, 0x20, %o0
 2:	andcc		%o2, 0x18, %o5
 	be,pt		%icc, 3f
 	 sub		%o2, %o5, %o2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1))</span>
<span class="p_add">+</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x00, %g1), NG4_retl_o2_plus_o5)</span>
 	add		%o1, 0x08, %o1
 	add		%o0, 0x08, %o0
 	subcc		%o5, 0x08, %o5
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stx, %g1, %o0 - 0x08))</span>
<span class="p_add">+	 EX_ST(STORE(stx, %g1, %o0 - 0x08), NG4_retl_o2_plus_o5_plus_8)</span>
 3:	brz,pt		%o2, .Lexit
 	 cmp		%o2, 0x04
 	bl,pn		%icc, .Ltiny
 	 nop
<span class="p_del">-	EX_LD(LOAD(lduw, %o1 + 0x00, %g1))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1 + 0x00, %g1), NG4_retl_o2)</span>
 	add		%o1, 0x04, %o1
 	add		%o0, 0x04, %o0
 	subcc		%o2, 0x04, %o2
 	bne,pn		%icc, .Ltiny
<span class="p_del">-	 EX_ST(STORE(stw, %g1, %o0 - 0x04))</span>
<span class="p_add">+	 EX_ST(STORE(stw, %g1, %o0 - 0x04), NG4_retl_o2_plus_4)</span>
 	ba,a,pt		%icc, .Lexit
 .Lmedium_unaligned:
 	/* First get dest 8 byte aligned.  */
<span class="p_chunk">@@ -309,12 +461,12 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	brz,pt		%g1, 2f
 	 sub		%o2, %g1, %o2
 
<span class="p_del">-1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g2))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g2), NG4_retl_o2_plus_g1)</span>
 	add		%o1, 1, %o1
 	subcc		%g1, 1, %g1
 	add		%o0, 1, %o0
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stb, %g2, %o0 - 0x01))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g2, %o0 - 0x01), NG4_retl_o2_plus_g1_plus_1)</span>
 2:
 	and		%o1, 0x7, %g1
 	brz,pn		%g1, .Lmedium_noprefetch
<span class="p_chunk">@@ -322,16 +474,16 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	mov		64, %g2
 	sub		%g2, %g1, %g2
 	andn		%o1, 0x7, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x00, %o4))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x00, %o4), NG4_retl_o2)</span>
 	sllx		%o4, %g1, %o4
 	andn		%o2, 0x08 - 1, %o5
 	sub		%o2, %o5, %o2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x08, %g3))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x08, %g3), NG4_retl_o2_plus_o5)</span>
 	add		%o1, 0x08, %o1
 	subcc		%o5, 0x08, %o5
 	srlx		%g3, %g2, GLOBAL_SPARE
 	or		GLOBAL_SPARE, %o4, GLOBAL_SPARE
<span class="p_del">-	EX_ST(STORE(stx, GLOBAL_SPARE, %o0 + 0x00))</span>
<span class="p_add">+	EX_ST(STORE(stx, GLOBAL_SPARE, %o0 + 0x00), NG4_retl_o2_plus_o5_plus_8)</span>
 	add		%o0, 0x08, %o0
 	bne,pt		%icc, 1b
 	 sllx		%g3, %g1, %o4
<span class="p_chunk">@@ -342,17 +494,17 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	ba,pt		%icc, .Lsmall_unaligned
 
 .Ltiny:
<span class="p_del">-	EX_LD(LOAD(ldub, %o1 + 0x00, %g1))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1 + 0x00, %g1), NG4_retl_o2)</span>
 	subcc		%o2, 1, %o2
 	be,pn		%icc, .Lexit
<span class="p_del">-	 EX_ST(STORE(stb, %g1, %o0 + 0x00))</span>
<span class="p_del">-	EX_LD(LOAD(ldub, %o1 + 0x01, %g1))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g1, %o0 + 0x00), NG4_retl_o2_plus_1)</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1 + 0x01, %g1), NG4_retl_o2)</span>
 	subcc		%o2, 1, %o2
 	be,pn		%icc, .Lexit
<span class="p_del">-	 EX_ST(STORE(stb, %g1, %o0 + 0x01))</span>
<span class="p_del">-	EX_LD(LOAD(ldub, %o1 + 0x02, %g1))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g1, %o0 + 0x01), NG4_retl_o2_plus_1)</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1 + 0x02, %g1), NG4_retl_o2)</span>
 	ba,pt		%icc, .Lexit
<span class="p_del">-	 EX_ST(STORE(stb, %g1, %o0 + 0x02))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g1, %o0 + 0x02), NG4_retl_o2)</span>
 
 .Lsmall:
 	andcc		%g2, 0x3, %g0
<span class="p_chunk">@@ -360,22 +512,22 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	 andn		%o2, 0x4 - 1, %o5
 	sub		%o2, %o5, %o2
 1:
<span class="p_del">-	EX_LD(LOAD(lduw, %o1 + 0x00, %g1))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1 + 0x00, %g1), NG4_retl_o2_plus_o5)</span>
 	add		%o1, 0x04, %o1
 	subcc		%o5, 0x04, %o5
 	add		%o0, 0x04, %o0
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stw, %g1, %o0 - 0x04))</span>
<span class="p_add">+	 EX_ST(STORE(stw, %g1, %o0 - 0x04), NG4_retl_o2_plus_o5_plus_4)</span>
 	brz,pt		%o2, .Lexit
 	 nop
 	ba,a,pt		%icc, .Ltiny
 
 .Lsmall_unaligned:
<span class="p_del">-1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g1))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldub, %o1 + 0x00, %g1), NG4_retl_o2)</span>
 	add		%o1, 1, %o1
 	add		%o0, 1, %o0
 	subcc		%o2, 1, %o2
 	bne,pt		%icc, 1b
<span class="p_del">-	 EX_ST(STORE(stb, %g1, %o0 - 0x01))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %g1, %o0 - 0x01), NG4_retl_o2_plus_1)</span>
 	ba,a,pt		%icc, .Lexit
 	.size		FUNC_NAME, .-FUNC_NAME
<span class="p_header">diff --git a/arch/sparc/lib/NGcopy_from_user.S b/arch/sparc/lib/NGcopy_from_user.S</span>
<span class="p_header">index 5d1e4d1ac21e..9cd42fcbc781 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NGcopy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NGcopy_from_user.S</span>
<span class="p_chunk">@@ -3,11 +3,11 @@</span> <span class="p_context"></span>
  * Copyright (C) 2006, 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __ret_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NGcopy_to_user.S b/arch/sparc/lib/NGcopy_to_user.S</span>
<span class="p_header">index ff630dcb273c..5c358afd464e 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NGcopy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NGcopy_to_user.S</span>
<span class="p_chunk">@@ -3,11 +3,11 @@</span> <span class="p_context"></span>
  * Copyright (C) 2006, 2007 David S. Miller (davem@davemloft.net)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __ret_one_asi;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/NGmemcpy.S b/arch/sparc/lib/NGmemcpy.S</span>
<span class="p_header">index 96a14caf6966..d88c4ed50a00 100644</span>
<span class="p_header">--- a/arch/sparc/lib/NGmemcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/NGmemcpy.S</span>
<span class="p_chunk">@@ -4,6 +4,7 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #include &lt;asm/asi.h&gt;
 #include &lt;asm/thread_info.h&gt;
 #define GLOBAL_SPARE	%g7
<span class="p_chunk">@@ -27,15 +28,11 @@</span> <span class="p_context"></span>
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 
 #ifndef LOAD
<span class="p_chunk">@@ -79,6 +76,92 @@</span> <span class="p_context"></span>
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+__restore_asi:</span>
<span class="p_add">+	ret</span>
<span class="p_add">+	wr	%g0, ASI_AIUS, %asi</span>
<span class="p_add">+	 restore</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_i4_plus_1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %i5, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_i4_plus_1)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_8)</span>
<span class="p_add">+	sub	%g1, 8, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_8)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	sub	%g1, 16, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_24)</span>
<span class="p_add">+	sub	%g1, 24, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_24)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	sub	%g1, 32, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_40)</span>
<span class="p_add">+	sub	%g1, 40, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_40)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+	sub	%g1, 48, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_minus_56)</span>
<span class="p_add">+	sub	%g1, 56, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_minus_56)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_i4)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %i4, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_i4)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_i4_minus_8)</span>
<span class="p_add">+	sub	%i4, 8, %i4</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %i4, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_i4_minus_8)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_8)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, 8, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_8)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_4)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, 4, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_4)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_1)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, 1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_1)</span>
<span class="p_add">+ENTRY(NG_ret_i2_plus_g1_plus_1)</span>
<span class="p_add">+	add	%g1, 1, %g1</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %g1, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_plus_g1_plus_1)</span>
<span class="p_add">+ENTRY(NG_ret_i2)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 mov	%i2, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2)</span>
<span class="p_add">+ENTRY(NG_ret_i2_and_7_plus_i4)</span>
<span class="p_add">+	and	%i2, 7, %i2</span>
<span class="p_add">+	ba,pt	%xcc, __restore_asi</span>
<span class="p_add">+	 add	%i2, %i4, %i0</span>
<span class="p_add">+ENDPROC(NG_ret_i2_and_7_plus_i4)</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 	.align		64
 
 	.globl	FUNC_NAME
<span class="p_chunk">@@ -126,8 +209,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	sub		%g0, %i4, %i4	! bytes to align dst
 	sub		%i2, %i4, %i2
 1:	subcc		%i4, 1, %i4
<span class="p_del">-	EX_LD(LOAD(ldub, %i1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o0))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %i1, %g1), NG_ret_i2_plus_i4_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o0), NG_ret_i2_plus_i4_plus_1)</span>
 	add		%i1, 1, %i1
 	bne,pt		%XCC, 1b
 	add		%o0, 1, %o0
<span class="p_chunk">@@ -160,7 +243,7 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	and		%i4, 0x7, GLOBAL_SPARE
 	sll		GLOBAL_SPARE, 3, GLOBAL_SPARE
 	mov		64, %i5
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1, %g2, %g3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1, %g2, %g3), NG_ret_i2_plus_g1)</span>
 	sub		%i5, GLOBAL_SPARE, %i5
 	mov		16, %o4
 	mov		32, %o5
<span class="p_chunk">@@ -178,31 +261,31 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	srlx		WORD3, PRE_SHIFT, TMP; \
 	or		WORD2, TMP, WORD2;
 
<span class="p_del">-8:	EX_LD(LOAD_TWIN(%i1 + %o4, %o2, %o3))</span>
<span class="p_add">+8:	EX_LD(LOAD_TWIN(%i1 + %o4, %o2, %o3), NG_ret_i2_plus_g1)</span>
 	MIX_THREE_WORDS(%g2, %g3, %o2, %i5, GLOBAL_SPARE, %o1)
 	LOAD(prefetch, %i1 + %i3, #one_read)
 
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0 + 0x00))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0 + 0x08))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0 + 0x00), NG_ret_i2_plus_g1)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0 + 0x08), NG_ret_i2_plus_g1_minus_8)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o5, %g2, %g3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o5, %g2, %g3), NG_ret_i2_plus_g1_minus_16)</span>
 	MIX_THREE_WORDS(%o2, %o3, %g2, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x18))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x10), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x18), NG_ret_i2_plus_g1_minus_24)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3), NG_ret_i2_plus_g1_minus_32)</span>
 	MIX_THREE_WORDS(%g2, %g3, %o2, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0 + 0x20))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0 + 0x28))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0 + 0x20), NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0 + 0x28), NG_ret_i2_plus_g1_minus_40)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %i3, %g2, %g3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %i3, %g2, %g3), NG_ret_i2_plus_g1_minus_48)</span>
 	add		%i1, 64, %i1
 	MIX_THREE_WORDS(%o2, %o3, %g2, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x30))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x38))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x30), NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x38), NG_ret_i2_plus_g1_minus_56)</span>
 
 	subcc		%g1, 64, %g1
 	bne,pt		%XCC, 8b
<span class="p_chunk">@@ -211,31 +294,31 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	ba,pt		%XCC, 60f
 	 add		%i1, %i4, %i1
 
<span class="p_del">-9:	EX_LD(LOAD_TWIN(%i1 + %o4, %o2, %o3))</span>
<span class="p_add">+9:	EX_LD(LOAD_TWIN(%i1 + %o4, %o2, %o3), NG_ret_i2_plus_g1)</span>
 	MIX_THREE_WORDS(%g3, %o2, %o3, %i5, GLOBAL_SPARE, %o1)
 	LOAD(prefetch, %i1 + %i3, #one_read)
 
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0 + 0x00))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x08))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0 + 0x00), NG_ret_i2_plus_g1)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x08), NG_ret_i2_plus_g1_minus_8)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o5, %g2, %g3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o5, %g2, %g3), NG_ret_i2_plus_g1_minus_16)</span>
 	MIX_THREE_WORDS(%o3, %g2, %g3, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0 + 0x18))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x10), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0 + 0x18), NG_ret_i2_plus_g1_minus_24)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3), NG_ret_i2_plus_g1_minus_32)</span>
 	MIX_THREE_WORDS(%g3, %o2, %o3, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%g3, %o0 + 0x20))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x28))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g3, %o0 + 0x20), NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x28), NG_ret_i2_plus_g1_minus_40)</span>
 
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %i3, %g2, %g3))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %i3, %g2, %g3), NG_ret_i2_plus_g1_minus_48)</span>
 	add		%i1, 64, %i1
 	MIX_THREE_WORDS(%o3, %g2, %g3, %i5, GLOBAL_SPARE, %o1)
 
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x30))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%g2, %o0 + 0x38))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x30), NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%g2, %o0 + 0x38), NG_ret_i2_plus_g1_minus_56)</span>
 
 	subcc		%g1, 64, %g1
 	bne,pt		%XCC, 9b
<span class="p_chunk">@@ -249,25 +332,25 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	 * one twin load ahead, then add 8 back into source when
 	 * we finish the loop.
 	 */
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1, %o4, %o5))</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1, %o4, %o5), NG_ret_i2_plus_g1)</span>
 	mov	16, %o7
 	mov	32, %g2
 	mov	48, %g3
 	mov	64, %o1
<span class="p_del">-1:	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3))</span>
<span class="p_add">+1:	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3), NG_ret_i2_plus_g1)</span>
 	LOAD(prefetch, %i1 + %o1, #one_read)
<span class="p_del">-	EX_ST(STORE_INIT(%o5, %o0 + 0x00))	! initializes cache line</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x08))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %g2, %o4, %o5))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o4, %o0 + 0x18))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %g3, %o2, %o3))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o5, %o0 + 0x20))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x28))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o1, %o4, %o5))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o5, %o0 + 0x00), NG_ret_i2_plus_g1)	! initializes cache line</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x08), NG_ret_i2_plus_g1_minus_8)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %g2, %o4, %o5), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x10), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o4, %o0 + 0x18), NG_ret_i2_plus_g1_minus_24)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %g3, %o2, %o3), NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o5, %o0 + 0x20), NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x28), NG_ret_i2_plus_g1_minus_40)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o1, %o4, %o5), NG_ret_i2_plus_g1_minus_48)</span>
 	add		%i1, 64, %i1
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x30))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o4, %o0 + 0x38))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x30), NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o4, %o0 + 0x38), NG_ret_i2_plus_g1_minus_56)</span>
 	subcc		%g1, 64, %g1
 	bne,pt		%XCC, 1b
 	 add		%o0, 64, %o0
<span class="p_chunk">@@ -282,20 +365,20 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	mov	32, %g2
 	mov	48, %g3
 	mov	64, %o1
<span class="p_del">-1:	EX_LD(LOAD_TWIN(%i1 + %g0, %o4, %o5))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3))</span>
<span class="p_add">+1:	EX_LD(LOAD_TWIN(%i1 + %g0, %o4, %o5), NG_ret_i2_plus_g1)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %o7, %o2, %o3), NG_ret_i2_plus_g1)</span>
 	LOAD(prefetch, %i1 + %o1, #one_read)
<span class="p_del">-	EX_ST(STORE_INIT(%o4, %o0 + 0x00))	! initializes cache line</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o5, %o0 + 0x08))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %g2, %o4, %o5))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x10))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x18))</span>
<span class="p_del">-	EX_LD(LOAD_TWIN(%i1 + %g3, %o2, %o3))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o4, %o0 + 0x00), NG_ret_i2_plus_g1)	! initializes cache line</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o5, %o0 + 0x08), NG_ret_i2_plus_g1_minus_8)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %g2, %o4, %o5), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x10), NG_ret_i2_plus_g1_minus_16)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x18), NG_ret_i2_plus_g1_minus_24)</span>
<span class="p_add">+	EX_LD(LOAD_TWIN(%i1 + %g3, %o2, %o3), NG_ret_i2_plus_g1_minus_32)</span>
 	add	%i1, 64, %i1
<span class="p_del">-	EX_ST(STORE_INIT(%o4, %o0 + 0x20))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o5, %o0 + 0x28))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o2, %o0 + 0x30))</span>
<span class="p_del">-	EX_ST(STORE_INIT(%o3, %o0 + 0x38))</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o4, %o0 + 0x20), NG_ret_i2_plus_g1_minus_32)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o5, %o0 + 0x28), NG_ret_i2_plus_g1_minus_40)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o2, %o0 + 0x30), NG_ret_i2_plus_g1_minus_48)</span>
<span class="p_add">+	EX_ST(STORE_INIT(%o3, %o0 + 0x38), NG_ret_i2_plus_g1_minus_56)</span>
 	subcc	%g1, 64, %g1
 	bne,pt	%XCC, 1b
 	 add	%o0, 64, %o0
<span class="p_chunk">@@ -321,28 +404,28 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	andn		%i2, 0xf, %i4
 	and		%i2, 0xf, %i2
 1:	subcc		%i4, 0x10, %i4
<span class="p_del">-	EX_LD(LOAD(ldx, %i1, %o4))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %i1, %o4), NG_ret_i2_plus_i4)</span>
 	add		%i1, 0x08, %i1
<span class="p_del">-	EX_LD(LOAD(ldx, %i1, %g1))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %i1, %g1), NG_ret_i2_plus_i4)</span>
 	sub		%i1, 0x08, %i1
<span class="p_del">-	EX_ST(STORE(stx, %o4, %i1 + %i3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o4, %i1 + %i3), NG_ret_i2_plus_i4)</span>
 	add		%i1, 0x8, %i1
<span class="p_del">-	EX_ST(STORE(stx, %g1, %i1 + %i3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %g1, %i1 + %i3), NG_ret_i2_plus_i4_minus_8)</span>
 	bgu,pt		%XCC, 1b
 	 add		%i1, 0x8, %i1
 73:	andcc		%i2, 0x8, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%i2, 0x8, %i2
<span class="p_del">-	EX_LD(LOAD(ldx, %i1, %o4))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o4, %i1 + %i3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %i1, %o4), NG_ret_i2_plus_8)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o4, %i1 + %i3), NG_ret_i2_plus_8)</span>
 	add		%i1, 0x8, %i1
 1:	andcc		%i2, 0x4, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%i2, 0x4, %i2
<span class="p_del">-	EX_LD(LOAD(lduw, %i1, %i5))</span>
<span class="p_del">-	EX_ST(STORE(stw, %i5, %i1 + %i3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %i1, %i5), NG_ret_i2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %i5, %i1 + %i3), NG_ret_i2_plus_4)</span>
 	add		%i1, 0x4, %i1
 1:	cmp		%i2, 0
 	be,pt		%XCC, 85f
<span class="p_chunk">@@ -358,8 +441,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	sub		%i2, %g1, %i2
 
 1:	subcc		%g1, 1, %g1
<span class="p_del">-	EX_LD(LOAD(ldub, %i1, %i5))</span>
<span class="p_del">-	EX_ST(STORE(stb, %i5, %i1 + %i3))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %i1, %i5), NG_ret_i2_plus_g1_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %i5, %i1 + %i3), NG_ret_i2_plus_g1_plus_1)</span>
 	bgu,pt		%icc, 1b
 	 add		%i1, 1, %i1
 
<span class="p_chunk">@@ -375,16 +458,16 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 
 8:	mov		64, %i3
 	andn		%i1, 0x7, %i1
<span class="p_del">-	EX_LD(LOAD(ldx, %i1, %g2))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %i1, %g2), NG_ret_i2)</span>
 	sub		%i3, %g1, %i3
 	andn		%i2, 0x7, %i4
 	sllx		%g2, %g1, %g2
 1:	add		%i1, 0x8, %i1
<span class="p_del">-	EX_LD(LOAD(ldx, %i1, %g3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %i1, %g3), NG_ret_i2_and_7_plus_i4)</span>
 	subcc		%i4, 0x8, %i4
 	srlx		%g3, %i3, %i5
 	or		%i5, %g2, %i5
<span class="p_del">-	EX_ST(STORE(stx, %i5, %o0))</span>
<span class="p_add">+	EX_ST(STORE(stx, %i5, %o0), NG_ret_i2_and_7_plus_i4)</span>
 	add		%o0, 0x8, %o0
 	bgu,pt		%icc, 1b
 	 sllx		%g3, %g1, %g2
<span class="p_chunk">@@ -404,8 +487,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 
 1:
 	subcc		%i2, 4, %i2
<span class="p_del">-	EX_LD(LOAD(lduw, %i1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stw, %g1, %i1 + %i3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %i1, %g1), NG_ret_i2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %g1, %i1 + %i3), NG_ret_i2_plus_4)</span>
 	bgu,pt		%XCC, 1b
 	 add		%i1, 4, %i1
 
<span class="p_chunk">@@ -415,8 +498,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %i0=dst, %i1=src, %i2=len */</span>
 	.align		32
 90:
 	subcc		%i2, 1, %i2
<span class="p_del">-	EX_LD(LOAD(ldub, %i1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %i1 + %i3))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %i1, %g1), NG_ret_i2_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %i1 + %i3), NG_ret_i2_plus_1)</span>
 	bgu,pt		%XCC, 90b
 	 add		%i1, 1, %i1
 	ret
<span class="p_header">diff --git a/arch/sparc/lib/U1copy_from_user.S b/arch/sparc/lib/U1copy_from_user.S</span>
<span class="p_header">index ecc5692fa2b4..bb6ff73229e3 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U1copy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U1copy_from_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 1999, 2000, 2004 David S. Miller (davem@redhat.com)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_LD_FP(x)		\</span>
<span class="p_add">+#define EX_LD_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_fp;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/U1copy_to_user.S b/arch/sparc/lib/U1copy_to_user.S</span>
<span class="p_header">index 9eea392e44d4..ed92ce739558 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U1copy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U1copy_to_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 1999, 2000, 2004 David S. Miller (davem@redhat.com)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_ST_FP(x)		\</span>
<span class="p_add">+#define EX_ST_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_fp;\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/U1memcpy.S b/arch/sparc/lib/U1memcpy.S</span>
<span class="p_header">index 3e6209ebb7d7..f30d2ab2c371 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U1memcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U1memcpy.S</span>
<span class="p_chunk">@@ -5,6 +5,7 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #include &lt;asm/visasm.h&gt;
 #include &lt;asm/asi.h&gt;
 #define GLOBAL_SPARE	g7
<span class="p_chunk">@@ -23,21 +24,17 @@</span> <span class="p_context"></span>
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 #ifndef EX_LD_FP
<span class="p_del">-#define EX_LD_FP(x)	x</span>
<span class="p_add">+#define EX_LD_FP(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 #ifndef EX_ST_FP
<span class="p_del">-#define EX_ST_FP(x)	x</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_add">+#define EX_ST_FP(x,y)	x</span>
 #endif
 
 #ifndef LOAD
<span class="p_chunk">@@ -78,53 +75,169 @@</span> <span class="p_context"></span>
 	faligndata		%f7, %f8, %f60;			\
 	faligndata		%f8, %f9, %f62;
 
<span class="p_del">-#define MAIN_LOOP_CHUNK(src, dest, fdest, fsrc, len, jmptgt)	\</span>
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%src, %fdest));				\</span>
<span class="p_del">-	EX_ST_FP(STORE_BLK(%fsrc, %dest));				\</span>
<span class="p_del">-	add			%src, 0x40, %src;		\</span>
<span class="p_del">-	subcc			%len, 0x40, %len;		\</span>
<span class="p_del">-	be,pn			%xcc, jmptgt;			\</span>
<span class="p_del">-	 add			%dest, 0x40, %dest;		\</span>
<span class="p_del">-</span>
<span class="p_del">-#define LOOP_CHUNK1(src, dest, len, branch_dest)		\</span>
<span class="p_del">-	MAIN_LOOP_CHUNK(src, dest, f0,  f48, len, branch_dest)</span>
<span class="p_del">-#define LOOP_CHUNK2(src, dest, len, branch_dest)		\</span>
<span class="p_del">-	MAIN_LOOP_CHUNK(src, dest, f16, f48, len, branch_dest)</span>
<span class="p_del">-#define LOOP_CHUNK3(src, dest, len, branch_dest)		\</span>
<span class="p_del">-	MAIN_LOOP_CHUNK(src, dest, f32, f48, len, branch_dest)</span>
<span class="p_add">+#define MAIN_LOOP_CHUNK(src, dest, fdest, fsrc, jmptgt)			\</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%src, %fdest), U1_gs_80_fp);			\</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%fsrc, %dest), U1_gs_80_fp);			\</span>
<span class="p_add">+	add			%src, 0x40, %src;			\</span>
<span class="p_add">+	subcc			%GLOBAL_SPARE, 0x40, %GLOBAL_SPARE;	\</span>
<span class="p_add">+	be,pn			%xcc, jmptgt;				\</span>
<span class="p_add">+	 add			%dest, 0x40, %dest;			\</span>
<span class="p_add">+</span>
<span class="p_add">+#define LOOP_CHUNK1(src, dest, branch_dest)		\</span>
<span class="p_add">+	MAIN_LOOP_CHUNK(src, dest, f0,  f48, branch_dest)</span>
<span class="p_add">+#define LOOP_CHUNK2(src, dest, branch_dest)		\</span>
<span class="p_add">+	MAIN_LOOP_CHUNK(src, dest, f16, f48, branch_dest)</span>
<span class="p_add">+#define LOOP_CHUNK3(src, dest, branch_dest)		\</span>
<span class="p_add">+	MAIN_LOOP_CHUNK(src, dest, f32, f48, branch_dest)</span>
 
 #define DO_SYNC			membar	#Sync;
 #define STORE_SYNC(dest, fsrc)				\
<span class="p_del">-	EX_ST_FP(STORE_BLK(%fsrc, %dest));			\</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%fsrc, %dest), U1_gs_80_fp);	\</span>
 	add			%dest, 0x40, %dest;	\
 	DO_SYNC
 
 #define STORE_JUMP(dest, fsrc, target)			\
<span class="p_del">-	EX_ST_FP(STORE_BLK(%fsrc, %dest));			\</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%fsrc, %dest), U1_gs_40_fp);	\</span>
 	add			%dest, 0x40, %dest;	\
 	ba,pt			%xcc, target;		\
 	 nop;
 
<span class="p_del">-#define FINISH_VISCHUNK(dest, f0, f1, left)	\</span>
<span class="p_del">-	subcc			%left, 8, %left;\</span>
<span class="p_del">-	bl,pn			%xcc, 95f;	\</span>
<span class="p_del">-	 faligndata		%f0, %f1, %f48;	\</span>
<span class="p_del">-	EX_ST_FP(STORE(std, %f48, %dest));		\</span>
<span class="p_add">+#define FINISH_VISCHUNK(dest, f0, f1)			\</span>
<span class="p_add">+	subcc			%g3, 8, %g3;		\</span>
<span class="p_add">+	bl,pn			%xcc, 95f;		\</span>
<span class="p_add">+	 faligndata		%f0, %f1, %f48;		\</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f48, %dest), U1_g3_8_fp);	\</span>
 	add			%dest, 8, %dest;
 
<span class="p_del">-#define UNEVEN_VISCHUNK_LAST(dest, f0, f1, left)	\</span>
<span class="p_del">-	subcc			%left, 8, %left;	\</span>
<span class="p_del">-	bl,pn			%xcc, 95f;		\</span>
<span class="p_add">+#define UNEVEN_VISCHUNK_LAST(dest, f0, f1)	\</span>
<span class="p_add">+	subcc			%g3, 8, %g3;	\</span>
<span class="p_add">+	bl,pn			%xcc, 95f;	\</span>
 	 fsrc2			%f0, %f1;
 
<span class="p_del">-#define UNEVEN_VISCHUNK(dest, f0, f1, left)		\</span>
<span class="p_del">-	UNEVEN_VISCHUNK_LAST(dest, f0, f1, left)	\</span>
<span class="p_add">+#define UNEVEN_VISCHUNK(dest, f0, f1)		\</span>
<span class="p_add">+	UNEVEN_VISCHUNK_LAST(dest, f0, f1)	\</span>
 	ba,a,pt			%xcc, 93f;
 
 	.register	%g2,#scratch
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+ENTRY(U1_g1_1_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%g1, 1, %g1</span>
<span class="p_add">+	add		%g1, %g2, %g1</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g1, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g1_1_fp)</span>
<span class="p_add">+ENTRY(U1_g2_0_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g2, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g2_0_fp)</span>
<span class="p_add">+ENTRY(U1_g2_8_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%g2, 8, %g2</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g2, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g2_8_fp)</span>
<span class="p_add">+ENTRY(U1_gs_0_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%GLOBAL_SPARE, %g3, %o0</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o0, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_0_fp)</span>
<span class="p_add">+ENTRY(U1_gs_80_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%GLOBAL_SPARE, 0x80, %GLOBAL_SPARE</span>
<span class="p_add">+	add		%GLOBAL_SPARE, %g3, %o0</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o0, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_80_fp)</span>
<span class="p_add">+ENTRY(U1_gs_40_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%GLOBAL_SPARE, 0x40, %GLOBAL_SPARE</span>
<span class="p_add">+	add		%GLOBAL_SPARE, %g3, %o0</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o0, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_40_fp)</span>
<span class="p_add">+ENTRY(U1_g3_0_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g3, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g3_0_fp)</span>
<span class="p_add">+ENTRY(U1_g3_8_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%g3, 8, %g3</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g3, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g3_8_fp)</span>
<span class="p_add">+ENTRY(U1_o2_0_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 mov		%o2, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_0_fp)</span>
<span class="p_add">+ENTRY(U1_o2_1_fp)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_1_fp)</span>
<span class="p_add">+ENTRY(U1_gs_0)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%GLOBAL_SPARE, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_0)</span>
<span class="p_add">+ENTRY(U1_gs_8)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%GLOBAL_SPARE, %o2, %GLOBAL_SPARE</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%GLOBAL_SPARE, 0x8, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_8)</span>
<span class="p_add">+ENTRY(U1_gs_10)</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	add		%GLOBAL_SPARE, %o2, %GLOBAL_SPARE</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%GLOBAL_SPARE, 0x10, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_10)</span>
<span class="p_add">+ENTRY(U1_o2_0)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 mov		%o2, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_0)</span>
<span class="p_add">+ENTRY(U1_o2_8)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o2, 8, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_8)</span>
<span class="p_add">+ENTRY(U1_o2_4)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o2, 4, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_4)</span>
<span class="p_add">+ENTRY(U1_o2_1)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(U1_o2_1)</span>
<span class="p_add">+ENTRY(U1_g1_0)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g1, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g1_0)</span>
<span class="p_add">+ENTRY(U1_g1_1)</span>
<span class="p_add">+	add		%g1, 1, %g1</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%g1, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_g1_1)</span>
<span class="p_add">+ENTRY(U1_gs_0_o2_adj)</span>
<span class="p_add">+	and		%o2, 7, %o2</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%GLOBAL_SPARE, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_0_o2_adj)</span>
<span class="p_add">+ENTRY(U1_gs_8_o2_adj)</span>
<span class="p_add">+	and		%o2, 7, %o2</span>
<span class="p_add">+	add		%GLOBAL_SPARE, 8, %GLOBAL_SPARE</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add		%GLOBAL_SPARE, %o2, %o0</span>
<span class="p_add">+ENDPROC(U1_gs_8_o2_adj)</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 	.align		64
 
 	.globl		FUNC_NAME
<span class="p_chunk">@@ -166,8 +279,8 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	 and		%g2, 0x38, %g2
 
 1:	subcc		%g1, 0x1, %g1
<span class="p_del">-	EX_LD_FP(LOAD(ldub, %o1 + 0x00, %o3))</span>
<span class="p_del">-	EX_ST_FP(STORE(stb, %o3, %o1 + %GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldub, %o1 + 0x00, %o3), U1_g1_1_fp)</span>
<span class="p_add">+	EX_ST_FP(STORE(stb, %o3, %o1 + %GLOBAL_SPARE), U1_g1_1_fp)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 0x1, %o1
 
<span class="p_chunk">@@ -178,20 +291,20 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	be,pt		%icc, 3f
 	 alignaddr	%o1, %g0, %o1
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1, %f4))</span>
<span class="p_del">-1:	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f6))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1, %f4), U1_g2_0_fp)</span>
<span class="p_add">+1:	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f6), U1_g2_0_fp)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f4, %f6, %f0
<span class="p_del">-	EX_ST_FP(STORE(std, %f0, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f0, %o0), U1_g2_8_fp)</span>
 	be,pn		%icc, 3f
 	 add		%o0, 0x8, %o0
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f4))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f4), U1_g2_0_fp)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f6, %f4, %f0
<span class="p_del">-	EX_ST_FP(STORE(std, %f0, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f0, %o0), U1_g2_8_fp)</span>
 	bne,pt		%icc, 1b
 	 add		%o0, 0x8, %o0
 
<span class="p_chunk">@@ -214,13 +327,13 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	add		%g1, %GLOBAL_SPARE, %g1
 	subcc		%o2, %g3, %o2
 
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o1, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o1, %f0), U1_gs_0_fp)</span>
 	add		%o1, 0x40, %o1
 	add		%g1, %g3, %g1
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o1, %f16))</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o1, %f16), U1_gs_0_fp)</span>
 	add		%o1, 0x40, %o1
 	sub		%GLOBAL_SPARE, 0x80, %GLOBAL_SPARE
<span class="p_del">-	EX_LD_FP(LOAD_BLK(%o1, %f32))</span>
<span class="p_add">+	EX_LD_FP(LOAD_BLK(%o1, %f32), U1_gs_80_fp)</span>
 	add		%o1, 0x40, %o1
 
 	/* There are 8 instances of the unrolled loop,
<span class="p_chunk">@@ -240,11 +353,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 
 	.align		64
 1:	FREG_FROB(f0, f2, f4, f6, f8, f10,f12,f14,f16)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f16,f18,f20,f22,f24,f26,f28,f30,f32)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f32,f34,f36,f38,f40,f42,f44,f46,f0)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f0, %f2, %f48
 1:	FREG_FROB(f16,f18,f20,f22,f24,f26,f28,f30,f32)
<span class="p_chunk">@@ -261,11 +374,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 56f)
 
 1:	FREG_FROB(f2, f4, f6, f8, f10,f12,f14,f16,f18)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f18,f20,f22,f24,f26,f28,f30,f32,f34)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f34,f36,f38,f40,f42,f44,f46,f0, f2)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f2, %f4, %f48
 1:	FREG_FROB(f18,f20,f22,f24,f26,f28,f30,f32,f34)
<span class="p_chunk">@@ -282,11 +395,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 57f)
 
 1:	FREG_FROB(f4, f6, f8, f10,f12,f14,f16,f18,f20)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f20,f22,f24,f26,f28,f30,f32,f34,f36)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f36,f38,f40,f42,f44,f46,f0, f2, f4)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f4, %f6, %f48
 1:	FREG_FROB(f20,f22,f24,f26,f28,f30,f32,f34,f36)
<span class="p_chunk">@@ -303,11 +416,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 58f)
 
 1:	FREG_FROB(f6, f8, f10,f12,f14,f16,f18,f20,f22)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f22,f24,f26,f28,f30,f32,f34,f36,f38)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f38,f40,f42,f44,f46,f0, f2, f4, f6) 
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f6, %f8, %f48
 1:	FREG_FROB(f22,f24,f26,f28,f30,f32,f34,f36,f38)
<span class="p_chunk">@@ -324,11 +437,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 59f)
 
 1:	FREG_FROB(f8, f10,f12,f14,f16,f18,f20,f22,f24)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f24,f26,f28,f30,f32,f34,f36,f38,f40)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f40,f42,f44,f46,f0, f2, f4, f6, f8)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f8, %f10, %f48
 1:	FREG_FROB(f24,f26,f28,f30,f32,f34,f36,f38,f40)
<span class="p_chunk">@@ -345,11 +458,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 60f)
 
 1:	FREG_FROB(f10,f12,f14,f16,f18,f20,f22,f24,f26)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f26,f28,f30,f32,f34,f36,f38,f40,f42)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f42,f44,f46,f0, f2, f4, f6, f8, f10)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f10, %f12, %f48
 1:	FREG_FROB(f26,f28,f30,f32,f34,f36,f38,f40,f42)
<span class="p_chunk">@@ -366,11 +479,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 61f)
 
 1:	FREG_FROB(f12,f14,f16,f18,f20,f22,f24,f26,f28)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f28,f30,f32,f34,f36,f38,f40,f42,f44)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f44,f46,f0, f2, f4, f6, f8, f10,f12)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f12, %f14, %f48
 1:	FREG_FROB(f28,f30,f32,f34,f36,f38,f40,f42,f44)
<span class="p_chunk">@@ -387,11 +500,11 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	STORE_JUMP(o0, f48, 62f)
 
 1:	FREG_FROB(f14,f16,f18,f20,f22,f24,f26,f28,f30)
<span class="p_del">-	LOOP_CHUNK1(o1, o0, GLOBAL_SPARE, 1f)</span>
<span class="p_add">+	LOOP_CHUNK1(o1, o0, 1f)</span>
 	FREG_FROB(f30,f32,f34,f36,f38,f40,f42,f44,f46)
<span class="p_del">-	LOOP_CHUNK2(o1, o0, GLOBAL_SPARE, 2f)</span>
<span class="p_add">+	LOOP_CHUNK2(o1, o0, 2f)</span>
 	FREG_FROB(f46,f0, f2, f4, f6, f8, f10,f12,f14)
<span class="p_del">-	LOOP_CHUNK3(o1, o0, GLOBAL_SPARE, 3f)</span>
<span class="p_add">+	LOOP_CHUNK3(o1, o0, 3f)</span>
 	ba,pt		%xcc, 1b+4
 	 faligndata	%f14, %f16, %f48
 1:	FREG_FROB(f30,f32,f34,f36,f38,f40,f42,f44,f46)
<span class="p_chunk">@@ -407,53 +520,53 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	FREG_FROB(f30,f32,f34,f36,f38,f40,f42,f44,f46)
 	STORE_JUMP(o0, f48, 63f)
 
<span class="p_del">-40:	FINISH_VISCHUNK(o0, f0,  f2,  g3)</span>
<span class="p_del">-41:	FINISH_VISCHUNK(o0, f2,  f4,  g3)</span>
<span class="p_del">-42:	FINISH_VISCHUNK(o0, f4,  f6,  g3)</span>
<span class="p_del">-43:	FINISH_VISCHUNK(o0, f6,  f8,  g3)</span>
<span class="p_del">-44:	FINISH_VISCHUNK(o0, f8,  f10, g3)</span>
<span class="p_del">-45:	FINISH_VISCHUNK(o0, f10, f12, g3)</span>
<span class="p_del">-46:	FINISH_VISCHUNK(o0, f12, f14, g3)</span>
<span class="p_del">-47:	UNEVEN_VISCHUNK(o0, f14, f0,  g3)</span>
<span class="p_del">-48:	FINISH_VISCHUNK(o0, f16, f18, g3)</span>
<span class="p_del">-49:	FINISH_VISCHUNK(o0, f18, f20, g3)</span>
<span class="p_del">-50:	FINISH_VISCHUNK(o0, f20, f22, g3)</span>
<span class="p_del">-51:	FINISH_VISCHUNK(o0, f22, f24, g3)</span>
<span class="p_del">-52:	FINISH_VISCHUNK(o0, f24, f26, g3)</span>
<span class="p_del">-53:	FINISH_VISCHUNK(o0, f26, f28, g3)</span>
<span class="p_del">-54:	FINISH_VISCHUNK(o0, f28, f30, g3)</span>
<span class="p_del">-55:	UNEVEN_VISCHUNK(o0, f30, f0,  g3)</span>
<span class="p_del">-56:	FINISH_VISCHUNK(o0, f32, f34, g3)</span>
<span class="p_del">-57:	FINISH_VISCHUNK(o0, f34, f36, g3)</span>
<span class="p_del">-58:	FINISH_VISCHUNK(o0, f36, f38, g3)</span>
<span class="p_del">-59:	FINISH_VISCHUNK(o0, f38, f40, g3)</span>
<span class="p_del">-60:	FINISH_VISCHUNK(o0, f40, f42, g3)</span>
<span class="p_del">-61:	FINISH_VISCHUNK(o0, f42, f44, g3)</span>
<span class="p_del">-62:	FINISH_VISCHUNK(o0, f44, f46, g3)</span>
<span class="p_del">-63:	UNEVEN_VISCHUNK_LAST(o0, f46, f0,  g3)</span>
<span class="p_del">-</span>
<span class="p_del">-93:	EX_LD_FP(LOAD(ldd, %o1, %f2))</span>
<span class="p_add">+40:	FINISH_VISCHUNK(o0, f0,  f2)</span>
<span class="p_add">+41:	FINISH_VISCHUNK(o0, f2,  f4)</span>
<span class="p_add">+42:	FINISH_VISCHUNK(o0, f4,  f6)</span>
<span class="p_add">+43:	FINISH_VISCHUNK(o0, f6,  f8)</span>
<span class="p_add">+44:	FINISH_VISCHUNK(o0, f8,  f10)</span>
<span class="p_add">+45:	FINISH_VISCHUNK(o0, f10, f12)</span>
<span class="p_add">+46:	FINISH_VISCHUNK(o0, f12, f14)</span>
<span class="p_add">+47:	UNEVEN_VISCHUNK(o0, f14, f0)</span>
<span class="p_add">+48:	FINISH_VISCHUNK(o0, f16, f18)</span>
<span class="p_add">+49:	FINISH_VISCHUNK(o0, f18, f20)</span>
<span class="p_add">+50:	FINISH_VISCHUNK(o0, f20, f22)</span>
<span class="p_add">+51:	FINISH_VISCHUNK(o0, f22, f24)</span>
<span class="p_add">+52:	FINISH_VISCHUNK(o0, f24, f26)</span>
<span class="p_add">+53:	FINISH_VISCHUNK(o0, f26, f28)</span>
<span class="p_add">+54:	FINISH_VISCHUNK(o0, f28, f30)</span>
<span class="p_add">+55:	UNEVEN_VISCHUNK(o0, f30, f0)</span>
<span class="p_add">+56:	FINISH_VISCHUNK(o0, f32, f34)</span>
<span class="p_add">+57:	FINISH_VISCHUNK(o0, f34, f36)</span>
<span class="p_add">+58:	FINISH_VISCHUNK(o0, f36, f38)</span>
<span class="p_add">+59:	FINISH_VISCHUNK(o0, f38, f40)</span>
<span class="p_add">+60:	FINISH_VISCHUNK(o0, f40, f42)</span>
<span class="p_add">+61:	FINISH_VISCHUNK(o0, f42, f44)</span>
<span class="p_add">+62:	FINISH_VISCHUNK(o0, f44, f46)</span>
<span class="p_add">+63:	UNEVEN_VISCHUNK_LAST(o0, f46, f0)</span>
<span class="p_add">+</span>
<span class="p_add">+93:	EX_LD_FP(LOAD(ldd, %o1, %f2), U1_g3_0_fp)</span>
 	add		%o1, 8, %o1
 	subcc		%g3, 8, %g3
 	faligndata	%f0, %f2, %f8
<span class="p_del">-	EX_ST_FP(STORE(std, %f8, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f8, %o0), U1_g3_8_fp)</span>
 	bl,pn		%xcc, 95f
 	 add		%o0, 8, %o0
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1, %f0), U1_g3_0_fp)</span>
 	add		%o1, 8, %o1
 	subcc		%g3, 8, %g3
 	faligndata	%f2, %f0, %f8
<span class="p_del">-	EX_ST_FP(STORE(std, %f8, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f8, %o0), U1_g3_8_fp)</span>
 	bge,pt		%xcc, 93b
 	 add		%o0, 8, %o0
 
 95:	brz,pt		%o2, 2f
 	 mov		%g1, %o1
 
<span class="p_del">-1:	EX_LD_FP(LOAD(ldub, %o1, %o3))</span>
<span class="p_add">+1:	EX_LD_FP(LOAD(ldub, %o1, %o3), U1_o2_0_fp)</span>
 	add		%o1, 1, %o1
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX_ST_FP(STORE(stb, %o3, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(stb, %o3, %o0), U1_o2_1_fp)</span>
 	bne,pt		%xcc, 1b
 	 add		%o0, 1, %o0
 
<span class="p_chunk">@@ -469,27 +582,27 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 
 72:	andn		%o2, 0xf, %GLOBAL_SPARE
 	and		%o2, 0xf, %o2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x00, %o5))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x08, %g1))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x00, %o5), U1_gs_0)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x08, %g1), U1_gs_0)</span>
 	subcc		%GLOBAL_SPARE, 0x10, %GLOBAL_SPARE
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + %o3), U1_gs_10)</span>
 	add		%o1, 0x8, %o1
<span class="p_del">-	EX_ST(STORE(stx, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %g1, %o1 + %o3), U1_gs_8)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 0x8, %o1
 73:	andcc		%o2, 0x8, %g0
 	be,pt		%XCC, 1f
 	 nop
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %o5))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %o5), U1_o2_0)</span>
 	sub		%o2, 0x8, %o2
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + %o3), U1_o2_8)</span>
 	add		%o1, 0x8, %o1
 1:	andcc		%o2, 0x4, %g0
 	be,pt		%XCC, 1f
 	 nop
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %o5))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %o5), U1_o2_0)</span>
 	sub		%o2, 0x4, %o2
<span class="p_del">-	EX_ST(STORE(stw, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stw, %o5, %o1 + %o3), U1_o2_4)</span>
 	add		%o1, 0x4, %o1
 1:	cmp		%o2, 0
 	be,pt		%XCC, 85f
<span class="p_chunk">@@ -503,9 +616,9 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	 sub		%g0, %g1, %g1
 	sub		%o2, %g1, %o2
 
<span class="p_del">-1:	EX_LD(LOAD(ldub, %o1, %o5))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldub, %o1, %o5), U1_g1_0)</span>
 	subcc		%g1, 1, %g1
<span class="p_del">-	EX_ST(STORE(stb, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stb, %o5, %o1 + %o3), U1_g1_1)</span>
 	bgu,pt		%icc, 1b
 	 add		%o1, 1, %o1
 
<span class="p_chunk">@@ -521,16 +634,16 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 
 8:	mov		64, %o3
 	andn		%o1, 0x7, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g2))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g2), U1_o2_0)</span>
 	sub		%o3, %g1, %o3
 	andn		%o2, 0x7, %GLOBAL_SPARE
 	sllx		%g2, %g1, %g2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x8, %g3))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x8, %g3), U1_gs_0_o2_adj)</span>
 	subcc		%GLOBAL_SPARE, 0x8, %GLOBAL_SPARE
 	add		%o1, 0x8, %o1
 	srlx		%g3, %o3, %o5
 	or		%o5, %g2, %o5
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o0))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o0), U1_gs_8_o2_adj)</span>
 	add		%o0, 0x8, %o0
 	bgu,pt		%icc, 1b
 	 sllx		%g3, %g1, %g2
<span class="p_chunk">@@ -548,9 +661,9 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	bne,pn		%XCC, 90f
 	 sub		%o0, %o1, %o3
 
<span class="p_del">-1:	EX_LD(LOAD(lduw, %o1, %g1))</span>
<span class="p_add">+1:	EX_LD(LOAD(lduw, %o1, %g1), U1_o2_0)</span>
 	subcc		%o2, 4, %o2
<span class="p_del">-	EX_ST(STORE(stw, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stw, %g1, %o1 + %o3), U1_o2_4)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 4, %o1
 
<span class="p_chunk">@@ -558,9 +671,9 @@</span> <span class="p_context"> FUNC_NAME:		/* %o0=dst, %o1=src, %o2=len */</span>
 	 mov		EX_RETVAL(%o4), %o0
 
 	.align		32
<span class="p_del">-90:	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_add">+90:	EX_LD(LOAD(ldub, %o1, %g1), U1_o2_0)</span>
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o1 + %o3), U1_o2_1)</span>
 	bgu,pt		%XCC, 90b
 	 add		%o1, 1, %o1
 	retl
<span class="p_header">diff --git a/arch/sparc/lib/U3copy_from_user.S b/arch/sparc/lib/U3copy_from_user.S</span>
<span class="p_header">index 88ad73d86fe4..db73010a1af8 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U3copy_from_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U3copy_from_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 1999, 2000, 2004 David S. Miller (davem@redhat.com)
  */
 
<span class="p_del">-#define EX_LD(x)		\</span>
<span class="p_add">+#define EX_LD(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_LD_FP(x)		\</span>
<span class="p_add">+#define EX_LD_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/U3copy_to_user.S b/arch/sparc/lib/U3copy_to_user.S</span>
<span class="p_header">index 845139d75537..c4ee858e352a 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U3copy_to_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U3copy_to_user.S</span>
<span class="p_chunk">@@ -3,19 +3,19 @@</span> <span class="p_context"></span>
  * Copyright (C) 1999, 2000, 2004 David S. Miller (davem@redhat.com)
  */
 
<span class="p_del">-#define EX_ST(x)		\</span>
<span class="p_add">+#define EX_ST(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, y;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_del">-#define EX_ST_FP(x)		\</span>
<span class="p_add">+#define EX_ST_FP(x,y)		\</span>
 98:	x;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one_fp;\</span>
<span class="p_add">+	.word 98b, y##_fp;	\</span>
 	.text;			\
 	.align 4;
 
<span class="p_header">diff --git a/arch/sparc/lib/U3memcpy.S b/arch/sparc/lib/U3memcpy.S</span>
<span class="p_header">index 491ee69e4995..54f98706b03b 100644</span>
<span class="p_header">--- a/arch/sparc/lib/U3memcpy.S</span>
<span class="p_header">+++ b/arch/sparc/lib/U3memcpy.S</span>
<span class="p_chunk">@@ -4,6 +4,7 @@</span> <span class="p_context"></span>
  */
 
 #ifdef __KERNEL__
<span class="p_add">+#include &lt;linux/linkage.h&gt;</span>
 #include &lt;asm/visasm.h&gt;
 #include &lt;asm/asi.h&gt;
 #define GLOBAL_SPARE	%g7
<span class="p_chunk">@@ -22,21 +23,17 @@</span> <span class="p_context"></span>
 #endif
 
 #ifndef EX_LD
<span class="p_del">-#define EX_LD(x)	x</span>
<span class="p_add">+#define EX_LD(x,y)	x</span>
 #endif
 #ifndef EX_LD_FP
<span class="p_del">-#define EX_LD_FP(x)	x</span>
<span class="p_add">+#define EX_LD_FP(x,y)	x</span>
 #endif
 
 #ifndef EX_ST
<span class="p_del">-#define EX_ST(x)	x</span>
<span class="p_add">+#define EX_ST(x,y)	x</span>
 #endif
 #ifndef EX_ST_FP
<span class="p_del">-#define EX_ST_FP(x)	x</span>
<span class="p_del">-#endif</span>
<span class="p_del">-</span>
<span class="p_del">-#ifndef EX_RETVAL</span>
<span class="p_del">-#define EX_RETVAL(x)	x</span>
<span class="p_add">+#define EX_ST_FP(x,y)	x</span>
 #endif
 
 #ifndef LOAD
<span class="p_chunk">@@ -77,6 +74,87 @@</span> <span class="p_context"></span>
 	 */
 
 	.text
<span class="p_add">+#ifndef EX_RETVAL</span>
<span class="p_add">+#define EX_RETVAL(x)	x</span>
<span class="p_add">+__restore_fp:</span>
<span class="p_add">+	VISExitHalf</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_g2_plus_g1_plus_1_fp)</span>
<span class="p_add">+	add	%g1, 1, %g1</span>
<span class="p_add">+	add	%g2, %g1, %g2</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %g2, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_g2_plus_g1_plus_1_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_g2_fp)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %g2, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_g2_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_g2_plus_8_fp)</span>
<span class="p_add">+	add	%g2, 8, %g2</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %g2, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_g2_plus_8_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 mov	%o2, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_1)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 1, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_1)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_4)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 4, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_4)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_8)</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 8, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_8)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+	add	%g1, 1, %g1</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, %g1, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+ENTRY(U3_retl_o2_fp)</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 mov	%o2, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_o3_sll_6_plus_0x80_fp)</span>
<span class="p_add">+	sll	%o3, 6, %o3</span>
<span class="p_add">+	add	%o3, 0x80, %o3</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %o3, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_o3_sll_6_plus_0x80_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_o3_sll_6_plus_0x40_fp)</span>
<span class="p_add">+	sll	%o3, 6, %o3</span>
<span class="p_add">+	add	%o3, 0x40, %o3</span>
<span class="p_add">+	ba,pt	%xcc, __restore_fp</span>
<span class="p_add">+	 add	%o2, %o3, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_o3_sll_6_plus_0x40_fp)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_GS_plus_0x10)</span>
<span class="p_add">+	add	GLOBAL_SPARE, 0x10, GLOBAL_SPARE</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, GLOBAL_SPARE, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_GS_plus_0x10)</span>
<span class="p_add">+ENTRY(U3_retl_o2_plus_GS_plus_0x08)</span>
<span class="p_add">+	add	GLOBAL_SPARE, 0x08, GLOBAL_SPARE</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, GLOBAL_SPARE, %o0</span>
<span class="p_add">+ENDPROC(U3_retl_o2_plus_GS_plus_0x08)</span>
<span class="p_add">+ENTRY(U3_retl_o2_and_7_plus_GS)</span>
<span class="p_add">+	and	%o2, 7, %o2</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, GLOBAL_SPARE, %o2</span>
<span class="p_add">+ENDPROC(U3_retl_o2_and_7_plus_GS)</span>
<span class="p_add">+ENTRY(U3_retl_o2_and_7_plus_GS_plus_8)</span>
<span class="p_add">+	add	GLOBAL_SPARE, 8, GLOBAL_SPARE</span>
<span class="p_add">+	and	%o2, 7, %o2</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, GLOBAL_SPARE, %o2</span>
<span class="p_add">+ENDPROC(U3_retl_o2_and_7_plus_GS_plus_8)</span>
<span class="p_add">+#endif</span>
<span class="p_add">+</span>
 	.align		64
 
 	/* The cheetah&#39;s flexible spine, oversized liver, enlarged heart,
<span class="p_chunk">@@ -126,8 +204,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	 and		%g2, 0x38, %g2
 
 1:	subcc		%g1, 0x1, %g1
<span class="p_del">-	EX_LD_FP(LOAD(ldub, %o1 + 0x00, %o3))</span>
<span class="p_del">-	EX_ST_FP(STORE(stb, %o3, %o1 + GLOBAL_SPARE))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldub, %o1 + 0x00, %o3), U3_retl_o2_plus_g2_plus_g1_plus_1)</span>
<span class="p_add">+	EX_ST_FP(STORE(stb, %o3, %o1 + GLOBAL_SPARE), U3_retl_o2_plus_g2_plus_g1_plus_1)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 0x1, %o1
 
<span class="p_chunk">@@ -138,20 +216,20 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	be,pt		%icc, 3f
 	 alignaddr	%o1, %g0, %o1
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1, %f4))</span>
<span class="p_del">-1:	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f6))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1, %f4), U3_retl_o2_plus_g2)</span>
<span class="p_add">+1:	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f6), U3_retl_o2_plus_g2)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f4, %f6, %f0
<span class="p_del">-	EX_ST_FP(STORE(std, %f0, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f0, %o0), U3_retl_o2_plus_g2_plus_8)</span>
 	be,pn		%icc, 3f
 	 add		%o0, 0x8, %o0
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f4))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x8, %f4), U3_retl_o2_plus_g2)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f6, %f4, %f2
<span class="p_del">-	EX_ST_FP(STORE(std, %f2, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f2, %o0), U3_retl_o2_plus_g2_plus_8)</span>
 	bne,pt		%icc, 1b
 	 add		%o0, 0x8, %o0
 
<span class="p_chunk">@@ -161,25 +239,25 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	LOAD(prefetch, %o1 + 0x080, #one_read)
 	LOAD(prefetch, %o1 + 0x0c0, #one_read)
 	LOAD(prefetch, %o1 + 0x100, #one_read)
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x000, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x000, %f0), U3_retl_o2)</span>
 	LOAD(prefetch, %o1 + 0x140, #one_read)
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2), U3_retl_o2)</span>
 	LOAD(prefetch, %o1 + 0x180, #one_read)
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4), U3_retl_o2)</span>
 	LOAD(prefetch, %o1 + 0x1c0, #one_read)
 	faligndata	%f0, %f2, %f16
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6), U3_retl_o2)</span>
 	faligndata	%f2, %f4, %f18
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8), U3_retl_o2)</span>
 	faligndata	%f4, %f6, %f20
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10), U3_retl_o2)</span>
 	faligndata	%f6, %f8, %f22
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12), U3_retl_o2)</span>
 	faligndata	%f8, %f10, %f24
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14), U3_retl_o2)</span>
 	faligndata	%f10, %f12, %f26
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0), U3_retl_o2)</span>
 
 	subcc		GLOBAL_SPARE, 0x80, GLOBAL_SPARE
 	add		%o1, 0x40, %o1
<span class="p_chunk">@@ -190,26 +268,26 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 	.align		64
 1:
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 	faligndata	%f12, %f14, %f28
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 	faligndata	%f14, %f0, %f30
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f16, %o0))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f16, %o0), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f0, %f2, %f16
 	add		%o0, 0x40, %o0
 
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f2, %f4, %f18
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f4, %f6, %f20
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	subcc		%o3, 0x01, %o3
 	faligndata	%f6, %f8, %f22
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 
 	faligndata	%f8, %f10, %f24
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 	LOAD(prefetch, %o1 + 0x1c0, #one_read)
 	faligndata	%f10, %f12, %f26
 	bg,pt		%XCC, 1b
<span class="p_chunk">@@ -217,29 +295,29 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 	/* Finally we copy the last full 64-byte block. */
 2:
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x008, %f2), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 	faligndata	%f12, %f14, %f28
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x010, %f4), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
 	faligndata	%f14, %f0, %f30
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f16, %o0))</span>
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f16, %o0), U3_retl_o2_plus_o3_sll_6_plus_0x80)</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x018, %f6), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f0, %f2, %f16
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x020, %f8), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f2, %f4, %f18
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x028, %f10), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f4, %f6, %f20
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x030, %f12), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f6, %f8, %f22
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x038, %f14), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	faligndata	%f8, %f10, %f24
 	cmp		%g1, 0
 	be,pt		%XCC, 1f
 	 add		%o0, 0x40, %o0
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x040, %f0), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 1:	faligndata	%f10, %f12, %f26
 	faligndata	%f12, %f14, %f28
 	faligndata	%f14, %f0, %f30
<span class="p_del">-	EX_ST_FP(STORE_BLK(%f16, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE_BLK(%f16, %o0), U3_retl_o2_plus_o3_sll_6_plus_0x40)</span>
 	add		%o0, 0x40, %o0
 	add		%o1, 0x40, %o1
 	membar		#Sync
<span class="p_chunk">@@ -259,20 +337,20 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 	sub		%o2, %g2, %o2
 	be,a,pt		%XCC, 1f
<span class="p_del">-	 EX_LD_FP(LOAD(ldd, %o1 + 0x00, %f0))</span>
<span class="p_add">+	 EX_LD_FP(LOAD(ldd, %o1 + 0x00, %f0), U3_retl_o2_plus_g2)</span>
 
<span class="p_del">-1:	EX_LD_FP(LOAD(ldd, %o1 + 0x08, %f2))</span>
<span class="p_add">+1:	EX_LD_FP(LOAD(ldd, %o1 + 0x08, %f2), U3_retl_o2_plus_g2)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f0, %f2, %f8
<span class="p_del">-	EX_ST_FP(STORE(std, %f8, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f8, %o0), U3_retl_o2_plus_g2_plus_8)</span>
 	be,pn		%XCC, 2f
 	 add		%o0, 0x8, %o0
<span class="p_del">-	EX_LD_FP(LOAD(ldd, %o1 + 0x08, %f0))</span>
<span class="p_add">+	EX_LD_FP(LOAD(ldd, %o1 + 0x08, %f0), U3_retl_o2_plus_g2)</span>
 	add		%o1, 0x8, %o1
 	subcc		%g2, 0x8, %g2
 	faligndata	%f2, %f0, %f8
<span class="p_del">-	EX_ST_FP(STORE(std, %f8, %o0))</span>
<span class="p_add">+	EX_ST_FP(STORE(std, %f8, %o0), U3_retl_o2_plus_g2_plus_8)</span>
 	bne,pn		%XCC, 1b
 	 add		%o0, 0x8, %o0
 
<span class="p_chunk">@@ -292,30 +370,33 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	 andcc		%o2, 0x8, %g0
 	be,pt		%icc, 1f
 	 nop
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %o5), U3_retl_o2)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + %o3), U3_retl_o2)</span>
 	add		%o1, 0x8, %o1
<span class="p_add">+	sub		%o2, 8, %o2</span>
 
 1:	andcc		%o2, 0x4, %g0
 	be,pt		%icc, 1f
 	 nop
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stw, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %o5), U3_retl_o2)</span>
<span class="p_add">+	EX_ST(STORE(stw, %o5, %o1 + %o3), U3_retl_o2)</span>
 	add		%o1, 0x4, %o1
<span class="p_add">+	sub		%o2, 4, %o2</span>
 
 1:	andcc		%o2, 0x2, %g0
 	be,pt		%icc, 1f
 	 nop
<span class="p_del">-	EX_LD(LOAD(lduh, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(sth, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(lduh, %o1, %o5), U3_retl_o2)</span>
<span class="p_add">+	EX_ST(STORE(sth, %o5, %o1 + %o3), U3_retl_o2)</span>
 	add		%o1, 0x2, %o1
<span class="p_add">+	sub		%o2, 2, %o2</span>
 
 1:	andcc		%o2, 0x1, %g0
 	be,pt		%icc, 85f
 	 nop
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %o5))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %o5), U3_retl_o2)</span>
 	ba,pt		%xcc, 85f
<span class="p_del">-	 EX_ST(STORE(stb, %o5, %o1 + %o3))</span>
<span class="p_add">+	 EX_ST(STORE(stb, %o5, %o1 + %o3), U3_retl_o2)</span>
 
 	.align		64
 70: /* 16 &lt; len &lt;= 64 */
<span class="p_chunk">@@ -326,26 +407,26 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	andn		%o2, 0xf, GLOBAL_SPARE
 	and		%o2, 0xf, %o2
 1:	subcc		GLOBAL_SPARE, 0x10, GLOBAL_SPARE
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x00, %o5))</span>
<span class="p_del">-	EX_LD(LOAD(ldx, %o1 + 0x08, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x00, %o5), U3_retl_o2_plus_GS_plus_0x10)</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1 + 0x08, %g1), U3_retl_o2_plus_GS_plus_0x10)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + %o3), U3_retl_o2_plus_GS_plus_0x10)</span>
 	add		%o1, 0x8, %o1
<span class="p_del">-	EX_ST(STORE(stx, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_ST(STORE(stx, %g1, %o1 + %o3), U3_retl_o2_plus_GS_plus_0x08)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 0x8, %o1
 73:	andcc		%o2, 0x8, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%o2, 0x8, %o2
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %o5), U3_retl_o2_plus_8)</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o1 + %o3), U3_retl_o2_plus_8)</span>
 	add		%o1, 0x8, %o1
 1:	andcc		%o2, 0x4, %g0
 	be,pt		%XCC, 1f
 	 nop
 	sub		%o2, 0x4, %o2
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stw, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %o5), U3_retl_o2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %o5, %o1 + %o3), U3_retl_o2_plus_4)</span>
 	add		%o1, 0x4, %o1
 1:	cmp		%o2, 0
 	be,pt		%XCC, 85f
<span class="p_chunk">@@ -361,8 +442,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	sub		%o2, %g1, %o2
 
 1:	subcc		%g1, 1, %g1
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %o5))</span>
<span class="p_del">-	EX_ST(STORE(stb, %o5, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %o5), U3_retl_o2_plus_g1_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %o5, %o1 + %o3), U3_retl_o2_plus_g1_plus_1)</span>
 	bgu,pt		%icc, 1b
 	 add		%o1, 1, %o1
 
<span class="p_chunk">@@ -378,16 +459,16 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 8:	mov		64, %o3
 	andn		%o1, 0x7, %o1
<span class="p_del">-	EX_LD(LOAD(ldx, %o1, %g2))</span>
<span class="p_add">+	EX_LD(LOAD(ldx, %o1, %g2), U3_retl_o2)</span>
 	sub		%o3, %g1, %o3
 	andn		%o2, 0x7, GLOBAL_SPARE
 	sllx		%g2, %g1, %g2
<span class="p_del">-1:	EX_LD(LOAD(ldx, %o1 + 0x8, %g3))</span>
<span class="p_add">+1:	EX_LD(LOAD(ldx, %o1 + 0x8, %g3), U3_retl_o2_and_7_plus_GS)</span>
 	subcc		GLOBAL_SPARE, 0x8, GLOBAL_SPARE
 	add		%o1, 0x8, %o1
 	srlx		%g3, %o3, %o5
 	or		%o5, %g2, %o5
<span class="p_del">-	EX_ST(STORE(stx, %o5, %o0))</span>
<span class="p_add">+	EX_ST(STORE(stx, %o5, %o0), U3_retl_o2_and_7_plus_GS_plus_8)</span>
 	add		%o0, 0x8, %o0
 	bgu,pt		%icc, 1b
 	 sllx		%g3, %g1, %g2
<span class="p_chunk">@@ -407,8 +488,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 
 1:
 	subcc		%o2, 4, %o2
<span class="p_del">-	EX_LD(LOAD(lduw, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stw, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(lduw, %o1, %g1), U3_retl_o2_plus_4)</span>
<span class="p_add">+	EX_ST(STORE(stw, %g1, %o1 + %o3), U3_retl_o2_plus_4)</span>
 	bgu,pt		%XCC, 1b
 	 add		%o1, 4, %o1
 
<span class="p_chunk">@@ -418,8 +499,8 @@</span> <span class="p_context"> FUNC_NAME:	/* %o0=dst, %o1=src, %o2=len */</span>
 	.align		32
 90:
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX_LD(LOAD(ldub, %o1, %g1))</span>
<span class="p_del">-	EX_ST(STORE(stb, %g1, %o1 + %o3))</span>
<span class="p_add">+	EX_LD(LOAD(ldub, %o1, %g1), U3_retl_o2_plus_1)</span>
<span class="p_add">+	EX_ST(STORE(stb, %g1, %o1 + %o3), U3_retl_o2_plus_1)</span>
 	bgu,pt		%XCC, 90b
 	 add		%o1, 1, %o1
 	retl
<span class="p_header">diff --git a/arch/sparc/lib/copy_in_user.S b/arch/sparc/lib/copy_in_user.S</span>
<span class="p_header">index 302c0e60dc2c..4c89b486fa0d 100644</span>
<span class="p_header">--- a/arch/sparc/lib/copy_in_user.S</span>
<span class="p_header">+++ b/arch/sparc/lib/copy_in_user.S</span>
<span class="p_chunk">@@ -8,18 +8,33 @@</span> <span class="p_context"></span>
 
 #define XCC xcc
 
<span class="p_del">-#define EX(x,y)			\</span>
<span class="p_add">+#define EX(x,y,z)		\</span>
 98:	x,y;			\
 	.section __ex_table,&quot;a&quot;;\
 	.align 4;		\
<span class="p_del">-	.word 98b, __retl_one;	\</span>
<span class="p_add">+	.word 98b, z;		\</span>
 	.text;			\
 	.align 4;
 
<span class="p_add">+#define EX_O4(x,y) EX(x,y,__retl_o4_plus_8)</span>
<span class="p_add">+#define EX_O2_4(x,y) EX(x,y,__retl_o2_plus_4)</span>
<span class="p_add">+#define EX_O2_1(x,y) EX(x,y,__retl_o2_plus_1)</span>
<span class="p_add">+</span>
 	.register	%g2,#scratch
 	.register	%g3,#scratch
 
 	.text
<span class="p_add">+__retl_o4_plus_8:</span>
<span class="p_add">+	add	%o4, %o2, %o4</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o4, 8, %o0</span>
<span class="p_add">+__retl_o2_plus_4:</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 4, %o0</span>
<span class="p_add">+__retl_o2_plus_1:</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 add	%o2, 1, %o0</span>
<span class="p_add">+</span>
 	.align	32
 
 	/* Don&#39;t try to get too fancy here, just nice and
<span class="p_chunk">@@ -44,8 +59,8 @@</span> <span class="p_context"> ENTRY(___copy_in_user)	/* %o0=dst, %o1=src, %o2=len */</span>
 	andn		%o2, 0x7, %o4
 	and		%o2, 0x7, %o2
 1:	subcc		%o4, 0x8, %o4
<span class="p_del">-	EX(ldxa [%o1] %asi, %o5)</span>
<span class="p_del">-	EX(stxa %o5, [%o0] %asi)</span>
<span class="p_add">+	EX_O4(ldxa [%o1] %asi, %o5)</span>
<span class="p_add">+	EX_O4(stxa %o5, [%o0] %asi)</span>
 	add		%o1, 0x8, %o1
 	bgu,pt		%XCC, 1b
 	 add		%o0, 0x8, %o0
<span class="p_chunk">@@ -53,8 +68,8 @@</span> <span class="p_context"> ENTRY(___copy_in_user)	/* %o0=dst, %o1=src, %o2=len */</span>
 	be,pt		%XCC, 1f
 	 nop
 	sub		%o2, 0x4, %o2
<span class="p_del">-	EX(lduwa [%o1] %asi, %o5)</span>
<span class="p_del">-	EX(stwa %o5, [%o0] %asi)</span>
<span class="p_add">+	EX_O2_4(lduwa [%o1] %asi, %o5)</span>
<span class="p_add">+	EX_O2_4(stwa %o5, [%o0] %asi)</span>
 	add		%o1, 0x4, %o1
 	add		%o0, 0x4, %o0
 1:	cmp		%o2, 0
<span class="p_chunk">@@ -70,8 +85,8 @@</span> <span class="p_context"> ENTRY(___copy_in_user)	/* %o0=dst, %o1=src, %o2=len */</span>
 
 82:
 	subcc		%o2, 4, %o2
<span class="p_del">-	EX(lduwa [%o1] %asi, %g1)</span>
<span class="p_del">-	EX(stwa %g1, [%o0] %asi)</span>
<span class="p_add">+	EX_O2_4(lduwa [%o1] %asi, %g1)</span>
<span class="p_add">+	EX_O2_4(stwa %g1, [%o0] %asi)</span>
 	add		%o1, 4, %o1
 	bgu,pt		%XCC, 82b
 	 add		%o0, 4, %o0
<span class="p_chunk">@@ -82,8 +97,8 @@</span> <span class="p_context"> ENTRY(___copy_in_user)	/* %o0=dst, %o1=src, %o2=len */</span>
 	.align	32
 90:
 	subcc		%o2, 1, %o2
<span class="p_del">-	EX(lduba [%o1] %asi, %g1)</span>
<span class="p_del">-	EX(stba %g1, [%o0] %asi)</span>
<span class="p_add">+	EX_O2_1(lduba [%o1] %asi, %g1)</span>
<span class="p_add">+	EX_O2_1(stba %g1, [%o0] %asi)</span>
 	add		%o1, 1, %o1
 	bgu,pt		%XCC, 90b
 	 add		%o0, 1, %o0
<span class="p_header">diff --git a/arch/sparc/lib/user_fixup.c b/arch/sparc/lib/user_fixup.c</span>
deleted file mode 100644
<span class="p_header">index ac96ae236709..000000000000</span>
<span class="p_header">--- a/arch/sparc/lib/user_fixup.c</span>
<span class="p_header">+++ /dev/null</span>
<span class="p_chunk">@@ -1,71 +0,0 @@</span> <span class="p_context"></span>
<span class="p_del">-/* user_fixup.c: Fix up user copy faults.</span>
<span class="p_del">- *</span>
<span class="p_del">- * Copyright (C) 2004 David S. Miller &lt;davem@redhat.com&gt;</span>
<span class="p_del">- */</span>
<span class="p_del">-</span>
<span class="p_del">-#include &lt;linux/compiler.h&gt;</span>
<span class="p_del">-#include &lt;linux/kernel.h&gt;</span>
<span class="p_del">-#include &lt;linux/string.h&gt;</span>
<span class="p_del">-#include &lt;linux/errno.h&gt;</span>
<span class="p_del">-#include &lt;linux/module.h&gt;</span>
<span class="p_del">-</span>
<span class="p_del">-#include &lt;asm/uaccess.h&gt;</span>
<span class="p_del">-</span>
<span class="p_del">-/* Calculating the exact fault address when using</span>
<span class="p_del">- * block loads and stores can be very complicated.</span>
<span class="p_del">- *</span>
<span class="p_del">- * Instead of trying to be clever and handling all</span>
<span class="p_del">- * of the cases, just fix things up simply here.</span>
<span class="p_del">- */</span>
<span class="p_del">-</span>
<span class="p_del">-static unsigned long compute_size(unsigned long start, unsigned long size, unsigned long *offset)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned long fault_addr = current_thread_info()-&gt;fault_address;</span>
<span class="p_del">-	unsigned long end = start + size;</span>
<span class="p_del">-</span>
<span class="p_del">-	if (fault_addr &lt; start || fault_addr &gt;= end) {</span>
<span class="p_del">-		*offset = 0;</span>
<span class="p_del">-	} else {</span>
<span class="p_del">-		*offset = fault_addr - start;</span>
<span class="p_del">-		size = end - fault_addr;</span>
<span class="p_del">-	}</span>
<span class="p_del">-	return size;</span>
<span class="p_del">-}</span>
<span class="p_del">-</span>
<span class="p_del">-unsigned long copy_from_user_fixup(void *to, const void __user *from, unsigned long size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned long offset;</span>
<span class="p_del">-</span>
<span class="p_del">-	size = compute_size((unsigned long) from, size, &amp;offset);</span>
<span class="p_del">-	if (likely(size))</span>
<span class="p_del">-		memset(to + offset, 0, size);</span>
<span class="p_del">-</span>
<span class="p_del">-	return size;</span>
<span class="p_del">-}</span>
<span class="p_del">-EXPORT_SYMBOL(copy_from_user_fixup);</span>
<span class="p_del">-</span>
<span class="p_del">-unsigned long copy_to_user_fixup(void __user *to, const void *from, unsigned long size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned long offset;</span>
<span class="p_del">-</span>
<span class="p_del">-	return compute_size((unsigned long) to, size, &amp;offset);</span>
<span class="p_del">-}</span>
<span class="p_del">-EXPORT_SYMBOL(copy_to_user_fixup);</span>
<span class="p_del">-</span>
<span class="p_del">-unsigned long copy_in_user_fixup(void __user *to, void __user *from, unsigned long size)</span>
<span class="p_del">-{</span>
<span class="p_del">-	unsigned long fault_addr = current_thread_info()-&gt;fault_address;</span>
<span class="p_del">-	unsigned long start = (unsigned long) to;</span>
<span class="p_del">-	unsigned long end = start + size;</span>
<span class="p_del">-</span>
<span class="p_del">-	if (fault_addr &gt;= start &amp;&amp; fault_addr &lt; end)</span>
<span class="p_del">-		return end - fault_addr;</span>
<span class="p_del">-</span>
<span class="p_del">-	start = (unsigned long) from;</span>
<span class="p_del">-	end = start + size;</span>
<span class="p_del">-	if (fault_addr &gt;= start &amp;&amp; fault_addr &lt; end)</span>
<span class="p_del">-		return end - fault_addr;</span>
<span class="p_del">-</span>
<span class="p_del">-	return size;</span>
<span class="p_del">-}</span>
<span class="p_del">-EXPORT_SYMBOL(copy_in_user_fixup);</span>
<span class="p_header">diff --git a/arch/sparc/mm/fault_64.c b/arch/sparc/mm/fault_64.c</span>
<span class="p_header">index dbabe5713a15..e15f33715103 100644</span>
<span class="p_header">--- a/arch/sparc/mm/fault_64.c</span>
<span class="p_header">+++ b/arch/sparc/mm/fault_64.c</span>
<span class="p_chunk">@@ -479,14 +479,14 @@</span> <span class="p_context"> good_area:</span>
 	up_read(&amp;mm-&gt;mmap_sem);
 
 	mm_rss = get_mm_rss(mm);
<span class="p_del">-#if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)</span>
<span class="p_del">-	mm_rss -= (mm-&gt;context.huge_pte_count * (HPAGE_SIZE / PAGE_SIZE));</span>
<span class="p_add">+#if defined(CONFIG_TRANSPARENT_HUGEPAGE)</span>
<span class="p_add">+	mm_rss -= (mm-&gt;context.thp_pte_count * (HPAGE_SIZE / PAGE_SIZE));</span>
 #endif
 	if (unlikely(mm_rss &gt;
 		     mm-&gt;context.tsb_block[MM_TSB_BASE].tsb_rss_limit))
 		tsb_grow(mm, MM_TSB_BASE, mm_rss);
 #if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)
<span class="p_del">-	mm_rss = mm-&gt;context.huge_pte_count;</span>
<span class="p_add">+	mm_rss = mm-&gt;context.hugetlb_pte_count + mm-&gt;context.thp_pte_count;</span>
 	if (unlikely(mm_rss &gt;
 		     mm-&gt;context.tsb_block[MM_TSB_HUGE].tsb_rss_limit)) {
 		if (mm-&gt;context.tsb_block[MM_TSB_HUGE].tsb)
<span class="p_header">diff --git a/arch/sparc/mm/hugetlbpage.c b/arch/sparc/mm/hugetlbpage.c</span>
<span class="p_header">index 364d093f46c6..da1142401bf4 100644</span>
<span class="p_header">--- a/arch/sparc/mm/hugetlbpage.c</span>
<span class="p_header">+++ b/arch/sparc/mm/hugetlbpage.c</span>
<span class="p_chunk">@@ -180,7 +180,7 @@</span> <span class="p_context"> void set_huge_pte_at(struct mm_struct *mm, unsigned long addr,</span>
 	unsigned long nptes;
 
 	if (!pte_present(*ptep) &amp;&amp; pte_present(entry))
<span class="p_del">-		mm-&gt;context.huge_pte_count++;</span>
<span class="p_add">+		mm-&gt;context.hugetlb_pte_count++;</span>
 
 	addr &amp;= HPAGE_MASK;
 
<span class="p_chunk">@@ -212,7 +212,7 @@</span> <span class="p_context"> pte_t huge_ptep_get_and_clear(struct mm_struct *mm, unsigned long addr,</span>
 
 	entry = *ptep;
 	if (pte_present(entry))
<span class="p_del">-		mm-&gt;context.huge_pte_count--;</span>
<span class="p_add">+		mm-&gt;context.hugetlb_pte_count--;</span>
 
 	addr &amp;= HPAGE_MASK;
 	nptes = 1 &lt;&lt; HUGETLB_PAGE_ORDER;
<span class="p_header">diff --git a/arch/sparc/mm/init_64.c b/arch/sparc/mm/init_64.c</span>
<span class="p_header">index 3c4b8975fa76..a5331c336b2a 100644</span>
<span class="p_header">--- a/arch/sparc/mm/init_64.c</span>
<span class="p_header">+++ b/arch/sparc/mm/init_64.c</span>
<span class="p_chunk">@@ -346,7 +346,8 @@</span> <span class="p_context"> void update_mmu_cache(struct vm_area_struct *vma, unsigned long address, pte_t *</span>
 	spin_lock_irqsave(&amp;mm-&gt;context.lock, flags);
 
 #if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)
<span class="p_del">-	if (mm-&gt;context.huge_pte_count &amp;&amp; is_hugetlb_pte(pte))</span>
<span class="p_add">+	if ((mm-&gt;context.hugetlb_pte_count || mm-&gt;context.thp_pte_count) &amp;&amp;</span>
<span class="p_add">+	    is_hugetlb_pte(pte))</span>
 		__update_mmu_tsb_insert(mm, MM_TSB_HUGE, REAL_HPAGE_SHIFT,
 					address, pte_val(pte));
 	else
<span class="p_header">diff --git a/arch/sparc/mm/tlb.c b/arch/sparc/mm/tlb.c</span>
<span class="p_header">index f81cd9736700..3659d37b4d81 100644</span>
<span class="p_header">--- a/arch/sparc/mm/tlb.c</span>
<span class="p_header">+++ b/arch/sparc/mm/tlb.c</span>
<span class="p_chunk">@@ -175,9 +175,9 @@</span> <span class="p_context"> void set_pmd_at(struct mm_struct *mm, unsigned long addr,</span>
 
 	if ((pmd_val(pmd) ^ pmd_val(orig)) &amp; _PAGE_PMD_HUGE) {
 		if (pmd_val(pmd) &amp; _PAGE_PMD_HUGE)
<span class="p_del">-			mm-&gt;context.huge_pte_count++;</span>
<span class="p_add">+			mm-&gt;context.thp_pte_count++;</span>
 		else
<span class="p_del">-			mm-&gt;context.huge_pte_count--;</span>
<span class="p_add">+			mm-&gt;context.thp_pte_count--;</span>
 
 		/* Do not try to allocate the TSB hash table if we
 		 * don&#39;t have one already.  We have various locks held
<span class="p_header">diff --git a/arch/sparc/mm/tsb.c b/arch/sparc/mm/tsb.c</span>
<span class="p_header">index a0604a493a36..9cdeca0fa955 100644</span>
<span class="p_header">--- a/arch/sparc/mm/tsb.c</span>
<span class="p_header">+++ b/arch/sparc/mm/tsb.c</span>
<span class="p_chunk">@@ -27,6 +27,20 @@</span> <span class="p_context"> static inline int tag_compare(unsigned long tag, unsigned long vaddr)</span>
 	return (tag == (vaddr &gt;&gt; 22));
 }
 
<span class="p_add">+static void flush_tsb_kernel_range_scan(unsigned long start, unsigned long end)</span>
<span class="p_add">+{</span>
<span class="p_add">+	unsigned long idx;</span>
<span class="p_add">+</span>
<span class="p_add">+	for (idx = 0; idx &lt; KERNEL_TSB_NENTRIES; idx++) {</span>
<span class="p_add">+		struct tsb *ent = &amp;swapper_tsb[idx];</span>
<span class="p_add">+		unsigned long match = idx &lt;&lt; 13;</span>
<span class="p_add">+</span>
<span class="p_add">+		match |= (ent-&gt;tag &lt;&lt; 22);</span>
<span class="p_add">+		if (match &gt;= start &amp;&amp; match &lt; end)</span>
<span class="p_add">+			ent-&gt;tag = (1UL &lt;&lt; TSB_TAG_INVALID_BIT);</span>
<span class="p_add">+	}</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 /* TSB flushes need only occur on the processor initiating the address
  * space modification, not on each cpu the address space has run on.
  * Only the TLB flush needs that treatment.
<span class="p_chunk">@@ -36,6 +50,9 @@</span> <span class="p_context"> void flush_tsb_kernel_range(unsigned long start, unsigned long end)</span>
 {
 	unsigned long v;
 
<span class="p_add">+	if ((end - start) &gt;&gt; PAGE_SHIFT &gt;= 2 * KERNEL_TSB_NENTRIES)</span>
<span class="p_add">+		return flush_tsb_kernel_range_scan(start, end);</span>
<span class="p_add">+</span>
 	for (v = start; v &lt; end; v += PAGE_SIZE) {
 		unsigned long hash = tsb_hash(v, PAGE_SHIFT,
 					      KERNEL_TSB_NENTRIES);
<span class="p_chunk">@@ -470,7 +487,7 @@</span> <span class="p_context"> retry_tsb_alloc:</span>
 int init_new_context(struct task_struct *tsk, struct mm_struct *mm)
 {
 #if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)
<span class="p_del">-	unsigned long huge_pte_count;</span>
<span class="p_add">+	unsigned long total_huge_pte_count;</span>
 #endif
 	unsigned int i;
 
<span class="p_chunk">@@ -479,12 +496,14 @@</span> <span class="p_context"> int init_new_context(struct task_struct *tsk, struct mm_struct *mm)</span>
 	mm-&gt;context.sparc64_ctx_val = 0UL;
 
 #if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)
<span class="p_del">-	/* We reset it to zero because the fork() page copying</span>
<span class="p_add">+	/* We reset them to zero because the fork() page copying</span>
 	 * will re-increment the counters as the parent PTEs are
 	 * copied into the child address space.
 	 */
<span class="p_del">-	huge_pte_count = mm-&gt;context.huge_pte_count;</span>
<span class="p_del">-	mm-&gt;context.huge_pte_count = 0;</span>
<span class="p_add">+	total_huge_pte_count = mm-&gt;context.hugetlb_pte_count +</span>
<span class="p_add">+			 mm-&gt;context.thp_pte_count;</span>
<span class="p_add">+	mm-&gt;context.hugetlb_pte_count = 0;</span>
<span class="p_add">+	mm-&gt;context.thp_pte_count = 0;</span>
 #endif
 
 	/* copy_mm() copies over the parent&#39;s mm_struct before calling
<span class="p_chunk">@@ -500,8 +519,8 @@</span> <span class="p_context"> int init_new_context(struct task_struct *tsk, struct mm_struct *mm)</span>
 	tsb_grow(mm, MM_TSB_BASE, get_mm_rss(mm));
 
 #if defined(CONFIG_HUGETLB_PAGE) || defined(CONFIG_TRANSPARENT_HUGEPAGE)
<span class="p_del">-	if (unlikely(huge_pte_count))</span>
<span class="p_del">-		tsb_grow(mm, MM_TSB_HUGE, huge_pte_count);</span>
<span class="p_add">+	if (unlikely(total_huge_pte_count))</span>
<span class="p_add">+		tsb_grow(mm, MM_TSB_HUGE, total_huge_pte_count);</span>
 #endif
 
 	if (unlikely(!mm-&gt;context.tsb_block[MM_TSB_BASE].tsb))
<span class="p_header">diff --git a/arch/sparc/mm/ultra.S b/arch/sparc/mm/ultra.S</span>
<span class="p_header">index b4f4733abc6e..5d2fd6cd3189 100644</span>
<span class="p_header">--- a/arch/sparc/mm/ultra.S</span>
<span class="p_header">+++ b/arch/sparc/mm/ultra.S</span>
<span class="p_chunk">@@ -30,7 +30,7 @@</span> <span class="p_context"></span>
 	.text
 	.align		32
 	.globl		__flush_tlb_mm
<span class="p_del">-__flush_tlb_mm:		/* 18 insns */</span>
<span class="p_add">+__flush_tlb_mm:		/* 19 insns */</span>
 	/* %o0=(ctx &amp; TAG_CONTEXT_BITS), %o1=SECONDARY_CONTEXT */
 	ldxa		[%o1] ASI_DMMU, %g2
 	cmp		%g2, %o0
<span class="p_chunk">@@ -81,7 +81,7 @@</span> <span class="p_context"> __flush_tlb_page:	/* 22 insns */</span>
 
 	.align		32
 	.globl		__flush_tlb_pending
<span class="p_del">-__flush_tlb_pending:	/* 26 insns */</span>
<span class="p_add">+__flush_tlb_pending:	/* 27 insns */</span>
 	/* %o0 = context, %o1 = nr, %o2 = vaddrs[] */
 	rdpr		%pstate, %g7
 	sllx		%o1, 3, %o1
<span class="p_chunk">@@ -113,12 +113,14 @@</span> <span class="p_context"> __flush_tlb_pending:	/* 26 insns */</span>
 
 	.align		32
 	.globl		__flush_tlb_kernel_range
<span class="p_del">-__flush_tlb_kernel_range:	/* 16 insns */</span>
<span class="p_add">+__flush_tlb_kernel_range:	/* 31 insns */</span>
 	/* %o0=start, %o1=end */
 	cmp		%o0, %o1
 	be,pn		%xcc, 2f
<span class="p_add">+	 sub		%o1, %o0, %o3</span>
<span class="p_add">+	srlx		%o3, 18, %o4</span>
<span class="p_add">+	brnz,pn		%o4, __spitfire_flush_tlb_kernel_range_slow</span>
 	 sethi		%hi(PAGE_SIZE), %o4
<span class="p_del">-	sub		%o1, %o0, %o3</span>
 	sub		%o3, %o4, %o3
 	or		%o0, 0x20, %o0		! Nucleus
 1:	stxa		%g0, [%o0 + %o3] ASI_DMMU_DEMAP
<span class="p_chunk">@@ -131,6 +133,41 @@</span> <span class="p_context"> __flush_tlb_kernel_range:	/* 16 insns */</span>
 	retl
 	 nop
 	nop
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+</span>
<span class="p_add">+__spitfire_flush_tlb_kernel_range_slow:</span>
<span class="p_add">+	mov		63 * 8, %o4</span>
<span class="p_add">+1:	ldxa		[%o4] ASI_ITLB_DATA_ACCESS, %o3</span>
<span class="p_add">+	andcc		%o3, 0x40, %g0			/* _PAGE_L_4U */</span>
<span class="p_add">+	bne,pn		%xcc, 2f</span>
<span class="p_add">+	 mov		TLB_TAG_ACCESS, %o3</span>
<span class="p_add">+	stxa		%g0, [%o3] ASI_IMMU</span>
<span class="p_add">+	stxa		%g0, [%o4] ASI_ITLB_DATA_ACCESS</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+2:	ldxa		[%o4] ASI_DTLB_DATA_ACCESS, %o3</span>
<span class="p_add">+	andcc		%o3, 0x40, %g0</span>
<span class="p_add">+	bne,pn		%xcc, 2f</span>
<span class="p_add">+	 mov		TLB_TAG_ACCESS, %o3</span>
<span class="p_add">+	stxa		%g0, [%o3] ASI_DMMU</span>
<span class="p_add">+	stxa		%g0, [%o4] ASI_DTLB_DATA_ACCESS</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+2:	sub		%o4, 8, %o4</span>
<span class="p_add">+	brgez,pt	%o4, 1b</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 nop</span>
 
 __spitfire_flush_tlb_mm_slow:
 	rdpr		%pstate, %g1
<span class="p_chunk">@@ -285,6 +322,40 @@</span> <span class="p_context"> __cheetah_flush_tlb_pending:	/* 27 insns */</span>
 	retl
 	 wrpr		%g7, 0x0, %pstate
 
<span class="p_add">+__cheetah_flush_tlb_kernel_range:	/* 31 insns */</span>
<span class="p_add">+	/* %o0=start, %o1=end */</span>
<span class="p_add">+	cmp		%o0, %o1</span>
<span class="p_add">+	be,pn		%xcc, 2f</span>
<span class="p_add">+	 sub		%o1, %o0, %o3</span>
<span class="p_add">+	srlx		%o3, 18, %o4</span>
<span class="p_add">+	brnz,pn		%o4, 3f</span>
<span class="p_add">+	 sethi		%hi(PAGE_SIZE), %o4</span>
<span class="p_add">+	sub		%o3, %o4, %o3</span>
<span class="p_add">+	or		%o0, 0x20, %o0		! Nucleus</span>
<span class="p_add">+1:	stxa		%g0, [%o0 + %o3] ASI_DMMU_DEMAP</span>
<span class="p_add">+	stxa		%g0, [%o0 + %o3] ASI_IMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	brnz,pt		%o3, 1b</span>
<span class="p_add">+	 sub		%o3, %o4, %o3</span>
<span class="p_add">+2:	sethi		%hi(KERNBASE), %o3</span>
<span class="p_add">+	flush		%o3</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+3:	mov		0x80, %o4</span>
<span class="p_add">+	stxa		%g0, [%o4] ASI_DMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	stxa		%g0, [%o4] ASI_IMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+</span>
 #ifdef DCACHE_ALIASING_POSSIBLE
 __cheetah_flush_dcache_page: /* 11 insns */
 	sethi		%hi(PAGE_OFFSET), %g1
<span class="p_chunk">@@ -309,19 +380,28 @@</span> <span class="p_context"> __hypervisor_tlb_tl0_error:</span>
 	ret
 	 restore
 
<span class="p_del">-__hypervisor_flush_tlb_mm: /* 10 insns */</span>
<span class="p_add">+__hypervisor_flush_tlb_mm: /* 19 insns */</span>
 	mov		%o0, %o2	/* ARG2: mmu context */
 	mov		0, %o0		/* ARG0: CPU lists unimplemented */
 	mov		0, %o1		/* ARG1: CPU lists unimplemented */
 	mov		HV_MMU_ALL, %o3	/* ARG3: flags */
 	mov		HV_FAST_MMU_DEMAP_CTX, %o5
 	ta		HV_FAST_TRAP
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_tl0_error</span>
<span class="p_add">+	brnz,pn		%o0, 1f</span>
 	 mov		HV_FAST_MMU_DEMAP_CTX, %o1
 	retl
 	 nop
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_tl0_error), %o5</span>
<span class="p_add">+	jmpl		%o5 + %lo(__hypervisor_tlb_tl0_error), %g0</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
 
<span class="p_del">-__hypervisor_flush_tlb_page: /* 11 insns */</span>
<span class="p_add">+__hypervisor_flush_tlb_page: /* 22 insns */</span>
 	/* %o0 = context, %o1 = vaddr */
 	mov		%o0, %g2
 	mov		%o1, %o0              /* ARG0: vaddr + IMMU-bit */
<span class="p_chunk">@@ -330,12 +410,23 @@</span> <span class="p_context"> __hypervisor_flush_tlb_page: /* 11 insns */</span>
 	srlx		%o0, PAGE_SHIFT, %o0
 	sllx		%o0, PAGE_SHIFT, %o0
 	ta		HV_MMU_UNMAP_ADDR_TRAP
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_tl0_error</span>
<span class="p_add">+	brnz,pn		%o0, 1f</span>
 	 mov		HV_MMU_UNMAP_ADDR_TRAP, %o1
 	retl
 	 nop
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_tl0_error), %o2</span>
<span class="p_add">+	jmpl		%o2 + %lo(__hypervisor_tlb_tl0_error), %g0</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
 
<span class="p_del">-__hypervisor_flush_tlb_pending: /* 16 insns */</span>
<span class="p_add">+__hypervisor_flush_tlb_pending: /* 27 insns */</span>
 	/* %o0 = context, %o1 = nr, %o2 = vaddrs[] */
 	sllx		%o1, 3, %g1
 	mov		%o2, %g2
<span class="p_chunk">@@ -347,31 +438,57 @@</span> <span class="p_context"> __hypervisor_flush_tlb_pending: /* 16 insns */</span>
 	srlx		%o0, PAGE_SHIFT, %o0
 	sllx		%o0, PAGE_SHIFT, %o0
 	ta		HV_MMU_UNMAP_ADDR_TRAP
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_tl0_error</span>
<span class="p_add">+	brnz,pn		%o0, 1f</span>
 	 mov		HV_MMU_UNMAP_ADDR_TRAP, %o1
 	brnz,pt		%g1, 1b
 	 nop
 	retl
 	 nop
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_tl0_error), %o2</span>
<span class="p_add">+	jmpl		%o2 + %lo(__hypervisor_tlb_tl0_error), %g0</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
 
<span class="p_del">-__hypervisor_flush_tlb_kernel_range: /* 16 insns */</span>
<span class="p_add">+__hypervisor_flush_tlb_kernel_range: /* 31 insns */</span>
 	/* %o0=start, %o1=end */
 	cmp		%o0, %o1
 	be,pn		%xcc, 2f
<span class="p_del">-	 sethi		%hi(PAGE_SIZE), %g3</span>
<span class="p_del">-	mov		%o0, %g1</span>
<span class="p_del">-	sub		%o1, %g1, %g2</span>
<span class="p_add">+	 sub		%o1, %o0, %g2</span>
<span class="p_add">+	srlx		%g2, 18, %g3</span>
<span class="p_add">+	brnz,pn		%g3, 4f</span>
<span class="p_add">+	 mov		%o0, %g1</span>
<span class="p_add">+	sethi		%hi(PAGE_SIZE), %g3</span>
 	sub		%g2, %g3, %g2
 1:	add		%g1, %g2, %o0	/* ARG0: virtual address */
 	mov		0, %o1		/* ARG1: mmu context */
 	mov		HV_MMU_ALL, %o2	/* ARG2: flags */
 	ta		HV_MMU_UNMAP_ADDR_TRAP
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_tl0_error</span>
<span class="p_add">+	brnz,pn		%o0, 3f</span>
 	 mov		HV_MMU_UNMAP_ADDR_TRAP, %o1
 	brnz,pt		%g2, 1b
 	 sub		%g2, %g3, %g2
 2:	retl
 	 nop
<span class="p_add">+3:	sethi		%hi(__hypervisor_tlb_tl0_error), %o2</span>
<span class="p_add">+	jmpl		%o2 + %lo(__hypervisor_tlb_tl0_error), %g0</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+4:	mov		0, %o0		/* ARG0: CPU lists unimplemented */</span>
<span class="p_add">+	mov		0, %o1		/* ARG1: CPU lists unimplemented */</span>
<span class="p_add">+	mov		0, %o2		/* ARG2: mmu context == nucleus */</span>
<span class="p_add">+	mov		HV_MMU_ALL, %o3	/* ARG3: flags */</span>
<span class="p_add">+	mov		HV_FAST_MMU_DEMAP_CTX, %o5</span>
<span class="p_add">+	ta		HV_FAST_TRAP</span>
<span class="p_add">+	brnz,pn		%o0, 3b</span>
<span class="p_add">+	 mov		HV_FAST_MMU_DEMAP_CTX, %o1</span>
<span class="p_add">+	retl</span>
<span class="p_add">+	 nop</span>
 
 #ifdef DCACHE_ALIASING_POSSIBLE
 	/* XXX Niagara and friends have an 8K cache, so no aliasing is
<span class="p_chunk">@@ -394,43 +511,6 @@</span> <span class="p_context"> tlb_patch_one:</span>
 	retl
 	 nop
 
<span class="p_del">-	.globl		cheetah_patch_cachetlbops</span>
<span class="p_del">-cheetah_patch_cachetlbops:</span>
<span class="p_del">-	save		%sp, -128, %sp</span>
<span class="p_del">-</span>
<span class="p_del">-	sethi		%hi(__flush_tlb_mm), %o0</span>
<span class="p_del">-	or		%o0, %lo(__flush_tlb_mm), %o0</span>
<span class="p_del">-	sethi		%hi(__cheetah_flush_tlb_mm), %o1</span>
<span class="p_del">-	or		%o1, %lo(__cheetah_flush_tlb_mm), %o1</span>
<span class="p_del">-	call		tlb_patch_one</span>
<span class="p_del">-	 mov		19, %o2</span>
<span class="p_del">-</span>
<span class="p_del">-	sethi		%hi(__flush_tlb_page), %o0</span>
<span class="p_del">-	or		%o0, %lo(__flush_tlb_page), %o0</span>
<span class="p_del">-	sethi		%hi(__cheetah_flush_tlb_page), %o1</span>
<span class="p_del">-	or		%o1, %lo(__cheetah_flush_tlb_page), %o1</span>
<span class="p_del">-	call		tlb_patch_one</span>
<span class="p_del">-	 mov		22, %o2</span>
<span class="p_del">-</span>
<span class="p_del">-	sethi		%hi(__flush_tlb_pending), %o0</span>
<span class="p_del">-	or		%o0, %lo(__flush_tlb_pending), %o0</span>
<span class="p_del">-	sethi		%hi(__cheetah_flush_tlb_pending), %o1</span>
<span class="p_del">-	or		%o1, %lo(__cheetah_flush_tlb_pending), %o1</span>
<span class="p_del">-	call		tlb_patch_one</span>
<span class="p_del">-	 mov		27, %o2</span>
<span class="p_del">-</span>
<span class="p_del">-#ifdef DCACHE_ALIASING_POSSIBLE</span>
<span class="p_del">-	sethi		%hi(__flush_dcache_page), %o0</span>
<span class="p_del">-	or		%o0, %lo(__flush_dcache_page), %o0</span>
<span class="p_del">-	sethi		%hi(__cheetah_flush_dcache_page), %o1</span>
<span class="p_del">-	or		%o1, %lo(__cheetah_flush_dcache_page), %o1</span>
<span class="p_del">-	call		tlb_patch_one</span>
<span class="p_del">-	 mov		11, %o2</span>
<span class="p_del">-#endif /* DCACHE_ALIASING_POSSIBLE */</span>
<span class="p_del">-</span>
<span class="p_del">-	ret</span>
<span class="p_del">-	 restore</span>
<span class="p_del">-</span>
 #ifdef CONFIG_SMP
 	/* These are all called by the slaves of a cross call, at
 	 * trap level 1, with interrupts fully disabled.
<span class="p_chunk">@@ -447,7 +527,7 @@</span> <span class="p_context"> cheetah_patch_cachetlbops:</span>
 	 */
 	.align		32
 	.globl		xcall_flush_tlb_mm
<span class="p_del">-xcall_flush_tlb_mm:	/* 21 insns */</span>
<span class="p_add">+xcall_flush_tlb_mm:	/* 24 insns */</span>
 	mov		PRIMARY_CONTEXT, %g2
 	ldxa		[%g2] ASI_DMMU, %g3
 	srlx		%g3, CTX_PGSZ1_NUC_SHIFT, %g4
<span class="p_chunk">@@ -469,9 +549,12 @@</span> <span class="p_context"> xcall_flush_tlb_mm:	/* 21 insns */</span>
 	nop
 	nop
 	nop
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
 
 	.globl		xcall_flush_tlb_page
<span class="p_del">-xcall_flush_tlb_page:	/* 17 insns */</span>
<span class="p_add">+xcall_flush_tlb_page:	/* 20 insns */</span>
 	/* %g5=context, %g1=vaddr */
 	mov		PRIMARY_CONTEXT, %g4
 	ldxa		[%g4] ASI_DMMU, %g2
<span class="p_chunk">@@ -490,15 +573,20 @@</span> <span class="p_context"> xcall_flush_tlb_page:	/* 17 insns */</span>
 	retry
 	nop
 	nop
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
 
 	.globl		xcall_flush_tlb_kernel_range
<span class="p_del">-xcall_flush_tlb_kernel_range:	/* 25 insns */</span>
<span class="p_add">+xcall_flush_tlb_kernel_range:	/* 44 insns */</span>
 	sethi		%hi(PAGE_SIZE - 1), %g2
 	or		%g2, %lo(PAGE_SIZE - 1), %g2
 	andn		%g1, %g2, %g1
 	andn		%g7, %g2, %g7
 	sub		%g7, %g1, %g3
<span class="p_del">-	add		%g2, 1, %g2</span>
<span class="p_add">+	srlx		%g3, 18, %g2</span>
<span class="p_add">+	brnz,pn		%g2, 2f</span>
<span class="p_add">+	 add		%g2, 1, %g2</span>
 	sub		%g3, %g2, %g3
 	or		%g1, 0x20, %g1		! Nucleus
 1:	stxa		%g0, [%g1 + %g3] ASI_DMMU_DEMAP
<span class="p_chunk">@@ -507,8 +595,25 @@</span> <span class="p_context"> xcall_flush_tlb_kernel_range:	/* 25 insns */</span>
 	brnz,pt		%g3, 1b
 	 sub		%g3, %g2, %g3
 	retry
<span class="p_del">-	nop</span>
<span class="p_del">-	nop</span>
<span class="p_add">+2:	mov		63 * 8, %g1</span>
<span class="p_add">+1:	ldxa		[%g1] ASI_ITLB_DATA_ACCESS, %g2</span>
<span class="p_add">+	andcc		%g2, 0x40, %g0			/* _PAGE_L_4U */</span>
<span class="p_add">+	bne,pn		%xcc, 2f</span>
<span class="p_add">+	 mov		TLB_TAG_ACCESS, %g2</span>
<span class="p_add">+	stxa		%g0, [%g2] ASI_IMMU</span>
<span class="p_add">+	stxa		%g0, [%g1] ASI_ITLB_DATA_ACCESS</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+2:	ldxa		[%g1] ASI_DTLB_DATA_ACCESS, %g2</span>
<span class="p_add">+	andcc		%g2, 0x40, %g0</span>
<span class="p_add">+	bne,pn		%xcc, 2f</span>
<span class="p_add">+	 mov		TLB_TAG_ACCESS, %g2</span>
<span class="p_add">+	stxa		%g0, [%g2] ASI_DMMU</span>
<span class="p_add">+	stxa		%g0, [%g1] ASI_DTLB_DATA_ACCESS</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+2:	sub		%g1, 8, %g1</span>
<span class="p_add">+	brgez,pt	%g1, 1b</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+	retry</span>
 	nop
 	nop
 	nop
<span class="p_chunk">@@ -637,6 +742,52 @@</span> <span class="p_context"> xcall_fetch_glob_pmu_n4:</span>
 
 	retry
 
<span class="p_add">+__cheetah_xcall_flush_tlb_kernel_range:	/* 44 insns */</span>
<span class="p_add">+	sethi		%hi(PAGE_SIZE - 1), %g2</span>
<span class="p_add">+	or		%g2, %lo(PAGE_SIZE - 1), %g2</span>
<span class="p_add">+	andn		%g1, %g2, %g1</span>
<span class="p_add">+	andn		%g7, %g2, %g7</span>
<span class="p_add">+	sub		%g7, %g1, %g3</span>
<span class="p_add">+	srlx		%g3, 18, %g2</span>
<span class="p_add">+	brnz,pn		%g2, 2f</span>
<span class="p_add">+	 add		%g2, 1, %g2</span>
<span class="p_add">+	sub		%g3, %g2, %g3</span>
<span class="p_add">+	or		%g1, 0x20, %g1		! Nucleus</span>
<span class="p_add">+1:	stxa		%g0, [%g1 + %g3] ASI_DMMU_DEMAP</span>
<span class="p_add">+	stxa		%g0, [%g1 + %g3] ASI_IMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	brnz,pt		%g3, 1b</span>
<span class="p_add">+	 sub		%g3, %g2, %g3</span>
<span class="p_add">+	retry</span>
<span class="p_add">+2:	mov		0x80, %g2</span>
<span class="p_add">+	stxa		%g0, [%g2] ASI_DMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	stxa		%g0, [%g2] ASI_IMMU_DEMAP</span>
<span class="p_add">+	membar		#Sync</span>
<span class="p_add">+	retry</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+	nop</span>
<span class="p_add">+</span>
 #ifdef DCACHE_ALIASING_POSSIBLE
 	.align		32
 	.globl		xcall_flush_dcache_page_cheetah
<span class="p_chunk">@@ -700,7 +851,7 @@</span> <span class="p_context"> __hypervisor_tlb_xcall_error:</span>
 	ba,a,pt	%xcc, rtrap
 
 	.globl		__hypervisor_xcall_flush_tlb_mm
<span class="p_del">-__hypervisor_xcall_flush_tlb_mm: /* 21 insns */</span>
<span class="p_add">+__hypervisor_xcall_flush_tlb_mm: /* 24 insns */</span>
 	/* %g5=ctx, g1,g2,g3,g4,g7=scratch, %g6=unusable */
 	mov		%o0, %g2
 	mov		%o1, %g3
<span class="p_chunk">@@ -714,7 +865,7 @@</span> <span class="p_context"> __hypervisor_xcall_flush_tlb_mm: /* 21 insns */</span>
 	mov		HV_FAST_MMU_DEMAP_CTX, %o5
 	ta		HV_FAST_TRAP
 	mov		HV_FAST_MMU_DEMAP_CTX, %g6
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_xcall_error</span>
<span class="p_add">+	brnz,pn		%o0, 1f</span>
 	 mov		%o0, %g5
 	mov		%g2, %o0
 	mov		%g3, %o1
<span class="p_chunk">@@ -723,9 +874,12 @@</span> <span class="p_context"> __hypervisor_xcall_flush_tlb_mm: /* 21 insns */</span>
 	mov		%g7, %o5
 	membar		#Sync
 	retry
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_xcall_error), %g4</span>
<span class="p_add">+	jmpl		%g4 + %lo(__hypervisor_tlb_xcall_error), %g0</span>
<span class="p_add">+	 nop</span>
 
 	.globl		__hypervisor_xcall_flush_tlb_page
<span class="p_del">-__hypervisor_xcall_flush_tlb_page: /* 17 insns */</span>
<span class="p_add">+__hypervisor_xcall_flush_tlb_page: /* 20 insns */</span>
 	/* %g5=ctx, %g1=vaddr */
 	mov		%o0, %g2
 	mov		%o1, %g3
<span class="p_chunk">@@ -737,42 +891,64 @@</span> <span class="p_context"> __hypervisor_xcall_flush_tlb_page: /* 17 insns */</span>
 	sllx		%o0, PAGE_SHIFT, %o0
 	ta		HV_MMU_UNMAP_ADDR_TRAP
 	mov		HV_MMU_UNMAP_ADDR_TRAP, %g6
<span class="p_del">-	brnz,a,pn	%o0, __hypervisor_tlb_xcall_error</span>
<span class="p_add">+	brnz,a,pn	%o0, 1f</span>
 	 mov		%o0, %g5
 	mov		%g2, %o0
 	mov		%g3, %o1
 	mov		%g4, %o2
 	membar		#Sync
 	retry
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_xcall_error), %g4</span>
<span class="p_add">+	jmpl		%g4 + %lo(__hypervisor_tlb_xcall_error), %g0</span>
<span class="p_add">+	 nop</span>
 
 	.globl		__hypervisor_xcall_flush_tlb_kernel_range
<span class="p_del">-__hypervisor_xcall_flush_tlb_kernel_range: /* 25 insns */</span>
<span class="p_add">+__hypervisor_xcall_flush_tlb_kernel_range: /* 44 insns */</span>
 	/* %g1=start, %g7=end, g2,g3,g4,g5,g6=scratch */
 	sethi		%hi(PAGE_SIZE - 1), %g2
 	or		%g2, %lo(PAGE_SIZE - 1), %g2
 	andn		%g1, %g2, %g1
 	andn		%g7, %g2, %g7
 	sub		%g7, %g1, %g3
<span class="p_add">+	srlx		%g3, 18, %g7</span>
 	add		%g2, 1, %g2
 	sub		%g3, %g2, %g3
 	mov		%o0, %g2
 	mov		%o1, %g4
<span class="p_del">-	mov		%o2, %g7</span>
<span class="p_add">+	brnz,pn		%g7, 2f</span>
<span class="p_add">+	 mov		%o2, %g7</span>
 1:	add		%g1, %g3, %o0	/* ARG0: virtual address */
 	mov		0, %o1		/* ARG1: mmu context */
 	mov		HV_MMU_ALL, %o2	/* ARG2: flags */
 	ta		HV_MMU_UNMAP_ADDR_TRAP
 	mov		HV_MMU_UNMAP_ADDR_TRAP, %g6
<span class="p_del">-	brnz,pn		%o0, __hypervisor_tlb_xcall_error</span>
<span class="p_add">+	brnz,pn		%o0, 1f</span>
 	 mov		%o0, %g5
 	sethi		%hi(PAGE_SIZE), %o2
 	brnz,pt		%g3, 1b
 	 sub		%g3, %o2, %g3
<span class="p_del">-	mov		%g2, %o0</span>
<span class="p_add">+5:	mov		%g2, %o0</span>
 	mov		%g4, %o1
 	mov		%g7, %o2
 	membar		#Sync
 	retry
<span class="p_add">+1:	sethi		%hi(__hypervisor_tlb_xcall_error), %g4</span>
<span class="p_add">+	jmpl		%g4 + %lo(__hypervisor_tlb_xcall_error), %g0</span>
<span class="p_add">+	 nop</span>
<span class="p_add">+2:	mov		%o3, %g1</span>
<span class="p_add">+	mov		%o5, %g3</span>
<span class="p_add">+	mov		0, %o0		/* ARG0: CPU lists unimplemented */</span>
<span class="p_add">+	mov		0, %o1		/* ARG1: CPU lists unimplemented */</span>
<span class="p_add">+	mov		0, %o2		/* ARG2: mmu context == nucleus */</span>
<span class="p_add">+	mov		HV_MMU_ALL, %o3	/* ARG3: flags */</span>
<span class="p_add">+	mov		HV_FAST_MMU_DEMAP_CTX, %o5</span>
<span class="p_add">+	ta		HV_FAST_TRAP</span>
<span class="p_add">+	mov		%g1, %o3</span>
<span class="p_add">+	brz,pt		%o0, 5b</span>
<span class="p_add">+	 mov		%g3, %o5</span>
<span class="p_add">+	mov		HV_FAST_MMU_DEMAP_CTX, %g6</span>
<span class="p_add">+	ba,pt		%xcc, 1b</span>
<span class="p_add">+	 clr		%g5</span>
 
 	/* These just get rescheduled to PIL vectors. */
 	.globl		xcall_call_function
<span class="p_chunk">@@ -809,6 +985,58 @@</span> <span class="p_context"> xcall_kgdb_capture:</span>
 
 #endif /* CONFIG_SMP */
 
<span class="p_add">+	.globl		cheetah_patch_cachetlbops</span>
<span class="p_add">+cheetah_patch_cachetlbops:</span>
<span class="p_add">+	save		%sp, -128, %sp</span>
<span class="p_add">+</span>
<span class="p_add">+	sethi		%hi(__flush_tlb_mm), %o0</span>
<span class="p_add">+	or		%o0, %lo(__flush_tlb_mm), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_flush_tlb_mm), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_flush_tlb_mm), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		19, %o2</span>
<span class="p_add">+</span>
<span class="p_add">+	sethi		%hi(__flush_tlb_page), %o0</span>
<span class="p_add">+	or		%o0, %lo(__flush_tlb_page), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_flush_tlb_page), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_flush_tlb_page), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		22, %o2</span>
<span class="p_add">+</span>
<span class="p_add">+	sethi		%hi(__flush_tlb_pending), %o0</span>
<span class="p_add">+	or		%o0, %lo(__flush_tlb_pending), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_flush_tlb_pending), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_flush_tlb_pending), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		27, %o2</span>
<span class="p_add">+</span>
<span class="p_add">+	sethi		%hi(__flush_tlb_kernel_range), %o0</span>
<span class="p_add">+	or		%o0, %lo(__flush_tlb_kernel_range), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_flush_tlb_kernel_range), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_flush_tlb_kernel_range), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		31, %o2</span>
<span class="p_add">+</span>
<span class="p_add">+#ifdef DCACHE_ALIASING_POSSIBLE</span>
<span class="p_add">+	sethi		%hi(__flush_dcache_page), %o0</span>
<span class="p_add">+	or		%o0, %lo(__flush_dcache_page), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_flush_dcache_page), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_flush_dcache_page), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		11, %o2</span>
<span class="p_add">+#endif /* DCACHE_ALIASING_POSSIBLE */</span>
<span class="p_add">+</span>
<span class="p_add">+#ifdef CONFIG_SMP</span>
<span class="p_add">+	sethi		%hi(xcall_flush_tlb_kernel_range), %o0</span>
<span class="p_add">+	or		%o0, %lo(xcall_flush_tlb_kernel_range), %o0</span>
<span class="p_add">+	sethi		%hi(__cheetah_xcall_flush_tlb_kernel_range), %o1</span>
<span class="p_add">+	or		%o1, %lo(__cheetah_xcall_flush_tlb_kernel_range), %o1</span>
<span class="p_add">+	call		tlb_patch_one</span>
<span class="p_add">+	 mov		44, %o2</span>
<span class="p_add">+#endif /* CONFIG_SMP */</span>
<span class="p_add">+</span>
<span class="p_add">+	ret</span>
<span class="p_add">+	 restore</span>
 
 	.globl		hypervisor_patch_cachetlbops
 hypervisor_patch_cachetlbops:
<span class="p_chunk">@@ -819,28 +1047,28 @@</span> <span class="p_context"> hypervisor_patch_cachetlbops:</span>
 	sethi		%hi(__hypervisor_flush_tlb_mm), %o1
 	or		%o1, %lo(__hypervisor_flush_tlb_mm), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		10, %o2</span>
<span class="p_add">+	 mov		19, %o2</span>
 
 	sethi		%hi(__flush_tlb_page), %o0
 	or		%o0, %lo(__flush_tlb_page), %o0
 	sethi		%hi(__hypervisor_flush_tlb_page), %o1
 	or		%o1, %lo(__hypervisor_flush_tlb_page), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		11, %o2</span>
<span class="p_add">+	 mov		22, %o2</span>
 
 	sethi		%hi(__flush_tlb_pending), %o0
 	or		%o0, %lo(__flush_tlb_pending), %o0
 	sethi		%hi(__hypervisor_flush_tlb_pending), %o1
 	or		%o1, %lo(__hypervisor_flush_tlb_pending), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		16, %o2</span>
<span class="p_add">+	 mov		27, %o2</span>
 
 	sethi		%hi(__flush_tlb_kernel_range), %o0
 	or		%o0, %lo(__flush_tlb_kernel_range), %o0
 	sethi		%hi(__hypervisor_flush_tlb_kernel_range), %o1
 	or		%o1, %lo(__hypervisor_flush_tlb_kernel_range), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		16, %o2</span>
<span class="p_add">+	 mov		31, %o2</span>
 
 #ifdef DCACHE_ALIASING_POSSIBLE
 	sethi		%hi(__flush_dcache_page), %o0
<span class="p_chunk">@@ -857,21 +1085,21 @@</span> <span class="p_context"> hypervisor_patch_cachetlbops:</span>
 	sethi		%hi(__hypervisor_xcall_flush_tlb_mm), %o1
 	or		%o1, %lo(__hypervisor_xcall_flush_tlb_mm), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		21, %o2</span>
<span class="p_add">+	 mov		24, %o2</span>
 
 	sethi		%hi(xcall_flush_tlb_page), %o0
 	or		%o0, %lo(xcall_flush_tlb_page), %o0
 	sethi		%hi(__hypervisor_xcall_flush_tlb_page), %o1
 	or		%o1, %lo(__hypervisor_xcall_flush_tlb_page), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		17, %o2</span>
<span class="p_add">+	 mov		20, %o2</span>
 
 	sethi		%hi(xcall_flush_tlb_kernel_range), %o0
 	or		%o0, %lo(xcall_flush_tlb_kernel_range), %o0
 	sethi		%hi(__hypervisor_xcall_flush_tlb_kernel_range), %o1
 	or		%o1, %lo(__hypervisor_xcall_flush_tlb_kernel_range), %o1
 	call		tlb_patch_one
<span class="p_del">-	 mov		25, %o2</span>
<span class="p_add">+	 mov		44, %o2</span>
 #endif /* CONFIG_SMP */
 
 	ret
<span class="p_header">diff --git a/drivers/net/ethernet/broadcom/bgmac.c b/drivers/net/ethernet/broadcom/bgmac.c</span>
<span class="p_header">index c32f5d32f811..b56c9c581359 100644</span>
<span class="p_header">--- a/drivers/net/ethernet/broadcom/bgmac.c</span>
<span class="p_header">+++ b/drivers/net/ethernet/broadcom/bgmac.c</span>
<span class="p_chunk">@@ -314,6 +314,10 @@</span> <span class="p_context"> static void bgmac_dma_rx_enable(struct bgmac *bgmac,</span>
 	u32 ctl;
 
 	ctl = bgmac_read(bgmac, ring-&gt;mmio_base + BGMAC_DMA_RX_CTL);
<span class="p_add">+</span>
<span class="p_add">+	/* preserve ONLY bits 16-17 from current hardware value */</span>
<span class="p_add">+	ctl &amp;= BGMAC_DMA_RX_ADDREXT_MASK;</span>
<span class="p_add">+</span>
 	if (bgmac-&gt;core-&gt;id.rev &gt;= 4) {
 		ctl &amp;= ~BGMAC_DMA_RX_BL_MASK;
 		ctl |= BGMAC_DMA_RX_BL_128 &lt;&lt; BGMAC_DMA_RX_BL_SHIFT;
<span class="p_chunk">@@ -324,7 +328,6 @@</span> <span class="p_context"> static void bgmac_dma_rx_enable(struct bgmac *bgmac,</span>
 		ctl &amp;= ~BGMAC_DMA_RX_PT_MASK;
 		ctl |= BGMAC_DMA_RX_PT_1 &lt;&lt; BGMAC_DMA_RX_PT_SHIFT;
 	}
<span class="p_del">-	ctl &amp;= BGMAC_DMA_RX_ADDREXT_MASK;</span>
 	ctl |= BGMAC_DMA_RX_ENABLE;
 	ctl |= BGMAC_DMA_RX_PARITY_DISABLE;
 	ctl |= BGMAC_DMA_RX_OVERFLOW_CONT;
<span class="p_header">diff --git a/drivers/tty/serial/sunhv.c b/drivers/tty/serial/sunhv.c</span>
<span class="p_header">index ca0d3802f2af..4e603d060e80 100644</span>
<span class="p_header">--- a/drivers/tty/serial/sunhv.c</span>
<span class="p_header">+++ b/drivers/tty/serial/sunhv.c</span>
<span class="p_chunk">@@ -490,12 +490,6 @@</span> <span class="p_context"> static void sunhv_console_write_bychar(struct console *con, const char *s, unsig</span>
 		locked = spin_trylock_irqsave(&amp;port-&gt;lock, flags);
 	else
 		spin_lock_irqsave(&amp;port-&gt;lock, flags);
<span class="p_del">-	if (port-&gt;sysrq) {</span>
<span class="p_del">-		locked = 0;</span>
<span class="p_del">-	} else if (oops_in_progress) {</span>
<span class="p_del">-		locked = spin_trylock(&amp;port-&gt;lock);</span>
<span class="p_del">-	} else</span>
<span class="p_del">-		spin_lock(&amp;port-&gt;lock);</span>
 
 	for (i = 0; i &lt; n; i++) {
 		if (*s == &#39;\n&#39;)
<span class="p_header">diff --git a/drivers/tty/tty_ldisc.c b/drivers/tty/tty_ldisc.c</span>
<span class="p_header">index 629e3c865072..9bee25cfa0be 100644</span>
<span class="p_header">--- a/drivers/tty/tty_ldisc.c</span>
<span class="p_header">+++ b/drivers/tty/tty_ldisc.c</span>
<span class="p_chunk">@@ -417,6 +417,10 @@</span> <span class="p_context"> EXPORT_SYMBOL_GPL(tty_ldisc_flush);</span>
  *	they are not on hot paths so a little discipline won&#39;t do
  *	any harm.
  *
<span class="p_add">+ *	The line discipline-related tty_struct fields are reset to</span>
<span class="p_add">+ *	prevent the ldisc driver from re-using stale information for</span>
<span class="p_add">+ *	the new ldisc instance.</span>
<span class="p_add">+ *</span>
  *	Locking: takes termios_rwsem
  */
 
<span class="p_chunk">@@ -425,6 +429,9 @@</span> <span class="p_context"> static void tty_set_termios_ldisc(struct tty_struct *tty, int num)</span>
 	down_write(&amp;tty-&gt;termios_rwsem);
 	tty-&gt;termios.c_line = num;
 	up_write(&amp;tty-&gt;termios_rwsem);
<span class="p_add">+</span>
<span class="p_add">+	tty-&gt;disc_data = NULL;</span>
<span class="p_add">+	tty-&gt;receive_room = 0;</span>
 }
 
 /**
<span class="p_header">diff --git a/include/linux/filter.h b/include/linux/filter.h</span>
<span class="p_header">index 5110d4211866..ccb98b459c59 100644</span>
<span class="p_header">--- a/include/linux/filter.h</span>
<span class="p_header">+++ b/include/linux/filter.h</span>
<span class="p_chunk">@@ -421,7 +421,11 @@</span> <span class="p_context"> static inline void bpf_prog_unlock_ro(struct bpf_prog *fp)</span>
 }
 #endif /* CONFIG_DEBUG_SET_MODULE_RONX */
 
<span class="p_del">-int sk_filter(struct sock *sk, struct sk_buff *skb);</span>
<span class="p_add">+int sk_filter_trim_cap(struct sock *sk, struct sk_buff *skb, unsigned int cap);</span>
<span class="p_add">+static inline int sk_filter(struct sock *sk, struct sk_buff *skb)</span>
<span class="p_add">+{</span>
<span class="p_add">+	return sk_filter_trim_cap(sk, skb, 1);</span>
<span class="p_add">+}</span>
 
 int bpf_prog_select_runtime(struct bpf_prog *fp);
 void bpf_prog_free(struct bpf_prog *fp);
<span class="p_header">diff --git a/include/net/ip6_tunnel.h b/include/net/ip6_tunnel.h</span>
<span class="p_header">index ff788b665277..9c2c044153f6 100644</span>
<span class="p_header">--- a/include/net/ip6_tunnel.h</span>
<span class="p_header">+++ b/include/net/ip6_tunnel.h</span>
<span class="p_chunk">@@ -86,6 +86,7 @@</span> <span class="p_context"> static inline void ip6tunnel_xmit(struct sock *sk, struct sk_buff *skb,</span>
 	struct net_device_stats *stats = &amp;dev-&gt;stats;
 	int pkt_len, err;
 
<span class="p_add">+	memset(skb-&gt;cb, 0, sizeof(struct inet6_skb_parm));</span>
 	pkt_len = skb-&gt;len - skb_inner_network_offset(skb);
 	err = ip6_local_out(dev_net(skb_dst(skb)-&gt;dev), sk, skb);
 
<span class="p_header">diff --git a/include/net/tcp.h b/include/net/tcp.h</span>
<span class="p_header">index 9c3ab544d3a8..e9d7a8ef9a6d 100644</span>
<span class="p_header">--- a/include/net/tcp.h</span>
<span class="p_header">+++ b/include/net/tcp.h</span>
<span class="p_chunk">@@ -1156,6 +1156,7 @@</span> <span class="p_context"> static inline void tcp_prequeue_init(struct tcp_sock *tp)</span>
 }
 
 bool tcp_prequeue(struct sock *sk, struct sk_buff *skb);
<span class="p_add">+int tcp_filter(struct sock *sk, struct sk_buff *skb);</span>
 
 #undef STATE_TRACE
 
<span class="p_header">diff --git a/net/core/dev.c b/net/core/dev.c</span>
<span class="p_header">index b3fa4b86ab4c..9ca749c81b6c 100644</span>
<span class="p_header">--- a/net/core/dev.c</span>
<span class="p_header">+++ b/net/core/dev.c</span>
<span class="p_chunk">@@ -2462,7 +2462,7 @@</span> <span class="p_context"> int skb_checksum_help(struct sk_buff *skb)</span>
 			goto out;
 	}
 
<span class="p_del">-	*(__sum16 *)(skb-&gt;data + offset) = csum_fold(csum);</span>
<span class="p_add">+	*(__sum16 *)(skb-&gt;data + offset) = csum_fold(csum) ?: CSUM_MANGLED_0;</span>
 out_set_summed:
 	skb-&gt;ip_summed = CHECKSUM_NONE;
 out:
<span class="p_header">diff --git a/net/core/filter.c b/net/core/filter.c</span>
<span class="p_header">index 75e9b2b2336d..e94355452166 100644</span>
<span class="p_header">--- a/net/core/filter.c</span>
<span class="p_header">+++ b/net/core/filter.c</span>
<span class="p_chunk">@@ -52,9 +52,10 @@</span> <span class="p_context"></span>
 #include &lt;net/dst.h&gt;
 
 /**
<span class="p_del">- *	sk_filter - run a packet through a socket filter</span>
<span class="p_add">+ *	sk_filter_trim_cap - run a packet through a socket filter</span>
  *	@sk: sock associated with &amp;sk_buff
  *	@skb: buffer to filter
<span class="p_add">+ *	@cap: limit on how short the eBPF program may trim the packet</span>
  *
  * Run the eBPF program and then cut skb-&gt;data to correct size returned by
  * the program. If pkt_len is 0 we toss packet. If skb-&gt;len is smaller
<span class="p_chunk">@@ -63,7 +64,7 @@</span> <span class="p_context"></span>
  * be accepted or -EPERM if the packet should be tossed.
  *
  */
<span class="p_del">-int sk_filter(struct sock *sk, struct sk_buff *skb)</span>
<span class="p_add">+int sk_filter_trim_cap(struct sock *sk, struct sk_buff *skb, unsigned int cap)</span>
 {
 	int err;
 	struct sk_filter *filter;
<span class="p_chunk">@@ -84,14 +85,13 @@</span> <span class="p_context"> int sk_filter(struct sock *sk, struct sk_buff *skb)</span>
 	filter = rcu_dereference(sk-&gt;sk_filter);
 	if (filter) {
 		unsigned int pkt_len = bpf_prog_run_save_cb(filter-&gt;prog, skb);
<span class="p_del">-</span>
<span class="p_del">-		err = pkt_len ? pskb_trim(skb, pkt_len) : -EPERM;</span>
<span class="p_add">+		err = pkt_len ? pskb_trim(skb, max(cap, pkt_len)) : -EPERM;</span>
 	}
 	rcu_read_unlock();
 
 	return err;
 }
<span class="p_del">-EXPORT_SYMBOL(sk_filter);</span>
<span class="p_add">+EXPORT_SYMBOL(sk_filter_trim_cap);</span>
 
 static u64 __skb_get_pay_offset(u64 ctx, u64 a, u64 x, u64 r4, u64 r5)
 {
<span class="p_header">diff --git a/net/core/flow_dissector.c b/net/core/flow_dissector.c</span>
<span class="p_header">index 4ab6ead3d8ee..9aba9e93c0a2 100644</span>
<span class="p_header">--- a/net/core/flow_dissector.c</span>
<span class="p_header">+++ b/net/core/flow_dissector.c</span>
<span class="p_chunk">@@ -131,7 +131,7 @@</span> <span class="p_context"> bool __skb_flow_dissect(const struct sk_buff *skb,</span>
 	struct flow_dissector_key_tags *key_tags;
 	struct flow_dissector_key_keyid *key_keyid;
 	u8 ip_proto = 0;
<span class="p_del">-	bool ret = false;</span>
<span class="p_add">+	bool ret;</span>
 
 	if (!data) {
 		data = skb-&gt;data;
<span class="p_chunk">@@ -492,12 +492,17 @@</span> <span class="p_context"> ip_proto_again:</span>
 out_good:
 	ret = true;
 
<span class="p_del">-out_bad:</span>
<span class="p_add">+	key_control-&gt;thoff = (u16)nhoff;</span>
<span class="p_add">+out:</span>
 	key_basic-&gt;n_proto = proto;
 	key_basic-&gt;ip_proto = ip_proto;
<span class="p_del">-	key_control-&gt;thoff = (u16)nhoff;</span>
 
 	return ret;
<span class="p_add">+</span>
<span class="p_add">+out_bad:</span>
<span class="p_add">+	ret = false;</span>
<span class="p_add">+	key_control-&gt;thoff = min_t(u16, nhoff, skb ? skb-&gt;len : hlen);</span>
<span class="p_add">+	goto out;</span>
 }
 EXPORT_SYMBOL(__skb_flow_dissect);
 
<span class="p_header">diff --git a/net/core/sock.c b/net/core/sock.c</span>
<span class="p_header">index 0d91f7dca751..88f017854509 100644</span>
<span class="p_header">--- a/net/core/sock.c</span>
<span class="p_header">+++ b/net/core/sock.c</span>
<span class="p_chunk">@@ -1562,6 +1562,7 @@</span> <span class="p_context"> struct sock *sk_clone_lock(const struct sock *sk, const gfp_t priority)</span>
 		}
 
 		newsk-&gt;sk_err	   = 0;
<span class="p_add">+		newsk-&gt;sk_err_soft = 0;</span>
 		newsk-&gt;sk_priority = 0;
 		newsk-&gt;sk_incoming_cpu = raw_smp_processor_id();
 		atomic64_set(&amp;newsk-&gt;sk_cookie, 0);
<span class="p_header">diff --git a/net/dccp/ipv4.c b/net/dccp/ipv4.c</span>
<span class="p_header">index 8be8f27bfacc..861e1fa25d5e 100644</span>
<span class="p_header">--- a/net/dccp/ipv4.c</span>
<span class="p_header">+++ b/net/dccp/ipv4.c</span>
<span class="p_chunk">@@ -235,7 +235,7 @@</span> <span class="p_context"> static void dccp_v4_err(struct sk_buff *skb, u32 info)</span>
 {
 	const struct iphdr *iph = (struct iphdr *)skb-&gt;data;
 	const u8 offset = iph-&gt;ihl &lt;&lt; 2;
<span class="p_del">-	const struct dccp_hdr *dh = (struct dccp_hdr *)(skb-&gt;data + offset);</span>
<span class="p_add">+	const struct dccp_hdr *dh;</span>
 	struct dccp_sock *dp;
 	struct inet_sock *inet;
 	const int type = icmp_hdr(skb)-&gt;type;
<span class="p_chunk">@@ -245,11 +245,13 @@</span> <span class="p_context"> static void dccp_v4_err(struct sk_buff *skb, u32 info)</span>
 	int err;
 	struct net *net = dev_net(skb-&gt;dev);
 
<span class="p_del">-	if (skb-&gt;len &lt; offset + sizeof(*dh) ||</span>
<span class="p_del">-	    skb-&gt;len &lt; offset + __dccp_basic_hdr_len(dh)) {</span>
<span class="p_del">-		ICMP_INC_STATS_BH(net, ICMP_MIB_INERRORS);</span>
<span class="p_del">-		return;</span>
<span class="p_del">-	}</span>
<span class="p_add">+	/* Only need dccph_dport &amp; dccph_sport which are the first</span>
<span class="p_add">+	 * 4 bytes in dccp header.</span>
<span class="p_add">+	 * Our caller (icmp_socket_deliver()) already pulled 8 bytes for us.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+	BUILD_BUG_ON(offsetofend(struct dccp_hdr, dccph_sport) &gt; 8);</span>
<span class="p_add">+	BUILD_BUG_ON(offsetofend(struct dccp_hdr, dccph_dport) &gt; 8);</span>
<span class="p_add">+	dh = (struct dccp_hdr *)(skb-&gt;data + offset);</span>
 
 	sk = __inet_lookup_established(net, &amp;dccp_hashinfo,
 				       iph-&gt;daddr, dh-&gt;dccph_dport,
<span class="p_header">diff --git a/net/dccp/ipv6.c b/net/dccp/ipv6.c</span>
<span class="p_header">index b8608b71a66d..27c4e81efa24 100644</span>
<span class="p_header">--- a/net/dccp/ipv6.c</span>
<span class="p_header">+++ b/net/dccp/ipv6.c</span>
<span class="p_chunk">@@ -70,7 +70,7 @@</span> <span class="p_context"> static void dccp_v6_err(struct sk_buff *skb, struct inet6_skb_parm *opt,</span>
 			u8 type, u8 code, int offset, __be32 info)
 {
 	const struct ipv6hdr *hdr = (const struct ipv6hdr *)skb-&gt;data;
<span class="p_del">-	const struct dccp_hdr *dh = (struct dccp_hdr *)(skb-&gt;data + offset);</span>
<span class="p_add">+	const struct dccp_hdr *dh;</span>
 	struct dccp_sock *dp;
 	struct ipv6_pinfo *np;
 	struct sock *sk;
<span class="p_chunk">@@ -78,12 +78,13 @@</span> <span class="p_context"> static void dccp_v6_err(struct sk_buff *skb, struct inet6_skb_parm *opt,</span>
 	__u64 seq;
 	struct net *net = dev_net(skb-&gt;dev);
 
<span class="p_del">-	if (skb-&gt;len &lt; offset + sizeof(*dh) ||</span>
<span class="p_del">-	    skb-&gt;len &lt; offset + __dccp_basic_hdr_len(dh)) {</span>
<span class="p_del">-		ICMP6_INC_STATS_BH(net, __in6_dev_get(skb-&gt;dev),</span>
<span class="p_del">-				   ICMP6_MIB_INERRORS);</span>
<span class="p_del">-		return;</span>
<span class="p_del">-	}</span>
<span class="p_add">+	/* Only need dccph_dport &amp; dccph_sport which are the first</span>
<span class="p_add">+	 * 4 bytes in dccp header.</span>
<span class="p_add">+	 * Our caller (icmpv6_notify()) already pulled 8 bytes for us.</span>
<span class="p_add">+	 */</span>
<span class="p_add">+	BUILD_BUG_ON(offsetofend(struct dccp_hdr, dccph_sport) &gt; 8);</span>
<span class="p_add">+	BUILD_BUG_ON(offsetofend(struct dccp_hdr, dccph_dport) &gt; 8);</span>
<span class="p_add">+	dh = (struct dccp_hdr *)(skb-&gt;data + offset);</span>
 
 	sk = __inet6_lookup_established(net, &amp;dccp_hashinfo,
 					&amp;hdr-&gt;daddr, dh-&gt;dccph_dport,
<span class="p_chunk">@@ -947,6 +948,7 @@</span> <span class="p_context"> static const struct inet_connection_sock_af_ops dccp_ipv6_mapped = {</span>
 	.getsockopt	   = ipv6_getsockopt,
 	.addr2sockaddr	   = inet6_csk_addr2sockaddr,
 	.sockaddr_len	   = sizeof(struct sockaddr_in6),
<span class="p_add">+	.bind_conflict	   = inet6_csk_bind_conflict,</span>
 #ifdef CONFIG_COMPAT
 	.compat_setsockopt = compat_ipv6_setsockopt,
 	.compat_getsockopt = compat_ipv6_getsockopt,
<span class="p_header">diff --git a/net/dccp/proto.c b/net/dccp/proto.c</span>
<span class="p_header">index 41e65804ddf5..9fe25bf63296 100644</span>
<span class="p_header">--- a/net/dccp/proto.c</span>
<span class="p_header">+++ b/net/dccp/proto.c</span>
<span class="p_chunk">@@ -1009,6 +1009,10 @@</span> <span class="p_context"> void dccp_close(struct sock *sk, long timeout)</span>
 		__kfree_skb(skb);
 	}
 
<span class="p_add">+	/* If socket has been already reset kill it. */</span>
<span class="p_add">+	if (sk-&gt;sk_state == DCCP_CLOSED)</span>
<span class="p_add">+		goto adjudge_to_death;</span>
<span class="p_add">+</span>
 	if (data_was_unread) {
 		/* Unread data was tossed, send an appropriate Reset Code */
 		DCCP_WARN(&quot;ABORT with %u bytes unread\n&quot;, data_was_unread);
<span class="p_header">diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c</span>
<span class="p_header">index e5a3ff210fec..7c52afb98c42 100644</span>
<span class="p_header">--- a/net/ipv4/fib_trie.c</span>
<span class="p_header">+++ b/net/ipv4/fib_trie.c</span>
<span class="p_chunk">@@ -2456,22 +2456,19 @@</span> <span class="p_context"> static struct key_vector *fib_route_get_idx(struct fib_route_iter *iter,</span>
 	struct key_vector *l, **tp = &amp;iter-&gt;tnode;
 	t_key key;
 
<span class="p_del">-	/* use cache location of next-to-find key */</span>
<span class="p_add">+	/* use cached location of previously found key */</span>
 	if (iter-&gt;pos &gt; 0 &amp;&amp; pos &gt;= iter-&gt;pos) {
<span class="p_del">-		pos -= iter-&gt;pos;</span>
 		key = iter-&gt;key;
 	} else {
<span class="p_del">-		iter-&gt;pos = 0;</span>
<span class="p_add">+		iter-&gt;pos = 1;</span>
 		key = 0;
 	}
 
<span class="p_del">-	while ((l = leaf_walk_rcu(tp, key)) != NULL) {</span>
<span class="p_add">+	pos -= iter-&gt;pos;</span>
<span class="p_add">+</span>
<span class="p_add">+	while ((l = leaf_walk_rcu(tp, key)) &amp;&amp; (pos-- &gt; 0)) {</span>
 		key = l-&gt;key + 1;
 		iter-&gt;pos++;
<span class="p_del">-</span>
<span class="p_del">-		if (--pos &lt;= 0)</span>
<span class="p_del">-			break;</span>
<span class="p_del">-</span>
 		l = NULL;
 
 		/* handle unlikely case of a key wrap */
<span class="p_chunk">@@ -2480,7 +2477,7 @@</span> <span class="p_context"> static struct key_vector *fib_route_get_idx(struct fib_route_iter *iter,</span>
 	}
 
 	if (l)
<span class="p_del">-		iter-&gt;key = key;	/* remember it */</span>
<span class="p_add">+		iter-&gt;key = l-&gt;key;	/* remember it */</span>
 	else
 		iter-&gt;pos = 0;		/* forget it */
 
<span class="p_chunk">@@ -2508,7 +2505,7 @@</span> <span class="p_context"> static void *fib_route_seq_start(struct seq_file *seq, loff_t *pos)</span>
 		return fib_route_get_idx(iter, *pos);
 
 	iter-&gt;pos = 0;
<span class="p_del">-	iter-&gt;key = 0;</span>
<span class="p_add">+	iter-&gt;key = KEY_MAX;</span>
 
 	return SEQ_START_TOKEN;
 }
<span class="p_chunk">@@ -2517,7 +2514,7 @@</span> <span class="p_context"> static void *fib_route_seq_next(struct seq_file *seq, void *v, loff_t *pos)</span>
 {
 	struct fib_route_iter *iter = seq-&gt;private;
 	struct key_vector *l = NULL;
<span class="p_del">-	t_key key = iter-&gt;key;</span>
<span class="p_add">+	t_key key = iter-&gt;key + 1;</span>
 
 	++*pos;
 
<span class="p_chunk">@@ -2526,7 +2523,7 @@</span> <span class="p_context"> static void *fib_route_seq_next(struct seq_file *seq, void *v, loff_t *pos)</span>
 		l = leaf_walk_rcu(&amp;iter-&gt;tnode, key);
 
 	if (l) {
<span class="p_del">-		iter-&gt;key = l-&gt;key + 1;</span>
<span class="p_add">+		iter-&gt;key = l-&gt;key;</span>
 		iter-&gt;pos++;
 	} else {
 		iter-&gt;pos = 0;
<span class="p_header">diff --git a/net/ipv4/route.c b/net/ipv4/route.c</span>
<span class="p_header">index 8533a75a9328..7ceb8a574a50 100644</span>
<span class="p_header">--- a/net/ipv4/route.c</span>
<span class="p_header">+++ b/net/ipv4/route.c</span>
<span class="p_chunk">@@ -747,7 +747,9 @@</span> <span class="p_context"> static void __ip_do_redirect(struct rtable *rt, struct sk_buff *skb, struct flow</span>
 			goto reject_redirect;
 	}
 
<span class="p_del">-	n = ipv4_neigh_lookup(&amp;rt-&gt;dst, NULL, &amp;new_gw);</span>
<span class="p_add">+	n = __ipv4_neigh_lookup(rt-&gt;dst.dev, new_gw);</span>
<span class="p_add">+	if (!n)</span>
<span class="p_add">+		n = neigh_create(&amp;arp_tbl, &amp;new_gw, rt-&gt;dst.dev);</span>
 	if (!IS_ERR(n)) {
 		if (!(n-&gt;nud_state &amp; NUD_VALID)) {
 			neigh_event_send(n, NULL);
<span class="p_header">diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.c</span>
<span class="p_header">index 036a76ba2ac2..69daa81736f6 100644</span>
<span class="p_header">--- a/net/ipv4/tcp.c</span>
<span class="p_header">+++ b/net/ipv4/tcp.c</span>
<span class="p_chunk">@@ -1212,7 +1212,7 @@</span> <span class="p_context"> new_segment:</span>
 
 			if (!skb_can_coalesce(skb, i, pfrag-&gt;page,
 					      pfrag-&gt;offset)) {
<span class="p_del">-				if (i == sysctl_max_skb_frags || !sg) {</span>
<span class="p_add">+				if (i &gt;= sysctl_max_skb_frags || !sg) {</span>
 					tcp_mark_push(tp, skb);
 					goto new_segment;
 				}
<span class="p_header">diff --git a/net/ipv4/tcp_dctcp.c b/net/ipv4/tcp_dctcp.c</span>
<span class="p_header">index 7e538f71f5fb..55d7da1d2ce9 100644</span>
<span class="p_header">--- a/net/ipv4/tcp_dctcp.c</span>
<span class="p_header">+++ b/net/ipv4/tcp_dctcp.c</span>
<span class="p_chunk">@@ -56,6 +56,7 @@</span> <span class="p_context"> struct dctcp {</span>
 	u32 next_seq;
 	u32 ce_state;
 	u32 delayed_ack_reserved;
<span class="p_add">+	u32 loss_cwnd;</span>
 };
 
 static unsigned int dctcp_shift_g __read_mostly = 4; /* g = 1/2^4 */
<span class="p_chunk">@@ -96,6 +97,7 @@</span> <span class="p_context"> static void dctcp_init(struct sock *sk)</span>
 		ca-&gt;dctcp_alpha = min(dctcp_alpha_on_init, DCTCP_MAX_ALPHA);
 
 		ca-&gt;delayed_ack_reserved = 0;
<span class="p_add">+		ca-&gt;loss_cwnd = 0;</span>
 		ca-&gt;ce_state = 0;
 
 		dctcp_reset(tp, ca);
<span class="p_chunk">@@ -111,9 +113,10 @@</span> <span class="p_context"> static void dctcp_init(struct sock *sk)</span>
 
 static u32 dctcp_ssthresh(struct sock *sk)
 {
<span class="p_del">-	const struct dctcp *ca = inet_csk_ca(sk);</span>
<span class="p_add">+	struct dctcp *ca = inet_csk_ca(sk);</span>
 	struct tcp_sock *tp = tcp_sk(sk);
 
<span class="p_add">+	ca-&gt;loss_cwnd = tp-&gt;snd_cwnd;</span>
 	return max(tp-&gt;snd_cwnd - ((tp-&gt;snd_cwnd * ca-&gt;dctcp_alpha) &gt;&gt; 11U), 2U);
 }
 
<span class="p_chunk">@@ -308,12 +311,20 @@</span> <span class="p_context"> static size_t dctcp_get_info(struct sock *sk, u32 ext, int *attr,</span>
 	return 0;
 }
 
<span class="p_add">+static u32 dctcp_cwnd_undo(struct sock *sk)</span>
<span class="p_add">+{</span>
<span class="p_add">+	const struct dctcp *ca = inet_csk_ca(sk);</span>
<span class="p_add">+</span>
<span class="p_add">+	return max(tcp_sk(sk)-&gt;snd_cwnd, ca-&gt;loss_cwnd);</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 static struct tcp_congestion_ops dctcp __read_mostly = {
 	.init		= dctcp_init,
 	.in_ack_event   = dctcp_update_alpha,
 	.cwnd_event	= dctcp_cwnd_event,
 	.ssthresh	= dctcp_ssthresh,
 	.cong_avoid	= tcp_reno_cong_avoid,
<span class="p_add">+	.undo_cwnd	= dctcp_cwnd_undo,</span>
 	.set_state	= dctcp_state,
 	.get_info	= dctcp_get_info,
 	.flags		= TCP_CONG_NEEDS_ECN,
<span class="p_header">diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c</span>
<span class="p_header">index b5853cac3269..b58a38eea059 100644</span>
<span class="p_header">--- a/net/ipv4/tcp_ipv4.c</span>
<span class="p_header">+++ b/net/ipv4/tcp_ipv4.c</span>
<span class="p_chunk">@@ -1533,6 +1533,21 @@</span> <span class="p_context"> bool tcp_prequeue(struct sock *sk, struct sk_buff *skb)</span>
 }
 EXPORT_SYMBOL(tcp_prequeue);
 
<span class="p_add">+int tcp_filter(struct sock *sk, struct sk_buff *skb)</span>
<span class="p_add">+{</span>
<span class="p_add">+	struct tcphdr *th = (struct tcphdr *)skb-&gt;data;</span>
<span class="p_add">+	unsigned int eaten = skb-&gt;len;</span>
<span class="p_add">+	int err;</span>
<span class="p_add">+</span>
<span class="p_add">+	err = sk_filter_trim_cap(sk, skb, th-&gt;doff * 4);</span>
<span class="p_add">+	if (!err) {</span>
<span class="p_add">+		eaten -= skb-&gt;len;</span>
<span class="p_add">+		TCP_SKB_CB(skb)-&gt;end_seq -= eaten;</span>
<span class="p_add">+	}</span>
<span class="p_add">+	return err;</span>
<span class="p_add">+}</span>
<span class="p_add">+EXPORT_SYMBOL(tcp_filter);</span>
<span class="p_add">+</span>
 /*
  *	From tcp_input.c
  */
<span class="p_chunk">@@ -1638,8 +1653,10 @@</span> <span class="p_context"> process:</span>
 
 	nf_reset(skb);
 
<span class="p_del">-	if (sk_filter(sk, skb))</span>
<span class="p_add">+	if (tcp_filter(sk, skb))</span>
 		goto discard_and_relse;
<span class="p_add">+	th = (const struct tcphdr *)skb-&gt;data;</span>
<span class="p_add">+	iph = ip_hdr(skb);</span>
 
 	skb-&gt;dev = NULL;
 
<span class="p_header">diff --git a/net/ipv6/tcp_ipv6.c b/net/ipv6/tcp_ipv6.c</span>
<span class="p_header">index fbd521fdae53..5f581616bf6a 100644</span>
<span class="p_header">--- a/net/ipv6/tcp_ipv6.c</span>
<span class="p_header">+++ b/net/ipv6/tcp_ipv6.c</span>
<span class="p_chunk">@@ -1214,7 +1214,7 @@</span> <span class="p_context"> static int tcp_v6_do_rcv(struct sock *sk, struct sk_buff *skb)</span>
 	if (skb-&gt;protocol == htons(ETH_P_IP))
 		return tcp_v4_do_rcv(sk, skb);
 
<span class="p_del">-	if (sk_filter(sk, skb))</span>
<span class="p_add">+	if (tcp_filter(sk, skb))</span>
 		goto discard;
 
 	/*
<span class="p_chunk">@@ -1438,8 +1438,10 @@</span> <span class="p_context"> process:</span>
 	if (tcp_v6_inbound_md5_hash(sk, skb))
 		goto discard_and_relse;
 
<span class="p_del">-	if (sk_filter(sk, skb))</span>
<span class="p_add">+	if (tcp_filter(sk, skb))</span>
 		goto discard_and_relse;
<span class="p_add">+	th = (const struct tcphdr *)skb-&gt;data;</span>
<span class="p_add">+	hdr = ipv6_hdr(skb);</span>
 
 	skb-&gt;dev = NULL;
 
<span class="p_header">diff --git a/net/sctp/socket.c b/net/sctp/socket.c</span>
<span class="p_header">index 402817be3873..b5fd4ab56156 100644</span>
<span class="p_header">--- a/net/sctp/socket.c</span>
<span class="p_header">+++ b/net/sctp/socket.c</span>
<span class="p_chunk">@@ -1212,9 +1212,12 @@</span> <span class="p_context"> static int __sctp_connect(struct sock *sk,</span>
 
 	timeo = sock_sndtimeo(sk, f_flags &amp; O_NONBLOCK);
 
<span class="p_del">-	err = sctp_wait_for_connect(asoc, &amp;timeo);</span>
<span class="p_del">-	if ((err == 0 || err == -EINPROGRESS) &amp;&amp; assoc_id)</span>
<span class="p_add">+	if (assoc_id)</span>
 		*assoc_id = asoc-&gt;assoc_id;
<span class="p_add">+	err = sctp_wait_for_connect(asoc, &amp;timeo);</span>
<span class="p_add">+	/* Note: the asoc may be freed after the return of</span>
<span class="p_add">+	 * sctp_wait_for_connect.</span>
<span class="p_add">+	 */</span>
 
 	/* Don&#39;t free association on exit. */
 	asoc = NULL;
<span class="p_header">diff --git a/net/socket.c b/net/socket.c</span>
<span class="p_header">index 263b334ec5e4..0090225eeb1e 100644</span>
<span class="p_header">--- a/net/socket.c</span>
<span class="p_header">+++ b/net/socket.c</span>
<span class="p_chunk">@@ -2041,6 +2041,8 @@</span> <span class="p_context"> int __sys_sendmmsg(int fd, struct mmsghdr __user *mmsg, unsigned int vlen,</span>
 		if (err)
 			break;
 		++datagrams;
<span class="p_add">+		if (msg_data_left(&amp;msg_sys))</span>
<span class="p_add">+			break;</span>
 	}
 
 	fput_light(sock-&gt;file, fput_needed);

</pre>
</div>




  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system
  </div>
 </body>
</html>



